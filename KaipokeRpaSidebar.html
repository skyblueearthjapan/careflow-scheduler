<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }
    h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 16px;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 8px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-title {
      font-weight: bold;
      color: #444;
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 13px;
      color: #666;
    }
    select, input {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.2s;
    }
    .btn-primary { background: #4285f4; color: white; }
    .btn-primary:hover { background: #3367d6; }
    .btn-success { background: #34a853; color: white; }
    .btn-success:hover { background: #2d8e47; }
    .btn-warning { background: #fbbc04; color: #333; }
    .btn-warning:hover { background: #f0a800; }
    .btn-danger { background: #ea4335; color: white; }
    .btn-danger:hover { background: #d33426; }
    .btn-info { background: #5f6368; color: white; }
    .btn-info:hover { background: #4a4d51; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #resultArea {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      min-height: 80px;
      white-space: pre-wrap;
      font-size: 13px;
      color: #333;
    }
    #statusIndicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-ready { background: #34a853; }
    .status-busy { background: #fbbc04; }
    .status-error { background: #ea4335; }
    .loading { display: none; text-align: center; padding: 20px; }
    .loading.show { display: block; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4285f4;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .lock-msg {
      font-size: 12px; color: #ea4335; padding: 4px 8px; margin: -4px 0 8px 0;
      background: #fef7f7; border-radius: 4px; border: 1px solid #fce8e6;
    }
    .completed-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; margin-bottom: 8px; }
    .completed-tag {
      display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
      background: #e8f5e9; border-radius: 4px; font-size: 11px; color: #2e7d32; cursor: pointer;
    }
    .completed-tag:hover { background: #fce8e6; color: #c62828; }
    .interlock-row { display: flex; gap: 4px; margin-bottom: 8px; }
    .interlock-row select { flex: 1; }
    .interlock-row button { width: auto; padding: 8px 10px; font-size: 12px; white-space: nowrap; }
  </style>
</head>
<body>
  <h2>ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–</h2>

  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
  <div id="authScreen" class="section">
    <div class="section-title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼</div>
    <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
    <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" onkeydown="if(event.key==='Enter')verifyPassword()">
    <button class="btn-primary" onclick="verifyPassword()">èªè¨¼</button>
    <div id="authError" style="color:#ea4335;font-size:13px;margin-top:8px;display:none;"></div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆèªè¨¼å¾Œã«è¡¨ç¤ºï¼‰ -->
  <div id="mainContent" style="display:none;">

  <!-- ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ -->
  <div class="section">
    <div class="section-title">
      <span id="statusIndicator" class="status-error"></span>
      <span id="statusText">ç¢ºèªä¸­...</span>
    </div>
    <button class="btn-primary" onclick="refreshStatus()">çŠ¶æ…‹ã‚’æ›´æ–°</button>
  </div>

  <!-- å¯¾è±¡è¨­å®š -->
  <div class="section">
    <div class="section-title">å¯¾è±¡è¨­å®š</div>
    <label>å¯¾è±¡æœˆ</label>
    <select id="targetMonth" onchange="onMonthChange()"></select>

    <label>å¯¾è±¡é€±ï¼ˆå·®åˆ†é©ç”¨æ™‚ã«å¿…è¦ï¼‰</label>
    <select id="weekStart" onchange="updateButtonStates()"></select>
  </div>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="section">
    <div class="section-title">è‡ªå‹•åŒ–æ“ä½œ</div>

    <button class="btn-info" onclick="onTestClick()">
      1. æ¥ç¶šãƒ†ã‚¹ãƒˆ
    </button>

    <button class="btn-primary" id="expandBtn" onclick="onExpandClick()">
      2. æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹
    </button>
    <div class="lock-msg" id="expandLock" style="display:none;"></div>

    <button class="btn-success" onclick="onExportClick()">
      3. CSVå‡ºåŠ›ï¼ˆDriveã«ä¿å­˜ï¼‰
    </button>

    <button class="btn-warning" onclick="onDiffClick()">
      4. å·®åˆ†ç¢ºèªï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
    </button>

    <button class="btn-danger" id="applyBtn" onclick="onApplyClick()">
      5. å·®åˆ†é©ç”¨ï¼ˆã‚«ã‚¤ãƒã‚±ã«åæ˜ ï¼‰
    </button>
    <div class="lock-msg" id="applyLock" style="display:none;"></div>
  </div>

  <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯è¨­å®š -->
  <div class="section">
    <div class="section-title" style="cursor:pointer;" onclick="toggleInterlock()">
      ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯è¨­å®š <span id="interlockArrow">â–¶</span>
    </div>
    <div id="interlockPanel" style="display:none;">
      <label>æœˆé–“å±•é–‹ - åˆ¶é™æœˆï¼ˆã“ã®æœˆä»¥é™ã®ã¿å®Ÿè¡Œå¯ï¼‰</label>
      <div class="interlock-row">
        <select id="expandMinMonth"></select>
        <button class="btn-primary" onclick="saveExpandMin()">ğŸ”’ä¿å­˜</button>
      </div>
      <label>æœˆé–“å±•é–‹ - å®Œäº†æœˆï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ ğŸ”’ï¼‰</label>
      <div class="completed-tags" id="expandCompleted"><span style="font-size:11px;color:#999;">ãªã—</span></div>
      <hr style="border:none;border-top:1px solid #ddd;margin:12px 0;">
      <label>å·®åˆ†é©ç”¨ - åˆ¶é™é€±ï¼ˆã“ã®é€±ä»¥é™ã®ã¿å®Ÿè¡Œå¯ï¼‰</label>
      <div class="interlock-row">
        <select id="applyMinWeek"></select>
        <button class="btn-primary" onclick="saveApplyMin()">ğŸ”’ä¿å­˜</button>
      </div>
      <label>å·®åˆ†é©ç”¨ - å®Œäº†é€±ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ ğŸ”’ï¼‰</label>
      <div class="completed-tags" id="applyCompleted"><span style="font-size:11px;color:#999;">ãªã—</span></div>
    </div>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div id="loadingText">å‡¦ç†ä¸­...</div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="section">
    <div class="section-title">å®Ÿè¡Œçµæœ</div>
    <div id="resultArea">ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ“ä½œã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
  </div>

  </div><!-- /mainContent -->

  <script>
    // ==========================================
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
    // ==========================================
    function verifyPassword() {
      var password = document.getElementById('passwordInput').value;
      var errorEl = document.getElementById('authError');
      errorEl.style.display = 'none';

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initializeMain();
          } else {
            errorEl.innerText = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
            errorEl.style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
          }
        })
        .withFailureHandler(function(error) {
          errorEl.innerText = 'èªè¨¼ã‚¨ãƒ©ãƒ¼: ' + error.message;
          errorEl.style.display = 'block';
        })
        .verifyKaipokePassword(password);
    }

    // ==========================================
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯çŠ¶æ…‹
    // ==========================================
    var interlock = { expandMinMonth: null, expandCompleted: [], applyMinWeek: null, applyCompleted: [] };

    // ==========================================
    // åˆæœŸåŒ–
    // ==========================================
    function initializeMain() {
      // æœˆé¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‹•çš„ç”Ÿæˆ
      var select = document.getElementById("targetMonth");
      var now = new Date();
      var year = now.getFullYear();
      select.innerHTML = '';
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'å¹´' + m + 'æœˆ';
        select.appendChild(opt);
      }
      var currentMonth = year + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
      select.value = currentMonth;

      // é€±ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
      onMonthChange();

      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯èª­ã¿è¾¼ã¿
      loadInterlock();

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
      refreshStatus();

      // æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•å®Ÿè¡Œ
      onTestClick();
    }

    window.onload = function() {
      document.getElementById('passwordInput').focus();
    };

    // ==========================================
    // é€±ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
    // ==========================================
    function getWeeksForMonth(yearMonth) {
      var parts = yearMonth.split('-');
      var year = parseInt(parts[0]);
      var month = parseInt(parts[1]) - 1;
      var weeks = [];
      var date = new Date(year, month, 1);
      while (date.getDay() !== 1) { date.setDate(date.getDate() + 1); }
      var weekNum = 1;
      while (date.getMonth() === month) {
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var dateStr = date.getFullYear() + '-' + mm + '-' + dd;
        weeks.push({ value: dateStr, label: dateStr + 'ï¼ˆ' + (month + 1) + 'æœˆ' + weekNum + 'é€±ç›®ï¼‰' });
        weekNum++;
        date.setDate(date.getDate() + 7);
      }
      return weeks;
    }

    function onMonthChange() {
      var month = getSelectedMonth();
      var weeks = getWeeksForMonth(month);
      var sel = document.getElementById("weekStart");
      sel.innerHTML = '';
      weeks.forEach(function(w) {
        var opt = document.createElement('option');
        opt.value = w.value;
        opt.textContent = w.label;
        sel.appendChild(opt);
      });
      updateButtonStates();
    }

    // ==========================================
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ­ãƒƒã‚¯
    // ==========================================
    function loadInterlock() {
      google.script.run
        .withSuccessHandler(function(settings) {
          interlock = settings;
          updateButtonStates();
          populateInterlockPanel();
        })
        .withFailureHandler(function() {})
        .getInterlockSettings();
    }

    function checkExpandAllowed(month) {
      if (interlock.expandMinMonth && month < interlock.expandMinMonth) {
        return { allowed: false, reason: interlock.expandMinMonth.replace(/^\d{4}-0?/, '').replace(/^(\d+)/, function(m){return parseInt(m);}) + 'æœˆä»¥é™ã®ã¿å±•é–‹å¯èƒ½ã§ã™' };
      }
      if (interlock.expandCompleted.indexOf(month) >= 0) {
        return { allowed: false, reason: month + ' ã¯å±•é–‹å®Œäº†æ¸ˆã¿ã§ã™' };
      }
      return { allowed: true };
    }

    function checkApplyAllowed(weekStart) {
      if (!weekStart) return { allowed: true };
      if (interlock.applyMinWeek && weekStart < interlock.applyMinWeek) {
        return { allowed: false, reason: interlock.applyMinWeek + ' ä»¥é™ã®ã¿å·®åˆ†é©ç”¨å¯èƒ½ã§ã™' };
      }
      if (interlock.applyCompleted.indexOf(weekStart) >= 0) {
        return { allowed: false, reason: weekStart + ' ã¯å·®åˆ†é©ç”¨å®Œäº†æ¸ˆã¿ã§ã™' };
      }
      return { allowed: true };
    }

    function updateButtonStates() {
      var month = getSelectedMonth();
      var weekStart = getWeekStart();

      var ec = checkExpandAllowed(month);
      var expandBtn = document.getElementById('expandBtn');
      var expandLock = document.getElementById('expandLock');
      if (expandBtn) { expandBtn.disabled = !ec.allowed; }
      if (expandLock) { expandLock.style.display = ec.allowed ? 'none' : 'block'; expandLock.textContent = ec.allowed ? '' : 'ğŸ”’ ' + ec.reason; }

      var ac = checkApplyAllowed(weekStart);
      var applyBtn = document.getElementById('applyBtn');
      var applyLock = document.getElementById('applyLock');
      if (applyBtn) { applyBtn.disabled = !ac.allowed; }
      if (applyLock) { applyLock.style.display = ac.allowed ? 'none' : 'block'; applyLock.textContent = ac.allowed ? '' : 'ğŸ”’ ' + ac.reason; }
    }

    function toggleInterlock() {
      var panel = document.getElementById('interlockPanel');
      var arrow = document.getElementById('interlockArrow');
      if (panel.style.display === 'none') { panel.style.display = 'block'; arrow.textContent = 'â–¼'; }
      else { panel.style.display = 'none'; arrow.textContent = 'â–¶'; }
    }

    function populateInterlockPanel() {
      var now = new Date();
      var year = now.getFullYear();

      // å±•é–‹åˆ¶é™æœˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
      var expandSel = document.getElementById('expandMinMonth');
      expandSel.innerHTML = '<option value="">åˆ¶é™ãªã—</option>';
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'å¹´' + m + 'æœˆ';
        expandSel.appendChild(opt);
      }
      if (interlock.expandMinMonth) expandSel.value = interlock.expandMinMonth;

      // å·®åˆ†åˆ¶é™é€±ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå…¨æœˆã®é€±ã‚’è¡¨ç¤ºï¼‰
      var applySel = document.getElementById('applyMinWeek');
      applySel.innerHTML = '<option value="">åˆ¶é™ãªã—</option>';
      for (var m2 = 1; m2 <= 12; m2++) {
        var monthStr = year + '-' + ('0' + m2).slice(-2);
        var weeks = getWeeksForMonth(monthStr);
        weeks.forEach(function(w) {
          var opt = document.createElement('option');
          opt.value = w.value;
          opt.textContent = w.label;
          applySel.appendChild(opt);
        });
      }
      if (interlock.applyMinWeek) applySel.value = interlock.applyMinWeek;

      renderCompletedTags();
    }

    function renderCompletedTags() {
      var ec = document.getElementById('expandCompleted');
      if (interlock.expandCompleted.length === 0) {
        ec.innerHTML = '<span style="font-size:11px;color:#999;">ãªã—</span>';
      } else {
        ec.innerHTML = '';
        interlock.expandCompleted.forEach(function(m) {
          var tag = document.createElement('span');
          tag.className = 'completed-tag';
          tag.textContent = m + ' âœ“';
          tag.title = 'ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…è¦ï¼‰';
          tag.onclick = function() { unlockExpand(m); };
          ec.appendChild(tag);
        });
      }
      var ac = document.getElementById('applyCompleted');
      if (interlock.applyCompleted.length === 0) {
        ac.innerHTML = '<span style="font-size:11px;color:#999;">ãªã—</span>';
      } else {
        ac.innerHTML = '';
        interlock.applyCompleted.forEach(function(w) {
          var tag = document.createElement('span');
          tag.className = 'completed-tag';
          tag.textContent = w + ' âœ“';
          tag.title = 'ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…è¦ï¼‰';
          tag.onclick = function() { unlockApply(w); };
          ac.appendChild(tag);
        });
      }
    }

    function saveExpandMin() {
      var val = document.getElementById('expandMinMonth').value;
      var pw = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (pw === null) return;
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            interlock.expandMinMonth = val || null;
            updateButtonStates();
            setTimeout(function() { alert('ä¿å­˜ã—ã¾ã—ãŸ'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); })
        .saveInterlockSetting('å±•é–‹åˆ¶é™æœˆ', val, pw);
    }

    function saveApplyMin() {
      var val = document.getElementById('applyMinWeek').value;
      var pw = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (pw === null) return;
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            interlock.applyMinWeek = val || null;
            updateButtonStates();
            setTimeout(function() { alert('ä¿å­˜ã—ã¾ã—ãŸ'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); })
        .saveInterlockSetting('å·®åˆ†åˆ¶é™é€±', val, pw);
    }

    function unlockExpand(month) {
      if (!confirm(month + ' ã®å±•é–‹å®Œäº†ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var pw = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (pw === null) return;
      var newList = interlock.expandCompleted.filter(function(m) { return m !== month; });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            interlock.expandCompleted = newList;
            updateButtonStates();
            renderCompletedTags();
            setTimeout(function() { alert('è§£é™¤ã—ã¾ã—ãŸ'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); })
        .saveInterlockSetting('å±•é–‹å®Œäº†æœˆ', newList.join(','), pw);
    }

    function unlockApply(weekStart) {
      if (!confirm(weekStart + ' ã®å·®åˆ†é©ç”¨å®Œäº†ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var pw = prompt('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      if (pw === null) return;
      var newList = interlock.applyCompleted.filter(function(w) { return w !== weekStart; });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            interlock.applyCompleted = newList;
            updateButtonStates();
            renderCompletedTags();
            setTimeout(function() { alert('è§£é™¤ã—ã¾ã—ãŸ'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('ã‚¨ãƒ©ãƒ¼: ' + e.message); })
        .saveInterlockSetting('å·®åˆ†å®Œäº†é€±', newList.join(','), pw);
    }

    // ==========================================
    // UIæ“ä½œ
    // ==========================================
    function showLoading(message) {
      document.getElementById("loading").className = "loading show";
      document.getElementById("loadingText").innerText = message || "å‡¦ç†ä¸­...";
      disableAllButtons(true);
    }

    function hideLoading() {
      document.getElementById("loading").className = "loading";
      disableAllButtons(false);
      updateButtonStates();
    }

    function disableAllButtons(disabled) {
      var buttons = document.querySelectorAll("#mainContent button");
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].disabled = disabled;
      }
    }

    function showResult(message, isError) {
      var area = document.getElementById("resultArea");
      area.innerText = message;
      area.style.color = isError ? "#ea4335" : "#333";
    }

    function getSelectedMonth() {
      return document.getElementById("targetMonth").value;
    }

    function getWeekStart() {
      return document.getElementById("weekStart").value;
    }

    // ==========================================
    // ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª
    // ==========================================
    function refreshStatus() {
      google.script.run
        .withSuccessHandler(function(result) {
          var indicator = document.getElementById("statusIndicator");
          var text = document.getElementById("statusText");

          if (result.status === "ready") {
            indicator.className = "status-ready";
            text.innerText = result.message;
          } else if (result.status === "busy") {
            indicator.className = "status-busy";
            text.innerText = result.message;
          } else {
            indicator.className = "status-error";
            text.innerText = result.message;
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById("statusIndicator").className = "status-error";
          document.getElementById("statusText").innerText = "ã‚¨ãƒ©ãƒ¼: " + error.message;
        })
        .checkServerStatus();
    }

    // ==========================================
    // æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆ1ç•ªç›®ï¼‰
    // ==========================================
    function onTestClick() {
      showLoading("æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...");
      showResult("ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™...");

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showResult(result.message, !result.success);
          refreshStatus();
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showResult("ã‚¨ãƒ©ãƒ¼: " + error.message, true);
          refreshStatus();
        })
        .runConnectionTest();
    }

    // ==========================================
    // æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹ï¼ˆ2ç•ªç›®ï¼‰
    // ==========================================
    function onExpandClick() {
      var month = getSelectedMonth();
      var check = checkExpandAllowed(month);
      if (!check.allowed) { alert('ğŸ”’ ' + check.reason); return; }
      if (!confirm("æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å±•é–‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ‰€è¦æ™‚é–“: ç´„2ã€œ5åˆ†ï¼‰")) return;

      showLoading("æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹ä¸­...\nï¼ˆ61ååˆ†ã€ç´„2ã€œ5åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰");
      showResult("å‡¦ç†é–‹å§‹...");

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showResult(result.message, !result.success);
          refreshStatus();
          if (result.success) {
            google.script.run.withSuccessHandler(function() {
              interlock.expandCompleted.push(month);
              updateButtonStates();
              renderCompletedTags();
            }).markExpandCompleted(month);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showResult("ã‚¨ãƒ©ãƒ¼: " + error.message, true);
          refreshStatus();
        })
        .runExpand(month);
    }

    // ==========================================
    // CSVå‡ºåŠ›ï¼ˆ3ç•ªç›®ï¼‰
    // ==========================================
    function onExportClick() {
      if (!confirm("CSVã‚’å‡ºåŠ›ã—ã¦Google Driveã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return;

      showLoading("CSVå‡ºåŠ›ä¸­...");
      showResult("å‡¦ç†é–‹å§‹...");

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showResult(result.message, !result.success);
          refreshStatus();
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showResult("ã‚¨ãƒ©ãƒ¼: " + error.message, true);
          refreshStatus();
        })
        .runExport(getSelectedMonth());
    }

    // ==========================================
    // å·®åˆ†ç¢ºèªï¼ˆ4ç•ªç›®ï¼‰
    // ==========================================
    function onDiffClick() {
      var weekStart = getWeekStart();
      if (!weekStart) { alert("å¯¾è±¡é€±ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      showLoading("å·®åˆ†ç¢ºèªä¸­...");
      showResult("å‡¦ç†é–‹å§‹...");

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showResult(result.message, !result.success);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showResult("ã‚¨ãƒ©ãƒ¼: " + error.message, true);
        })
        .checkDiff(getSelectedMonth(), weekStart);
    }

    // ==========================================
    // å·®åˆ†é©ç”¨ï¼ˆ5ç•ªç›®ï¼‰
    // ==========================================
    function onApplyClick() {
      var weekStart = getWeekStart();
      if (!weekStart) { alert("å¯¾è±¡é€±ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      var check = checkApplyAllowed(weekStart);
      if (!check.allowed) { alert('ğŸ”’ ' + check.reason); return; }
      if (!confirm("å·®åˆ†ã‚’ã‚«ã‚¤ãƒã‚±ã«é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“")) return;

      showLoading("å·®åˆ†é©ç”¨ä¸­...");
      showResult("å‡¦ç†é–‹å§‹...");

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          showResult(result.message, !result.success);
          refreshStatus();
          if (result.success) {
            google.script.run.withSuccessHandler(function() {
              interlock.applyCompleted.push(weekStart);
              updateButtonStates();
              renderCompletedTags();
            }).markApplyCompleted(weekStart);

            // é©ç”¨å¾Œæ¤œè¨¼ã®ææ¡ˆ
            if (confirm('å·®åˆ†é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nã‚«ã‚¤ãƒã‚±ã‹ã‚‰CSVã‚’å†å‡ºåŠ›ã—ã¦ã€é©ç”¨çµæœã‚’æ¤œè¨¼ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ¤œè¨¼ã«ã¯CSVå†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã®ãŸã‚æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰')) {
              showLoading('é©ç”¨å¾Œæ¤œè¨¼ä¸­ï¼ˆCSVå†å‡ºåŠ› + ç…§åˆï¼‰...');
              showResult('ã‚«ã‚¤ãƒã‚±ã‹ã‚‰CSVã‚’å†å‡ºåŠ›ã—ã¦ã„ã¾ã™...');
              google.script.run
                .withSuccessHandler(function(vResult) {
                  hideLoading();
                  showResult(vResult.message, !vResult.success);
                })
                .withFailureHandler(function(vError) {
                  hideLoading();
                  showResult('æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + vError.message, true);
                })
                .runPostApplyVerification(getSelectedMonth());
            }
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showResult("ã‚¨ãƒ©ãƒ¼: " + error.message, true);
          refreshStatus();
        })
        .runApply(getSelectedMonth(), weekStart);
    }
  </script>
</body>
</html>
