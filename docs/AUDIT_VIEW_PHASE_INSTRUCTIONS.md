# 監査（合否判定）ビュー：段階別 設計指示（Phase 1〜3）

前提：既存の週間生成・割当ロジックには手を入れない。
監査機能は「追加のGASコード（別ファイル）」＋「既存Webアプリに画面追加」で実装する。

---

## 全体ゴール（再掲）

- 週ビュー（割当結果）を起点に、セル（スタッフ×日）内の患者ごとに **○/△/×** を付与する
- 患者名クリックで「その患者の1週間分の根拠＋差分＋判定」を表示する
- 判定根拠は、以下を患者IDで拾って提示する
  1. 患者マスタ（希望曜日／希望時間帯／時間タイプ）
  2. 患者個別変更（追加／キャンセル／時間変更）
  3. 患者紐づきイベント（衝突判定用）
  4. 特別訪問週間（ADD/REPLACE期待）
  5. 実績＝割当結果（Actual）

---

# Phase 1：データ取り込み＋最小UI（"見える化"最優先）

**目的**：まず「監査タブで、週セル→患者一覧→患者詳細」が動く状態を作る（判定は暫定でもOK）。

## 1-1. 追加するGASファイル（例）

- `audit_service.gs`（サーバー側API）
- `audit_repo.gs`（シート読込・正規化）
- `audit_types.gs`（キー定義・ユーティリティ）

※既存ファイルは触らない。必要なら"参照するだけ"。

## 1-2. 最小API（3本だけで良い）

### 1) `audit_getWeekSummary(weekStartStr)`
- 入力：`weekStartStr`（yyyy/MM/dd）
- 出力：`cellSummary`（sdKey=staff|date → 患者配列）と、最低限のpatientSummary（集計）

### 2) `audit_getCellDetail(staffId, dateStr)`
- 入力：staffId, dateStr
- 出力：そのセルに入っている患者の一覧（status/tags/detailKey）

### 3) `audit_getPatientDetail(pid, weekStartStr)`
- 入力：pid, weekStartStr
- 出力：master/change/special/event/actual/dayJudgements（最小DTOでもOK）

## 1-3. 取り込み対象シート（Phase1で読む）

| 用途 | シート名 |
|------|----------|
| 実績 | `割当結果` |
| マスタ | `患者マスタ` |
| 個別変更 | `個別変更リクエスト` |
| イベント | `イベントリクエスト`（患者紐づきのみ） |
| 特別訪問週間 | ヘッダー＆明細（既存のシート名に合わせる） |

※"見つからないシートは空扱い"で落ちないようにする。

## 1-4. 正規化（minutes化）ルール（必須）

- 監査内部は minutes（0〜1440）に統一
- Date / serial / "HH:mm" を必ず `parseTimeToMinutes()` で揃える
- dateStr は `yyyy/MM/dd` に統一（pid|date, staff|date でMap化）

## 1-5. 判定ロジック（Phase1は"暫定版"でOK）

- まずは下記だけで○/×を付ける
  - Actualがある → OK（仮）
  - Actualがない（未割当含む）→ NG（仮）
- タグも最小：
  - `HAS_ACTUAL` / `NO_ACTUAL`
- ここで「UIが動く」「セルクリックで一覧が出る」「患者詳細が開く」を最優先

## 1-6. UI（最小）

- 既存Webアプリのタブに **「監査」** を追加
- 監査画面には最低限これだけ：
  - 週開始日 DatePicker + 更新ボタン
  - 週ビュー表（スタッフ×日）
  - セルクリックで患者一覧
  - 患者クリックで詳細モーダル/右ペイン

### 成果物（Phase1完了の定義）

- [ ] 監査タブが開ける
- [ ] 任意の週を選ぶと、週ビューのセルに患者が出る
- [ ] 患者詳細で master/actual が表示される（判定は暫定で良い）

---

# Phase 2：期待（Expected）構築＋○/△/× 判定（監査の中核）

**目的**：期待と実績の差分を正しく出し、根拠タグを付ける（運用に耐える）。

## 2-1. Expected生成（優先順位を固定）

同一 patient/day の期待を作る優先順位：

1. **特別訪問週間 REPLACE**（通常期待を置換）
2. **個別変更**（キャンセル／時間変更：同日最新1件）
3. **通常**（患者マスタ）
4. **特別訪問週間 ADD**（通常に"追加期待"を積む）

※同日に期待枠が複数あり得る（通常＋追加など）

## 2-2. 個別変更の"効いてるか検証"を監査で可視化

- 期待ソースに `source: MASTER|CHANGE|SPECIAL_ADD|SPECIAL_REPLACE` を必ず入れる
- 患者詳細に「この日の期待はどのソースで決まったか」を表示する
- 例：`2026/01/15 期待=CHANGE(追加)` のように

## 2-3. 判定ルール（本番版）

- バッファ：`AUDIT_TIME_BUFFER_MIN=15`
- timeType別に判定：
  - **固定**：開始/終了が期待と一致（±バッファ）でOK/WARN、超過でNG
  - **時間帯**：actual start/end が earliest/latest 内ならOK、±バッファ内WARN、それ以上NG
  - **午前/午後/終日**：既定の範囲内で同様判定
- **キャンセル**：
  - 期待がキャンセルなのに実績がある → NG（CANCELLED_BUT_VISITED）
- **追加**：
  - 期待が追加なのに実績が無い → WARN（運用によりNGでも可。初期はWARN推奨）

## 2-4. イベント（患者紐づき）衝突判定

- 同日でイベント区間と actual の区間が重なる → NG（EVENT_CONFLICT）
- 患者詳細に「イベント時間」と「実績時間」を並べて根拠表示

## 2-5. 週ビュー集計表示（UI強化）

- セルに ○/△/× 件数（例：○2 △1 ×0）
- 一覧行に tags を短く（TIME_DIFF(+10m) など）
- patientSummary（患者一覧の上部に "今週NGがある患者" を抽出しても良い）

### 成果物（Phase2完了の定義）

- [ ] 患者詳細で「期待（Expected）」「実績（Actual）」「根拠（master/change/special/event）」が出る
- [ ] ○/△/× の判定が意図通り
- [ ] "個別変更が効いてない/効いてる" が画面で説明できる

---

# Phase 3：運用向け（高速化・説明力・保守性）

**目的**：使い続けられる品質にする（速度/キャッシュ/エラー耐性/UX）。

## 3-1. キャッシュ（必須）

- datasetCacheKey = `auditDataset|YYYYMMDD`（週開始）
- TTL：15分
- 週サマリの生成が重い場合は、GAS CacheService + 断片キャッシュ（patientDetail別）も検討

## 3-2. 例外・欠損の扱い（落ちない）

- シートが無い／列名が違う → "空"として扱い、画面に警告（fatalにしない）
- 時刻がパースできない → tags に `TIME_PARSE_ERROR` を出し、判定はWARN/NGで落とす
- pid が空の行は無視（EV行など）

## 3-3. 判定の説明力（クライアント説明向け）

- 患者詳細に「判定理由」を1行要約で出す
  - 例：`午後希望(13:00-17:00)だが実績が08:30開始 → バッファ超過`
- "どこがズレたか" を minutes差分で明示（+/-）

## 3-4. UI改善（任意）

- 週ビューのセル内患者一覧にフィルタ（OK非表示、NGのみ表示）
- NG/WARNの理由別に集計（イベント衝突が何件、時間ズレが何件）

## 3-5. テストデータと検証手順をMDに追記

- テスト患者1名（例：青木花子）
- 個別変更：追加／キャンセル／時間変更を同週に置いたケース
- イベント衝突ケース
- 特別訪問週間 REPLACE/ADDケース
- 期待→実績→判定結果が画面で説明できること

### 成果物（Phase3完了の定義）

- [ ] 週サマリがストレスなく表示される
- [ ] 欠損や表記ゆれで落ちない
- [ ] クライアントに画面で説明できる（根拠が揃っている）

---

# 実装順（コーディングエージェント向けの迷わない進め方）

1. **Phase1**：API→UI接続まで通す（判定は仮でも可）
2. **Phase2**：Expected生成→○/△/× 完成（この時点で運用できる）
3. **Phase3**：高速化・UX・エラー耐性・説明力を上げる

---

# 受け入れ基準（最低限のチェック項目）

- [ ] 監査タブが他タブと同様に切り替えできる
- [ ] 週開始を変えると表示が変わる
- [ ] セルクリック→患者一覧が出る
- [ ] 患者クリック→詳細に master/change/special/event/actual が表示される
- [ ] "個別変更が効いてない" 場合は、その理由（ヘッダー差/日付パース/週範囲外/同日latest判定など）が tags/理由に出る
