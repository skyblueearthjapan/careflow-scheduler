<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    /* ============================================================
       ã‚ˆã‚Šã‚ˆã‚Šãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼
       - ã‚°ãƒªãƒ¼ãƒ³ï¼ˆã‚„ã•ã—ã•ï¼‰: #B7D38A
       - ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆã‚ãŸãŸã‹ã•ï¼‰: #F6B26B
       - ã‚¤ã‚¨ãƒ­ãƒ¼ï¼ˆå¸Œæœ›ï¼‰: #F9E0A6
       - ãƒ–ãƒ«ãƒ¼ï¼ˆä¿¡é ¼ãƒ»åŒ»ç™‚ï¼‰: #7DA7D9
       - æ–‡å­—è‰²: #333333
       ============================================================ */

    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
    }

    /* ============================================================
       åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
       ============================================================ */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }

    /* ============================================================
       ãƒ˜ãƒƒãƒ€ãƒ¼
       ============================================================ */
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .header-status {
      font-size: 12px;
      opacity: 0.95;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* ============================================================
       ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆ3æ®µæ§‹æˆã®æº–å‚™ï¼‰
       ============================================================ */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ä¸Šéƒ¨ï¼šGPTãƒãƒ£ãƒƒãƒˆæ¬„ï¼ˆç¬¬2æ®µéšã§æœ‰åŠ¹åŒ–ï¼‰ */
    .chat-area {
      display: none; /* ç¬¬2æ®µéšã§æœ‰åŠ¹åŒ– */
      height: 200px;
      border-bottom: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 10px;
    }

    /* ä¸­å¤®ï¼šé€±ãƒ“ãƒ¥ãƒ¼ + ãƒœã‚¿ãƒ³ç¾¤ */
    .content-area {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ä¸‹éƒ¨ï¼šã‚¿ãƒ–ï¼ˆç¬¬2æ®µéšã§æœ‰åŠ¹åŒ–ï¼‰ */
    .tab-area {
      display: none; /* ç¬¬2æ®µéšã§æœ‰åŠ¹åŒ– */
      height: 40px;
      border-top: 1px solid var(--color-border);
      background: var(--color-white);
    }

    /* ============================================================
       å·¦å´ï¼šé€±ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢
       ============================================================ */
    .left-panel {
      flex: 1;
      padding: 16px;
      overflow: auto;
      background: var(--color-white);
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--color-yellow-light);
      border-radius: 8px;
      border: 1px solid var(--color-yellow);
      font-size: 13px;
    }

    .status-text {
      color: var(--color-text-light);
    }

    .status-text.loading {
      color: var(--color-blue-dark);
    }

    .status-text.error {
      color: var(--color-error);
    }

    .status-text.success {
      color: var(--color-green-dark);
    }

    .refresh-btn {
      padding: 6px 14px;
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .refresh-btn:hover {
      background: var(--color-green-dark);
    }

    .refresh-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ============================================================
       é€±ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
       ============================================================ */
    .week-table-container {
      overflow: auto;
      max-height: calc(100vh - 200px);
      border-radius: 8px;
      border: 1px solid var(--color-green-light);
    }

    #weekTable {
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
      font-size: 13px;
    }

    #weekTable th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      padding: 12px 10px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--color-blue-dark);
      z-index: 10;
    }

    #weekTable th:first-child {
      left: 0;
      z-index: 20;
      min-width: 160px;
      text-align: left;
      background: var(--color-green);
      border-color: var(--color-green-dark);
    }

    #weekTable td {
      border: 1px solid var(--color-green-light);
      padding: 8px 10px;
      vertical-align: top;
      background: var(--color-white);
    }

    #weekTable td:first-child {
      position: sticky;
      left: 0;
      background: var(--color-yellow-light);
      font-weight: 600;
      min-width: 160px;
      z-index: 5;
      border-left: 3px solid var(--color-green);
    }

    #weekTable tr:nth-child(even) td {
      background: #FDFDFB;
    }

    #weekTable tr:nth-child(even) td:first-child {
      background: #FDF8E8;
    }

    #weekTable tr:hover td {
      background: var(--color-blue-light);
    }

    #weekTable tr:hover td:first-child {
      background: var(--color-yellow);
    }

    .cell-content {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 12px;
      max-height: 120px;
      overflow-y: auto;
    }

    .cell-empty {
      color: #ccc;
      font-style: italic;
    }

    /* ============================================================
       å³å´ï¼šãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ«
       ============================================================ */
    .right-panel {
      width: 270px;
      border-left: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
    }

    .button-group {
      margin-bottom: 20px;
    }

    .button-group-title {
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      padding-left: 2px;
    }

    .action-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .action-btn.primary {
      background: var(--color-orange);
      color: var(--color-white);
      box-shadow: 0 2px 4px rgba(246, 178, 107, 0.3);
    }

    .action-btn.primary:hover:not(:disabled) {
      background: var(--color-orange-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(246, 178, 107, 0.4);
    }

    .action-btn.secondary {
      background: var(--color-yellow-light);
      color: var(--color-text);
      border: 1px solid var(--color-yellow);
    }

    .action-btn.secondary:hover:not(:disabled) {
      background: var(--color-yellow);
      border-color: var(--color-orange-light);
    }

    .action-btn .icon {
      font-size: 16px;
    }

    .action-btn .spinner {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .action-btn.loading .spinner {
      display: inline-block;
    }

    .action-btn.loading .icon {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============================================================
       å®Ÿè¡Œãƒ­ã‚°
       ============================================================ */
    .log-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .log-title {
      font-size: 12px;
      color: var(--color-text-light);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .log-list {
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
    }

    .log-item {
      padding: 8px 10px;
      margin-bottom: 6px;
      background: var(--color-yellow-light);
      border-radius: 6px;
      border-left: 3px solid var(--color-green);
    }

    .log-item.error {
      border-left-color: var(--color-error);
      background: #FFF5F5;
    }

    .log-item-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .log-item-action {
      font-weight: 600;
      color: var(--color-text);
    }

    .log-item-time {
      color: var(--color-text-light);
    }

    .log-item-message {
      color: var(--color-text-light);
      line-height: 1.4;
    }

    /* ============================================================
       è¨­å®šã‚¨ãƒ©ãƒ¼è¡¨ç¤º
       ============================================================ */
    .config-error {
      background: var(--color-orange-light);
      border: 1px solid var(--color-orange);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .config-error h3 {
      margin: 0 0 8px;
      color: var(--color-orange-dark);
      font-size: 14px;
    }

    .config-error ul {
      margin: 0;
      padding-left: 20px;
      color: var(--color-text);
    }

    /* ============================================================
       ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–
       ============================================================ */
    @media (max-width: 768px) {
      .content-area {
        flex-direction: column;
      }

      .right-panel {
        width: 100%;
        border-left: none;
        border-top: 1px solid var(--color-border);
        max-height: 300px;
      }
    }

    /* ============================================================
       ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼ï¼ˆç¬¬1.5æ®µéšï¼‰
       ============================================================ */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-top: 1px solid var(--color-green-light);
      background: var(--color-white);
      flex-shrink: 0;
    }

    .tabs-left {
      display: flex;
      gap: 6px;
    }

    .input-app-link {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--color-orange);
      background: var(--color-orange-light);
      border-radius: 8px;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }

    .input-app-link:hover {
      background: var(--color-orange);
      color: var(--color-white);
    }

    .input-app-link.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .input-app-link .icon {
      font-size: 14px;
    }

    .tabs-right {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .tab-btn {
      border: 1px solid var(--color-green-light);
      background: var(--color-white);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text);
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      background: var(--color-green-light);
      border-color: var(--color-green);
    }

    .tab-btn.active {
      background: var(--color-green);
      border-color: var(--color-green);
      color: var(--color-white);
    }

    /* ============================================================
       æ±ç”¨ã‚·ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆç¬¬1.5æ®µéšï¼‰
       ============================================================ */
    .sheet-table-wrap {
      overflow: auto;
      max-height: calc(100vh - 220px);
      border: 1px solid var(--color-green-light);
      border-radius: 8px;
    }

    .sheet-table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    .sheet-table th,
    .sheet-table td {
      border: 1px solid var(--color-border);
      padding: 8px 10px;
      white-space: nowrap;
    }

    .sheet-table thead th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      font-weight: 600;
      z-index: 1;
    }

    .sheet-table tbody tr:nth-child(even) {
      background: #FDFDFB;
    }

    .sheet-table tbody tr:hover {
      background: var(--color-blue-light);
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é ˜åŸŸï¼ˆã‚¿ãƒ–åˆ‡æ›¿ç”¨ï¼‰ */
    #mainContent {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <h1>è¨ªå•çœ‹è­· è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</h1>
    <span class="header-status" id="headerStatus">é€±ãƒ“ãƒ¥ãƒ¼ + GASå®Ÿè¡Œ</span>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-container">
    <!-- ä¸Šéƒ¨ï¼šGPTãƒãƒ£ãƒƒãƒˆæ¬„ï¼ˆç¬¬2æ®µéšç”¨ã®æ ï¼‰ -->
    <div class="chat-area" id="chatArea">
      <!-- ç¬¬2æ®µéšã§å®Ÿè£… -->
    </div>

    <!-- ä¸­å¤®ï¼šé€±ãƒ“ãƒ¥ãƒ¼ + ãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="content-area">
      <!-- å·¦å´ï¼šé€±ãƒ“ãƒ¥ãƒ¼ -->
      <div class="left-panel">
        <div class="status-bar">
          <span class="status-text" id="statusText">èª­ã¿è¾¼ã¿ä¸­...</span>
          <button class="refresh-btn" id="refreshBtn" onclick="loadWeekView()">æ›´æ–°</button>
        </div>

        <div id="configError" class="config-error" style="display: none;">
          <h3>è¨­å®šã‚¨ãƒ©ãƒ¼</h3>
          <ul id="configErrorList"></ul>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆã‚¿ãƒ–åˆ‡æ›¿å¯¾è±¡ï¼‰ -->
        <div id="mainContent">
          <div class="week-table-container">
            <table id="weekTable"></table>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ« -->
      <div class="right-panel">
        <div class="panel-title">GASå®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆç³» -->
        <div class="button-group">
          <div class="button-group-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ</div>
          <button class="action-btn primary" onclick="runAction('runGenerateWeeklyRequests', this)">
            <span class="icon">ğŸ“‹</span>
            <span class="spinner"></span>
            é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆ
          </button>
          <button class="action-btn primary" onclick="runAction('runCreateAssignments', this)">
            <span class="icon">ğŸ“…</span>
            <span class="spinner"></span>
            å‰²å½“çµæœã‚’ä½œæˆ
          </button>
        </div>

        <!-- æ›´æ–°ç³» -->
        <div class="button-group">
          <div class="button-group-title">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</div>
          <button class="action-btn secondary" onclick="runAction('runUpdateWeekView', this)">
            <span class="icon">ğŸ”„</span>
            <span class="spinner"></span>
            é€±ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
          </button>
          <button class="action-btn secondary" onclick="runAction('runCreateRouteSummary', this)">
            <span class="icon">ğŸ—ºï¸</span>
            <span class="spinner"></span>
            ãƒ«ãƒ¼ãƒˆã‚µãƒãƒªã‚’ä½œæˆ
          </button>
          <button class="action-btn secondary" onclick="runAction('runUpdateLocation', this)">
            <span class="icon">ğŸ“</span>
            <span class="spinner"></span>
            ä½ç½®æƒ…å ±ã‚’æ›´æ–°
          </button>
        </div>

        <!-- å®Ÿè¡Œãƒ­ã‚° -->
        <div class="log-section">
          <div class="log-title">
            <span>æœ€è¿‘ã®å®Ÿè¡Œãƒ­ã‚°</span>
            <button class="refresh-btn" onclick="loadLogs()" style="padding: 4px 10px; font-size: 11px;">æ›´æ–°</button>
          </div>
          <div class="log-list" id="logList">
            <div style="color: #888; font-style: italic;">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸‹éƒ¨ï¼šã‚¿ãƒ–ãƒãƒ¼ï¼ˆç¬¬1.5æ®µéšï¼‰ -->
    <div class="bottom-bar">
      <div class="tabs-left">
        <!-- å…¥åŠ›ç®¡ç†ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ -->
        <a id="inputAppLink" class="input-app-link disabled" href="#" target="_blank">
          <span class="icon">ğŸ“</span>
          å…¥åŠ›ç®¡ç†ç”»é¢ã¸
        </a>
      </div>

      <div class="tabs-right">
        <button class="tab-btn active" onclick="showWeekView(this)">é€±ãƒ“ãƒ¥ãƒ¼</button>
        <button class="tab-btn" onclick="showSheet('é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', this)">é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
        <button class="tab-btn" onclick="showSheet('å‰²å½“çµæœ', this)">å‰²å½“çµæœ</button>
        <button class="tab-btn" onclick="showSheet('å‰²å½“ä¸å¯', this)">å‰²å½“ä¸å¯</button>
        <button class="tab-btn" onclick="showSheet('ãƒ«ãƒ¼ãƒˆã‚µãƒãƒª', this)">ãƒ«ãƒ¼ãƒˆã‚µãƒãƒª</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // åˆæœŸåŒ–
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      checkConfig();
      loadWeekView();
      loadLogs();
      loadAppLinks();
    });

    // ============================================================
    // è¨­å®šãƒã‚§ãƒƒã‚¯
    // ============================================================
    function checkConfig() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            showConfigError(result.issues);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Config check failed:', error);
        })
        .checkConfiguration();
    }

    function showConfigError(issues) {
      const errorDiv = document.getElementById('configError');
      const errorList = document.getElementById('configErrorList');

      errorList.innerHTML = issues.map(function(issue) {
        return '<li>' + escapeHtml(issue) + '</li>';
      }).join('');

      errorDiv.style.display = 'block';
    }

    // ============================================================
    // é€±ãƒ“ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
    // ============================================================
    function loadWeekView() {
      setStatus('loading', 'é€±ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ä¸­...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(renderWeekView)
        .withFailureHandler(function(error) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getWeekView();
    }

    function renderWeekView(data) {
      document.getElementById('refreshBtn').disabled = false;

      if (!data.success) {
        setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + data.error);
        return;
      }

      const table = document.getElementById('weekTable');
      table.innerHTML = '';

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      data.header.forEach(function(h, i) {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      // ãƒ‡ãƒ¼ã‚¿è¡Œ
      const tbody = document.createElement('tbody');

      data.rows.forEach(function(row) {
        const tr = document.createElement('tr');

        // è·å“¡å
        const tdStaff = document.createElement('td');
        tdStaff.textContent = row.staff;
        tr.appendChild(tdStaff);

        // å„æ—¥ã®ã‚»ãƒ«
        row.cells.forEach(function(cell) {
          const td = document.createElement('td');
          const content = (cell || '').toString().trim();

          if (content) {
            const div = document.createElement('div');
            div.className = 'cell-content';
            div.textContent = content;
            td.appendChild(div);
          } else {
            td.innerHTML = '<span class="cell-empty">-</span>';
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);

      setStatus('success', 'è¡¨ç¤ºå®Œäº†ï¼ˆã‚¹ã‚¿ãƒƒãƒ• ' + data.rows.length + 'åï¼‰');
    }

    function setStatus(type, message) {
      const statusText = document.getElementById('statusText');
      statusText.className = 'status-text ' + type;
      statusText.textContent = message;
    }

    // ============================================================
    // GASã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    // ============================================================
    function runAction(functionName, button) {
      // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
      button.classList.add('loading');
      button.disabled = true;

      // å…¨ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const allButtons = document.querySelectorAll('.action-btn');
      allButtons.forEach(function(btn) {
        btn.disabled = true;
      });

      google.script.run
        .withSuccessHandler(function(result) {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          button.classList.remove('loading');
          allButtons.forEach(function(btn) {
            btn.disabled = false;
          });

          if (result.success) {
            showNotification('success', result.message);
            // é€±ãƒ“ãƒ¥ãƒ¼é–¢é€£ã®å‡¦ç†ãªã‚‰å†èª­ã¿è¾¼ã¿
            if (functionName.includes('WeekView') || functionName.includes('Assignments')) {
              loadWeekView();
            }
          } else {
            showNotification('error', result.error);
          }

          // ãƒ­ã‚°ã‚’æ›´æ–°
          loadLogs();
        })
        .withFailureHandler(function(error) {
          button.classList.remove('loading');
          allButtons.forEach(function(btn) {
            btn.disabled = false;
          });
          showNotification('error', error.message);
          loadLogs();
        })
        [functionName]();
    }

    function showNotification(type, message) {
      // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå°†æ¥çš„ã«ã¯ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã«å¤‰æ›´å¯èƒ½ï¼‰
      if (type === 'success') {
        alert('âœ“ ' + message);
      } else {
        alert('âœ— ã‚¨ãƒ©ãƒ¼: ' + message);
      }
    }

    // ============================================================
    // å®Ÿè¡Œãƒ­ã‚°
    // ============================================================
    function loadLogs() {
      google.script.run
        .withSuccessHandler(renderLogs)
        .withFailureHandler(function(error) {
          document.getElementById('logList').innerHTML =
            '<div style="color: #E88B8B;">ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .getExecutionLogs(5);
    }

    function renderLogs(data) {
      const logList = document.getElementById('logList');

      if (!data.success || !data.logs || data.logs.length === 0) {
        logList.innerHTML = '<div style="color: #888; font-style: italic;">å®Ÿè¡Œãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      logList.innerHTML = data.logs.map(function(log) {
        const time = formatLogTime(log.timestamp);
        const itemClass = log.success ? '' : ' error';

        return '<div class="log-item' + itemClass + '">' +
          '<div class="log-item-header">' +
            '<span class="log-item-action">' + escapeHtml(log.action) + '</span>' +
            '<span class="log-item-time">' + time + '</span>' +
          '</div>' +
          '<div class="log-item-message">' + escapeHtml(log.message) + '</div>' +
        '</div>';
      }).join('');
    }

    function formatLogTime(timestamp) {
      if (!timestamp) return '-';
      try {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return String(timestamp).substring(11, 16);
      }
    }

    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================================
    // ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆç¬¬1.5æ®µéšï¼‰
    // ============================================================
    const SHEET_OPTS = {
      'é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ': { filterThisWeek: true, dateColName: 'æ—¥ä»˜', limit: 500 },
      'å‰²å½“çµæœ':       { filterThisWeek: true, dateColName: 'æ—¥ä»˜', limit: 800 },
      'å‰²å½“ä¸å¯':       { filterThisWeek: true, dateColName: 'æ—¥ä»˜', limit: 500 },
      'ãƒ«ãƒ¼ãƒˆã‚µãƒãƒª':   { filterThisWeek: true, dateColName: 'æ—¥ä»˜', limit: 500 }
    };

    let currentView = 'weekView'; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ãƒ“ãƒ¥ãƒ¼

    function setActiveTab(btn) {
      document.querySelectorAll('.tabs-right .tab-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');
    }

    function showWeekView(btn) {
      setActiveTab(btn);
      currentView = 'weekView';

      // é€±ãƒ“ãƒ¥ãƒ¼ã®HTMLã‚’å¾©å…ƒ
      document.getElementById('mainContent').innerHTML =
        '<div class="week-table-container"><table id="weekTable"></table></div>';

      // é€±ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿
      loadWeekView();
    }

    function showSheet(sheetName, btn) {
      setActiveTab(btn);
      currentView = sheetName;

      const opt = SHEET_OPTS[sheetName] || { limit: 300 };
      setStatus('loading', sheetName + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...');

      google.script.run
        .withSuccessHandler(function(data) {
          renderSheetTable(sheetName, data);
        })
        .withFailureHandler(function(e) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .getSheetTable(sheetName, opt);
    }

    function renderSheetTable(title, data) {
      if (!data.headers || data.headers.length === 0) {
        setStatus('error', title + ' ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('mainContent').innerHTML =
          '<div style="padding: 20px; text-align: center; color: #888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      setStatus('success', title + 'ï¼ˆ' + data.rowCount + 'è¡Œï¼‰');

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ç”Ÿæˆ
      const headerHtml = data.headers.map(function(h) {
        return '<th>' + escapeHtml(String(h)) + '</th>';
      }).join('');

      // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ç”Ÿæˆ
      const rowsHtml = data.rows.map(function(row) {
        const cells = row.map(function(cell) {
          return '<td>' + escapeHtml(formatCell(cell)) + '</td>';
        }).join('');
        return '<tr>' + cells + '</tr>';
      }).join('');

      const tableHtml =
        '<div class="sheet-table-wrap">' +
          '<table class="sheet-table">' +
            '<thead><tr>' + headerHtml + '</tr></thead>' +
            '<tbody>' + rowsHtml + '</tbody>' +
          '</table>' +
        '</div>';

      document.getElementById('mainContent').innerHTML = tableHtml;
    }

    function formatCell(cell) {
      if (cell === null || cell === undefined) return '';

      // Dateå‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆGASã‹ã‚‰æ¸¡ã•ã‚ŒãŸå ´åˆï¼‰
      if (cell && typeof cell === 'object' && cell._type === 'date') {
        try {
          const d = new Date(cell.value);
          return d.toLocaleDateString('ja-JP');
        } catch (e) {
          return String(cell.value);
        }
      }

      return String(cell);
    }

    // ============================================================
    // å…¥åŠ›ç®¡ç†ç”»é¢ãƒªãƒ³ã‚¯
    // ============================================================
    function loadAppLinks() {
      google.script.run
        .withSuccessHandler(function(data) {
          if (data && data.hasInputApp && data.inputAppUrl) {
            const link = document.getElementById('inputAppLink');
            link.href = data.inputAppUrl;
            link.classList.remove('disabled');
          }
        })
        .withFailureHandler(function(error) {
          console.log('App links not configured:', error);
        })
        .getAppLinks();
    }
  </script>

</body>
</html>
