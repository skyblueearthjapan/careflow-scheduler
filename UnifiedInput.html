<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
      --color-disabled: #CCCCCC;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-badge { font-size: 11px; background: var(--color-orange); padding: 4px 10px; border-radius: 12px; font-weight: 500; }
    .header-status { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; }
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .left-panel { flex: 1; padding: 16px; overflow: auto; background: var(--color-white); display: flex; flex-direction: column; }
    .status-bar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px; padding: 10px 14px;
      background: var(--color-yellow-light); border-radius: 8px; border: 1px solid var(--color-yellow); font-size: 13px;
    }
    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }
    .refresh-btn {
      padding: 6px 14px; background: var(--color-green); color: var(--color-white);
      border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: var(--color-disabled); cursor: not-allowed; }
    #mainContent { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .table-container { flex: 1; overflow: auto; border: 1px solid var(--color-green-light); border-radius: 8px; }
    .data-table { border-collapse: collapse; width: max-content; min-width: 100%; font-size: 12px; }
    .data-table th {
      position: sticky; top: 0; background: var(--color-blue); color: var(--color-white);
      padding: 10px 12px; text-align: left; font-weight: 600;
      border: 1px solid var(--color-blue-dark); white-space: nowrap; z-index: 10;
    }
    .data-table td {
      border: 1px solid var(--color-border); padding: 8px 12px;
      background: var(--color-white); white-space: nowrap; cursor: pointer;
    }
    .data-table tbody tr:nth-child(even) td { background: #FDFDFB; }
    .data-table tbody tr:hover td { background: var(--color-blue-light); }
    /* Row Handle */
    .row-handle {
      width: 30px; text-align: center; cursor: grab; color: var(--color-disabled);
      user-select: none; font-size: 14px;
    }
    .row-handle:hover { color: var(--color-text); }
    /* è¡Œé¸æŠçŠ¶æ…‹ */
    .data-table tbody tr.row-selected td { background: var(--color-orange-light) !important; border-color: var(--color-orange); }
    .data-table tbody tr.row-selected .row-handle { color: var(--color-orange-dark); font-weight: bold; }
    /* ã‚»ãƒ«é¸æŠçŠ¶æ…‹ */
    .data-table td.cell-focused { outline: 2px solid var(--color-blue); outline-offset: -2px; }
    /* ç·¨é›†ä¸­ã‚»ãƒ« */
    .data-table td.dirty { background: var(--color-yellow) !important; }
    .data-table td.is-new { background: var(--color-green-light) !important; }
    .data-table td.editing { padding: 0; }
    .data-table td.editing input,
    .data-table td.editing select {
      width: 100%; padding: 8px 10px; border: 2px solid var(--color-blue);
      font-size: 12px; font-family: inherit; outline: none;
    }
    /* å³ãƒ‘ãƒãƒ« */
    .right-panel {
      width: 240px; border-left: 1px solid var(--color-border);
      background: var(--color-white); padding: 16px;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .panel-title {
      font-size: 14px; font-weight: 600; margin-bottom: 16px; padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
      display: flex; align-items: center; justify-content: space-between;
    }
    .dirty-badge { font-size: 10px; background: var(--color-orange); color: var(--color-white); padding: 2px 6px; border-radius: 4px; display: none; }
    .dirty-badge.show { display: inline-block; }
    .operation-group { margin-bottom: 20px; }
    .operation-group-title { font-size: 11px; color: var(--color-text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .operation-btn {
      width: 100%; padding: 10px 14px; margin-bottom: 8px;
      border: 1px solid var(--color-border); border-radius: 6px;
      background: var(--color-white); color: var(--color-text);
      font-size: 12px; text-align: left; cursor: pointer;
      display: flex; align-items: center; gap: 8px; transition: all 0.15s ease;
    }
    .operation-btn:hover:not(:disabled) { background: var(--color-green-light); border-color: var(--color-green); }
    .operation-btn:disabled { background: var(--color-bg); color: var(--color-disabled); cursor: not-allowed; }
    .operation-btn .icon { font-size: 14px; }
    .operation-btn.primary { background: var(--color-green); color: var(--color-white); border-color: var(--color-green-dark); }
    .operation-btn.primary:hover:not(:disabled) { background: var(--color-green-dark); }
    .operation-btn.danger:hover:not(:disabled) { background: var(--color-error); color: var(--color-white); border-color: var(--color-error); }
    .info-section { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--color-border); }
    .info-item { font-size: 11px; color: var(--color-text-light); margin-bottom: 6px; display: flex; justify-content: space-between; }
    .info-item .label { color: var(--color-text); }
    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast-container { position: fixed; top: 80px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 12px 20px; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; max-width: 320px; }
    .toast.success { background: var(--color-green); color: var(--color-white); }
    .toast.error { background: var(--color-error); color: var(--color-white); }
    .toast.info { background: var(--color-blue); color: var(--color-white); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    /* ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼ */
    .bottom-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-top: 1px solid var(--color-green-light); background: var(--color-white); }
    .tabs-left { display: flex; gap: 8px; }
    .tab-btn { border: 1px solid var(--color-green-light); background: var(--color-white); padding: 8px 14px; border-radius: 999px; cursor: pointer; font-size: 12px; font-weight: 500; color: var(--color-text); transition: all 0.2s ease; }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active { background: var(--color-green); border-color: var(--color-green); color: var(--color-white); }
    .tabs-right { display: flex; gap: 8px; }
    .nav-link { padding: 8px 16px; font-size: 12px; font-weight: 500; border: 1px solid var(--color-green); background: var(--color-green-light); border-radius: 8px; color: var(--color-text); cursor: pointer; text-decoration: none; transition: all 0.2s ease; }
    .nav-link:hover { background: var(--color-green); color: var(--color-white); }
    /* æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .weekday-editor { display: flex; gap: 4px; flex-wrap: wrap; padding: 4px; }
    .weekday-editor label { display: flex; align-items: center; gap: 2px; font-size: 11px; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
    .weekday-editor label:hover { background: var(--color-blue-light); }
    .weekday-editor input { width: 14px; height: 14px; }
    /* ã‚¹ã‚¿ãƒƒãƒ•è¤‡æ•°é¸æŠ */
    .staff-multi-select { display: flex; flex-direction: column; gap: 2px; padding: 4px; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ccc; border-radius: 4px; min-width: 180px; }
    .staff-multi-select label { display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer; padding: 2px 4px; border-radius: 4px; white-space: nowrap; }
    .staff-multi-select label:hover { background: var(--color-blue-light); }
    .staff-multi-select input { width: 14px; height: 14px; }
    /* æœªä½¿ç”¨åˆ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .unused-column { background: #f5f5f0 !important; color: #888; }
    .unused-mark { color: #e67e22; font-weight: bold; font-size: 10px; vertical-align: super; cursor: help; }
    /* ============================================================
       ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰
       ============================================================ */
    .wizard-panel {
      background: var(--color-white);
      border-bottom: 2px solid var(--color-green);
      padding: 0;
      display: none;
    }
    .wizard-panel.active { display: block; }
    .wizard-header {
      background: linear-gradient(135deg, var(--color-blue-light) 0%, var(--color-blue) 100%);
      color: var(--color-white);
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wizard-header h3 { margin: 0; font-size: 14px; }
    .wizard-close { background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 4px 8px; }
    .wizard-close:hover { background: rgba(255,255,255,0.2); border-radius: 4px; }
    .wizard-body { display: flex; height: 280px; }
    .wizard-chat { flex: 1; padding: 12px; overflow-y: auto; background: #f8f9fa; }
    .wizard-input-area { width: 320px; border-left: 1px solid var(--color-border); padding: 12px; display: flex; flex-direction: column; }
    /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .chat-message { margin-bottom: 12px; display: flex; flex-direction: column; }
    .chat-message.bot { align-items: flex-start; }
    .chat-message.user { align-items: flex-end; }
    .chat-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
    }
    .chat-message.bot .chat-bubble {
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-bottom-left-radius: 4px;
    }
    .chat-message.user .chat-bubble {
      background: var(--color-blue);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .chat-label { font-size: 10px; color: #999; margin-bottom: 4px; }
    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .wizard-question { font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--color-text); }
    .wizard-hint { font-size: 11px; color: #888; margin-bottom: 8px; }
    .wizard-input-container { flex: 1; overflow-y: auto; }
    .wizard-input-container input[type="text"],
    .wizard-input-container input[type="number"],
    .wizard-input-container input[type="date"],
    .wizard-input-container input[type="time"],
    .wizard-input-container textarea,
    .wizard-input-container select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .wizard-input-container textarea { height: 60px; resize: vertical; }
    .wizard-input-container input:focus,
    .wizard-input-container textarea:focus,
    .wizard-input-container select:focus { outline: none; border-color: var(--color-blue); }
    .wizard-checkboxes { display: flex; flex-wrap: wrap; gap: 6px; }
    .wizard-checkboxes label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      padding: 4px 8px;
      background: #f0f0f0;
      border-radius: 4px;
      cursor: pointer;
    }
    .wizard-checkboxes label:hover { background: var(--color-blue-light); }
    .wizard-checkboxes input { width: 14px; height: 14px; }
    .wizard-error { color: var(--color-error); font-size: 11px; margin-top: 4px; }
    /* ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    .wizard-buttons { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border); }
    .wizard-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .wizard-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .wizard-btn.secondary { background: #e0e0e0; color: var(--color-text); }
    .wizard-btn.secondary:hover:not(:disabled) { background: #d0d0d0; }
    .wizard-btn.primary { background: var(--color-blue); color: white; }
    .wizard-btn.primary:hover:not(:disabled) { background: var(--color-blue-dark); }
    .wizard-btn.success { background: var(--color-green); color: white; }
    .wizard-btn.success:hover:not(:disabled) { background: var(--color-green-dark); }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
    .wizard-preview { background: #fff; border: 1px solid var(--color-border); border-radius: 6px; padding: 8px; margin-bottom: 8px; max-height: 150px; overflow-y: auto; }
    .wizard-preview table { width: 100%; font-size: 11px; border-collapse: collapse; }
    .wizard-preview th, .wizard-preview td { padding: 4px 6px; text-align: left; border-bottom: 1px solid #eee; }
    .wizard-preview th { background: #f5f5f5; font-weight: 600; }
    /* é–‹å§‹ãƒœã‚¿ãƒ³ */
    .wizard-start-btn {
      background: var(--color-blue);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 8px;
    }
    .wizard-start-btn:hover { background: var(--color-blue-dark); }
    /* é€²æ—ãƒãƒ¼ */
    .wizard-progress { height: 4px; background: #e0e0e0; margin-bottom: 8px; border-radius: 2px; }
    .wizard-progress-bar { height: 100%; background: var(--color-green); border-radius: 2px; transition: width 0.3s; }
    /* åŒè¡Œå‰²ä»˜ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ */
    .mentor-wizard-body { display: flex; padding: 16px; gap: 16px; }
    .mentor-wizard-left { width: 260px; display: flex; flex-direction: column; gap: 12px; }
    .mentor-wizard-right { flex: 1; overflow-x: auto; }
    .mentor-wizard-section { display: flex; flex-direction: column; gap: 6px; }
    .mentor-wizard-label { font-size: 12px; font-weight: 600; color: var(--color-text); }
    .mentor-week-nav { display: flex; align-items: center; gap: 8px; }
    .mentor-week-nav button { padding: 6px 10px; border: 1px solid var(--color-border); background: var(--color-white); border-radius: 4px; cursor: pointer; }
    .mentor-week-nav button:hover { background: var(--color-orange-light); }
    .mentor-week-nav span { flex: 1; text-align: center; font-size: 13px; font-weight: 500; }
    .mentor-quick-btns { display: flex; flex-wrap: wrap; gap: 6px; }
    .mentor-quick-btns button { padding: 6px 10px; font-size: 11px; border: 1px solid var(--color-border); background: var(--color-white); border-radius: 4px; cursor: pointer; }
    .mentor-quick-btns button:hover { background: var(--color-blue-light); }
    .mentor-grid-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .mentor-grid-table th { background: var(--color-orange); color: var(--color-white); padding: 8px 10px; text-align: left; white-space: nowrap; }
    .mentor-grid-table td { border: 1px solid var(--color-border); padding: 6px 8px; background: var(--color-white); }
    .mentor-grid-table select { width: 100%; padding: 6px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 12px; }
    .mentor-grid-table .status-ok { color: var(--color-green-dark); font-size: 11px; }
    .mentor-grid-table .status-warn { color: var(--color-orange-dark); font-size: 11px; }
    .mentor-grid-table .status-empty { color: var(--color-disabled); font-size: 11px; }
    .mentor-wizard-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--color-border); background: #f9f9f9; }
    #wizardTraineeSelect { width: 100%; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 12px; }
    @media (max-width: 900px) { .right-panel { display: none; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>è¨ªå•çœ‹è­· è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</h1>
      <span class="header-badge">ç®¡ç†è€…å°‚ç”¨</span>
    </div>
    <span class="header-status">å…¥åŠ›ç®¡ç†ç”»é¢</span>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ -->
  <div class="wizard-panel" id="wizardPanel">
    <div class="wizard-header">
      <h3 id="wizardTitle">æ–°è¦ç™»éŒ²ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</h3>
      <button class="wizard-close" onclick="closeWizard()">Ã—</button>
    </div>
    <div class="wizard-body">
      <div class="wizard-chat" id="wizardChat">
        <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
      <div class="wizard-input-area">
        <div class="wizard-progress">
          <div class="wizard-progress-bar" id="wizardProgressBar" style="width: 0%"></div>
        </div>
        <div class="wizard-question" id="wizardQuestion">ç™»éŒ²ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</div>
        <div class="wizard-hint" id="wizardHint"></div>
        <div class="wizard-input-container" id="wizardInputContainer">
          <!-- å…¥åŠ›UIãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
        <div class="wizard-error" id="wizardError"></div>
        <div class="wizard-buttons">
          <button class="wizard-btn secondary" id="wizardBackBtn" onclick="wizardBack()" disabled>æˆ»ã‚‹</button>
          <button class="wizard-btn secondary" id="wizardSkipBtn" onclick="wizardSkip()" style="display:none;">ã‚¹ã‚­ãƒƒãƒ—</button>
          <button class="wizard-btn primary" id="wizardNextBtn" onclick="wizardNext()">æ¬¡ã¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŒè¡Œå‰²ä»˜ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ -->
  <div class="wizard-panel" id="mentorWizardPanel">
    <div class="wizard-header" style="background: linear-gradient(135deg, var(--color-orange-light) 0%, var(--color-orange) 100%);">
      <h3>åŒè¡Œå‰²ä»˜ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</h3>
      <button class="wizard-close" onclick="closeMentorWizard()">Ã—</button>
    </div>
    <div class="mentor-wizard-body">
      <div class="mentor-wizard-left">
        <div class="mentor-wizard-section">
          <label class="mentor-wizard-label">å¯¾è±¡é€±</label>
          <div class="mentor-week-nav">
            <button type="button" onclick="mentorWeekPrev()">â—€</button>
            <span id="mentorWeekDisplay">2026/01/05 ã€œ 2026/01/11</span>
            <button type="button" onclick="mentorWeekNext()">â–¶</button>
          </div>
        </div>
        <div class="mentor-wizard-section">
          <label class="mentor-wizard-label">æ–°äººï¼ˆtraineeï¼‰ã‚’é¸æŠ</label>
          <select id="wizardTraineeSelect" onchange="onTraineeChange()">
            <option value="">-- æ–°äººã‚’é¸æŠ --</option>
          </select>
        </div>
        <div class="mentor-wizard-section">
          <label class="mentor-wizard-label">ä¾¿åˆ©ãƒœã‚¿ãƒ³</label>
          <div class="mentor-quick-btns">
            <button type="button" onclick="applyAllDaysSameMentor()">å…¨æ—¥åŒã˜ãƒ¡ãƒ³ã‚¿ãƒ¼</button>
            <button type="button" onclick="applyWeekdayMentor()">å¹³æ—¥åŒã˜</button>
            <button type="button" onclick="clearMentorGrid()">å…¨ã‚¯ãƒªã‚¢</button>
          </div>
        </div>
        <div id="mentorWizardError" class="wizard-error"></div>
      </div>
      <div class="mentor-wizard-right">
        <table class="mentor-grid-table">
          <thead>
            <tr>
              <th>æ›œæ—¥</th>
              <th>æ—¥ä»˜</th>
              <th>ãƒ¡ãƒ³ã‚¿ãƒ¼</th>
              <th>æ™‚é–“å¸¯</th>
              <th>çŠ¶æ…‹</th>
            </tr>
          </thead>
          <tbody id="mentorGridBody">
            <!-- JS ã§ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="mentor-wizard-footer">
      <button class="wizard-btn secondary" onclick="closeMentorWizard()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="wizard-btn success" id="btnSaveMentorWizard" onclick="saveMentorWizard()">ä¿å­˜</button>
    </div>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">èª­ã¿è¾¼ã¿ä¸­...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="reloadCurrentSheet()">æ›´æ–°</button>
      </div>
      <div id="mainContent">
        <div class="table-container">
          <table class="data-table" id="dataTable">
            <thead><tr><th>èª­ã¿è¾¼ã¿ä¸­...</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-title">æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼<span class="dirty-badge" id="dirtyBadge">æœªä¿å­˜</span></div>
      <div class="operation-group">
        <div class="operation-group-title">æ–°è¦ç™»éŒ²</div>
        <button class="operation-btn primary" onclick="openWizard()"><span class="icon">ğŸ’¬</span>ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§ç™»éŒ²</button>
        <button class="operation-btn" onclick="openMentorWizard()"><span class="icon">ğŸ‘¥</span>åŒè¡Œå‰²ä»˜ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</button>
      </div>
      <div class="operation-group">
        <div class="operation-group-title">è¡Œæ“ä½œ</div>
        <button class="operation-btn" id="btnAddRow" onclick="onAddRow()"><span class="icon">+</span>ç©ºè¡Œã‚’è¿½åŠ ï¼ˆé¸æŠè¡Œã®ä¸‹ï¼‰</button>
        <button class="operation-btn danger" id="btnDeleteRows" onclick="onDeleteSelected()" disabled><span class="icon">-</span>é¸æŠè¡Œã‚’å‰Šé™¤</button>
        <button class="operation-btn" id="btnCopyRows" onclick="onCopySelected()" disabled><span class="icon">C</span>è¡Œã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="operation-group">
        <div class="operation-group-title">ç·¨é›†æ“ä½œ</div>
        <button class="operation-btn" id="btnUndo" onclick="onDiscardChanges()" disabled><span class="icon">U</span>å¤‰æ›´ã‚’å…ƒã«æˆ»ã™</button>
      </div>
      <div class="operation-group">
        <div class="operation-group-title">ä¿å­˜</div>
        <button class="operation-btn primary" id="btnSave" onclick="onSaveChanges()" disabled><span class="icon">S</span>å¤‰æ›´ã‚’ä¿å­˜</button>
      </div>
      <div class="operation-group" id="geoGroup" style="display:none;">
        <div class="operation-group-title">ä½ç½®æƒ…å ±</div>
        <button class="operation-btn" id="btnUpdateGeo" onclick="onUpdateGeo()" disabled><span class="icon">ğŸ“</span>ä½ç½®æƒ…å ±ã‚’æ›´æ–°</button>
      </div>
      <div class="info-section">
        <div class="info-item"><span class="label">è¡¨ç¤ºä¸­:</span><span id="infoSheetName">-</span></div>
        <div class="info-item"><span class="label">è¡Œæ•°:</span><span id="infoRowCount">-</span></div>
        <div class="info-item"><span class="label">åˆ—æ•°:</span><span id="infoColCount">-</span></div>
        <div class="info-item"><span class="label">é¸æŠä¸­:</span><span id="infoSelectedCount">0 è¡Œ</span></div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-sheet="æ‚£è€…ãƒã‚¹ã‚¿" onclick="showSheet('æ‚£è€…ãƒã‚¹ã‚¿', this)">æ‚£è€…ãƒã‚¹ã‚¿</button>
      <button class="tab-btn" data-sheet="ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿" onclick="showSheet('ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿', this)">ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</button>
      <button class="tab-btn" data-sheet="å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ" onclick="showSheet('å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', this)">æ‚£è€…å€‹åˆ¥å¤‰æ›´</button>
      <button class="tab-btn" data-sheet="ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ" onclick="showSheet('ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', this)">ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´</button>
      <button class="tab-btn" data-sheet="ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ" onclick="showSheet('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ', this)">ã‚¤ãƒ™ãƒ³ãƒˆ</button>
      <button class="tab-btn" data-sheet="ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜" onclick="showSheet('ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜', this)">åŒè¡Œå‰²ä»˜</button>
    </div>
    <div class="tabs-right"><a class="nav-link" onclick="goToOutput()">å‡ºåŠ›ç”»é¢ã¸ â†’</a></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================================
    var baseUrl = '';
    var currentSheetName = 'æ‚£è€…ãƒã‚¹ã‚¿';
    var tableData = { header: [], rows: [] };
    var originalData = { header: [], rows: [] };
    var rowMeta = []; // { sheetRowIndex, isSelected, isDirty, isNew }
    var dirtyCells = {}; // 'rowIdx-colIdx': newValue
    var isDirty = false;
    var editingCell = null;
    var focusedCell = null; // { rowIdx, colIdx }
    var dictionaries = { patients: {}, staff: {} };
    var staffOptions = []; // { id, name, label }
    var patientOptions = []; // { id, name, label }

    // åˆ—ã‚¿ã‚¤ãƒ—å®šç¾©
    var WEEKDAYS_EN = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var WEEKDAYS_JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    // è‹±èªâ†’æ—¥æœ¬èªå¤‰æ›ãƒãƒƒãƒ—
    var EN_TO_JP_MAP = { 'Sun':'æ—¥', 'Mon':'æœˆ', 'Tue':'ç«', 'Wed':'æ°´', 'Thu':'æœ¨', 'Fri':'é‡‘', 'Sat':'åœŸ' };
    var JP_TO_EN_MAP = { 'æ—¥':'Sun', 'æœˆ':'Mon', 'ç«':'Tue', 'æ°´':'Wed', 'æœ¨':'Thu', 'é‡‘':'Fri', 'åœŸ':'Sat' };
    var TIME_OPTIONS = generateTimeOptions(8, 20, 10); // 08:00ã€œ20:00, 10åˆ†åˆ»ã¿

    function generateTimeOptions(startHour, endHour, stepMin) {
      var opts = [];
      for (var h = startHour; h <= endHour; h++) {
        for (var m = 0; m < 60; m += stepMin) {
          if (h === endHour && m > 0) break;
          opts.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
        }
      }
      return opts;
    }

    // ============================================================
    // æœªä½¿ç”¨åˆ—ã®åˆ¤å®šï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã«å½±éŸ¿ã—ãªã„åˆ—ï¼‰
    // ============================================================
    function isUnusedColumn(headerName) {
      var h = headerName || '';
      if (h === 'ã‚¨ãƒªã‚¢' && currentSheetName === 'æ‚£è€…ãƒã‚¹ã‚¿') {
        return 'ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨';
      }
      if (h === 'å¾—æ„ã‚¨ãƒªã‚¢' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿') {
        return 'ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨';
      }
      if (h === 'ã‚¹ã‚­ãƒ«' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿') {
        return 'ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨';
      }
      return null;
    }

    // ============================================================
    // åˆ—ã‚¿ã‚¤ãƒ—åˆ¤å®š
    // ============================================================
    function getEditorType(headerName) {
      var h = (headerName || '').toLowerCase();
      var hOrig = headerName || '';
      // IDåˆ—ã¯å¯¾å¿œã™ã‚‹ã‚·ãƒ¼ãƒˆã§ã®ã¿è‡ªå‹•æ¡ç•ªï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
      if (h === 'patient_id' && currentSheetName === 'æ‚£è€…ãƒã‚¹ã‚¿') return 'auto_id';
      if (h === 'staff_id' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿') return 'auto_id';
      if (h === 'change_id' && currentSheetName === 'å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'auto_id';
      if (h === 'staff_change_id' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'auto_id';
      if (h === 'event_id' && currentSheetName === 'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'auto_id';
      // ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜ã®staff_idã¯ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ
      if (h === 'trainee_staff_id' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜') return 'staff_single_select';
      if (h === 'mentor_staff_id' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜') return 'staff_single_select';
      // å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®patient_idã¯æ‚£è€…é¸æŠ
      if (h === 'patient_id' && currentSheetName === 'å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'patient_select';
      // ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®staff_idã¯ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ
      if (h === 'staff_id' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'staff_single_select';
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®staff_id/patient_idã¯é¸æŠ
      if (h === 'staff_id' && currentSheetName === 'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'staff_single_select';
      if (h === 'patient_id' && currentSheetName === 'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ') return 'patient_select';
      // æ‚£è€…åãƒ»ã‚¹ã‚¿ãƒƒãƒ•åã¯è‡ªç”±å…¥åŠ›
      if (hOrig === 'æ‚£è€…å' || hOrig === 'ã‚¹ã‚¿ãƒƒãƒ•å') return 'text';
      // æŒ‡å®šã‚¹ã‚¿ãƒƒãƒ•IDãƒ»NGã‚¹ã‚¿ãƒƒãƒ•IDã¯ã‚¹ã‚¿ãƒƒãƒ•é¸æŠï¼ˆè¤‡æ•°ï¼‰
      if (hOrig === 'æŒ‡å®šã‚¹ã‚¿ãƒƒãƒ•ID' || hOrig === 'NGã‚¹ã‚¿ãƒƒãƒ•ID') return 'staff_multi_select';
      if (hOrig === 'æ€§åˆ¥') return 'sex_select';
      if (hOrig === 'ã‚¨ãƒªã‚¢' || hOrig === 'å¾—æ„ã‚¨ãƒªã‚¢') return 'area_select';
      if (h.includes('ç·¯åº¦') || h.includes('çµŒåº¦')) return 'geo_readonly';
      // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆé–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’å«ã‚€ï¼‰
      if (h.includes('æ—¥ä»˜') || hOrig === 'é–‹å§‹æ—¥' || hOrig === 'çµ‚äº†æ—¥') return 'date_picker';
      // æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆé–‹å§‹ãƒ»çµ‚äº†ã ã‘ã§ã¯æ—¥ä»˜ã¨åŒºåˆ¥ã§ããªã„ã®ã§æ™‚åˆ»ã‚’å«ã‚€ã‚‚ã®ã®ã¿ï¼‰
      if (h.includes('æ™‚åˆ»') || h.includes('æ™‚é–“å¸¯ï¼ˆé–‹å§‹ï¼‰') || h.includes('æ™‚é–“å¸¯ï¼ˆçµ‚ï¼‰') || h.includes('ã‚·ãƒ•ãƒˆ')) return 'time_select';
      if (h.includes('æ›œæ—¥') && (h.includes('è¤‡æ•°') || h.includes('å¸Œæœ›') || h.includes('å‹¤å‹™'))) return 'weekday_multi';
      // æ›œæ—¥NGã¯æ—¥æœ¬èªå˜ä¸€é¸æŠ
      if (hOrig === 'æ›œæ—¥NG' || h.includes('æ›œæ—¥ng')) return 'weekday_ng_jp';
      if (h.includes('å„ªå…ˆåº¦') || h === 'æ›œæ—¥å„ªå…ˆåº¦') return 'priority_select';
      if (h.includes('æ™‚é–“ã‚¿ã‚¤ãƒ—')) return 'time_type_select';
      if (h.includes('æ€§åˆ¥åˆ¶é™')) return 'sex_limit_select';
      if (h.includes('å¿…è¦ã‚¹ã‚¿ãƒƒãƒ•') || h.includes('è¨ªå•å›æ•°') || h.includes('æœ€å¤§è¨ªå•') || h.includes('ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“')) return 'number';
      if (h.includes('æŒ‡å®šã‚¿ã‚¤ãƒ—') || h.includes('ç¶™ç¶šå¸Œæœ›')) return 'staff_type_select';
      if (h.includes('æ“ä½œ')) return 'operation_select';
      if (h.includes('ã‚¹ã‚­ãƒ«')) return 'skill_select';
      if (hOrig === 'åˆ¶é™ã‚¿ã‚¤ãƒ—') return 'restriction_type_select';
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨
      if (hOrig === 'ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥') return 'event_type_select';
      if (hOrig === 'æ™‚é–“å¸¯' && currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜') return 'time_band_select';
      if (hOrig === 'æ™‚é–“æŒ‡å®šæ–¹æ³•') return 'time_mode_select';
      if (hOrig === 'æ‚£è€…å½±éŸ¿') return 'patient_affect_select';
      if (hOrig === 'æ‰€è¦æ™‚é–“(åˆ†)') return 'number';
      if (hOrig === 'å›ºå®šæ ' || hOrig === 'æ‚£è€…ç´ã¥ã' || hOrig === 'äº‹å‰äº‹å‹™æ‰€æˆ»ã‚Š' || hOrig === 'äº‹å¾Œäº‹å‹™æ‰€æˆ»ã‚Š') return 'boolean_select';
      return 'text';
    }

    // ============================================================
    // åˆæœŸåŒ–
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run.withSuccessHandler(function(url) { baseUrl = url; }).getBaseUrl();
      google.script.run.withSuccessHandler(function(result) {
        if (result.success) {
          dictionaries = result.data;
          // è¾æ›¸ã‹ã‚‰æ‚£è€…é¸æŠè‚¢ã‚’ç”Ÿæˆ
          patientOptions = [];
          for (var pid in dictionaries.patients) {
            patientOptions.push({
              id: pid,
              name: dictionaries.patients[pid],
              label: pid + ' ' + dictionaries.patients[pid]
            });
          }
          patientOptions.sort(function(a, b) { return a.id.localeCompare(b.id); });
        }
      }).input_getDictionaries();
      // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠè‚¢ã‚’èª­ã¿è¾¼ã¿
      google.script.run.withSuccessHandler(function(options) {
        staffOptions = options || [];
      }).input_getStaffOptions();

      var lastSheet = localStorage.getItem('unifiedInput_lastSheet');
      if (lastSheet) {
        currentSheetName = lastSheet;
        document.querySelectorAll('.tabs-left .tab-btn').forEach(function(tab) {
          tab.classList.toggle('active', tab.getAttribute('data-sheet') === currentSheetName);
        });
      }
      loadSheet(currentSheetName);
    });

    window.addEventListener('beforeunload', function(e) {
      if (isDirty) { e.preventDefault(); e.returnValue = ''; }
    });

    // ============================================================
    // ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    // ============================================================
    function showSheet(sheetName, btn) {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      currentSheetName = sheetName;
      localStorage.setItem('unifiedInput_lastSheet', sheetName);
      resetState();
      loadSheet(sheetName);
    }

    function resetState() {
      rowMeta = [];
      dirtyCells = {};
      isDirty = false;
      editingCell = null;
      focusedCell = null;
      updateButtonStates();
    }

    function loadSheet(sheetName) {
      setStatus('loading', sheetName + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('refreshBtn').disabled = true;
      // ä½ç½®æƒ…å ±ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      var showGeo = (sheetName === 'æ‚£è€…ãƒã‚¹ã‚¿' || sheetName === 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿');
      document.getElementById('geoGroup').style.display = showGeo ? 'block' : 'none';

      google.script.run
        .withSuccessHandler(function(data) {
          tableData = data;
          originalData = JSON.parse(JSON.stringify(data));
          // rowMetaåˆæœŸåŒ–
          rowMeta = data.rows.map(function(_, i) {
            return { sheetRowIndex: i + 2, isSelected: false, isDirty: false, isNew: false };
          });
          renderTable(data);
          document.getElementById('refreshBtn').disabled = false;
        })
        .withFailureHandler(function(e) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
          showToast('error', e.message);
        })
        .getSheetTableData(sheetName, 1000);
    }

    function reloadCurrentSheet() {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ')) return;
      resetState();
      loadSheet(currentSheetName);
    }

    // ============================================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ============================================================
    function renderTable(data) {
      if (data.error) { setStatus('error', data.error); return; }
      if (!data.header || data.header.length === 0) {
        setStatus('error', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('dataTable').innerHTML = '<thead><tr><th>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</th></tr></thead><tbody></tbody>';
        updateInfo('-', 0, 0);
        return;
      }
      setStatus('success', getDisplaySheetName(data.sheetName || currentSheetName) + 'ï¼ˆ' + data.rowCount + 'è¡Œï¼‰');
      updateInfo(data.sheetName || currentSheetName, data.rowCount, data.header.length);

      var headerHtml = '<tr><th class="row-handle"></th><th>#</th>' + data.header.map(function(h) {
        var unusedNote = isUnusedColumn(h);
        if (unusedNote) {
          return '<th class="unused-column" title="' + escapeHtml(unusedNote) + '">' + escapeHtml(String(h)) + ' <span class="unused-mark">*</span></th>';
        }
        return '<th>' + escapeHtml(String(h)) + '</th>';
      }).join('') + '</tr>';

      var rowsHtml = data.rows.map(function(row, rowIdx) {
        var meta = rowMeta[rowIdx] || {};
        var rowClass = [];
        if (meta.isSelected) rowClass.push('row-selected');
        var cells = '<td class="row-handle" data-row="' + rowIdx + '">â ¿</td>';
        cells += '<td>' + (rowIdx + 1) + '</td>';
        cells += row.map(function(cell, colIdx) {
          var cellKey = rowIdx + '-' + colIdx;
          var cellClass = [];
          if (dirtyCells.hasOwnProperty(cellKey)) cellClass.push('dirty');
          if (meta.isNew) cellClass.push('is-new');
          if (focusedCell && focusedCell.rowIdx === rowIdx && focusedCell.colIdx === colIdx) cellClass.push('cell-focused');
          var cellValue = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : cell;
          return '<td class="' + cellClass.join(' ') + '" data-row="' + rowIdx + '" data-col="' + colIdx + '">' + escapeHtml(formatCellDisplay(cellValue, data.header[colIdx])) + '</td>';
        }).join('');
        return '<tr class="' + rowClass.join(' ') + '" data-row="' + rowIdx + '">' + cells + '</tr>';
      }).join('');

      document.getElementById('dataTable').innerHTML = '<thead>' + headerHtml + '</thead><tbody>' + rowsHtml + '</tbody>';
      attachTableEvents();
    }

    function formatCellDisplay(value, headerName) {
      if (value === null || value === undefined) return '';
      var editorType = getEditorType(headerName);
      if (editorType === 'weekday_multi' && value) {
        // Mon,Tue â†’ æœˆ,ç«
        return String(value).split(',').map(function(d) {
          var idx = WEEKDAYS_EN.indexOf(d.trim());
          return idx >= 0 ? WEEKDAYS_JP[idx] : d;
        }).join(',');
      }
      if (editorType === 'weekday_ng_jp' && value) {
        // Sun â†’ æ—¥ (è‹±èªâ†’æ—¥æœ¬èªå¤‰æ›)
        var v = String(value).trim();
        return EN_TO_JP_MAP[v] || v;
      }
      if (editorType === 'staff_multi_select' && value) {
        // S001,S002 â†’ S001 ç”°ä¸­,S002 éˆ´æœ¨
        return String(value).split(',').map(function(id) {
          id = id.trim();
          var staff = staffOptions.find(function(s) { return s.id === id; });
          return staff ? staff.label : id;
        }).join(', ');
      }
      if (editorType === 'staff_single_select' && value) {
        // S001 â†’ S001 ç”°ä¸­
        var staff = staffOptions.find(function(s) { return s.id === String(value).trim(); });
        return staff ? staff.label : value;
      }
      if (editorType === 'patient_select' && value) {
        // P001 â†’ P001 å±±ç”°å¤ªéƒ
        var patient = patientOptions.find(function(p) { return p.id === String(value).trim(); });
        return patient ? patient.label : value;
      }
      if (editorType === 'time_select' && value) {
        // HH:MM:SS â†’ HH:MM
        return String(value).substring(0, 5);
      }
      if (editorType === 'date_picker' && value) {
        // Date object or date string â†’ yyyy/MM/dd
        try {
          var d;
          if (value instanceof Date) {
            d = value;
          } else if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
            d = new Date(value);
          } else if (typeof value === 'string' && value.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
            return value; // already formatted
          } else {
            d = new Date(value);
          }
          if (!isNaN(d.getTime())) {
            return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
          }
        } catch (e) {}
        return String(value);
      }
      return String(value);
    }

    function attachTableEvents() {
      var tbody = document.querySelector('#dataTable tbody');
      if (!tbody) return;

      tbody.addEventListener('click', function(e) {
        var td = e.target.closest('td');
        var tr = e.target.closest('tr');
        if (!tr || !td) return;
        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (isNaN(rowIdx)) return;

        // Row Handleã‚¯ãƒªãƒƒã‚¯ â†’ è¡Œé¸æŠ
        if (td.classList.contains('row-handle')) {
          toggleRowSelection(rowIdx, e.ctrlKey || e.metaKey, e.shiftKey);
          return;
        }

        // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (td.hasAttribute('data-col')) {
          var colIdx = parseInt(td.getAttribute('data-col'));
          setFocusedCell(rowIdx, colIdx);
          if (e.detail === 2) { // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯
            startCellEdit(rowIdx, colIdx);
          }
        }
      });
    }

    // ============================================================
    // è¡Œé¸æŠ
    // ============================================================
    function toggleRowSelection(rowIdx, ctrlKey, shiftKey) {
      if (ctrlKey) {
        rowMeta[rowIdx].isSelected = !rowMeta[rowIdx].isSelected;
      } else if (shiftKey && getSelectedRows().length > 0) {
        var lastSel = getSelectedRows().pop();
        var start = Math.min(lastSel, rowIdx);
        var end = Math.max(lastSel, rowIdx);
        for (var i = start; i <= end; i++) {
          rowMeta[i].isSelected = true;
        }
      } else {
        rowMeta.forEach(function(m, i) { m.isSelected = (i === rowIdx); });
      }
      updateRowSelectionUI();
      updateButtonStates();
    }

    function getSelectedRows() {
      var selected = [];
      rowMeta.forEach(function(m, i) { if (m.isSelected) selected.push(i); });
      return selected;
    }

    function updateRowSelectionUI() {
      document.querySelectorAll('#dataTable tbody tr').forEach(function(tr) {
        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (!isNaN(rowIdx) && rowMeta[rowIdx]) {
          tr.classList.toggle('row-selected', rowMeta[rowIdx].isSelected);
        }
      });
      document.getElementById('infoSelectedCount').textContent = getSelectedRows().length + ' è¡Œ';
    }

    // ============================================================
    // ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    // ============================================================
    function setFocusedCell(rowIdx, colIdx) {
      focusedCell = { rowIdx: rowIdx, colIdx: colIdx };
      document.querySelectorAll('#dataTable td.cell-focused').forEach(function(td) { td.classList.remove('cell-focused'); });
      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (td) td.classList.add('cell-focused');
    }

    // ============================================================
    // ã‚»ãƒ«ç·¨é›†
    // ============================================================
    function startCellEdit(rowIdx, colIdx) {
      if (editingCell) finishCellEdit();
      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (!td) return;

      var headerName = tableData.header[colIdx];
      var editorType = getEditorType(headerName);
      var cellKey = rowIdx + '-' + colIdx;
      var currentValue = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[rowIdx][colIdx];

      // èª­ã¿å–ã‚Šå°‚ç”¨
      if (editorType === 'readonly_text' || editorType === 'geo_readonly' || editorType === 'auto_id') {
        showToast('info', 'ã“ã®åˆ—ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™');
        return;
      }

      // æœªä½¿ç”¨åˆ—ã®æ³¨è¨˜è¡¨ç¤º
      var unusedNote = isUnusedColumn(headerName);
      if (unusedNote) {
        showToast('info', 'â€» ' + headerName + ': ' + unusedNote);
      }

      td.classList.add('editing');
      editingCell = { rowIdx: rowIdx, colIdx: colIdx, headerName: headerName };

      var editorHtml = createEditorHtml(editorType, currentValue, headerName);
      td.innerHTML = editorHtml;

      var input = td.querySelector('input, select');
      if (input) {
        input.focus();
        if (input.tagName === 'INPUT') input.select();
        input.addEventListener('blur', finishCellEdit);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') finishCellEdit();
          else if (e.key === 'Escape') cancelCellEdit();
        });
      }
    }

    function createEditorHtml(editorType, value, headerName) {
      switch (editorType) {
        case 'sex_select':
          return createSelect(['ç”·æ€§', 'å¥³æ€§'], value);
        case 'area_select':
          return createSelect(['', 'A1', 'A2', 'A3', 'B1', 'B2', 'B3'], value);
        case 'priority_select':
          return createSelect(['é«˜', 'ä¸­', 'ä½'], value);
        case 'time_type_select':
          return createSelect(['æ™‚é–“å¸¯', 'åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥', 'å›ºå®š'], value);
        case 'sex_limit_select':
          return createSelect(['', 'ç”·æ€§ã®ã¿', 'å¥³æ€§ã®ã¿'], value);
        case 'staff_type_select':
          return createSelect(['åŒã˜äººå¸Œæœ›', 'ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å„ªå…ˆ', 'ã©ã¡ã‚‰ã§ã‚‚'], value);
        case 'operation_select':
          return createSelect(['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'æ™‚é–“å¤‰æ›´', 'è¿½åŠ '], value);
        case 'skill_select':
          return createSelect(['', 'ãƒ™ãƒ†ãƒ©ãƒ³', 'ä¸­å …', 'æ–°äºº'], value);
        case 'restriction_type_select':
          return createSelect(['ä¼‘ã¿', 'åˆå‰ä¼‘', 'åˆå¾Œä¼‘', 'é…åˆ»', 'æ—©é€€', 'æ™‚é–“æŒ‡å®š'], value);
        case 'event_type_select':
          return createSelect(['ç—…é™¢åŒè¡Œ', 'æ–°è¦é¢ä¼š/å¥‘ç´„', 'ä¼šè­°/æ‰“åˆã›', 'å½¹æ‰€/æ‰‹ç¶šã', 'å¾Œè¦‹äºº/å¼è­·å£«åŒå¸­', 'äº‹å‹™ä½œæ¥­ï¼ˆå¤–å‡ºï¼‰', 'ãã®ä»–'], value);
        case 'time_mode_select':
          return createSelect(['æ™‚é–“æŒ‡å®š', 'åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥'], value);
        case 'time_band_select':
          return createSelect(['çµ‚æ—¥', 'åˆå‰', 'åˆå¾Œ'], value);
        case 'patient_affect_select':
          return createSelect(['', 'è¨ªå•ä¸å¯', 'æ™‚é–“å›ºå®š', 'æƒ…å ±ã®ã¿'], value);
        case 'boolean_select':
          return createSelect(['', 'TRUE', 'FALSE'], value);
        case 'time_select':
          var timeVal = value ? String(value).substring(0, 5) : '';
          return createSelect(TIME_OPTIONS, timeVal);
        case 'date_picker':
          var dateVal = value ? formatDateForInput(value) : '';
          return '<input type="date" value="' + dateVal + '" />';
        case 'weekday_multi':
          return createWeekdayEditor(value);
        case 'weekday_ng_jp':
          // æ›œæ—¥NG: æ—¥æœ¬èªè¡¨ç¤ºãƒ»ä¿å­˜ï¼ˆæ—¢å­˜ã®è‹±èªå€¤ã¯å¤‰æ›ã—ã¦è¡¨ç¤ºï¼‰
          var jpValue = EN_TO_JP_MAP[String(value).trim()] || value || '';
          return createSelect(['', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'], jpValue);
        case 'staff_multi_select':
          return createStaffMultiSelect(value);
        case 'staff_single_select':
          return createStaffSingleSelect(value);
        case 'patient_select':
          return createPatientSelect(value);
        case 'number':
          return '<input type="number" value="' + (value || '') + '" />';
        default:
          return '<input type="text" value="' + escapeHtml(value || '') + '" />';
      }
    }

    function createSelect(options, selectedValue) {
      var html = '<select>';
      options.forEach(function(opt) {
        var selected = (String(opt) === String(selectedValue)) ? ' selected' : '';
        html += '<option value="' + escapeHtml(opt) + '"' + selected + '>' + escapeHtml(opt) + '</option>';
      });
      html += '</select>';
      return html;
    }

    function createWeekdayEditor(value) {
      var selected = (value || '').split(',').map(function(s) { return s.trim(); });
      var html = '<div class="weekday-editor">';
      WEEKDAYS_EN.forEach(function(en, i) {
        var checked = selected.indexOf(en) >= 0 ? ' checked' : '';
        html += '<label><input type="checkbox" value="' + en + '"' + checked + '>' + WEEKDAYS_JP[i] + '</label>';
      });
      html += '</div>';
      return html;
    }

    function createStaffMultiSelect(value) {
      var selected = (value || '').split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s; });
      var html = '<div class="staff-multi-select">';
      if (staffOptions.length === 0) {
        html += '<span style="color:#999;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãªã—</span>';
      } else {
        staffOptions.forEach(function(staff) {
          var checked = selected.indexOf(staff.id) >= 0 ? ' checked' : '';
          html += '<label><input type="checkbox" value="' + escapeHtml(staff.id) + '"' + checked + '>' + escapeHtml(staff.label) + '</label>';
        });
      }
      html += '</div>';
      return html;
    }

    function createStaffSingleSelect(value) {
      var currentVal = String(value || '').trim();
      var html = '<select>';
      html += '<option value="">-- é¸æŠ --</option>';
      staffOptions.forEach(function(staff) {
        var selected = (staff.id === currentVal) ? ' selected' : '';
        html += '<option value="' + escapeHtml(staff.id) + '"' + selected + '>' + escapeHtml(staff.label) + '</option>';
      });
      html += '</select>';
      return html;
    }

    function createPatientSelect(value) {
      var currentVal = String(value || '').trim();
      var html = '<select>';
      html += '<option value="">-- é¸æŠ --</option>';
      patientOptions.forEach(function(patient) {
        var selected = (patient.id === currentVal) ? ' selected' : '';
        html += '<option value="' + escapeHtml(patient.id) + '"' + selected + '>' + escapeHtml(patient.label) + '</option>';
      });
      html += '</select>';
      return html;
    }

    function formatDateForInput(value) {
      if (!value) return '';
      try {
        var d = new Date(value);
        return d.toISOString().split('T')[0];
      } catch (e) {
        return '';
      }
    }

    function finishCellEdit() {
      if (!editingCell) return;
      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      if (!td) { editingCell = null; return; }

      var newValue = getEditorValue(td);
      var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
      var originalValue = originalData.rows[editingCell.rowIdx] ? originalData.rows[editingCell.rowIdx][editingCell.colIdx] : '';

      // å€¤ã®æ­£è¦åŒ–
      var editorType = getEditorType(editingCell.headerName);
      if (editorType === 'time_select' && newValue) {
        newValue = newValue + ':00'; // HH:MM â†’ HH:MM:SS
      }

      // å¤‰æ›´ãƒã‚§ãƒƒã‚¯
      if (String(newValue) === String(originalValue)) {
        delete dirtyCells[cellKey];
      } else {
        dirtyCells[cellKey] = newValue;
        rowMeta[editingCell.rowIdx].isDirty = true;
      }

      // å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
      tableData.rows[editingCell.rowIdx][editingCell.colIdx] = newValue;

      // IDâ†’åå‰ã®è‡ªå‹•è£œå®Œ
      autoCompleteNameFromId(editingCell.rowIdx, editingCell.colIdx, newValue);

      // æ™‚é–“ã‚¿ã‚¤ãƒ—é€£å‹•ã®è‡ªå‹•æ™‚é–“è¨­å®š
      autoSetTimeFromType(editingCell.rowIdx, editingCell.colIdx, newValue);

      td.classList.remove('editing');
      td.innerHTML = escapeHtml(formatCellDisplay(newValue, editingCell.headerName));
      if (dirtyCells.hasOwnProperty(cellKey)) td.classList.add('dirty');
      else td.classList.remove('dirty');

      editingCell = null;
      updateDirtyState();
    }

    function getEditorValue(td) {
      var input = td.querySelector('input[type="text"], input[type="number"], input[type="date"], select');
      if (input) return input.value;

      // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      var weekdayCheckboxes = td.querySelectorAll('.weekday-editor input[type="checkbox"]');
      if (weekdayCheckboxes.length > 0) {
        var vals = [];
        weekdayCheckboxes.forEach(function(cb) { if (cb.checked) vals.push(cb.value); });
        return vals.join(',');
      }

      // ã‚¹ã‚¿ãƒƒãƒ•è¤‡æ•°é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      var staffCheckboxes = td.querySelectorAll('.staff-multi-select input[type="checkbox"]');
      if (staffCheckboxes.length > 0) {
        var vals = [];
        staffCheckboxes.forEach(function(cb) { if (cb.checked) vals.push(cb.value); });
        return vals.join(',');
      }
      return '';
    }

    function cancelCellEdit() {
      if (!editingCell) return;
      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
      var value = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[editingCell.rowIdx][editingCell.colIdx];
      td.classList.remove('editing');
      td.innerHTML = escapeHtml(formatCellDisplay(value, editingCell.headerName));
      editingCell = null;
    }

    // ============================================================
    // è‡ªå‹•è£œå®Œ
    // ============================================================
    function autoCompleteNameFromId(rowIdx, colIdx, idValue) {
      var header = tableData.header[colIdx];
      var nameColIdx = -1;
      var nameValue = '';

      if (header === 'patient_id') {
        nameColIdx = tableData.header.indexOf('æ‚£è€…å');
        nameValue = dictionaries.patients[idValue] || '';
      } else if (header === 'staff_id') {
        nameColIdx = tableData.header.indexOf('ã‚¹ã‚¿ãƒƒãƒ•å');
        nameValue = dictionaries.staff[idValue] || '';
      }

      if (nameColIdx >= 0 && nameValue) {
        var nameCellKey = rowIdx + '-' + nameColIdx;
        dirtyCells[nameCellKey] = nameValue;
        tableData.rows[rowIdx][nameColIdx] = nameValue;
        // UIã‚‚æ›´æ–°
        var nameTd = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + nameColIdx + '"]');
        if (nameTd) {
          nameTd.textContent = nameValue;
          nameTd.classList.add('dirty');
        }
      }
    }

    // ============================================================
    // æ™‚é–“ã‚¿ã‚¤ãƒ—é€£å‹•ã®è‡ªå‹•æ™‚é–“è¨­å®š
    // ============================================================
    function autoSetTimeFromType(rowIdx, colIdx, newValue) {
      var header = tableData.header[colIdx];

      // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
      var timeTypeColIdx = tableData.header.indexOf('æ™‚é–“ã‚¿ã‚¤ãƒ—');
      var startColIdx = tableData.header.indexOf('å¸Œæœ›æ™‚é–“å¸¯ï¼ˆé–‹å§‹ï¼‰');
      var endColIdx = tableData.header.indexOf('å¸Œæœ›æ™‚é–“å¸¯ï¼ˆçµ‚äº†ï¼‰');
      var svcColIdx = tableData.header.indexOf('ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“');

      // æ‚£è€…ãƒã‚¹ã‚¿ä»¥å¤–ã§ã¯å‹•ä½œã—ãªã„
      if (currentSheetName !== 'æ‚£è€…ãƒã‚¹ã‚¿') return;
      if (startColIdx < 0 || endColIdx < 0) return;

      // æ™‚é–“ã‚¿ã‚¤ãƒ—ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆ
      if (header === 'æ™‚é–“ã‚¿ã‚¤ãƒ—') {
        var timeType = newValue;
        var startValue = '', endValue = '';

        if (timeType === 'åˆå‰') {
          startValue = '09:00:00';
          endValue = '12:00:00';
        } else if (timeType === 'åˆå¾Œ') {
          startValue = '13:00:00';
          endValue = '17:00:00';
        } else if (timeType === 'çµ‚æ—¥') {
          startValue = '09:00:00';
          endValue = '18:00:00';
        }

        // æ™‚é–“å¸¯/å›ºå®šã®å ´åˆã¯ã‚¯ãƒªã‚¢ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«è¨­å®šï¼‰
        if (startValue && endValue) {
          setCellValue(rowIdx, startColIdx, startValue);
          setCellValue(rowIdx, endColIdx, endValue);
        }
      }

      // ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼ˆå›ºå®šã‚¿ã‚¤ãƒ—æ™‚ï¼‰
      if (header === 'ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“' && timeTypeColIdx >= 0) {
        var timeType = tableData.rows[rowIdx][timeTypeColIdx];
        if (timeType === 'å›ºå®š') {
          var svcMin = parseInt(newValue, 10) || 0;
          if (svcMin > 0) {
            var startVal = tableData.rows[rowIdx][startColIdx];
            var endVal = tableData.rows[rowIdx][endColIdx];

            if (startVal && !endVal) {
              // é–‹å§‹ã‚ã‚Šã€çµ‚äº†ãªã— â†’ çµ‚äº†ã‚’è¨ˆç®—
              var endTime = addMinutesToTime(startVal, svcMin);
              if (endTime) setCellValue(rowIdx, endColIdx, endTime);
            } else if (!startVal && endVal) {
              // é–‹å§‹ãªã—ã€çµ‚äº†ã‚ã‚Š â†’ é–‹å§‹ã‚’è¨ˆç®—
              var startTime = addMinutesToTime(endVal, -svcMin);
              if (startTime) setCellValue(rowIdx, startColIdx, startTime);
            }
          }
        }
      }

      // é–‹å§‹æ™‚åˆ»ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼ˆå›ºå®šã‚¿ã‚¤ãƒ—æ™‚ï¼‰
      if ((header === 'å¸Œæœ›æ™‚é–“å¸¯ï¼ˆé–‹å§‹ï¼‰' || header.includes('é–‹å§‹')) && timeTypeColIdx >= 0 && svcColIdx >= 0) {
        var timeType = tableData.rows[rowIdx][timeTypeColIdx];
        if (timeType === 'å›ºå®š') {
          var svcMin = parseInt(tableData.rows[rowIdx][svcColIdx], 10) || 0;
          if (svcMin > 0 && newValue) {
            var endTime = addMinutesToTime(newValue, svcMin);
            if (endTime) setCellValue(rowIdx, endColIdx, endTime);
          }
        }
      }

      // çµ‚äº†æ™‚åˆ»ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼ˆå›ºå®šã‚¿ã‚¤ãƒ—æ™‚ï¼‰
      if ((header === 'å¸Œæœ›æ™‚é–“å¸¯ï¼ˆçµ‚äº†ï¼‰' || header.includes('çµ‚äº†')) && timeTypeColIdx >= 0 && svcColIdx >= 0) {
        var timeType = tableData.rows[rowIdx][timeTypeColIdx];
        if (timeType === 'å›ºå®š') {
          var svcMin = parseInt(tableData.rows[rowIdx][svcColIdx], 10) || 0;
          if (svcMin > 0 && newValue) {
            var startTime = addMinutesToTime(newValue, -svcMin);
            if (startTime) setCellValue(rowIdx, startColIdx, startTime);
          }
        }
      }
    }

    // æ™‚é–“ã«åˆ†ã‚’åŠ ç®—/æ¸›ç®—
    function addMinutesToTime(timeStr, minutes) {
      if (!timeStr) return null;
      var parts = String(timeStr).split(':');
      var h = parseInt(parts[0], 10) || 0;
      var m = parseInt(parts[1], 10) || 0;
      var totalMin = h * 60 + m + minutes;
      if (totalMin < 0) totalMin = 0;
      if (totalMin >= 24 * 60) totalMin = 24 * 60 - 1;
      var newH = Math.floor(totalMin / 60);
      var newM = totalMin % 60;
      return String(newH).padStart(2, '0') + ':' + String(newM).padStart(2, '0') + ':00';
    }

    // ã‚»ãƒ«ã«å€¤ã‚’è¨­å®šï¼ˆUIæ›´æ–°å«ã‚€ï¼‰
    function setCellValue(rowIdx, colIdx, value) {
      var cellKey = rowIdx + '-' + colIdx;
      var originalValue = originalData.rows[rowIdx] ? originalData.rows[rowIdx][colIdx] : '';

      if (String(value) === String(originalValue)) {
        delete dirtyCells[cellKey];
      } else {
        dirtyCells[cellKey] = value;
        rowMeta[rowIdx].isDirty = true;
      }

      tableData.rows[rowIdx][colIdx] = value;

      // UIæ›´æ–°
      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (td) {
        var headerName = tableData.header[colIdx];
        td.innerHTML = escapeHtml(formatCellDisplay(value, headerName));
        if (dirtyCells.hasOwnProperty(cellKey)) td.classList.add('dirty');
        else td.classList.remove('dirty');
      }
    }

    // ============================================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================================
    function updateDirtyState() {
      isDirty = Object.keys(dirtyCells).length > 0 || rowMeta.some(function(m) { return m.isNew; });
      document.getElementById('dirtyBadge').classList.toggle('show', isDirty);
      updateButtonStates();
    }

    function updateButtonStates() {
      var hasSelection = getSelectedRows().length > 0;
      var hasDirty = isDirty;
      document.getElementById('btnDeleteRows').disabled = !hasSelection;
      document.getElementById('btnCopyRows').disabled = !hasSelection;
      document.getElementById('btnUndo').disabled = !hasDirty;
      document.getElementById('btnSave').disabled = !hasDirty;
      document.getElementById('btnUpdateGeo').disabled = !hasSelection;
    }

    // ============================================================
    // æ“ä½œãƒœã‚¿ãƒ³
    // ============================================================
    function onAddRow() {
      var selectedRows = getSelectedRows();
      var baseRowIndex = null;
      if (selectedRows.length > 0) {
        var lastSelected = Math.max.apply(null, selectedRows);
        baseRowIndex = rowMeta[lastSelected].sheetRowIndex;
      }

      setStatus('loading', 'è¡Œã‚’è¿½åŠ ä¸­...');
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            reloadCurrentSheet();
          } else {
            showToast('error', result.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_insertRowBelow(currentSheetName, baseRowIndex);
    }

    function onDeleteSelected() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      if (!confirm(selectedRows.length + ' è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;

      setStatus('loading', 'å‰Šé™¤ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_deleteRows(currentSheetName, sheetRowNumbers);
    }

    function onCopySelected() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      setStatus('loading', 'ã‚³ãƒ”ãƒ¼ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_copyRows(currentSheetName, sheetRowNumbers);
    }

    function onDiscardChanges() {
      if (!confirm('æœªä¿å­˜ã®å¤‰æ›´ã‚’ã™ã¹ã¦ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) return;
      dirtyCells = {};
      tableData = JSON.parse(JSON.stringify(originalData));
      rowMeta.forEach(function(m) { m.isDirty = false; m.isNew = false; });
      renderTable(tableData);
      updateDirtyState();
      showToast('info', 'å¤‰æ›´ã‚’ç ´æ£„ã—ã¾ã—ãŸ');
    }

    function onSaveChanges() {
      var dirtyKeys = Object.keys(dirtyCells);
      if (dirtyKeys.length === 0) { showToast('info', 'ä¿å­˜ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      setStatus('loading', 'ä¿å­˜ä¸­...');
      var updates = dirtyKeys.map(function(key) {
        var parts = key.split('-');
        var rowIdx = parseInt(parts[0]);
        var colIdx = parseInt(parts[1]);
        return {
          row: rowMeta[rowIdx].sheetRowIndex,
          col: colIdx + 1,
          value: dirtyCells[key]
        };
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            originalData = JSON.parse(JSON.stringify(tableData));
            dirtyCells = {};
            rowMeta.forEach(function(m) { m.isDirty = false; m.isNew = false; });
            updateDirtyState();
            renderTable(tableData);
            setStatus('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
          } else {
            showToast('error', result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_updateCells(currentSheetName, updates);
    }

    function onUpdateGeo() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      setStatus('loading', 'ä½ç½®æƒ…å ±ã‚’æ›´æ–°ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            if (result.errors && result.errors.length > 0) {
              result.errors.forEach(function(err) { showToast('error', err); });
            }
            reloadCurrentSheet();
          } else {
            showToast('error', result.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_updateGeo(currentSheetName, sheetRowNumbers);
    }

    // ============================================================
    // ç”»é¢é·ç§»
    // ============================================================
    function goToOutput() {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var targetUrl = baseUrl ? baseUrl + '?page=output' : window.location.href.split('?')[0] + '?page=output';
      try { window.top.location.href = targetUrl; } catch (e) { window.location.href = targetUrl; }
    }

    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    function showToast(type, message) {
      var container = document.getElementById('toastContainer');
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.style.opacity = '0';
        setTimeout(function() { container.removeChild(toast); }, 300);
      }, 3000);
    }

    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function updateInfo(sheetName, rowCount, colCount) {
      document.getElementById('infoSheetName').textContent = getDisplaySheetName(sheetName);
      document.getElementById('infoRowCount').textContent = rowCount;
      document.getElementById('infoColCount').textContent = colCount;
    }

    // ã‚·ãƒ¼ãƒˆåã‹ã‚‰è¡¨ç¤ºåã¸ã®å¤‰æ›
    function getDisplaySheetName(sheetName) {
      var displayNames = {
        'å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ': 'æ‚£è€…å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
        'ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ': 'ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ'
      };
      return displayNames[sheetName] || sheetName;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // ============================================================
    // ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰
    // ============================================================

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
    var FORM_SCHEMA = {
      'æ‚£è€…ãƒã‚¹ã‚¿': [
        { key: 'patient_id', header: 'patient_id', label: 'æ‚£è€…IDã‚’ç™ºè¡Œã—ã¾ã™', type: 'autoId', prefix: 'P', required: true },
        { key: 'name', header: 'æ‚£è€…å', label: 'æ‚£è€…ã•ã‚“ã®ã€Œæ°åã€ã¯ï¼Ÿ', type: 'text', required: true },
        { key: 'sex', header: 'æ€§åˆ¥', label: 'æ€§åˆ¥ã¯ï¼Ÿ', type: 'select', options: ['', 'ç”·æ€§', 'å¥³æ€§'] },
        { key: 'address', header: 'ä½æ‰€', label: 'ä½æ‰€ã¯ï¼Ÿ', type: 'textarea', required: true },
        { key: 'area', header: 'ã‚¨ãƒªã‚¢', label: 'ã‚¨ãƒªã‚¢ã¯ï¼Ÿ', type: 'select', options: ['', 'A1', 'A2', 'A3', 'B1', 'B2', 'B3'], hint: 'â€»ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨' },
        { key: 'weeklyCount', header: 'é€±è¨ªå•å›æ•°', label: 'é€±ã®è¨ªå•å›æ•°ã¯ï¼Ÿ', type: 'number', required: true, min: 1 },
        { key: 'preferDays', header: 'å¸Œæœ›æ›œæ—¥ï¼ˆè¤‡æ•°å¯ï¼‰', label: 'å¸Œæœ›ã™ã‚‹æ›œæ—¥ã¯ï¼Ÿï¼ˆè¤‡æ•°é¸æŠï¼‰', type: 'multiSelect', options: ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'], required: true },
        { key: 'ngDays', header: 'æ›œæ—¥NG', label: 'NGã®æ›œæ—¥ã¯ï¼Ÿ', type: 'select', options: ['', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'] },
        { key: 'serviceMin', header: 'ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“', label: 'ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ï¼ˆåˆ†ï¼‰ã¯ï¼Ÿ', type: 'number', required: true, min: 5 },
        { key: 'timeType', header: 'æ™‚é–“ã‚¿ã‚¤ãƒ—', label: 'æ™‚é–“ã‚¿ã‚¤ãƒ—ã¯ï¼Ÿ', type: 'select', options: ['æ™‚é–“å¸¯', 'åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥', 'å›ºå®š'] },
        { key: 'fixedTarget', header: null, label: 'é–‹å§‹ãƒ»çµ‚äº†ã©ã¡ã‚‰ã‚’å›ºå®šã—ã¾ã™ã‹ï¼Ÿ', type: 'select', options: ['é–‹å§‹', 'çµ‚äº†'], conditionalOn: { key: 'timeType', value: 'å›ºå®š' } },
        { key: 'timeStart', header: 'å¸Œæœ›æ™‚é–“å¸¯ï¼ˆé–‹å§‹ï¼‰', label: 'å¸Œæœ›æ™‚é–“ï¼ˆé–‹å§‹ï¼‰ã¯ï¼Ÿ', type: 'time', required: true },
        { key: 'timeEnd', header: 'å¸Œæœ›æ™‚é–“å¸¯ï¼ˆçµ‚äº†ï¼‰', label: 'å¸Œæœ›æ™‚é–“ï¼ˆçµ‚äº†ï¼‰ã¯ï¼Ÿ', type: 'time', required: true },
        { key: 'sexLimit', header: 'æ€§åˆ¥åˆ¶é™', label: 'æ€§åˆ¥åˆ¶é™ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ', type: 'select', options: ['', 'ç”·æ€§ã®ã¿', 'å¥³æ€§ã®ã¿'] },
        { key: 'needStaff', header: 'å¿…è¦ã‚¹ã‚¿ãƒƒãƒ•æ•°', label: 'å¿…è¦ã‚¹ã‚¿ãƒƒãƒ•æ•°ã¯ï¼Ÿ', type: 'number', defaultValue: 1, min: 1 },
        { key: 'fixedStaff', header: 'æŒ‡å®šã‚¹ã‚¿ãƒƒãƒ•ID', label: 'æŒ‡å®šã‚¹ã‚¿ãƒƒãƒ•ã¯ï¼Ÿï¼ˆè¤‡æ•°å¯ï¼‰', type: 'staffMultiSelect' },
        { key: 'staffType', header: 'æŒ‡å®šã‚¿ã‚¤ãƒ—', label: 'æŒ‡å®šã‚¿ã‚¤ãƒ—ã¯ï¼Ÿ', type: 'select', options: ['', 'å¿…é ˆ', 'å„ªå…ˆ'] },
        { key: 'ngStaff', header: 'NGã‚¹ã‚¿ãƒƒãƒ•ID', label: 'NGã‚¹ã‚¿ãƒƒãƒ•ã¯ï¼Ÿï¼ˆè¤‡æ•°å¯ï¼‰', type: 'staffMultiSelect' },
        { key: 'contPref', header: 'ç¶™ç¶šå¸Œæœ›', label: 'ç¶™ç¶šå¸Œæœ›ã¯ï¼Ÿ', type: 'select', options: ['ã©ã¡ã‚‰ã§ã‚‚', 'åŒã˜äººå¸Œæœ›', 'ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å„ªå…ˆ'] },
        { key: 'note', header: 'å‚™è€ƒ', label: 'å‚™è€ƒï¼ˆä»»æ„ï¼‰', type: 'textarea' }
      ],
      'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿': [
        { key: 'staff_id', header: 'staff_id', label: 'ã‚¹ã‚¿ãƒƒãƒ•IDã‚’ç™ºè¡Œã—ã¾ã™', type: 'autoId', prefix: 'S', required: true },
        { key: 'staffName', header: 'ã‚¹ã‚¿ãƒƒãƒ•å', label: 'ã‚¹ã‚¿ãƒƒãƒ•åã¯ï¼Ÿ', type: 'text', required: true },
        { key: 'sex', header: 'æ€§åˆ¥', label: 'æ€§åˆ¥ã¯ï¼Ÿ', type: 'select', options: ['', 'ç”·æ€§', 'å¥³æ€§'] },
        { key: 'baseAddress', header: 'æ‹ ç‚¹ä½æ‰€', label: 'æ‹ ç‚¹ä½æ‰€ã¯ï¼Ÿ', type: 'textarea' },
        { key: 'shiftStart', header: 'ã‚·ãƒ•ãƒˆé–‹å§‹', label: 'ã‚·ãƒ•ãƒˆé–‹å§‹æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', required: true },
        { key: 'shiftEnd', header: 'ã‚·ãƒ•ãƒˆçµ‚äº†', label: 'ã‚·ãƒ•ãƒˆçµ‚äº†æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', required: true },
        { key: 'workDays', header: 'å‹¤å‹™æ›œæ—¥', label: 'å‹¤å‹™å¯èƒ½ãªæ›œæ—¥ã¯ï¼Ÿï¼ˆè¤‡æ•°é¸æŠï¼‰', type: 'multiSelect', options: ['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'], required: true },
        { key: 'areas', header: 'å¾—æ„ã‚¨ãƒªã‚¢', label: 'å¾—æ„ã‚¨ãƒªã‚¢ã¯ï¼Ÿ', type: 'text', hint: 'â€»ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨' },
        { key: 'maxPerDay', header: 'æœ€å¤§è¨ªå•ä»¶æ•°/æ—¥', label: '1æ—¥ã®æœ€å¤§è¨ªå•ä»¶æ•°ã¯ï¼Ÿ', type: 'number', required: true, min: 1 },
        { key: 'skill', header: 'ã‚¹ã‚­ãƒ«', label: 'ã‚¹ã‚­ãƒ«ã¯ï¼Ÿ', type: 'select', options: ['', 'ãƒ™ãƒ†ãƒ©ãƒ³', 'ä¸­å …', 'æ–°äºº'], hint: 'â€»ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—ã«æœªä½¿ç”¨' },
        { key: 'note', header: 'å‚™è€ƒ', label: 'å‚™è€ƒï¼ˆä»»æ„ï¼‰', type: 'textarea' }
      ],
      'å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ': [
        { key: 'change_id', header: 'change_id', label: 'å¤‰æ›´IDã‚’ç™ºè¡Œã—ã¾ã™', type: 'autoId', prefix: 'C', required: true },
        { key: 'patient_id', header: 'patient_id', label: 'å¯¾è±¡ã®æ‚£è€…ã¯ï¼Ÿ', type: 'patientSelect', required: true },
        { key: 'date', header: 'æ—¥ä»˜', label: 'å¤‰æ›´æ—¥ï¼ˆè¨ªå•æ—¥ï¼‰ã¯ï¼Ÿ', type: 'date', required: true },
        { key: 'operation', header: 'æ“ä½œ', label: 'æ“ä½œå†…å®¹ã¯ï¼Ÿ', type: 'select', options: ['æ™‚é–“å¤‰æ›´', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'è¿½åŠ '], required: true },
        { key: 'start', header: 'æ–°é–‹å§‹æ™‚åˆ»', label: 'æ–°ã—ã„é–‹å§‹æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', hint: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ç©ºæ¬„å¯' },
        { key: 'end', header: 'æ–°çµ‚äº†æ™‚åˆ»', label: 'æ–°ã—ã„çµ‚äº†æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', hint: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ç©ºæ¬„å¯' },
        { key: 'note', header: 'å‚™è€ƒ', label: 'å‚™è€ƒï¼ˆä»»æ„ï¼‰', type: 'textarea' }
      ],
      'ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´': [
        { key: 'staff_change_id', header: 'staff_change_id', label: 'ã‚¹ã‚¿ãƒƒãƒ•å¤‰æ›´IDã‚’ç™ºè¡Œã—ã¾ã™', type: 'autoId', prefix: 'SC', required: true },
        { key: 'staff_id', header: 'staff_id', label: 'å¯¾è±¡ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯ï¼Ÿ', type: 'staffSelect', required: true },
        { key: 'date', header: 'æ—¥ä»˜', label: 'å¤‰æ›´æ—¥ã¯ï¼Ÿ', type: 'date', required: true },
        { key: 'restrictionType', header: 'åˆ¶é™ã‚¿ã‚¤ãƒ—', label: 'åˆ¶é™ã‚¿ã‚¤ãƒ—ã¯ï¼Ÿ', type: 'select', options: ['ä¼‘ã¿', 'åˆå‰ä¼‘', 'åˆå¾Œä¼‘', 'é…åˆ»', 'æ—©é€€', 'æ™‚é–“æŒ‡å®š'], required: true },
        { key: 'startTime', header: 'é–‹å§‹æ™‚åˆ»', label: 'é–‹å§‹æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', conditionalOn: { key: 'restrictionType', value: ['é…åˆ»', 'æ™‚é–“æŒ‡å®š'] }, hint: 'é…åˆ»: å‡ºå‹¤äºˆå®šæ™‚åˆ» / æ™‚é–“æŒ‡å®š: ä¸å¯é–‹å§‹æ™‚åˆ»' },
        { key: 'endTime', header: 'çµ‚äº†æ™‚åˆ»', label: 'çµ‚äº†æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', conditionalOn: { key: 'restrictionType', value: ['æ—©é€€', 'æ™‚é–“æŒ‡å®š'] }, hint: 'æ—©é€€: é€€å‹¤äºˆå®šæ™‚åˆ» / æ™‚é–“æŒ‡å®š: ä¸å¯çµ‚äº†æ™‚åˆ»' },
        { key: 'reason', header: 'ç†ç”±', label: 'ç†ç”±ã¯ï¼Ÿ', type: 'textarea' },
        { key: 'note', header: 'å‚™è€ƒ', label: 'å‚™è€ƒï¼ˆä»»æ„ï¼‰', type: 'textarea' }
      ],
      'ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ': [
        { key: 'event_id', header: 'event_id', label: 'ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ç™ºè¡Œã—ã¾ã™', type: 'autoId', prefix: 'EV', required: true },
        { key: 'date', header: 'æ—¥ä»˜', label: 'ã‚¤ãƒ™ãƒ³ãƒˆã®æ—¥ä»˜ã¯ï¼Ÿ', type: 'date', required: true },
        { key: 'staff_id', header: 'staff_id', label: 'æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•ã¯ï¼Ÿ', type: 'staffSelect', required: true },
        { key: 'eventType', header: 'ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥', label: 'ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥ã¯ï¼Ÿ', type: 'select', options: ['ç—…é™¢åŒè¡Œ', 'æ–°è¦é¢ä¼š/å¥‘ç´„', 'ä¼šè­°/æ‰“åˆã›', 'å½¹æ‰€/æ‰‹ç¶šã', 'å¾Œè¦‹äºº/å¼è­·å£«åŒå¸­', 'äº‹å‹™ä½œæ¥­ï¼ˆå¤–å‡ºï¼‰', 'ãã®ä»–'], required: true },
        { key: 'title', header: 'ã‚¿ã‚¤ãƒˆãƒ«', label: 'ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç°¡å˜ãªåç§°ï¼‰ã¯ï¼Ÿ', type: 'text', required: true },
        { key: 'address', header: 'ä½æ‰€', label: 'é–‹å‚¬å ´æ‰€ã®ä½æ‰€ã¯ï¼Ÿ', type: 'text', required: true, hint: 'ä½ç½®æƒ…å ±ã¯å¾Œã‹ã‚‰ã€Œä½ç½®æƒ…å ±ã‚’æ›´æ–°ã€ã§å–å¾—ã§ãã¾ã™' },
        { key: 'timeMode', header: 'æ™‚é–“æŒ‡å®šæ–¹æ³•', label: 'æ™‚é–“ã®æŒ‡å®šæ–¹æ³•ã¯ï¼Ÿ', type: 'select', options: ['æ™‚é–“æŒ‡å®š', 'åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥'], required: true },
        { key: 'startTime', header: 'é–‹å§‹æ™‚åˆ»', label: 'é–‹å§‹æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', conditionalOn: { key: 'timeMode', value: 'æ™‚é–“æŒ‡å®š' }, required: true },
        { key: 'endTime', header: 'çµ‚äº†æ™‚åˆ»', label: 'çµ‚äº†æ™‚åˆ»ã¯ï¼Ÿ', type: 'time', conditionalOn: { key: 'timeMode', value: 'æ™‚é–“æŒ‡å®š' }, required: true },
        { key: 'durationMin', header: 'æ‰€è¦æ™‚é–“(åˆ†)', label: 'æ‰€è¦æ™‚é–“ã¯ä½•åˆ†ï¼Ÿ', type: 'number', conditionalOn: { key: 'timeMode', value: ['åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥'] }, hint: 'åˆå‰/åˆå¾Œ/çµ‚æ—¥ã®å ´åˆã«å¿…è¦', required: true },
        { key: 'fixedSlot', header: 'å›ºå®šæ ', label: 'ã“ã®æ ã¯å›ºå®šã§ã™ã‹ï¼Ÿï¼ˆå‹•ã‹ã›ãªã„ï¼‰', type: 'toggle', required: true },
        { key: 'patientLinked', header: 'æ‚£è€…ç´ã¥ã', label: 'æ‚£è€…ã¨ç´ã¥ãã‚¤ãƒ™ãƒ³ãƒˆã§ã™ã‹ï¼Ÿ', type: 'toggle', required: true },
        { key: 'patient_id', header: 'patient_id', label: 'å¯¾è±¡æ‚£è€…ã¯ï¼Ÿ', type: 'patientSelect', conditionalOn: { key: 'patientLinked', value: true } },
        { key: 'patientAffect', header: 'æ‚£è€…å½±éŸ¿', label: 'æ‚£è€…å´ã¸ã®å½±éŸ¿ã¯ï¼Ÿ', type: 'select', options: ['è¨ªå•ä¸å¯', 'æ™‚é–“å›ºå®š', 'æƒ…å ±ã®ã¿'], conditionalOn: { key: 'patientLinked', value: true }, hint: 'è¨ªå•ä¸å¯:ãã®æ™‚é–“ã¯NG / æ™‚é–“å›ºå®š:ã‚¤ãƒ™ãƒ³ãƒˆã«åˆã‚ã›ã‚‹ / æƒ…å ±ã®ã¿:æ‚£è€…å´åˆ¶ç´„ãªã—' },
        { key: 'returnBefore', header: 'äº‹å‰äº‹å‹™æ‰€æˆ»ã‚Š', label: 'äº‹å‹™æ‰€ã«æˆ»ã£ã¦ã‹ã‚‰å‘ã‹ã†ï¼Ÿ', type: 'toggle' },
        { key: 'returnAfter', header: 'äº‹å¾Œäº‹å‹™æ‰€æˆ»ã‚Š', label: 'çµ‚äº†å¾Œã«äº‹å‹™æ‰€ã¸æˆ»ã‚‹ï¼Ÿ', type: 'toggle' },
        { key: 'reason', header: 'ç†ç”±', label: 'ç†ç”±ã‚„ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰', type: 'textarea' },
        { key: 'notes', header: 'å‚™è€ƒ', label: 'å‚™è€ƒï¼ˆä»»æ„ï¼‰', type: 'textarea' }
      ]
    };

    // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰çŠ¶æ…‹
    var wizardState = {
      active: false,
      formType: null,
      schema: [],
      currentStep: -1,  // -1 = ãƒ•ã‚©ãƒ¼ãƒ é¸æŠ, 0~ = è³ªå•
      answers: {},
      chatHistory: []
    };

    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ç”¨ï¼‰
    function reloadWizardData(callback) {
      var loadCount = 0;
      var totalLoads = 2;

      function checkComplete() {
        loadCount++;
        if (loadCount >= totalLoads && callback) callback();
      }

      // æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            dictionaries = result.data;
            patientOptions = [];
            for (var pid in dictionaries.patients) {
              patientOptions.push({
                id: pid,
                name: dictionaries.patients[pid],
                label: pid + ' ' + dictionaries.patients[pid]
              });
            }
            patientOptions.sort(function(a, b) { return a.id.localeCompare(b.id); });
          }
          checkComplete();
        })
        .withFailureHandler(function(e) {
          console.error('Failed to load dictionaries:', e);
          checkComplete();
        })
        .input_getDictionaries();

      // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      google.script.run
        .withSuccessHandler(function(options) {
          staffOptions = options || [];
          checkComplete();
        })
        .withFailureHandler(function(e) {
          console.error('Failed to load staff options:', e);
          checkComplete();
        })
        .input_getStaffOptions();
    }

    // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’é–‹ã
    function openWizard() {
      wizardState = {
        active: true,
        formType: null,
        schema: [],
        currentStep: -1,
        answers: {},
        chatHistory: []
      };
      document.getElementById('wizardPanel').classList.add('active');
      document.getElementById('wizardTitle').textContent = 'æ–°è¦ç™»éŒ²ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰';

      // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã¯å†èª­ã¿è¾¼ã¿
      if (patientOptions.length === 0 || staffOptions.length === 0) {
        document.getElementById('wizardInputContainer').innerHTML = '<div style="text-align:center; color:#666;">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
        reloadWizardData(function() {
          renderWizardStep();
        });
      } else {
        renderWizardStep();
      }
    }

    // ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
    function closeWizard() {
      if (wizardState.currentStep > 0 && !confirm('å…¥åŠ›å†…å®¹ã‚’ç ´æ£„ã—ã¦ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ')) return;
      wizardState.active = false;
      document.getElementById('wizardPanel').classList.remove('active');
    }

    // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æç”»
    function renderWizardStep() {
      var chatEl = document.getElementById('wizardChat');
      var questionEl = document.getElementById('wizardQuestion');
      var hintEl = document.getElementById('wizardHint');
      var inputEl = document.getElementById('wizardInputContainer');
      var errorEl = document.getElementById('wizardError');
      var backBtn = document.getElementById('wizardBackBtn');
      var skipBtn = document.getElementById('wizardSkipBtn');
      var nextBtn = document.getElementById('wizardNextBtn');
      var progressBar = document.getElementById('wizardProgressBar');

      errorEl.textContent = '';

      // ãƒ•ã‚©ãƒ¼ãƒ é¸æŠã‚¹ãƒ†ãƒƒãƒ—
      if (wizardState.currentStep === -1) {
        questionEl.textContent = 'ã©ã®ç™»éŒ²ã‚’ã—ã¾ã™ã‹ï¼Ÿ';
        hintEl.textContent = '';
        inputEl.innerHTML = '<select id="wizardFormSelect">' +
          '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>' +
          '<option value="æ‚£è€…ãƒã‚¹ã‚¿">æ‚£è€…ãƒã‚¹ã‚¿</option>' +
          '<option value="ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿">ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</option>' +
          '<option value="å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ">æ‚£è€…å€‹åˆ¥å¤‰æ›´</option>' +
          '<option value="ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´">ã‚¹ã‚¿ãƒƒãƒ•å€‹åˆ¥å¤‰æ›´</option>' +
          '<option value="ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ">ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ</option>' +
          '</select>';
        backBtn.disabled = true;
        skipBtn.style.display = 'none';
        nextBtn.textContent = 'é–‹å§‹';
        progressBar.style.width = '0%';
        chatEl.innerHTML = '<div class="chat-message bot"><div class="chat-label">ã‚·ã‚¹ãƒ†ãƒ </div><div class="chat-bubble">ã“ã‚“ã«ã¡ã¯ï¼æ–°è¦ç™»éŒ²ã‚’å¯¾è©±å½¢å¼ã§ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚ã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ</div></div>';
        return;
      }

      var schema = wizardState.schema;
      var step = schema[wizardState.currentStep];
      var progress = ((wizardState.currentStep + 1) / schema.length) * 100;
      progressBar.style.width = progress + '%';

      // ç¢ºèªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæœ€å¾Œï¼‰
      if (wizardState.currentStep >= schema.length) {
        questionEl.textContent = 'å…¥åŠ›å†…å®¹ã®ç¢ºèª';
        hintEl.textContent = 'å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„';
        inputEl.innerHTML = renderPreview();
        backBtn.disabled = false;
        skipBtn.style.display = 'none';
        nextBtn.textContent = 'ç™»éŒ²';
        nextBtn.className = 'wizard-btn success';
        progressBar.style.width = '100%';
        return;
      }

      // é€šå¸¸ã®è³ªå•ã‚¹ãƒ†ãƒƒãƒ—
      questionEl.textContent = step.label;
      hintEl.textContent = step.hint || '';
      inputEl.innerHTML = renderWizardInput(step);
      backBtn.disabled = wizardState.currentStep === 0;
      skipBtn.style.display = step.required ? 'none' : 'inline-block';
      nextBtn.textContent = 'æ¬¡ã¸';
      nextBtn.className = 'wizard-btn primary';

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      var firstInput = inputEl.querySelector('input, select, textarea');
      if (firstInput) firstInput.focus();

      // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
      renderChatHistory();
    }

    // å…¥åŠ›UIã‚’ç”Ÿæˆ
    function renderWizardInput(step) {
      var currentVal = wizardState.answers[step.key] || step.defaultValue || '';

      switch (step.type) {
        case 'autoId':
          return '<div style="padding:10px; background:#f0f0f0; border-radius:6px; text-align:center; color:#666;">è‡ªå‹•ç™ºè¡Œï¼ˆ' + step.prefix + 'é€£ç•ªï¼‰</div>';
        case 'text':
          return '<input type="text" id="wizardInput" value="' + escapeHtml(currentVal) + '" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„" />';
        case 'textarea':
          return '<textarea id="wizardInput" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„">' + escapeHtml(currentVal) + '</textarea>';
        case 'number':
          return '<input type="number" id="wizardInput" value="' + escapeHtml(currentVal) + '" ' + (step.min !== undefined ? 'min="' + step.min + '"' : '') + ' placeholder="æ•°å€¤ã‚’å…¥åŠ›" />';
        case 'date':
          return '<input type="date" id="wizardInput" value="' + escapeHtml(currentVal) + '" />';
        case 'time':
          var timeVal = currentVal ? String(currentVal).substring(0, 5) : '';
          return '<select id="wizardInput"><option value="">-- é¸æŠ --</option>' + TIME_OPTIONS.map(function(t) {
            return '<option value="' + t + '"' + (t === timeVal ? ' selected' : '') + '>' + t + '</option>';
          }).join('') + '</select>';
        case 'select':
          return '<select id="wizardInput">' + step.options.map(function(opt) {
            return '<option value="' + escapeHtml(opt) + '"' + (opt === currentVal ? ' selected' : '') + '>' + (opt || '-- é¸æŠ --') + '</option>';
          }).join('') + '</select>';
        case 'multiSelect':
          var selected = currentVal ? currentVal.split(',') : [];
          return '<div class="wizard-checkboxes">' + step.options.map(function(opt) {
            var checked = selected.indexOf(opt) >= 0 ? ' checked' : '';
            return '<label><input type="checkbox" value="' + escapeHtml(opt) + '"' + checked + '>' + escapeHtml(opt) + '</label>';
          }).join('') + '</div>';
        case 'staffMultiSelect':
          var selectedStaff = currentVal ? currentVal.split(',') : [];
          if (staffOptions.length === 0) return '<div style="color:#999;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return '<div class="wizard-checkboxes" style="max-height:120px; overflow-y:auto;">' + staffOptions.map(function(s) {
            var checked = selectedStaff.indexOf(s.id) >= 0 ? ' checked' : '';
            return '<label><input type="checkbox" value="' + escapeHtml(s.id) + '"' + checked + '>' + escapeHtml(s.label) + '</label>';
          }).join('') + '</div>';
        case 'patientSelect':
          if (patientOptions.length === 0) return '<div style="color:#999;">æ‚£è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return '<select id="wizardInput"><option value="">-- é¸æŠ --</option>' + patientOptions.map(function(p) {
            return '<option value="' + escapeHtml(p.id) + '"' + (p.id === currentVal ? ' selected' : '') + '>' + escapeHtml(p.label) + '</option>';
          }).join('') + '</select>';
        case 'staffSelect':
          if (staffOptions.length === 0) return '<div style="color:#999;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return '<select id="wizardInput"><option value="">-- é¸æŠ --</option>' + staffOptions.map(function(s) {
            return '<option value="' + escapeHtml(s.id) + '"' + (s.id === currentVal ? ' selected' : '') + '>' + escapeHtml(s.label) + '</option>';
          }).join('') + '</select>';
        case 'toggle':
          var isTrue = currentVal === true || currentVal === 'TRUE' || currentVal === 'true';
          return '<select id="wizardInput">' +
            '<option value="FALSE"' + (!isTrue ? ' selected' : '') + '>ã„ã„ãˆ</option>' +
            '<option value="TRUE"' + (isTrue ? ' selected' : '') + '>ã¯ã„</option>' +
            '</select>';
        default:
          return '<input type="text" id="wizardInput" value="' + escapeHtml(currentVal) + '" />';
      }
    }

    // å…¥åŠ›å€¤ã‚’å–å¾—
    function getWizardInputValue() {
      var input = document.getElementById('wizardInput');
      if (input) return input.value;

      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆè¤‡æ•°é¸æŠï¼‰
      var checkboxes = document.querySelectorAll('#wizardInputContainer input[type="checkbox"]');
      if (checkboxes.length > 0) {
        var vals = [];
        checkboxes.forEach(function(cb) { if (cb.checked) vals.push(cb.value); });
        return vals.join(',');
      }
      return '';
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    function validateWizardInput(step, value) {
      if (step.type === 'autoId') return null; // è‡ªå‹•ãªã®ã§OK
      if (step.required && (!value || value.trim() === '')) return 'å¿…é ˆé …ç›®ã§ã™';
      if (step.type === 'number' && value) {
        var num = parseFloat(value);
        if (isNaN(num)) return 'æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        if (step.min !== undefined && num < step.min) return step.min + 'ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
      }
      if (step.type === 'multiSelect' && step.required && (!value || value.trim() === '')) return '1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„';
      return null;
    }

    // æ™‚é–“è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function addMinutesToTimeStr(timeStr, minutes) {
      var parts = timeStr.split(':');
      var h = parseInt(parts[0], 10);
      var m = parseInt(parts[1], 10);
      var totalMin = h * 60 + m + minutes;
      var newH = Math.floor(totalMin / 60) % 24;
      var newM = totalMin % 60;
      return String(newH).padStart(2, '0') + ':' + String(newM).padStart(2, '0') + ':00';
    }

    function subtractMinutesFromTimeStr(timeStr, minutes) {
      return addMinutesToTimeStr(timeStr, -minutes);
    }

    // æ¡ä»¶ä»˜ãã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã¹ãã‹åˆ¤å®š
    // conditionalOn.value ã¯æ–‡å­—åˆ—ã¾ãŸã¯é…åˆ—ã‚’ã‚µãƒãƒ¼ãƒˆ
    function shouldSkipStep(step) {
      if (!step.conditionalOn) return false;
      var condKey = step.conditionalOn.key;
      var condValue = step.conditionalOn.value;
      var currentValue = wizardState.answers[condKey];

      // booleanå€¤ã®æ­£è¦åŒ–ï¼ˆTRUE/FALSEæ–‡å­—åˆ—ã‚’booleanã«å¤‰æ›ï¼‰
      var normalizedCurrent = currentValue;
      if (currentValue === 'TRUE' || currentValue === 'true') normalizedCurrent = true;
      if (currentValue === 'FALSE' || currentValue === 'false') normalizedCurrent = false;

      // value ãŒé…åˆ—ã®å ´åˆã€ã„ãšã‚Œã‹ã«ä¸€è‡´ã™ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„
      if (Array.isArray(condValue)) {
        return condValue.indexOf(currentValue) === -1 && condValue.indexOf(normalizedCurrent) === -1;
      }
      // å˜ä¸€å€¤ã®å ´åˆï¼ˆbooleanæ¯”è¼ƒã‚‚å«ã‚€ï¼‰
      return currentValue !== condValue && normalizedCurrent !== condValue;
    }


    // æ¬¡ã®æœ‰åŠ¹ãªã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€
    function advanceToNextValidStep() {
      var schema = wizardState.schema;
      wizardState.currentStep++;
      // æ¡ä»¶ä»˜ãã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—
      while (wizardState.currentStep < schema.length && shouldSkipStep(schema[wizardState.currentStep])) {
        wizardState.currentStep++;
      }
    }

    // æ¬¡ã¸
    function wizardNext() {
      var errorEl = document.getElementById('wizardError');

      // ãƒ•ã‚©ãƒ¼ãƒ é¸æŠ
      if (wizardState.currentStep === -1) {
        var formSelect = document.getElementById('wizardFormSelect');
        var formType = formSelect ? formSelect.value : '';
        if (!formType) {
          errorEl.textContent = 'ç™»éŒ²ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„';
          return;
        }
        wizardState.formType = formType;
        wizardState.schema = FORM_SCHEMA[formType] || [];
        wizardState.currentStep = 0;
        document.getElementById('wizardTitle').textContent = formType + ' - æ–°è¦ç™»éŒ²';
        addChatMessage('user', formType);
        addChatMessage('bot', 'ã§ã¯ã€' + formType + 'ã®ç™»éŒ²ã‚’å§‹ã‚ã¾ã™ã€‚é †ç•ªã«è³ªå•ã—ã¦ã„ãã¾ã™ã­ã€‚');
        renderWizardStep();
        return;
      }

      var schema = wizardState.schema;

      // ç¢ºèªã‚¹ãƒ†ãƒƒãƒ— â†’ ç™»éŒ²å®Ÿè¡Œ
      if (wizardState.currentStep >= schema.length) {
        submitWizard();
        return;
      }

      // é€šå¸¸ã‚¹ãƒ†ãƒƒãƒ—
      var step = schema[wizardState.currentStep];
      var value = getWizardInputValue();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      var error = validateWizardInput(step, value);
      if (error) {
        errorEl.textContent = error;
        return;
      }

      // å€¤ã‚’æ­£è¦åŒ–ã—ã¦ä¿å­˜
      if (step.type === 'time' && value) {
        value = value + ':00'; // HH:MM â†’ HH:MM:SS
      }
      wizardState.answers[step.key] = value;

      // ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ 
      var displayValue = formatAnswerForDisplay(step, value);
      if (step.type !== 'autoId') {
        addChatMessage('user', displayValue || 'ï¼ˆæœªå…¥åŠ›ï¼‰');
      }

      // æ™‚é–“ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãè‡ªå‹•æ™‚é–“è¨­å®š
      if (step.key === 'timeType') {
        var autoTimeSet = null;
        if (value === 'åˆå‰') {
          autoTimeSet = { start: '09:00:00', end: '12:00:00', label: 'åˆå‰ï¼ˆ09:00ã€œ12:00ï¼‰' };
        } else if (value === 'åˆå¾Œ') {
          autoTimeSet = { start: '13:00:00', end: '17:00:00', label: 'åˆå¾Œï¼ˆ13:00ã€œ17:00ï¼‰' };
        } else if (value === 'çµ‚æ—¥') {
          autoTimeSet = { start: '09:00:00', end: '18:00:00', label: 'çµ‚æ—¥ï¼ˆ09:00ã€œ18:00ï¼‰' };
        }
        // åˆå‰/åˆå¾Œ/çµ‚æ—¥ã®å ´åˆã€æ™‚é–“ã‚’è‡ªå‹•è¨­å®šã—è³ªå•ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (autoTimeSet) {
          wizardState.answers['timeStart'] = autoTimeSet.start;
          wizardState.answers['timeEnd'] = autoTimeSet.end;
          addChatMessage('bot', 'æ™‚é–“ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸ: ' + autoTimeSet.label);
          // fixedTarget, timeStart, timeEnd ã‚’ã‚¹ã‚­ãƒƒãƒ—
          wizardState.currentStep++;
          while (wizardState.currentStep < schema.length) {
            var nextKey = schema[wizardState.currentStep].key;
            if (nextKey === 'fixedTarget' || nextKey === 'timeStart' || nextKey === 'timeEnd') {
              wizardState.currentStep++;
            } else {
              break;
            }
          }
          // æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
          if (wizardState.currentStep < schema.length) {
            addChatMessage('bot', schema[wizardState.currentStep].label);
          } else {
            addChatMessage('bot', 'å…¨ã¦ã®è³ªå•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
          renderWizardStep();
          return;
        }
        // å›ºå®šã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ã€fixedTargetã®è³ªå•ã¸é€²ã‚€
        if (value === 'å›ºå®š') {
          advanceToNextValidStep();
          if (wizardState.currentStep < schema.length) {
            addChatMessage('bot', schema[wizardState.currentStep].label);
          }
          renderWizardStep();
          return;
        }
      }

      // å›ºå®šã‚¿ã‚¤ãƒ—ã§é–‹å§‹/çµ‚äº†é¸æŠå¾Œã®å‡¦ç†
      if (step.key === 'fixedTarget') {
        var fixedTarget = value; // 'é–‹å§‹' or 'çµ‚äº†'
        advanceToNextValidStep();
        // fixedTargetã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´
        if (fixedTarget === 'é–‹å§‹') {
          addChatMessage('bot', 'å›ºå®šã™ã‚‹é–‹å§‹æ™‚åˆ»ã¯ï¼Ÿ');
        } else {
          // çµ‚äº†å›ºå®šã®å ´åˆã€timeStartã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦timeEndã¸
          if (wizardState.currentStep < schema.length && schema[wizardState.currentStep].key === 'timeStart') {
            wizardState.currentStep++;
          }
          addChatMessage('bot', 'å›ºå®šã™ã‚‹çµ‚äº†æ™‚åˆ»ã¯ï¼Ÿ');
        }
        renderWizardStep();
        return;
      }

      // å›ºå®šã‚¿ã‚¤ãƒ—ã§timeStartå…¥åŠ›å¾Œã€timeEndã‚’è‡ªå‹•è¨ˆç®—
      if (step.key === 'timeStart' && wizardState.answers['timeType'] === 'å›ºå®š' && wizardState.answers['fixedTarget'] === 'é–‹å§‹') {
        var serviceMin = parseInt(wizardState.answers['serviceMin'], 10) || 0;
        var calcEnd = addMinutesToTimeStr(value, serviceMin);
        wizardState.answers['timeEnd'] = calcEnd;
        addChatMessage('bot', 'çµ‚äº†æ™‚åˆ»ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã—ãŸ: ' + calcEnd.substring(0, 5));
        // timeEnd ã‚’ã‚¹ã‚­ãƒƒãƒ—
        wizardState.currentStep++;
        if (wizardState.currentStep < schema.length && schema[wizardState.currentStep].key === 'timeEnd') {
          wizardState.currentStep++;
        }
        if (wizardState.currentStep < schema.length) {
          addChatMessage('bot', schema[wizardState.currentStep].label);
        } else {
          addChatMessage('bot', 'å…¨ã¦ã®è³ªå•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        renderWizardStep();
        return;
      }

      // å›ºå®šã‚¿ã‚¤ãƒ—ã§timeEndå…¥åŠ›å¾Œã€timeStartã‚’è‡ªå‹•è¨ˆç®—
      if (step.key === 'timeEnd' && wizardState.answers['timeType'] === 'å›ºå®š' && wizardState.answers['fixedTarget'] === 'çµ‚äº†') {
        var serviceMin = parseInt(wizardState.answers['serviceMin'], 10) || 0;
        var calcStart = subtractMinutesFromTimeStr(value, serviceMin);
        wizardState.answers['timeStart'] = calcStart;
        addChatMessage('bot', 'é–‹å§‹æ™‚åˆ»ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã—ãŸ: ' + calcStart.substring(0, 5));
        advanceToNextValidStep();
        if (wizardState.currentStep < schema.length) {
          addChatMessage('bot', schema[wizardState.currentStep].label);
        } else {
          addChatMessage('bot', 'å…¨ã¦ã®è³ªå•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
        renderWizardStep();
        return;
      }

      // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
      advanceToNextValidStep();
      if (wizardState.currentStep < schema.length) {
        var nextStep = schema[wizardState.currentStep];
        addChatMessage('bot', nextStep.label);
      } else {
        addChatMessage('bot', 'å…¨ã¦ã®è³ªå•ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
      renderWizardStep();
    }

    // æˆ»ã‚‹
    function wizardBack() {
      if (wizardState.currentStep <= 0) return;
      wizardState.currentStep--;
      renderWizardStep();
    }

    // ã‚¹ã‚­ãƒƒãƒ—
    function wizardSkip() {
      var schema = wizardState.schema;
      var step = schema[wizardState.currentStep];
      if (step.required) return;
      wizardState.answers[step.key] = '';
      addChatMessage('user', 'ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰');
      wizardState.currentStep++;
      if (wizardState.currentStep < schema.length) {
        addChatMessage('bot', schema[wizardState.currentStep].label);
      }
      renderWizardStep();
    }

    // å›ç­”ã‚’è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatAnswerForDisplay(step, value) {
      if (!value) return '';
      if (step.type === 'staffMultiSelect') {
        return value.split(',').map(function(id) {
          var s = staffOptions.find(function(x) { return x.id === id; });
          return s ? s.label : id;
        }).join(', ');
      }
      if (step.type === 'staffSelect') {
        var s = staffOptions.find(function(x) { return x.id === value; });
        return s ? s.label : value;
      }
      if (step.type === 'patientSelect') {
        var p = patientOptions.find(function(x) { return x.id === value; });
        return p ? p.label : value;
      }
      if (step.type === 'time') {
        return value.substring(0, 5);
      }
      if (step.type === 'toggle') {
        return value === 'TRUE' ? 'ã¯ã„' : 'ã„ã„ãˆ';
      }
      return value;
    }

    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addChatMessage(role, text) {
      wizardState.chatHistory.push({ role: role, text: text });
    }

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æç”»
    function renderChatHistory() {
      var chatEl = document.getElementById('wizardChat');
      var html = wizardState.chatHistory.map(function(msg) {
        var labelText = msg.role === 'bot' ? 'ã‚·ã‚¹ãƒ†ãƒ ' : 'ã‚ãªãŸ';
        return '<div class="chat-message ' + msg.role + '"><div class="chat-label">' + labelText + '</div><div class="chat-bubble">' + escapeHtml(msg.text) + '</div></div>';
      }).join('');
      chatEl.innerHTML = html;
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
    function renderPreview() {
      var schema = wizardState.schema;
      var html = '<div class="wizard-preview"><table>';
      schema.forEach(function(step) {
        var value = wizardState.answers[step.key] || '';
        var displayValue = formatAnswerForDisplay(step, value);
        if (step.type === 'autoId') displayValue = 'ï¼ˆè‡ªå‹•ç™ºè¡Œï¼‰';
        html += '<tr><th>' + escapeHtml(step.header) + '</th><td>' + escapeHtml(displayValue || '-') + '</td></tr>';
      });
      html += '</table></div>';
      return html;
    }

    // ç™»éŒ²å®Ÿè¡Œ
    function submitWizard() {
      var nextBtn = document.getElementById('wizardNextBtn');
      var errorEl = document.getElementById('wizardError');
      nextBtn.disabled = true;
      nextBtn.textContent = 'ç™»éŒ²ä¸­...';
      errorEl.textContent = '';

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã‚’ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§é¸æŠã—ãŸã‚‚ã®ã«å›ºå®š
      var formType = wizardState.formType;
      var answers = wizardState.answers;

      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
      console.log('submitWizard: formType=', formType);
      console.log('submitWizard: answers=', JSON.stringify(answers));

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30ç§’ï¼‰
      var timeoutId = setTimeout(function() {
        nextBtn.disabled = false;
        nextBtn.textContent = 'ç™»éŒ²';
        errorEl.textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
      }, 30000);

      // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆæœ«å°¾ã«è¿½åŠ ï¼‰
      google.script.run
        .withSuccessHandler(function(result) {
          clearTimeout(timeoutId);
          console.log('submitWizard success:', result);
          nextBtn.disabled = false;
          nextBtn.textContent = 'ç™»éŒ²';
          if (result && result.success) {
            showToast('success', result.message || 'ç™»éŒ²ã—ã¾ã—ãŸ');
            wizardState.active = false;
            document.getElementById('wizardPanel').classList.remove('active');
            // ç™»éŒ²ã—ãŸãƒ•ã‚©ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã«å¯¾å¿œã™ã‚‹ã‚·ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãƒªãƒ­ãƒ¼ãƒ‰
            if (formType && formType !== currentSheetName) {
              loadSheet(formType);
            } else {
              reloadCurrentSheet();
            }
          } else {
            errorEl.textContent = (result && result.error) || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
          }
        })
        .withFailureHandler(function(e) {
          clearTimeout(timeoutId);
          console.error('submitWizard error:', e);
          nextBtn.disabled = false;
          nextBtn.textContent = 'ç™»éŒ²';
          errorEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e));
        })
        .input_createRowFromWizard(formType, answers, null);
    }

    // ============================================================
    // åŒè¡Œå‰²ä»˜ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰
    // ============================================================
    var mentorWizardState = {
      weekStart: null,  // Date
      traineeId: '',
      dayOffMap: {},    // "staffId|yyyy/MM/dd": true
      rows: []          // [{date, mentor, band, priority, status}]
    };
    var WEEKDAYS_LABEL = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];

    function getMonday(d) {
      var date = new Date(d);
      var day = date.getDay();
      var diff = date.getDate() - day + (day === 0 ? -6 : 1);
      date.setDate(diff);
      date.setHours(0, 0, 0, 0);
      return date;
    }

    function formatDateJP(d) {
      return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0');
    }

    function openMentorWizard() {
      var panel = document.getElementById('mentorWizardPanel');
      panel.classList.add('active');

      // ä»Šé€±ã®æœˆæ›œã‚’åˆæœŸå€¤
      mentorWizardState.weekStart = getMonday(new Date());
      updateMentorWeekDisplay();

      // æ–°äººãƒªã‚¹ãƒˆã‚’è¨­å®š
      var traineeSelect = document.getElementById('wizardTraineeSelect');
      traineeSelect.innerHTML = '<option value="">-- æ–°äººã‚’é¸æŠ --</option>';
      staffOptions.forEach(function(s) {
        // ã‚¹ã‚­ãƒ«=æ–°äººã‚’å„ªå…ˆè¡¨ç¤ºï¼ˆå…¨å“¡è¡¨ç¤ºï¼‰
        var label = s.label + (s.skill === 'æ–°äºº' ? ' â˜…æ–°äºº' : '');
        traineeSelect.innerHTML += '<option value="' + s.id + '">' + label + '</option>';
      });

      // ã‚°ãƒªãƒƒãƒ‰åˆæœŸåŒ–
      mentorWizardState.traineeId = '';
      mentorWizardState.rows = [];
      renderMentorGrid();
    }

    function closeMentorWizard() {
      document.getElementById('mentorWizardPanel').classList.remove('active');
    }

    function updateMentorWeekDisplay() {
      var start = mentorWizardState.weekStart;
      var end = new Date(start);
      end.setDate(end.getDate() + 6);
      document.getElementById('mentorWeekDisplay').textContent = formatDateJP(start) + ' ã€œ ' + formatDateJP(end);
      if (mentorWizardState.traineeId) {
        loadMentorPairsForWeek();
      }
    }

    function mentorWeekPrev() {
      mentorWizardState.weekStart.setDate(mentorWizardState.weekStart.getDate() - 7);
      updateMentorWeekDisplay();
      renderMentorGrid();
    }

    function mentorWeekNext() {
      mentorWizardState.weekStart.setDate(mentorWizardState.weekStart.getDate() + 7);
      updateMentorWeekDisplay();
      renderMentorGrid();
    }

    function onTraineeChange() {
      mentorWizardState.traineeId = document.getElementById('wizardTraineeSelect').value;
      if (mentorWizardState.traineeId) {
        loadMentorPairsForWeek();
      } else {
        mentorWizardState.rows = [];
        renderMentorGrid();
      }
    }

    function loadMentorPairsForWeek() {
      var start = mentorWizardState.weekStart;
      var end = new Date(start);
      end.setDate(end.getDate() + 6);

      google.script.run
        .withSuccessHandler(function(result) {
          // result: { pairs: [{date, mentor, band, priority}], dayOffMap: {...} }
          mentorWizardState.dayOffMap = result.dayOffMap || {};
          var existingPairs = result.pairs || [];

          // 7æ—¥åˆ†ã®è¡Œã‚’åˆæœŸåŒ–
          mentorWizardState.rows = [];
          for (var i = 0; i < 7; i++) {
            var d = new Date(start);
            d.setDate(d.getDate() + i);
            var dateStr = formatDateJP(d);

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°åæ˜ 
            var existing = existingPairs.find(function(p) { return p.date === dateStr; });
            mentorWizardState.rows.push({
              date: dateStr,
              weekday: WEEKDAYS_LABEL[i],
              mentor: existing ? existing.mentor : '',
              band: existing ? existing.band : 'çµ‚æ—¥',
              priority: existing ? existing.priority : 1
            });
          }
          renderMentorGrid();
        })
        .withFailureHandler(function(e) {
          console.error('loadMentorPairsForWeek error:', e);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã§åˆæœŸåŒ–
          mentorWizardState.rows = [];
          for (var i = 0; i < 7; i++) {
            var d = new Date(start);
            d.setDate(d.getDate() + i);
            mentorWizardState.rows.push({
              date: formatDateJP(d),
              weekday: WEEKDAYS_LABEL[i],
              mentor: '',
              band: 'çµ‚æ—¥',
              priority: 1
            });
          }
          renderMentorGrid();
        })
        .input_getMentorPairsForWeek(mentorWizardState.traineeId, formatDateJP(start), formatDateJP(end));
    }

    function renderMentorGrid() {
      var tbody = document.getElementById('mentorGridBody');
      var traineeId = mentorWizardState.traineeId;

      if (!traineeId || mentorWizardState.rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">æ–°äººã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
        return;
      }

      var html = '';
      mentorWizardState.rows.forEach(function(row, i) {
        var mentorOptions = '<option value="">-- æœªè¨­å®š --</option>';
        staffOptions.forEach(function(s) {
          if (s.id === traineeId) return; // traineeè‡ªèº«ã¯é™¤å¤–
          var selected = (s.id === row.mentor) ? ' selected' : '';
          mentorOptions += '<option value="' + s.id + '"' + selected + '>' + s.label + '</option>';
        });

        var bandOptions = ['çµ‚æ—¥', 'åˆå‰', 'åˆå¾Œ'].map(function(b) {
          return '<option value="' + b + '"' + (b === row.band ? ' selected' : '') + '>' + b + '</option>';
        }).join('');

        // çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
        var status = '';
        var statusClass = 'status-empty';
        if (row.mentor) {
          var traineeOff = mentorWizardState.dayOffMap[traineeId + '|' + row.date];
          var mentorOff = mentorWizardState.dayOffMap[row.mentor + '|' + row.date];
          if (traineeOff) {
            status = 'âš  æ–°äººä¼‘ã¿';
            statusClass = 'status-warn';
          } else if (mentorOff) {
            status = 'âš  ãƒ¡ãƒ³ã‚¿ãƒ¼ä¼‘ã¿';
            statusClass = 'status-warn';
          } else {
            status = 'âœ“ OK';
            statusClass = 'status-ok';
          }
        } else {
          status = 'æœªè¨­å®š';
        }

        html += '<tr>' +
          '<td>' + row.weekday + '</td>' +
          '<td>' + row.date + '</td>' +
          '<td><select id="mentorSelect_' + i + '" onchange="onMentorGridChange(' + i + ')">' + mentorOptions + '</select></td>' +
          '<td><select id="bandSelect_' + i + '" onchange="onMentorGridChange(' + i + ')">' + bandOptions + '</select></td>' +
          '<td class="' + statusClass + '">' + status + '</td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
    }

    function onMentorGridChange(idx) {
      var mentor = document.getElementById('mentorSelect_' + idx).value;
      var band = document.getElementById('bandSelect_' + idx).value;
      mentorWizardState.rows[idx].mentor = mentor;
      mentorWizardState.rows[idx].band = band;
      renderMentorGrid();
    }

    function applyAllDaysSameMentor() {
      var mentor = prompt('å…¨æ—¥ã«è¨­å®šã™ã‚‹ãƒ¡ãƒ³ã‚¿ãƒ¼ã®ã‚¹ã‚¿ãƒƒãƒ•IDã‚’å…¥åŠ›:\nï¼ˆä¾‹: S001ï¼‰');
      if (!mentor) return;
      mentorWizardState.rows.forEach(function(row) {
        row.mentor = mentor;
      });
      renderMentorGrid();
    }

    function applyWeekdayMentor() {
      var mentor = prompt('å¹³æ—¥ï¼ˆæœˆã€œé‡‘ï¼‰ã«è¨­å®šã™ã‚‹ãƒ¡ãƒ³ã‚¿ãƒ¼ã®ã‚¹ã‚¿ãƒƒãƒ•IDã‚’å…¥åŠ›:\nï¼ˆä¾‹: S001ï¼‰');
      if (!mentor) return;
      mentorWizardState.rows.forEach(function(row, i) {
        if (i < 5) row.mentor = mentor; // æœˆã€œé‡‘
      });
      renderMentorGrid();
    }

    function clearMentorGrid() {
      mentorWizardState.rows.forEach(function(row) {
        row.mentor = '';
        row.band = 'çµ‚æ—¥';
      });
      renderMentorGrid();
    }

    function saveMentorWizard() {
      var errorEl = document.getElementById('mentorWizardError');
      errorEl.textContent = '';

      if (!mentorWizardState.traineeId) {
        errorEl.textContent = 'æ–°äººã‚’é¸æŠã—ã¦ãã ã•ã„';
        return;
      }

      var start = mentorWizardState.weekStart;
      var end = new Date(start);
      end.setDate(end.getDate() + 6);

      // mentor ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹è¡Œã®ã¿ä¿å­˜
      var rowsToSave = mentorWizardState.rows.filter(function(row) {
        return row.mentor && row.mentor.trim() !== '';
      }).map(function(row) {
        return {
          date: row.date,
          mentor: row.mentor,
          band: row.band,
          priority: row.priority || 1
        };
      });

      var saveBtn = document.getElementById('btnSaveMentorWizard');
      saveBtn.disabled = true;
      saveBtn.textContent = 'ä¿å­˜ä¸­...';

      google.script.run
        .withSuccessHandler(function(result) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'ä¿å­˜';
          if (result && result.success) {
            showToast('success', 'åŒè¡Œå‰²ä»˜ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ' + result.savedCount + 'ä»¶ï¼‰');
            closeMentorWizard();
            // ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜ã‚¿ãƒ–ã«ã„ã‚‹å ´åˆã¯å†èª­ã¿è¾¼ã¿
            if (currentSheetName === 'ã‚¹ã‚¿ãƒƒãƒ•åŒè¡Œå‰²ä»˜') {
              reloadCurrentSheet();
            }
          } else {
            errorEl.textContent = (result && result.error) || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
          }
        })
        .withFailureHandler(function(e) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'ä¿å­˜';
          errorEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e));
        })
        .input_saveMentorPairsWizard({
          traineeId: mentorWizardState.traineeId,
          from: formatDateJP(start),
          to: formatDateJP(end),
          rows: rowsToSave
        });
    }
  </script>
</body>
</html>
