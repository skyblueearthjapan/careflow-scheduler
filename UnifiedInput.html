<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    /* ============================================================
       よりよりブランドカラー
       ============================================================ */
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
      --color-disabled: #CCCCCC;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }

    /* ============================================================
       ヘッダー
       ============================================================ */
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-badge {
      font-size: 11px;
      background: var(--color-orange);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    .header-status {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* ============================================================
       AIチャット・一括入力エリア（将来用プレースホルダー）
       ============================================================ */
    .ai-input-area {
      background: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      padding: 12px 20px;
    }

    .ai-input-container {
      display: flex;
      gap: 12px;
      align-items: stretch;
      opacity: 0.6;
    }

    .ai-chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--color-yellow-light);
      border: 1px dashed var(--color-yellow);
      border-radius: 8px;
    }

    .ai-chat-box .placeholder-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-orange-dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-chat-box textarea {
      flex: 1;
      min-height: 50px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 8px;
      resize: none;
      font-size: 13px;
    }

    .ai-chat-box textarea:disabled {
      background: var(--color-bg);
      cursor: not-allowed;
    }

    .bulk-input-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--color-blue-light);
      border: 1px dashed var(--color-blue);
      border-radius: 8px;
      opacity: 0.7;
    }

    .bulk-input-box .placeholder-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-blue-dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bulk-input-box textarea {
      flex: 1;
      min-height: 50px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 8px;
      resize: none;
      font-size: 13px;
    }

    .coming-soon-badge {
      font-size: 10px;
      background: var(--color-disabled);
      color: var(--color-white);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }

    .disabled-btn {
      padding: 6px 14px;
      background: var(--color-disabled);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: not-allowed;
    }

    /* ============================================================
       メインコンテンツ
       ============================================================ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .left-panel {
      flex: 1;
      padding: 16px;
      overflow: auto;
      background: var(--color-white);
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--color-yellow-light);
      border-radius: 8px;
      border: 1px solid var(--color-yellow);
      font-size: 13px;
    }

    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }

    .refresh-btn {
      padding: 6px 14px;
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: var(--color-disabled); cursor: not-allowed; }

    #mainContent {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-container {
      flex: 1;
      overflow: auto;
      border: 1px solid var(--color-green-light);
      border-radius: 8px;
    }

    .data-table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    .data-table th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--color-blue-dark);
      white-space: nowrap;
      z-index: 10;
    }

    .data-table td {
      border: 1px solid var(--color-border);
      padding: 8px 12px;
      background: var(--color-white);
      white-space: nowrap;
    }

    .data-table tbody tr:nth-child(even) td { background: #FDFDFB; }
    .data-table tbody tr:hover td { background: var(--color-blue-light); }

    /* ============================================================
       右パネル（将来用）
       ============================================================ */
    .right-panel {
      width: 240px;
      border-left: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .operation-group {
      margin-bottom: 20px;
      opacity: 0.6;
    }

    .operation-group-title {
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .operation-btn {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 8px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-bg);
      color: var(--color-text-light);
      font-size: 12px;
      text-align: left;
      cursor: not-allowed;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .operation-btn .icon { font-size: 14px; }

    .info-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .info-item {
      font-size: 11px;
      color: var(--color-text-light);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .info-item .label { color: var(--color-text); }

    /* ============================================================
       下部タブバー
       ============================================================ */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-top: 1px solid var(--color-green-light);
      background: var(--color-white);
    }

    .tabs-left { display: flex; gap: 8px; }

    .tab-btn {
      border: 1px solid var(--color-green-light);
      background: var(--color-white);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text);
      transition: all 0.2s ease;
    }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active {
      background: var(--color-green);
      border-color: var(--color-green);
      color: var(--color-white);
    }

    .tabs-right { display: flex; gap: 8px; }

    .nav-link {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--color-green);
      background: var(--color-green-light);
      border-radius: 8px;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      background: var(--color-green);
      color: var(--color-white);
    }

    /* 設定エラー */
    .config-error {
      background: var(--color-orange-light);
      border: 1px solid var(--color-orange);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .config-error h3 {
      margin: 0 0 8px;
      color: var(--color-orange-dark);
      font-size: 14px;
    }
    .config-error ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
    }

    /* レスポンシブ */
    @media (max-width: 900px) {
      .ai-input-container { flex-direction: column; }
      .right-panel { display: none; }
    }

    @media (max-width: 600px) {
      .tabs-left { flex-wrap: wrap; }
      .tab-btn { padding: 6px 10px; font-size: 11px; }
    }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <div class="header">
    <div class="header-left">
      <h1>訪問看護 自動スケジューリング</h1>
      <span class="header-badge">管理者専用</span>
    </div>
    <span class="header-status">入力管理画面</span>
  </div>

  <!-- AIチャット・一括入力エリア（将来用） -->
  <div class="ai-input-area">
    <div class="ai-input-container">
      <div class="ai-chat-box">
        <div class="placeholder-title">
          <span>AIチャット入力</span>
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <textarea disabled placeholder="AIアシスタントに質問や指示を入力...（準備中）"></textarea>
        <button class="disabled-btn" disabled>送信</button>
      </div>
      <div class="bulk-input-box">
        <div class="placeholder-title">
          <span>一括コピペ入力</span>
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <textarea disabled placeholder="Excelからコピーしたデータを貼り付け...（準備中）"></textarea>
        <button class="disabled-btn" disabled>解析・プレビュー</button>
      </div>
    </div>
  </div>

  <!-- メインコンテンツ -->
  <div class="main-container">
    <!-- 左：テーブル表示 -->
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">読み込み中...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="reloadCurrentSheet()">更新</button>
      </div>

      <div id="configError" class="config-error" style="display: none;">
        <h3>設定エラー</h3>
        <ul id="configErrorList"></ul>
      </div>

      <div id="mainContent">
        <div class="table-container">
          <table class="data-table" id="dataTable">
            <thead><tr><th>読み込み中...</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 右：操作パネル（将来用） -->
    <div class="right-panel">
      <div class="panel-title">
        操作メニュー
        <span class="coming-soon-badge">準備中</span>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">
          行操作
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <button class="operation-btn" disabled>
          <span class="icon">+</span>
          新規行を追加
        </button>
        <button class="operation-btn" disabled>
          <span class="icon">-</span>
          選択行を削除
        </button>
        <button class="operation-btn" disabled>
          <span class="icon">C</span>
          行をコピー
        </button>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">
          編集操作
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <button class="operation-btn" disabled>
          <span class="icon">E</span>
          セルを編集
        </button>
        <button class="operation-btn" disabled>
          <span class="icon">U</span>
          変更を元に戻す
        </button>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">
          保存
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <button class="operation-btn" disabled>
          <span class="icon">S</span>
          変更を保存
        </button>
      </div>

      <div class="info-section">
        <div class="info-item">
          <span class="label">表示中:</span>
          <span id="infoSheetName">-</span>
        </div>
        <div class="info-item">
          <span class="label">行数:</span>
          <span id="infoRowCount">-</span>
        </div>
        <div class="info-item">
          <span class="label">列数:</span>
          <span id="infoColCount">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 下部タブバー -->
  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-sheet="患者マスタ" onclick="showSheet('患者マスタ', this)">患者マスタ</button>
      <button class="tab-btn" data-sheet="スタッフマスタ" onclick="showSheet('スタッフマスタ', this)">スタッフマスタ</button>
      <button class="tab-btn" data-sheet="個別変更リクエスト" onclick="showSheet('個別変更リクエスト', this)">個別変更リクエスト</button>
    </div>
    <div class="tabs-right">
      <a class="nav-link" onclick="goToOutput()">出力画面へ →</a>
    </div>
  </div>

  <script>
    var baseUrl = '';
    var currentSheetName = '患者マスタ';

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      // ベースURL取得
      google.script.run
        .withSuccessHandler(function(url) { baseUrl = url; })
        .getBaseUrl();

      // 最後に開いたタブを復元
      var lastSheet = localStorage.getItem('unifiedInput_lastSheet');
      if (lastSheet) {
        currentSheetName = lastSheet;
        var tabs = document.querySelectorAll('.tabs-left .tab-btn');
        tabs.forEach(function(tab) {
          if (tab.getAttribute('data-sheet') === currentSheetName) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }

      checkConfig();
      loadSheet(currentSheetName);
    });

    // ============================================================
    // 設定チェック
    // ============================================================
    function checkConfig() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            showConfigError(result.issues);
          }
        })
        .withFailureHandler(function(e) {
          console.error('Config check failed:', e);
        })
        .checkConfiguration();
    }

    function showConfigError(issues) {
      var errorDiv = document.getElementById('configError');
      var errorList = document.getElementById('configErrorList');
      errorList.innerHTML = issues.map(function(issue) {
        return '<li>' + escapeHtml(issue) + '</li>';
      }).join('');
      errorDiv.style.display = 'block';
    }

    // ============================================================
    // シート表示
    // ============================================================
    function showSheet(sheetName, btn) {
      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');

      currentSheetName = sheetName;
      localStorage.setItem('unifiedInput_lastSheet', sheetName);

      loadSheet(sheetName);
    }

    function loadSheet(sheetName) {
      setStatus('loading', sheetName + ' を読み込み中...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(data) {
          renderTable(data);
          document.getElementById('refreshBtn').disabled = false;
        })
        .withFailureHandler(function(e) {
          setStatus('error', 'エラー: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getSheetTableData(sheetName, 1000);
    }

    function reloadCurrentSheet() {
      loadSheet(currentSheetName);
    }

    function renderTable(data) {
      if (data.error) {
        setStatus('error', data.error);
        return;
      }

      if (!data.header || data.header.length === 0) {
        setStatus('error', 'データがありません');
        document.getElementById('dataTable').innerHTML =
          '<thead><tr><th>データがありません</th></tr></thead><tbody></tbody>';
        updateInfo('-', 0, 0);
        return;
      }

      setStatus('success', (data.sheetName || currentSheetName) + '（' + data.rowCount + '行）');
      updateInfo(data.sheetName || currentSheetName, data.rowCount, data.header.length);

      var headerHtml = '<tr>' + data.header.map(function(h) {
        return '<th>' + escapeHtml(String(h)) + '</th>';
      }).join('') + '</tr>';

      var rowsHtml = data.rows.map(function(row) {
        var cells = row.map(function(cell) {
          return '<td>' + escapeHtml(formatCell(cell)) + '</td>';
        }).join('');
        return '<tr>' + cells + '</tr>';
      }).join('');

      document.getElementById('dataTable').innerHTML =
        '<thead>' + headerHtml + '</thead>' +
        '<tbody>' + rowsHtml + '</tbody>';
    }

    // ============================================================
    // 画面遷移（同一タブ）
    // ============================================================
    function goToOutput() {
      if (baseUrl) {
        window.location.href = baseUrl + '?page=output';
      } else {
        // baseUrlがまだ取得できていない場合、現在のURLから構築
        var currentUrl = window.location.href;
        var newUrl = currentUrl.split('?')[0] + '?page=output';
        window.location.href = newUrl;
      }
    }

    // ============================================================
    // ユーティリティ
    // ============================================================
    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function updateInfo(sheetName, rowCount, colCount) {
      document.getElementById('infoSheetName').textContent = sheetName;
      document.getElementById('infoRowCount').textContent = rowCount;
      document.getElementById('infoColCount').textContent = colCount;
    }

    function formatCell(cell) {
      if (cell === null || cell === undefined) return '';
      if (cell && typeof cell === 'object' && cell._type === 'date') {
        try {
          var d = new Date(cell.value);
          return d.toLocaleDateString('ja-JP');
        } catch (e) {
          return String(cell.value);
        }
      }
      return String(cell);
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>

</body>
</html>
