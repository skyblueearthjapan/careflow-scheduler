<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    /* ============================================================
       よりよりブランドカラー
       ============================================================ */
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
      --color-disabled: #CCCCCC;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }

    /* ============================================================
       ヘッダー
       ============================================================ */
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-badge {
      font-size: 11px;
      background: var(--color-orange);
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 500;
    }

    .header-status {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* ============================================================
       AIチャット・一括入力エリア（将来用プレースホルダー）
       ============================================================ */
    .ai-input-area {
      background: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      padding: 12px 20px;
    }

    .ai-input-container {
      display: flex;
      gap: 12px;
      align-items: stretch;
      opacity: 0.6;
    }

    .ai-chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--color-yellow-light);
      border: 1px dashed var(--color-yellow);
      border-radius: 8px;
    }

    .ai-chat-box .placeholder-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-orange-dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-chat-box textarea {
      flex: 1;
      min-height: 50px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 8px;
      resize: none;
      font-size: 13px;
    }

    .ai-chat-box textarea:disabled {
      background: var(--color-bg);
      cursor: not-allowed;
    }

    .bulk-input-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--color-blue-light);
      border: 1px dashed var(--color-blue);
      border-radius: 8px;
      opacity: 0.7;
    }

    .bulk-input-box .placeholder-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-blue-dark);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bulk-input-box textarea {
      flex: 1;
      min-height: 50px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 8px;
      resize: none;
      font-size: 13px;
    }

    .coming-soon-badge {
      font-size: 10px;
      background: var(--color-disabled);
      color: var(--color-white);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }

    .disabled-btn {
      padding: 6px 14px;
      background: var(--color-disabled);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: not-allowed;
    }

    /* ============================================================
       メインコンテンツ
       ============================================================ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .left-panel {
      flex: 1;
      padding: 16px;
      overflow: auto;
      background: var(--color-white);
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--color-yellow-light);
      border-radius: 8px;
      border: 1px solid var(--color-yellow);
      font-size: 13px;
    }

    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }

    .refresh-btn {
      padding: 6px 14px;
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: var(--color-disabled); cursor: not-allowed; }

    #mainContent {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-container {
      flex: 1;
      overflow: auto;
      border: 1px solid var(--color-green-light);
      border-radius: 8px;
    }

    .data-table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    .data-table th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      border: 1px solid var(--color-blue-dark);
      white-space: nowrap;
      z-index: 10;
    }

    .data-table td {
      border: 1px solid var(--color-border);
      padding: 8px 12px;
      background: var(--color-white);
      white-space: nowrap;
      cursor: pointer;
    }

    .data-table tbody tr:nth-child(even) td { background: #FDFDFB; }
    .data-table tbody tr:hover td { background: var(--color-blue-light); }

    /* 選択行のスタイル */
    .data-table tbody tr.selected td {
      background: var(--color-orange-light) !important;
      border-color: var(--color-orange);
    }

    /* 編集中セルのスタイル */
    .data-table td.dirty {
      background: var(--color-yellow) !important;
      font-weight: 600;
    }

    .data-table td.editing {
      padding: 0;
    }

    .data-table td.editing input {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid var(--color-blue);
      font-size: 12px;
      font-family: inherit;
      outline: none;
    }

    /* ============================================================
       右パネル（操作メニュー）
       ============================================================ */
    .right-panel {
      width: 240px;
      border-left: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .dirty-badge {
      font-size: 10px;
      background: var(--color-orange);
      color: var(--color-white);
      padding: 2px 6px;
      border-radius: 4px;
      display: none;
    }

    .dirty-badge.show {
      display: inline-block;
    }

    .operation-group {
      margin-bottom: 20px;
    }

    .operation-group-title {
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .operation-btn {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 8px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-white);
      color: var(--color-text);
      font-size: 12px;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .operation-btn:hover:not(:disabled) {
      background: var(--color-green-light);
      border-color: var(--color-green);
    }

    .operation-btn:disabled {
      background: var(--color-bg);
      color: var(--color-disabled);
      cursor: not-allowed;
    }

    .operation-btn .icon { font-size: 14px; }

    .operation-btn.primary {
      background: var(--color-green);
      color: var(--color-white);
      border-color: var(--color-green-dark);
    }

    .operation-btn.primary:hover:not(:disabled) {
      background: var(--color-green-dark);
    }

    .operation-btn.danger:hover:not(:disabled) {
      background: var(--color-error);
      color: var(--color-white);
      border-color: var(--color-error);
    }

    .info-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .info-item {
      font-size: 11px;
      color: var(--color-text-light);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
    }

    .info-item .label { color: var(--color-text); }

    /* ============================================================
       トースト通知
       ============================================================ */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
      max-width: 320px;
    }

    .toast.success {
      background: var(--color-green);
      color: var(--color-white);
    }

    .toast.error {
      background: var(--color-error);
      color: var(--color-white);
    }

    .toast.info {
      background: var(--color-blue);
      color: var(--color-white);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ============================================================
       下部タブバー
       ============================================================ */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-top: 1px solid var(--color-green-light);
      background: var(--color-white);
    }

    .tabs-left { display: flex; gap: 8px; }

    .tab-btn {
      border: 1px solid var(--color-green-light);
      background: var(--color-white);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text);
      transition: all 0.2s ease;
    }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active {
      background: var(--color-green);
      border-color: var(--color-green);
      color: var(--color-white);
    }

    .tabs-right { display: flex; gap: 8px; }

    .nav-link {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--color-green);
      background: var(--color-green-light);
      border-radius: 8px;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      background: var(--color-green);
      color: var(--color-white);
    }

    /* 設定エラー */
    .config-error {
      background: var(--color-orange-light);
      border: 1px solid var(--color-orange);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .config-error h3 {
      margin: 0 0 8px;
      color: var(--color-orange-dark);
      font-size: 14px;
    }
    .config-error ul {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
    }

    /* レスポンシブ */
    @media (max-width: 900px) {
      .ai-input-container { flex-direction: column; }
      .right-panel { display: none; }
    }

    @media (max-width: 600px) {
      .tabs-left { flex-wrap: wrap; }
      .tab-btn { padding: 6px 10px; font-size: 11px; }
    }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <div class="header">
    <div class="header-left">
      <h1>訪問看護 自動スケジューリング</h1>
      <span class="header-badge">管理者専用</span>
    </div>
    <span class="header-status">入力管理画面</span>
  </div>

  <!-- AIチャット・一括入力エリア（将来用） -->
  <div class="ai-input-area">
    <div class="ai-input-container">
      <div class="ai-chat-box">
        <div class="placeholder-title">
          <span>AIチャット入力</span>
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <textarea disabled placeholder="AIアシスタントに質問や指示を入力...（準備中）"></textarea>
        <button class="disabled-btn" disabled>送信</button>
      </div>
      <div class="bulk-input-box">
        <div class="placeholder-title">
          <span>一括コピペ入力</span>
          <span class="coming-soon-badge">Coming Soon</span>
        </div>
        <textarea disabled placeholder="Excelからコピーしたデータを貼り付け...（準備中）"></textarea>
        <button class="disabled-btn" disabled>解析・プレビュー</button>
      </div>
    </div>
  </div>

  <!-- メインコンテンツ -->
  <div class="main-container">
    <!-- 左：テーブル表示 -->
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">読み込み中...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="reloadCurrentSheet()">更新</button>
      </div>

      <div id="configError" class="config-error" style="display: none;">
        <h3>設定エラー</h3>
        <ul id="configErrorList"></ul>
      </div>

      <div id="mainContent">
        <div class="table-container">
          <table class="data-table" id="dataTable">
            <thead><tr><th>読み込み中...</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 右：操作パネル -->
    <div class="right-panel">
      <div class="panel-title">
        操作メニュー
        <span class="dirty-badge" id="dirtyBadge">未保存</span>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">行操作</div>
        <button class="operation-btn" id="btnAddRow" onclick="onAddRow()">
          <span class="icon">+</span>
          新規行を追加
        </button>
        <button class="operation-btn danger" id="btnDeleteRows" onclick="onDeleteSelected()" disabled>
          <span class="icon">-</span>
          選択行を削除
        </button>
        <button class="operation-btn" id="btnCopyRows" onclick="onCopySelected()" disabled>
          <span class="icon">C</span>
          行をコピー
        </button>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">編集操作</div>
        <button class="operation-btn" id="btnEditCell" onclick="onEditSelectedCell()" disabled>
          <span class="icon">E</span>
          セルを編集
        </button>
        <button class="operation-btn" id="btnUndo" onclick="onDiscardChanges()" disabled>
          <span class="icon">U</span>
          変更を元に戻す
        </button>
      </div>

      <div class="operation-group">
        <div class="operation-group-title">保存</div>
        <button class="operation-btn primary" id="btnSave" onclick="onSaveChanges()" disabled>
          <span class="icon">S</span>
          変更を保存
        </button>
      </div>

      <div class="info-section">
        <div class="info-item">
          <span class="label">表示中:</span>
          <span id="infoSheetName">-</span>
        </div>
        <div class="info-item">
          <span class="label">行数:</span>
          <span id="infoRowCount">-</span>
        </div>
        <div class="info-item">
          <span class="label">列数:</span>
          <span id="infoColCount">-</span>
        </div>
        <div class="info-item">
          <span class="label">選択中:</span>
          <span id="infoSelectedCount">0 行</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 下部タブバー -->
  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-sheet="患者マスタ" onclick="showSheet('患者マスタ', this)">患者マスタ</button>
      <button class="tab-btn" data-sheet="スタッフマスタ" onclick="showSheet('スタッフマスタ', this)">スタッフマスタ</button>
      <button class="tab-btn" data-sheet="個別変更リクエスト" onclick="showSheet('個別変更リクエスト', this)">個別変更リクエスト</button>
    </div>
    <div class="tabs-right">
      <a class="nav-link" onclick="goToOutput()">出力画面へ →</a>
    </div>
  </div>

  <!-- トースト通知コンテナ -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================================
    // 状態管理
    // ============================================================
    var baseUrl = '';
    var currentSheetName = '患者マスタ';
    var tableData = { header: [], rows: [] };       // 現在表示中のデータ
    var originalData = { header: [], rows: [] };    // 読み込み時の元データ
    var selectedRows = [];                           // 選択中の行インデックス（0-based、データ行）
    var dirtyCells = {};                             // 未保存の変更 { 'rowIdx-colIdx': newValue }
    var isDirty = false;                             // 未保存の変更があるか
    var editingCell = null;                          // 現在編集中のセル { rowIdx, colIdx }

    // ============================================================
    // 初期化
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      // ベースURL取得
      google.script.run
        .withSuccessHandler(function(url) { baseUrl = url; })
        .getBaseUrl();

      // 最後に開いたタブを復元
      var lastSheet = localStorage.getItem('unifiedInput_lastSheet');
      if (lastSheet) {
        currentSheetName = lastSheet;
        var tabs = document.querySelectorAll('.tabs-left .tab-btn');
        tabs.forEach(function(tab) {
          if (tab.getAttribute('data-sheet') === currentSheetName) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }

      checkConfig();
      loadSheet(currentSheetName);
    });

    // ページ離脱時の警告
    window.addEventListener('beforeunload', function(e) {
      if (isDirty) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // ============================================================
    // 設定チェック
    // ============================================================
    function checkConfig() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (!result.success) {
            showConfigError(result.issues);
          }
        })
        .withFailureHandler(function(e) {
          console.error('Config check failed:', e);
        })
        .checkConfiguration();
    }

    function showConfigError(issues) {
      var errorDiv = document.getElementById('configError');
      var errorList = document.getElementById('configErrorList');
      errorList.innerHTML = issues.map(function(issue) {
        return '<li>' + escapeHtml(issue) + '</li>';
      }).join('');
      errorDiv.style.display = 'block';
    }

    // ============================================================
    // シート表示
    // ============================================================
    function showSheet(sheetName, btn) {
      // 未保存の変更がある場合は確認
      if (isDirty) {
        if (!confirm('未保存の変更があります。破棄してよろしいですか？')) {
          return;
        }
      }

      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');

      currentSheetName = sheetName;
      localStorage.setItem('unifiedInput_lastSheet', sheetName);

      // 状態リセット
      resetState();
      loadSheet(sheetName);
    }

    function resetState() {
      selectedRows = [];
      dirtyCells = {};
      isDirty = false;
      editingCell = null;
      updateButtonStates();
    }

    function loadSheet(sheetName) {
      setStatus('loading', sheetName + ' を読み込み中...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(data) {
          tableData = data;
          originalData = JSON.parse(JSON.stringify(data)); // ディープコピー
          renderTable(data);
          document.getElementById('refreshBtn').disabled = false;
        })
        .withFailureHandler(function(e) {
          setStatus('error', 'エラー: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
          showToast('error', e.message);
        })
        .getSheetTableData(sheetName, 1000);
    }

    function reloadCurrentSheet() {
      if (isDirty) {
        if (!confirm('未保存の変更があります。破棄して再読み込みしますか？')) {
          return;
        }
      }
      resetState();
      loadSheet(currentSheetName);
    }

    function renderTable(data) {
      if (data.error) {
        setStatus('error', data.error);
        return;
      }

      if (!data.header || data.header.length === 0) {
        setStatus('error', 'データがありません');
        document.getElementById('dataTable').innerHTML =
          '<thead><tr><th>データがありません</th></tr></thead><tbody></tbody>';
        updateInfo('-', 0, 0);
        return;
      }

      setStatus('success', (data.sheetName || currentSheetName) + '（' + data.rowCount + '行）');
      updateInfo(data.sheetName || currentSheetName, data.rowCount, data.header.length);

      var headerHtml = '<tr><th>#</th>' + data.header.map(function(h) {
        return '<th>' + escapeHtml(String(h)) + '</th>';
      }).join('') + '</tr>';

      var rowsHtml = data.rows.map(function(row, rowIdx) {
        var isSelected = selectedRows.indexOf(rowIdx) >= 0;
        var rowClass = isSelected ? 'selected' : '';
        var cells = '<td>' + (rowIdx + 1) + '</td>' + row.map(function(cell, colIdx) {
          var cellKey = rowIdx + '-' + colIdx;
          var isDirtyCell = dirtyCells.hasOwnProperty(cellKey);
          var cellClass = isDirtyCell ? 'dirty' : '';
          var cellValue = isDirtyCell ? dirtyCells[cellKey] : cell;
          return '<td class="' + cellClass + '" data-row="' + rowIdx + '" data-col="' + colIdx + '">' +
                 escapeHtml(formatCell(cellValue)) + '</td>';
        }).join('');
        return '<tr class="' + rowClass + '" data-row="' + rowIdx + '">' + cells + '</tr>';
      }).join('');

      document.getElementById('dataTable').innerHTML =
        '<thead>' + headerHtml + '</thead>' +
        '<tbody>' + rowsHtml + '</tbody>';

      // 行クリックイベントを設定
      attachRowClickHandlers();
    }

    function attachRowClickHandlers() {
      var tbody = document.querySelector('#dataTable tbody');
      if (!tbody) return;

      tbody.addEventListener('click', function(e) {
        var td = e.target.closest('td');
        var tr = e.target.closest('tr');
        if (!tr || !td) return;

        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (isNaN(rowIdx)) return;

        // ダブルクリックでセル編集
        if (e.detail === 2 && td.hasAttribute('data-col')) {
          var colIdx = parseInt(td.getAttribute('data-col'));
          startCellEdit(rowIdx, colIdx);
          return;
        }

        // 行選択
        if (e.ctrlKey || e.metaKey) {
          // Ctrl/Cmd: トグル選択
          var idx = selectedRows.indexOf(rowIdx);
          if (idx >= 0) {
            selectedRows.splice(idx, 1);
          } else {
            selectedRows.push(rowIdx);
          }
        } else if (e.shiftKey && selectedRows.length > 0) {
          // Shift: 範囲選択
          var lastSelected = selectedRows[selectedRows.length - 1];
          var start = Math.min(lastSelected, rowIdx);
          var end = Math.max(lastSelected, rowIdx);
          for (var i = start; i <= end; i++) {
            if (selectedRows.indexOf(i) < 0) {
              selectedRows.push(i);
            }
          }
        } else {
          // 単純クリック: 単一選択
          selectedRows = [rowIdx];
        }

        updateRowSelection();
        updateButtonStates();
      });
    }

    function updateRowSelection() {
      var rows = document.querySelectorAll('#dataTable tbody tr');
      rows.forEach(function(tr) {
        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (selectedRows.indexOf(rowIdx) >= 0) {
          tr.classList.add('selected');
        } else {
          tr.classList.remove('selected');
        }
      });
      document.getElementById('infoSelectedCount').textContent = selectedRows.length + ' 行';
    }

    // ============================================================
    // セル編集
    // ============================================================
    function startCellEdit(rowIdx, colIdx) {
      // 既存の編集を終了
      if (editingCell) {
        finishCellEdit();
      }

      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (!td) return;

      var cellKey = rowIdx + '-' + colIdx;
      var currentValue = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[rowIdx][colIdx];

      td.classList.add('editing');
      td.innerHTML = '<input type="text" value="' + escapeHtml(formatCell(currentValue)) + '" />';

      var input = td.querySelector('input');
      input.focus();
      input.select();

      editingCell = { rowIdx: rowIdx, colIdx: colIdx };

      input.addEventListener('blur', finishCellEdit);
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          finishCellEdit();
        } else if (e.key === 'Escape') {
          cancelCellEdit();
        }
      });
    }

    function finishCellEdit() {
      if (!editingCell) return;

      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      var input = td ? td.querySelector('input') : null;

      if (input) {
        var newValue = input.value;
        var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
        var originalValue = originalData.rows[editingCell.rowIdx][editingCell.colIdx];

        // 元の値と同じなら変更を削除、違えば変更を記録
        if (String(newValue) === String(originalValue)) {
          delete dirtyCells[cellKey];
        } else {
          dirtyCells[cellKey] = newValue;
        }

        // UIを更新
        td.classList.remove('editing');
        if (dirtyCells.hasOwnProperty(cellKey)) {
          td.classList.add('dirty');
          td.textContent = formatCell(newValue);
        } else {
          td.classList.remove('dirty');
          td.textContent = formatCell(originalValue);
        }

        // 内部データも更新
        tableData.rows[editingCell.rowIdx][editingCell.colIdx] = newValue;
      }

      editingCell = null;
      updateDirtyState();
    }

    function cancelCellEdit() {
      if (!editingCell) return;

      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
      var value = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[editingCell.rowIdx][editingCell.colIdx];

      td.classList.remove('editing');
      td.textContent = formatCell(value);
      editingCell = null;
    }

    function updateDirtyState() {
      isDirty = Object.keys(dirtyCells).length > 0;
      document.getElementById('dirtyBadge').classList.toggle('show', isDirty);
      updateButtonStates();
    }

    // ============================================================
    // 操作ボタン
    // ============================================================
    function updateButtonStates() {
      var hasSelection = selectedRows.length > 0;
      var hasDirty = Object.keys(dirtyCells).length > 0;

      document.getElementById('btnDeleteRows').disabled = !hasSelection;
      document.getElementById('btnCopyRows').disabled = !hasSelection;
      document.getElementById('btnEditCell').disabled = selectedRows.length !== 1;
      document.getElementById('btnUndo').disabled = !hasDirty;
      document.getElementById('btnSave').disabled = !hasDirty;
    }

    // 新規行を追加
    function onAddRow() {
      setStatus('loading', '行を追加中...');

      var emptyRow = [new Array(tableData.header.length).fill('')];

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            reloadCurrentSheet();
          } else {
            showToast('error', result.message || '追加に失敗しました');
            setStatus('error', result.message);
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'エラー: ' + e.message);
        })
        .input_appendRows(currentSheetName, emptyRow);
    }

    // 選択行を削除
    function onDeleteSelected() {
      if (selectedRows.length === 0) {
        showToast('info', '行を選択してください');
        return;
      }

      if (!confirm(selectedRows.length + ' 行を削除しますか？この操作は元に戻せません。')) {
        return;
      }

      setStatus('loading', '削除中...');

      // UI上のrowIdxをシートの行番号に変換（+2: ヘッダー行 + 0-based→1-based）
      var sheetRowNumbers = selectedRows.map(function(rowIdx) {
        return rowIdx + 2;
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || '削除に失敗しました');
            setStatus('error', result.message);
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'エラー: ' + e.message);
        })
        .input_deleteRows(currentSheetName, sheetRowNumbers);
    }

    // 行をコピー
    function onCopySelected() {
      if (selectedRows.length === 0) {
        showToast('info', '行を選択してください');
        return;
      }

      setStatus('loading', 'コピー中...');

      var sheetRowNumbers = selectedRows.map(function(rowIdx) {
        return rowIdx + 2;
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || 'コピーに失敗しました');
            setStatus('error', result.message);
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'エラー: ' + e.message);
        })
        .input_copyRows(currentSheetName, sheetRowNumbers);
    }

    // セルを編集（選択行の最初のセルを編集）
    function onEditSelectedCell() {
      if (selectedRows.length !== 1) {
        showToast('info', '1行だけ選択してください');
        return;
      }
      startCellEdit(selectedRows[0], 0);
    }

    // 変更を元に戻す
    function onDiscardChanges() {
      if (!confirm('未保存の変更をすべて破棄しますか？')) {
        return;
      }

      dirtyCells = {};
      tableData = JSON.parse(JSON.stringify(originalData));
      renderTable(tableData);
      updateDirtyState();
      showToast('info', '変更を破棄しました');
    }

    // 変更を保存
    function onSaveChanges() {
      var dirtyKeys = Object.keys(dirtyCells);
      if (dirtyKeys.length === 0) {
        showToast('info', '保存する変更がありません');
        return;
      }

      setStatus('loading', '保存中...');

      // 更新データを構築（row/colは1-based）
      var updates = dirtyKeys.map(function(key) {
        var parts = key.split('-');
        var rowIdx = parseInt(parts[0]);
        var colIdx = parseInt(parts[1]);
        return {
          row: rowIdx + 2,  // シートの行番号（ヘッダー+1, 0-based→1-based）
          col: colIdx + 1,  // シートの列番号（0-based→1-based）
          value: dirtyCells[key]
        };
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            // 保存成功後、現在の状態を「元の状態」として更新
            originalData = JSON.parse(JSON.stringify(tableData));
            dirtyCells = {};
            updateDirtyState();
            renderTable(tableData);
            setStatus('success', '保存しました');
          } else {
            showToast('error', result.message || '保存に失敗しました');
            setStatus('error', result.message);
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'エラー: ' + e.message);
        })
        .input_updateCells(currentSheetName, updates);
    }

    // ============================================================
    // 画面遷移（同一タブ）
    // ============================================================
    function goToOutput() {
      if (isDirty) {
        if (!confirm('未保存の変更があります。破棄して移動しますか？')) {
          return;
        }
      }

      var targetUrl;
      if (baseUrl) {
        targetUrl = baseUrl + '?page=output';
      } else {
        var currentUrl = window.location.href;
        targetUrl = currentUrl.split('?')[0] + '?page=output';
      }
      // GASはiframe内で動くため、window.topを使用
      try {
        window.top.location.href = targetUrl;
      } catch (e) {
        window.location.href = targetUrl;
      }
    }

    // ============================================================
    // トースト通知
    // ============================================================
    function showToast(type, message) {
      var container = document.getElementById('toastContainer');
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(function() {
        toast.style.opacity = '0';
        setTimeout(function() {
          container.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // ============================================================
    // ユーティリティ
    // ============================================================
    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function updateInfo(sheetName, rowCount, colCount) {
      document.getElementById('infoSheetName').textContent = sheetName;
      document.getElementById('infoRowCount').textContent = rowCount;
      document.getElementById('infoColCount').textContent = colCount;
    }

    function formatCell(cell) {
      if (cell === null || cell === undefined) return '';
      if (cell && typeof cell === 'object' && cell._type === 'date') {
        try {
          var d = new Date(cell.value);
          return d.toLocaleDateString('ja-JP');
        } catch (e) {
          return String(cell.value);
        }
      }
      return String(cell);
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>

</body>
</html>
