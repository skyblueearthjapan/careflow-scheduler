<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
      --color-disabled: #CCCCCC;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-badge { font-size: 11px; background: var(--color-orange); padding: 4px 10px; border-radius: 12px; font-weight: 500; }
    .header-status { font-size: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 12px; }
    .main-container { flex: 1; display: flex; overflow: hidden; }
    .left-panel { flex: 1; padding: 16px; overflow: auto; background: var(--color-white); display: flex; flex-direction: column; }
    .status-bar {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px; padding: 10px 14px;
      background: var(--color-yellow-light); border-radius: 8px; border: 1px solid var(--color-yellow); font-size: 13px;
    }
    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }
    .refresh-btn {
      padding: 6px 14px; background: var(--color-green); color: var(--color-white);
      border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: var(--color-disabled); cursor: not-allowed; }
    #mainContent { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .table-container { flex: 1; overflow: auto; border: 1px solid var(--color-green-light); border-radius: 8px; }
    .data-table { border-collapse: collapse; width: max-content; min-width: 100%; font-size: 12px; }
    .data-table th {
      position: sticky; top: 0; background: var(--color-blue); color: var(--color-white);
      padding: 10px 12px; text-align: left; font-weight: 600;
      border: 1px solid var(--color-blue-dark); white-space: nowrap; z-index: 10;
    }
    .data-table td {
      border: 1px solid var(--color-border); padding: 8px 12px;
      background: var(--color-white); white-space: nowrap; cursor: pointer;
    }
    .data-table tbody tr:nth-child(even) td { background: #FDFDFB; }
    .data-table tbody tr:hover td { background: var(--color-blue-light); }
    /* Row Handle */
    .row-handle {
      width: 30px; text-align: center; cursor: grab; color: var(--color-disabled);
      user-select: none; font-size: 14px;
    }
    .row-handle:hover { color: var(--color-text); }
    /* è¡Œé¸æŠçŠ¶æ…‹ */
    .data-table tbody tr.row-selected td { background: var(--color-orange-light) !important; border-color: var(--color-orange); }
    .data-table tbody tr.row-selected .row-handle { color: var(--color-orange-dark); font-weight: bold; }
    /* ã‚»ãƒ«é¸æŠçŠ¶æ…‹ */
    .data-table td.cell-focused { outline: 2px solid var(--color-blue); outline-offset: -2px; }
    /* ç·¨é›†ä¸­ã‚»ãƒ« */
    .data-table td.dirty { background: var(--color-yellow) !important; }
    .data-table td.is-new { background: var(--color-green-light) !important; }
    .data-table td.editing { padding: 0; }
    .data-table td.editing input,
    .data-table td.editing select {
      width: 100%; padding: 8px 10px; border: 2px solid var(--color-blue);
      font-size: 12px; font-family: inherit; outline: none;
    }
    /* å³ãƒ‘ãƒãƒ« */
    .right-panel {
      width: 240px; border-left: 1px solid var(--color-border);
      background: var(--color-white); padding: 16px;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .panel-title {
      font-size: 14px; font-weight: 600; margin-bottom: 16px; padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
      display: flex; align-items: center; justify-content: space-between;
    }
    .dirty-badge { font-size: 10px; background: var(--color-orange); color: var(--color-white); padding: 2px 6px; border-radius: 4px; display: none; }
    .dirty-badge.show { display: inline-block; }
    .operation-group { margin-bottom: 20px; }
    .operation-group-title { font-size: 11px; color: var(--color-text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .operation-btn {
      width: 100%; padding: 10px 14px; margin-bottom: 8px;
      border: 1px solid var(--color-border); border-radius: 6px;
      background: var(--color-white); color: var(--color-text);
      font-size: 12px; text-align: left; cursor: pointer;
      display: flex; align-items: center; gap: 8px; transition: all 0.15s ease;
    }
    .operation-btn:hover:not(:disabled) { background: var(--color-green-light); border-color: var(--color-green); }
    .operation-btn:disabled { background: var(--color-bg); color: var(--color-disabled); cursor: not-allowed; }
    .operation-btn .icon { font-size: 14px; }
    .operation-btn.primary { background: var(--color-green); color: var(--color-white); border-color: var(--color-green-dark); }
    .operation-btn.primary:hover:not(:disabled) { background: var(--color-green-dark); }
    .operation-btn.danger:hover:not(:disabled) { background: var(--color-error); color: var(--color-white); border-color: var(--color-error); }
    .info-section { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--color-border); }
    .info-item { font-size: 11px; color: var(--color-text-light); margin-bottom: 6px; display: flex; justify-content: space-between; }
    .info-item .label { color: var(--color-text); }
    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast-container { position: fixed; top: 80px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 12px 20px; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; max-width: 320px; }
    .toast.success { background: var(--color-green); color: var(--color-white); }
    .toast.error { background: var(--color-error); color: var(--color-white); }
    .toast.info { background: var(--color-blue); color: var(--color-white); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    /* ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼ */
    .bottom-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; border-top: 1px solid var(--color-green-light); background: var(--color-white); }
    .tabs-left { display: flex; gap: 8px; }
    .tab-btn { border: 1px solid var(--color-green-light); background: var(--color-white); padding: 8px 14px; border-radius: 999px; cursor: pointer; font-size: 12px; font-weight: 500; color: var(--color-text); transition: all 0.2s ease; }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active { background: var(--color-green); border-color: var(--color-green); color: var(--color-white); }
    .tabs-right { display: flex; gap: 8px; }
    .nav-link { padding: 8px 16px; font-size: 12px; font-weight: 500; border: 1px solid var(--color-green); background: var(--color-green-light); border-radius: 8px; color: var(--color-text); cursor: pointer; text-decoration: none; transition: all 0.2s ease; }
    .nav-link:hover { background: var(--color-green); color: var(--color-white); }
    /* æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .weekday-editor { display: flex; gap: 4px; flex-wrap: wrap; padding: 4px; }
    .weekday-editor label { display: flex; align-items: center; gap: 2px; font-size: 11px; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
    .weekday-editor label:hover { background: var(--color-blue-light); }
    .weekday-editor input { width: 14px; height: 14px; }
    @media (max-width: 900px) { .right-panel { display: none; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <h1>è¨ªå•çœ‹è­· è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</h1>
      <span class="header-badge">ç®¡ç†è€…å°‚ç”¨</span>
    </div>
    <span class="header-status">å…¥åŠ›ç®¡ç†ç”»é¢</span>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">èª­ã¿è¾¼ã¿ä¸­...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="reloadCurrentSheet()">æ›´æ–°</button>
      </div>
      <div id="mainContent">
        <div class="table-container">
          <table class="data-table" id="dataTable">
            <thead><tr><th>èª­ã¿è¾¼ã¿ä¸­...</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel-title">æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼<span class="dirty-badge" id="dirtyBadge">æœªä¿å­˜</span></div>
      <div class="operation-group">
        <div class="operation-group-title">è¡Œæ“ä½œ</div>
        <button class="operation-btn" id="btnAddRow" onclick="onAddRow()"><span class="icon">+</span>æ–°è¦è¡Œã‚’è¿½åŠ ï¼ˆé¸æŠè¡Œã®ä¸‹ï¼‰</button>
        <button class="operation-btn danger" id="btnDeleteRows" onclick="onDeleteSelected()" disabled><span class="icon">-</span>é¸æŠè¡Œã‚’å‰Šé™¤</button>
        <button class="operation-btn" id="btnCopyRows" onclick="onCopySelected()" disabled><span class="icon">C</span>è¡Œã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="operation-group">
        <div class="operation-group-title">ç·¨é›†æ“ä½œ</div>
        <button class="operation-btn" id="btnUndo" onclick="onDiscardChanges()" disabled><span class="icon">U</span>å¤‰æ›´ã‚’å…ƒã«æˆ»ã™</button>
      </div>
      <div class="operation-group">
        <div class="operation-group-title">ä¿å­˜</div>
        <button class="operation-btn primary" id="btnSave" onclick="onSaveChanges()" disabled><span class="icon">S</span>å¤‰æ›´ã‚’ä¿å­˜</button>
      </div>
      <div class="operation-group" id="geoGroup" style="display:none;">
        <div class="operation-group-title">ä½ç½®æƒ…å ±</div>
        <button class="operation-btn" id="btnUpdateGeo" onclick="onUpdateGeo()" disabled><span class="icon">ğŸ“</span>ä½ç½®æƒ…å ±ã‚’æ›´æ–°</button>
      </div>
      <div class="info-section">
        <div class="info-item"><span class="label">è¡¨ç¤ºä¸­:</span><span id="infoSheetName">-</span></div>
        <div class="info-item"><span class="label">è¡Œæ•°:</span><span id="infoRowCount">-</span></div>
        <div class="info-item"><span class="label">åˆ—æ•°:</span><span id="infoColCount">-</span></div>
        <div class="info-item"><span class="label">é¸æŠä¸­:</span><span id="infoSelectedCount">0 è¡Œ</span></div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-sheet="æ‚£è€…ãƒã‚¹ã‚¿" onclick="showSheet('æ‚£è€…ãƒã‚¹ã‚¿', this)">æ‚£è€…ãƒã‚¹ã‚¿</button>
      <button class="tab-btn" data-sheet="ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿" onclick="showSheet('ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿', this)">ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿</button>
      <button class="tab-btn" data-sheet="å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ" onclick="showSheet('å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ', this)">å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
    </div>
    <div class="tabs-right"><a class="nav-link" onclick="goToOutput()">å‡ºåŠ›ç”»é¢ã¸ â†’</a></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ============================================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================================
    var baseUrl = '';
    var currentSheetName = 'æ‚£è€…ãƒã‚¹ã‚¿';
    var tableData = { header: [], rows: [] };
    var originalData = { header: [], rows: [] };
    var rowMeta = []; // { sheetRowIndex, isSelected, isDirty, isNew }
    var dirtyCells = {}; // 'rowIdx-colIdx': newValue
    var isDirty = false;
    var editingCell = null;
    var focusedCell = null; // { rowIdx, colIdx }
    var dictionaries = { patients: {}, staff: {} };

    // åˆ—ã‚¿ã‚¤ãƒ—å®šç¾©
    var WEEKDAYS_EN = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    var WEEKDAYS_JP = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    var TIME_OPTIONS = generateTimeOptions(8, 20, 10); // 08:00ã€œ20:00, 10åˆ†åˆ»ã¿

    function generateTimeOptions(startHour, endHour, stepMin) {
      var opts = [];
      for (var h = startHour; h <= endHour; h++) {
        for (var m = 0; m < 60; m += stepMin) {
          if (h === endHour && m > 0) break;
          opts.push(String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0'));
        }
      }
      return opts;
    }

    // ============================================================
    // åˆ—ã‚¿ã‚¤ãƒ—åˆ¤å®š
    // ============================================================
    function getEditorType(headerName) {
      var h = (headerName || '').toLowerCase();
      if (h.includes('patient_id') || h.includes('staff_id') || h.includes('change_id')) return 'id_text';
      if (h === 'æ‚£è€…å' || h === 'ã‚¹ã‚¿ãƒƒãƒ•å') return 'readonly_text';
      if (h === 'æ€§åˆ¥') return 'sex_select';
      if (h === 'ã‚¨ãƒªã‚¢') return 'area_select';
      if (h.includes('ç·¯åº¦') || h.includes('çµŒåº¦')) return 'geo_readonly';
      if (h.includes('æ—¥ä»˜')) return 'date_picker';
      if (h.includes('æ™‚åˆ»') || h.includes('é–‹å§‹') || h.includes('çµ‚äº†') || h.includes('æ™‚é–“å¸¯ï¼ˆé–‹å§‹ï¼‰') || h.includes('æ™‚é–“å¸¯ï¼ˆçµ‚ï¼‰') || h.includes('ã‚·ãƒ•ãƒˆ')) return 'time_select';
      if (h.includes('æ›œæ—¥') && (h.includes('è¤‡æ•°') || h.includes('å¸Œæœ›') || h.includes('å‹¤å‹™'))) return 'weekday_multi';
      if (h.includes('æ›œæ—¥ng') || h === 'æ›œæ—¥ng') return 'weekday_single';
      if (h.includes('å„ªå…ˆåº¦') || h === 'æ›œæ—¥å„ªå…ˆåº¦') return 'priority_select';
      if (h.includes('æ™‚é–“ã‚¿ã‚¤ãƒ—')) return 'time_type_select';
      if (h.includes('æ€§åˆ¥åˆ¶é™')) return 'sex_limit_select';
      if (h.includes('å¿…è¦ã‚¹ã‚¿ãƒƒãƒ•') || h.includes('è¨ªå•å›æ•°') || h.includes('æœ€å¤§è¨ªå•') || h.includes('ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“')) return 'number';
      if (h.includes('æŒ‡å®šã‚¿ã‚¤ãƒ—') || h.includes('ç¶™ç¶šå¸Œæœ›')) return 'staff_type_select';
      if (h.includes('æ“ä½œ')) return 'operation_select';
      if (h.includes('ã‚¹ã‚­ãƒ«')) return 'skill_select';
      return 'text';
    }

    // ============================================================
    // åˆæœŸåŒ–
    // ============================================================
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run.withSuccessHandler(function(url) { baseUrl = url; }).getBaseUrl();
      google.script.run.withSuccessHandler(function(result) {
        if (result.success) dictionaries = result.data;
      }).input_getDictionaries();

      var lastSheet = localStorage.getItem('unifiedInput_lastSheet');
      if (lastSheet) {
        currentSheetName = lastSheet;
        document.querySelectorAll('.tabs-left .tab-btn').forEach(function(tab) {
          tab.classList.toggle('active', tab.getAttribute('data-sheet') === currentSheetName);
        });
      }
      loadSheet(currentSheetName);
    });

    window.addEventListener('beforeunload', function(e) {
      if (isDirty) { e.preventDefault(); e.returnValue = ''; }
    });

    // ============================================================
    // ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    // ============================================================
    function showSheet(sheetName, btn) {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      currentSheetName = sheetName;
      localStorage.setItem('unifiedInput_lastSheet', sheetName);
      resetState();
      loadSheet(sheetName);
    }

    function resetState() {
      rowMeta = [];
      dirtyCells = {};
      isDirty = false;
      editingCell = null;
      focusedCell = null;
      updateButtonStates();
    }

    function loadSheet(sheetName) {
      setStatus('loading', sheetName + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('refreshBtn').disabled = true;
      // ä½ç½®æƒ…å ±ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
      var showGeo = (sheetName === 'æ‚£è€…ãƒã‚¹ã‚¿' || sheetName === 'ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚¹ã‚¿');
      document.getElementById('geoGroup').style.display = showGeo ? 'block' : 'none';

      google.script.run
        .withSuccessHandler(function(data) {
          tableData = data;
          originalData = JSON.parse(JSON.stringify(data));
          // rowMetaåˆæœŸåŒ–
          rowMeta = data.rows.map(function(_, i) {
            return { sheetRowIndex: i + 2, isSelected: false, isDirty: false, isNew: false };
          });
          renderTable(data);
          document.getElementById('refreshBtn').disabled = false;
        })
        .withFailureHandler(function(e) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
          showToast('error', e.message);
        })
        .getSheetTableData(sheetName, 1000);
    }

    function reloadCurrentSheet() {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã‹ï¼Ÿ')) return;
      resetState();
      loadSheet(currentSheetName);
    }

    // ============================================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ============================================================
    function renderTable(data) {
      if (data.error) { setStatus('error', data.error); return; }
      if (!data.header || data.header.length === 0) {
        setStatus('error', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('dataTable').innerHTML = '<thead><tr><th>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</th></tr></thead><tbody></tbody>';
        updateInfo('-', 0, 0);
        return;
      }
      setStatus('success', (data.sheetName || currentSheetName) + 'ï¼ˆ' + data.rowCount + 'è¡Œï¼‰');
      updateInfo(data.sheetName || currentSheetName, data.rowCount, data.header.length);

      var headerHtml = '<tr><th class="row-handle"></th><th>#</th>' + data.header.map(function(h) {
        return '<th>' + escapeHtml(String(h)) + '</th>';
      }).join('') + '</tr>';

      var rowsHtml = data.rows.map(function(row, rowIdx) {
        var meta = rowMeta[rowIdx] || {};
        var rowClass = [];
        if (meta.isSelected) rowClass.push('row-selected');
        var cells = '<td class="row-handle" data-row="' + rowIdx + '">â ¿</td>';
        cells += '<td>' + (rowIdx + 1) + '</td>';
        cells += row.map(function(cell, colIdx) {
          var cellKey = rowIdx + '-' + colIdx;
          var cellClass = [];
          if (dirtyCells.hasOwnProperty(cellKey)) cellClass.push('dirty');
          if (meta.isNew) cellClass.push('is-new');
          if (focusedCell && focusedCell.rowIdx === rowIdx && focusedCell.colIdx === colIdx) cellClass.push('cell-focused');
          var cellValue = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : cell;
          return '<td class="' + cellClass.join(' ') + '" data-row="' + rowIdx + '" data-col="' + colIdx + '">' + escapeHtml(formatCellDisplay(cellValue, data.header[colIdx])) + '</td>';
        }).join('');
        return '<tr class="' + rowClass.join(' ') + '" data-row="' + rowIdx + '">' + cells + '</tr>';
      }).join('');

      document.getElementById('dataTable').innerHTML = '<thead>' + headerHtml + '</thead><tbody>' + rowsHtml + '</tbody>';
      attachTableEvents();
    }

    function formatCellDisplay(value, headerName) {
      if (value === null || value === undefined) return '';
      var editorType = getEditorType(headerName);
      if (editorType === 'weekday_multi' && value) {
        // Mon,Tue â†’ æœˆ,ç«
        return String(value).split(',').map(function(d) {
          var idx = WEEKDAYS_EN.indexOf(d.trim());
          return idx >= 0 ? WEEKDAYS_JP[idx] : d;
        }).join(',');
      }
      if (editorType === 'time_select' && value) {
        // HH:MM:SS â†’ HH:MM
        return String(value).substring(0, 5);
      }
      return String(value);
    }

    function attachTableEvents() {
      var tbody = document.querySelector('#dataTable tbody');
      if (!tbody) return;

      tbody.addEventListener('click', function(e) {
        var td = e.target.closest('td');
        var tr = e.target.closest('tr');
        if (!tr || !td) return;
        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (isNaN(rowIdx)) return;

        // Row Handleã‚¯ãƒªãƒƒã‚¯ â†’ è¡Œé¸æŠ
        if (td.classList.contains('row-handle')) {
          toggleRowSelection(rowIdx, e.ctrlKey || e.metaKey, e.shiftKey);
          return;
        }

        // ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (td.hasAttribute('data-col')) {
          var colIdx = parseInt(td.getAttribute('data-col'));
          setFocusedCell(rowIdx, colIdx);
          if (e.detail === 2) { // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯
            startCellEdit(rowIdx, colIdx);
          }
        }
      });
    }

    // ============================================================
    // è¡Œé¸æŠ
    // ============================================================
    function toggleRowSelection(rowIdx, ctrlKey, shiftKey) {
      if (ctrlKey) {
        rowMeta[rowIdx].isSelected = !rowMeta[rowIdx].isSelected;
      } else if (shiftKey && getSelectedRows().length > 0) {
        var lastSel = getSelectedRows().pop();
        var start = Math.min(lastSel, rowIdx);
        var end = Math.max(lastSel, rowIdx);
        for (var i = start; i <= end; i++) {
          rowMeta[i].isSelected = true;
        }
      } else {
        rowMeta.forEach(function(m, i) { m.isSelected = (i === rowIdx); });
      }
      updateRowSelectionUI();
      updateButtonStates();
    }

    function getSelectedRows() {
      var selected = [];
      rowMeta.forEach(function(m, i) { if (m.isSelected) selected.push(i); });
      return selected;
    }

    function updateRowSelectionUI() {
      document.querySelectorAll('#dataTable tbody tr').forEach(function(tr) {
        var rowIdx = parseInt(tr.getAttribute('data-row'));
        if (!isNaN(rowIdx) && rowMeta[rowIdx]) {
          tr.classList.toggle('row-selected', rowMeta[rowIdx].isSelected);
        }
      });
      document.getElementById('infoSelectedCount').textContent = getSelectedRows().length + ' è¡Œ';
    }

    // ============================================================
    // ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    // ============================================================
    function setFocusedCell(rowIdx, colIdx) {
      focusedCell = { rowIdx: rowIdx, colIdx: colIdx };
      document.querySelectorAll('#dataTable td.cell-focused').forEach(function(td) { td.classList.remove('cell-focused'); });
      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (td) td.classList.add('cell-focused');
    }

    // ============================================================
    // ã‚»ãƒ«ç·¨é›†
    // ============================================================
    function startCellEdit(rowIdx, colIdx) {
      if (editingCell) finishCellEdit();
      var td = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + colIdx + '"]');
      if (!td) return;

      var headerName = tableData.header[colIdx];
      var editorType = getEditorType(headerName);
      var cellKey = rowIdx + '-' + colIdx;
      var currentValue = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[rowIdx][colIdx];

      // èª­ã¿å–ã‚Šå°‚ç”¨
      if (editorType === 'readonly_text' || editorType === 'geo_readonly') {
        showToast('info', 'ã“ã®åˆ—ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™');
        return;
      }

      td.classList.add('editing');
      editingCell = { rowIdx: rowIdx, colIdx: colIdx, headerName: headerName };

      var editorHtml = createEditorHtml(editorType, currentValue, headerName);
      td.innerHTML = editorHtml;

      var input = td.querySelector('input, select');
      if (input) {
        input.focus();
        if (input.tagName === 'INPUT') input.select();
        input.addEventListener('blur', finishCellEdit);
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') finishCellEdit();
          else if (e.key === 'Escape') cancelCellEdit();
        });
      }
    }

    function createEditorHtml(editorType, value, headerName) {
      switch (editorType) {
        case 'sex_select':
          return createSelect(['ç”·æ€§', 'å¥³æ€§'], value);
        case 'area_select':
          return createSelect(['A1', 'A2', 'A3', 'B1', 'B2', 'B3'], value);
        case 'priority_select':
          return createSelect(['é«˜', 'ä¸­', 'ä½'], value);
        case 'time_type_select':
          return createSelect(['æ™‚é–“å¸¯', 'åˆå‰', 'åˆå¾Œ', 'çµ‚æ—¥', 'å›ºå®š'], value);
        case 'sex_limit_select':
          return createSelect(['', 'ç”·æ€§ã®ã¿', 'å¥³æ€§ã®ã¿'], value);
        case 'staff_type_select':
          return createSelect(['åŒã˜äºº', 'ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', 'ã©ã¡ã‚‰ã§ã‚‚'], value);
        case 'operation_select':
          return createSelect(['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'æ™‚é–“å¤‰æ›´', 'è¿½åŠ '], value);
        case 'skill_select':
          return createSelect(['ãƒ™ãƒ†ãƒ©ãƒ³', 'ä¸­å …', 'æ–°äºº'], value);
        case 'time_select':
          var timeVal = value ? String(value).substring(0, 5) : '';
          return createSelect(TIME_OPTIONS, timeVal);
        case 'date_picker':
          var dateVal = value ? formatDateForInput(value) : '';
          return '<input type="date" value="' + dateVal + '" />';
        case 'weekday_multi':
          return createWeekdayEditor(value);
        case 'weekday_single':
          return createSelect(['', 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], value);
        case 'number':
          return '<input type="number" value="' + (value || '') + '" />';
        default:
          return '<input type="text" value="' + escapeHtml(value || '') + '" />';
      }
    }

    function createSelect(options, selectedValue) {
      var html = '<select>';
      options.forEach(function(opt) {
        var selected = (String(opt) === String(selectedValue)) ? ' selected' : '';
        html += '<option value="' + escapeHtml(opt) + '"' + selected + '>' + escapeHtml(opt) + '</option>';
      });
      html += '</select>';
      return html;
    }

    function createWeekdayEditor(value) {
      var selected = (value || '').split(',').map(function(s) { return s.trim(); });
      var html = '<div class="weekday-editor">';
      WEEKDAYS_EN.forEach(function(en, i) {
        var checked = selected.indexOf(en) >= 0 ? ' checked' : '';
        html += '<label><input type="checkbox" value="' + en + '"' + checked + '>' + WEEKDAYS_JP[i] + '</label>';
      });
      html += '</div>';
      return html;
    }

    function formatDateForInput(value) {
      if (!value) return '';
      try {
        var d = new Date(value);
        return d.toISOString().split('T')[0];
      } catch (e) {
        return '';
      }
    }

    function finishCellEdit() {
      if (!editingCell) return;
      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      if (!td) { editingCell = null; return; }

      var newValue = getEditorValue(td);
      var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
      var originalValue = originalData.rows[editingCell.rowIdx] ? originalData.rows[editingCell.rowIdx][editingCell.colIdx] : '';

      // å€¤ã®æ­£è¦åŒ–
      var editorType = getEditorType(editingCell.headerName);
      if (editorType === 'time_select' && newValue) {
        newValue = newValue + ':00'; // HH:MM â†’ HH:MM:SS
      }

      // å¤‰æ›´ãƒã‚§ãƒƒã‚¯
      if (String(newValue) === String(originalValue)) {
        delete dirtyCells[cellKey];
      } else {
        dirtyCells[cellKey] = newValue;
        rowMeta[editingCell.rowIdx].isDirty = true;
      }

      // å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ›´æ–°
      tableData.rows[editingCell.rowIdx][editingCell.colIdx] = newValue;

      // IDâ†’åå‰ã®è‡ªå‹•è£œå®Œ
      autoCompleteNameFromId(editingCell.rowIdx, editingCell.colIdx, newValue);

      td.classList.remove('editing');
      td.innerHTML = escapeHtml(formatCellDisplay(newValue, editingCell.headerName));
      if (dirtyCells.hasOwnProperty(cellKey)) td.classList.add('dirty');
      else td.classList.remove('dirty');

      editingCell = null;
      updateDirtyState();
    }

    function getEditorValue(td) {
      var input = td.querySelector('input[type="text"], input[type="number"], input[type="date"], select');
      if (input) return input.value;

      // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      var checkboxes = td.querySelectorAll('.weekday-editor input[type="checkbox"]');
      if (checkboxes.length > 0) {
        var vals = [];
        checkboxes.forEach(function(cb) { if (cb.checked) vals.push(cb.value); });
        return vals.join(',');
      }
      return '';
    }

    function cancelCellEdit() {
      if (!editingCell) return;
      var td = document.querySelector('td[data-row="' + editingCell.rowIdx + '"][data-col="' + editingCell.colIdx + '"]');
      var cellKey = editingCell.rowIdx + '-' + editingCell.colIdx;
      var value = dirtyCells.hasOwnProperty(cellKey) ? dirtyCells[cellKey] : tableData.rows[editingCell.rowIdx][editingCell.colIdx];
      td.classList.remove('editing');
      td.innerHTML = escapeHtml(formatCellDisplay(value, editingCell.headerName));
      editingCell = null;
    }

    // ============================================================
    // è‡ªå‹•è£œå®Œ
    // ============================================================
    function autoCompleteNameFromId(rowIdx, colIdx, idValue) {
      var header = tableData.header[colIdx];
      var nameColIdx = -1;
      var nameValue = '';

      if (header === 'patient_id') {
        nameColIdx = tableData.header.indexOf('æ‚£è€…å');
        nameValue = dictionaries.patients[idValue] || '';
      } else if (header === 'staff_id') {
        nameColIdx = tableData.header.indexOf('ã‚¹ã‚¿ãƒƒãƒ•å');
        nameValue = dictionaries.staff[idValue] || '';
      }

      if (nameColIdx >= 0 && nameValue) {
        var nameCellKey = rowIdx + '-' + nameColIdx;
        dirtyCells[nameCellKey] = nameValue;
        tableData.rows[rowIdx][nameColIdx] = nameValue;
        // UIã‚‚æ›´æ–°
        var nameTd = document.querySelector('td[data-row="' + rowIdx + '"][data-col="' + nameColIdx + '"]');
        if (nameTd) {
          nameTd.textContent = nameValue;
          nameTd.classList.add('dirty');
        }
      }
    }

    // ============================================================
    // çŠ¶æ…‹ç®¡ç†
    // ============================================================
    function updateDirtyState() {
      isDirty = Object.keys(dirtyCells).length > 0 || rowMeta.some(function(m) { return m.isNew; });
      document.getElementById('dirtyBadge').classList.toggle('show', isDirty);
      updateButtonStates();
    }

    function updateButtonStates() {
      var hasSelection = getSelectedRows().length > 0;
      var hasDirty = isDirty;
      document.getElementById('btnDeleteRows').disabled = !hasSelection;
      document.getElementById('btnCopyRows').disabled = !hasSelection;
      document.getElementById('btnUndo').disabled = !hasDirty;
      document.getElementById('btnSave').disabled = !hasDirty;
      document.getElementById('btnUpdateGeo').disabled = !hasSelection;
    }

    // ============================================================
    // æ“ä½œãƒœã‚¿ãƒ³
    // ============================================================
    function onAddRow() {
      var selectedRows = getSelectedRows();
      var baseRowIndex = null;
      if (selectedRows.length > 0) {
        var lastSelected = Math.max.apply(null, selectedRows);
        baseRowIndex = rowMeta[lastSelected].sheetRowIndex;
      }

      setStatus('loading', 'è¡Œã‚’è¿½åŠ ä¸­...');
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            reloadCurrentSheet();
          } else {
            showToast('error', result.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_insertRowBelow(currentSheetName, baseRowIndex);
    }

    function onDeleteSelected() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
      if (!confirm(selectedRows.length + ' è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;

      setStatus('loading', 'å‰Šé™¤ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_deleteRows(currentSheetName, sheetRowNumbers);
    }

    function onCopySelected() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      setStatus('loading', 'ã‚³ãƒ”ãƒ¼ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            resetState();
            loadSheet(currentSheetName);
          } else {
            showToast('error', result.message || 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_copyRows(currentSheetName, sheetRowNumbers);
    }

    function onDiscardChanges() {
      if (!confirm('æœªä¿å­˜ã®å¤‰æ›´ã‚’ã™ã¹ã¦ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ')) return;
      dirtyCells = {};
      tableData = JSON.parse(JSON.stringify(originalData));
      rowMeta.forEach(function(m) { m.isDirty = false; m.isNew = false; });
      renderTable(tableData);
      updateDirtyState();
      showToast('info', 'å¤‰æ›´ã‚’ç ´æ£„ã—ã¾ã—ãŸ');
    }

    function onSaveChanges() {
      var dirtyKeys = Object.keys(dirtyCells);
      if (dirtyKeys.length === 0) { showToast('info', 'ä¿å­˜ã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

      setStatus('loading', 'ä¿å­˜ä¸­...');
      var updates = dirtyKeys.map(function(key) {
        var parts = key.split('-');
        var rowIdx = parseInt(parts[0]);
        var colIdx = parseInt(parts[1]);
        return {
          row: rowMeta[rowIdx].sheetRowIndex,
          col: colIdx + 1,
          value: dirtyCells[key]
        };
      });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            originalData = JSON.parse(JSON.stringify(tableData));
            dirtyCells = {};
            rowMeta.forEach(function(m) { m.isDirty = false; m.isNew = false; });
            updateDirtyState();
            renderTable(tableData);
            setStatus('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
          } else {
            showToast('error', result.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_updateCells(currentSheetName, updates);
    }

    function onUpdateGeo() {
      var selectedRows = getSelectedRows();
      if (selectedRows.length === 0) { showToast('info', 'è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

      setStatus('loading', 'ä½ç½®æƒ…å ±ã‚’æ›´æ–°ä¸­...');
      var sheetRowNumbers = selectedRows.map(function(rowIdx) { return rowMeta[rowIdx].sheetRowIndex; });

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', result.message);
            if (result.errors && result.errors.length > 0) {
              result.errors.forEach(function(err) { showToast('error', err); });
            }
            reloadCurrentSheet();
          } else {
            showToast('error', result.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(e) {
          showToast('error', e.message);
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
        })
        .input_updateGeo(currentSheetName, sheetRowNumbers);
    }

    // ============================================================
    // ç”»é¢é·ç§»
    // ============================================================
    function goToOutput() {
      if (isDirty && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç ´æ£„ã—ã¦ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) return;
      var targetUrl = baseUrl ? baseUrl + '?page=output' : window.location.href.split('?')[0] + '?page=output';
      try { window.top.location.href = targetUrl; } catch (e) { window.location.href = targetUrl; }
    }

    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    function showToast(type, message) {
      var container = document.getElementById('toastContainer');
      var toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.style.opacity = '0';
        setTimeout(function() { container.removeChild(toast); }, 300);
      }, 3000);
    }

    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function updateInfo(sheetName, rowCount, colCount) {
      document.getElementById('infoSheetName').textContent = sheetName;
      document.getElementById('infoRowCount').textContent = rowCount;
      document.getElementById('infoColCount').textContent = colCount;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
