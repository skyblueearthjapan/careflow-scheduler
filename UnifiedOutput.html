<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    /* ============================================================
       „Çà„Çä„Çà„Çä„Éñ„É©„É≥„Éâ„Ç´„É©„Éº
       ============================================================ */
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }

    /* ============================================================
       „Éò„ÉÉ„ÉÄ„Éº
       ============================================================ */
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .header-status {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* ============================================================
       „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ
       ============================================================ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Â∑¶„Éë„Éç„É´ */
    .left-panel {
      flex: 1;
      padding: 16px;
      overflow: auto;
      background: var(--color-white);
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--color-yellow-light);
      border-radius: 8px;
      border: 1px solid var(--color-yellow);
      font-size: 13px;
    }

    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }

    .refresh-btn {
      padding: 6px 14px;
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }

    /* „ÉÜ„Éº„Éñ„É´„Ç≥„É≥„ÉÜ„Éä */
    #mainContent {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-container {
      flex: 1;
      overflow: scroll; /* Á∏¶Ê®™„Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÇíÂ∏∏„Å´Ë°®Á§∫ */
      border: 1px solid var(--color-green-light);
      border-radius: 8px;
    }
    /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
    .table-container::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    .table-container::-webkit-scrollbar-thumb {
      background: var(--color-green);
      border-radius: 6px;
    }
    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--color-green-dark);
    }

    /* ÈÄ±„Éì„É•„Éº„ÉÜ„Éº„Éñ„É´ */
    .week-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
      font-size: 13px;
    }

    .week-table th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      padding: 12px 10px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--color-blue-dark);
      z-index: 10;
    }

    .week-table th:first-child {
      left: 0;
      z-index: 20;
      min-width: 140px;
      text-align: left;
      background: var(--color-green);
      border-color: var(--color-green-dark);
    }

    .week-table td {
      border: 1px solid var(--color-green-light);
      padding: 8px 10px;
      vertical-align: top;
      background: var(--color-white);
    }

    .week-table td:first-child {
      position: sticky;
      left: 0;
      background: var(--color-yellow-light);
      font-weight: 600;
      min-width: 140px;
      z-index: 5;
      border-left: 3px solid var(--color-green);
    }

    .week-table tr:nth-child(even) td { background: #FDFDFB; }
    .week-table tr:nth-child(even) td:first-child { background: #FDF8E8; }
    .week-table tr:hover td { background: var(--color-blue-light); }
    .week-table tr:hover td:first-child { background: var(--color-yellow); }

    .cell-content {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 12px;
      /* ÂÜÖÂÆπÈáè„Å´Âøú„Åò„Å¶Á∏¶ÊñπÂêë„Å´Ëá™ÂãïÊã°ÂºµÔºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÂêåÊßòÔºâ */
    }

    /* Ê±éÁî®„Ç∑„Éº„Éà„ÉÜ„Éº„Éñ„É´ */
    .sheet-table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    .sheet-table th, .sheet-table td {
      border: 1px solid var(--color-border);
      padding: 8px 10px;
      white-space: nowrap;
    }

    .sheet-table thead th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      font-weight: 600;
      z-index: 1;
    }

    .sheet-table tbody tr:nth-child(even) { background: #FDFDFB; }
    .sheet-table tbody tr:hover { background: var(--color-blue-light); }

    /* ============================================================
       Âè≥„Éë„Éç„É´ÔºàGASÂÆüË°å„É°„Éã„É•„ÉºÔºâ
       ============================================================ */
    .right-panel {
      width: 260px;
      border-left: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
    }

    .button-group { margin-bottom: 20px; }

    /* ÂØæË±°ÈÄ±„Çª„É¨„ÇØ„Çø„Éº */
    .week-selector { margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border); }
    .week-selector label { display: block; font-size: 11px; color: var(--color-text-light); margin-bottom: 4px; letter-spacing: 0.3px; }
    .week-selector select {
      width: 100%; padding: 7px 8px; border: 1px solid var(--color-border); border-radius: 6px;
      font-size: 12px; background: var(--color-white); color: var(--color-text); margin-bottom: 8px;
    }
    .week-selector select:focus { outline: none; border-color: var(--color-green); box-shadow: 0 0 0 2px rgba(106,168,79,0.15); }
    .week-selector .current-week-label {
      font-size: 11px; color: var(--color-green-dark); font-weight: 500;
      padding: 4px 8px; background: rgba(106,168,79,0.08); border-radius: 4px; display: inline-block;
    }

    .button-group-title {
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .action-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .action-btn.primary {
      background: var(--color-orange);
      color: var(--color-white);
      box-shadow: 0 2px 4px rgba(246, 178, 107, 0.3);
    }
    .action-btn.primary:hover:not(:disabled) {
      background: var(--color-orange-dark);
      transform: translateY(-1px);
    }

    .action-btn.secondary {
      background: var(--color-yellow-light);
      color: var(--color-text);
      border: 1px solid var(--color-yellow);
    }
    .action-btn.secondary:hover:not(:disabled) {
      background: var(--color-yellow);
    }

    .action-btn.audit {
      background: var(--color-green);
      color: var(--color-white);
      box-shadow: 0 2px 4px rgba(106, 168, 79, 0.3);
    }
    .action-btn.audit:hover:not(:disabled) {
      background: var(--color-green-dark);
      transform: translateY(-1px);
    }
    .action-btn.audit.active {
      background: var(--color-green-dark);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .action-btn .spinner {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .action-btn.loading .spinner { display: inline-block; }
    .action-btn.loading .icon { display: none; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ÂÆüË°å„É≠„Ç∞ */
    .log-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .log-title {
      font-size: 12px;
      color: var(--color-text-light);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .log-list {
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
    }

    .log-item {
      padding: 8px 10px;
      margin-bottom: 6px;
      background: var(--color-yellow-light);
      border-radius: 6px;
      border-left: 3px solid var(--color-green);
    }
    .log-item.error { border-left-color: var(--color-error); background: #FFF5F5; }

    /* ============================================================
       ‰∏ãÈÉ®„Çø„Éñ„Éê„Éº
       ============================================================ */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-top: 1px solid var(--color-green-light);
      background: var(--color-white);
    }

    .tabs-left { display: flex; gap: 8px; }

    .tab-btn {
      border: 1px solid var(--color-green-light);
      background: var(--color-white);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text);
      transition: all 0.2s ease;
    }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active {
      background: var(--color-green);
      border-color: var(--color-green);
      color: var(--color-white);
    }

    .tabs-right { display: flex; gap: 8px; }

    .nav-link {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--color-orange);
      background: var(--color-orange-light);
      border-radius: 8px;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      background: var(--color-orange);
      color: var(--color-white);
    }

    /* „Éà„Éº„Çπ„Éà */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--color-green); color: white; }
    .toast.error { background: var(--color-error); color: white; }

    /* ============================================================
       Áõ£ÊüªÔºàÂêàÂê¶Âà§ÂÆöÔºâ„Éì„É•„Éº
       ============================================================ */
    .audit-controls {
      display: flex; align-items: center; gap: 16px; padding: 12px 0;
      border-bottom: 1px solid var(--color-border); margin-bottom: 12px;
    }
    .audit-controls label { font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .audit-controls input[type="date"] {
      padding: 6px 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 13px;
    }
    .audit-legend { font-size: 12px; color: var(--color-text-light); margin-left: auto; }
    .audit-ok { color: var(--color-green-dark); font-weight: bold; }
    .audit-warn { color: var(--color-orange-dark); font-weight: bold; }
    .audit-ng { color: var(--color-error); font-weight: bold; }
    .audit-toolbar {
      display: flex; align-items: center; gap: 16px; padding: 8px 0; margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .audit-filters { display: flex; align-items: center; gap: 6px; }
    .filter-label { font-size: 12px; color: var(--color-text-light); }
    .audit-filter-btn {
      padding: 4px 12px; border: 1px solid var(--color-border); border-radius: 4px;
      background: var(--color-white); font-size: 11px; cursor: pointer;
      transition: all 0.15s;
    }
    .audit-filter-btn:hover { background: var(--color-bg); }
    .audit-filter-btn.active { background: var(--color-green); color: var(--color-white); border-color: var(--color-green); }
    .audit-summary {
      display: flex; gap: 12px; font-size: 12px; margin-left: auto;
      padding: 6px 12px; background: var(--color-bg); border-radius: 6px;
    }
    .audit-summary .stat { display: flex; align-items: center; gap: 4px; }
    .audit-summary .stat-label { color: var(--color-text-light); }
    .audit-summary .stat-value { font-weight: 600; }
    .audit-summary .stat-value.ok { color: var(--color-green-dark); }
    .audit-summary .stat-value.warn { color: var(--color-orange-dark); }
    .audit-summary .stat-value.ng { color: var(--color-error); }
    .audit-cache-status { font-size: 11px; color: var(--color-text-light); }
    .audit-cache-status.from-cache { color: var(--color-blue-dark); }
    .audit-warnings {
      background: var(--color-orange-light); border: 1px solid var(--color-orange); border-radius: 6px;
      padding: 10px 14px; margin-bottom: 12px; font-size: 12px;
    }
    .audit-warnings-title { font-weight: 600; color: var(--color-orange-dark); margin-bottom: 6px; }
    .audit-warnings-list { color: var(--color-orange-dark); }
    .audit-main { display: flex; gap: 16px; flex: 1; overflow: hidden; }
    .audit-week-view { flex: 1; overflow: auto; border: 1px solid var(--color-green-light); border-radius: 8px; }
    .audit-table { border-collapse: collapse; width: 100%; font-size: 12px; }
    .audit-table th {
      position: sticky; top: 0; background: var(--color-blue); color: var(--color-white);
      padding: 10px 12px; text-align: center; font-weight: 600; border: 1px solid var(--color-blue-dark);
      white-space: nowrap; z-index: 10; min-width: 100px;
    }
    .audit-table th:first-child { min-width: 120px; text-align: left; }
    .audit-table td {
      border: 1px solid var(--color-border); padding: 8px; vertical-align: top;
      background: var(--color-white); cursor: pointer; min-height: 60px;
    }
    .audit-table td:first-child { font-weight: 500; background: var(--color-bg); }
    .audit-table td:hover { background: var(--color-blue-light); }
    .audit-cell-summary { display: flex; gap: 8px; font-size: 11px; justify-content: center; }
    .audit-cell-summary .ok { color: var(--color-green-dark); }
    .audit-cell-summary .warn { color: var(--color-orange-dark); }
    .audit-cell-summary .ng { color: var(--color-error); }
    .audit-detail-panel {
      width: 320px; border: 1px solid var(--color-border); border-radius: 8px;
      background: var(--color-white); display: flex; flex-direction: column; overflow: hidden;
    }
    .audit-detail-header {
      background: var(--color-green); color: var(--color-white); padding: 10px 14px;
      display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px;
    }
    .audit-close-btn {
      background: none; border: none; color: inherit; font-size: 18px; cursor: pointer; padding: 0 4px;
    }
    .audit-close-btn:hover { opacity: 0.7; }
    .audit-detail-content { flex: 1; overflow-y: auto; padding: 12px; }
    .audit-patient-item {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px; margin-bottom: 6px;
      border: 1px solid var(--color-border); border-radius: 6px; cursor: pointer; font-size: 12px;
    }
    .audit-patient-item:hover { background: var(--color-blue-light); }
    .audit-patient-item .status { font-size: 14px; }
    .audit-patient-item .status.ok { color: var(--color-green-dark); }
    .audit-patient-item .status.warn { color: var(--color-orange-dark); }
    .audit-patient-item .status.ng { color: var(--color-error); }
    .audit-patient-item .name { flex: 1; }
    .audit-patient-item .tags { font-size: 10px; color: var(--color-text-light); }
    .audit-patient-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .audit-modal-content {
      background: var(--color-white); border-radius: 12px; width: 90%; max-width: 700px;
      max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .audit-modal-header {
      background: var(--color-green); color: var(--color-white); padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 14px; border-radius: 12px 12px 0 0;
    }
    .audit-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .audit-section { margin-bottom: 20px; }
    .audit-section-title {
      font-size: 13px; font-weight: 600; color: var(--color-text);
      border-bottom: 2px solid var(--color-green); padding-bottom: 6px; margin-bottom: 10px;
    }
    .audit-info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
    .audit-info-item { font-size: 12px; }
    .audit-info-item .label { color: var(--color-text-light); }
    .audit-info-item .value { font-weight: 500; }
    .audit-day-row {
      border: 1px solid var(--color-border); border-radius: 6px; margin-bottom: 12px;
      overflow: hidden;
    }
    .audit-day-header {
      display: flex; align-items: center; gap: 12px; padding: 10px 12px;
      background: var(--color-bg); border-bottom: 1px solid var(--color-border);
    }
    .audit-day-header .date { font-weight: 600; min-width: 80px; }
    .audit-day-header .status-icon { font-size: 18px; font-weight: bold; }
    .audit-day-header .status-icon.ok { color: var(--color-green-dark); }
    .audit-day-header .status-icon.warn { color: var(--color-orange-dark); }
    .audit-day-header .status-icon.ng { color: var(--color-error); }
    .audit-day-body { padding: 12px; font-size: 12px; }
    .audit-day-body .tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
    .audit-compare-section { margin-bottom: 10px; }
    .audit-compare-label { font-weight: 600; color: var(--color-text-light); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; }
    .audit-expected-item, .audit-actual-item { padding: 4px 8px; background: var(--color-bg); border-radius: 4px; margin-bottom: 4px; }
    .audit-source-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .audit-source-badge.source-master { background: var(--color-green-light); color: var(--color-green-dark); }
    .audit-source-badge.source-change { background: var(--color-orange-light); color: var(--color-orange-dark); }
    .audit-source-badge.source-special { background: var(--color-blue-light); color: var(--color-blue-dark); }
    .audit-time-type { color: var(--color-text-light); font-size: 11px; }
    .audit-cancelled-badge { background: var(--color-error); color: var(--color-white); font-size: 10px; padding: 2px 6px; border-radius: 4px; }
    .audit-unassigned-badge { background: var(--color-error); color: var(--color-white); font-size: 10px; padding: 2px 4px; border-radius: 2px; }
    .audit-staff-name { color: var(--color-text-light); }
    .audit-check-item { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .audit-check-item.check-ok { background: var(--color-green-light); }
    .audit-check-item.check-warn { background: var(--color-orange-light); }
    .audit-check-item.check-ng { background: rgba(232, 139, 139, 0.3); }
    .audit-check-icon { font-weight: bold; width: 14px; text-align: center; }
    .check-ok .audit-check-icon { color: var(--color-green-dark); }
    .check-warn .audit-check-icon { color: var(--color-orange-dark); }
    .check-ng .audit-check-icon { color: var(--color-error); }
    .audit-diff { color: var(--color-text-light); font-size: 11px; }
    .audit-additional-info { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--color-border); }
    .audit-info-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; }
    .audit-info-badge.change { background: var(--color-orange-light); color: var(--color-orange-dark); }
    .audit-info-badge.special { background: var(--color-blue-light); color: var(--color-blue-dark); }
    .audit-info-badge.event { background: var(--color-yellow-light); color: var(--color-text); }
    .audit-tag {
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: var(--color-bg); border: 1px solid var(--color-border);
    }
    .audit-tag.ok { background: var(--color-green-light); border-color: var(--color-green); color: var(--color-green-dark); }
    .audit-tag.warn { background: var(--color-orange-light); border-color: var(--color-orange); color: var(--color-orange-dark); }
    .audit-tag.ng { background: rgba(232, 139, 139, 0.3); border-color: var(--color-error); color: var(--color-error); }

    /* Êù°‰ª∂ÂàÜÊûêUIÔºàÊñ∞Ê©üËÉΩÔºâ */
    .audit-collapsible summary { cursor: pointer; user-select: none; }
    .audit-collapsible summary:hover { background: var(--color-bg); }
    .audit-section-title.clickable { padding: 8px 12px; margin: -10px -10px 10px -10px; border-radius: 6px 6px 0 0; }
    .audit-subsection-title { font-size: 12px; font-weight: 600; color: var(--color-text); padding: 6px 0; margin-bottom: 8px; }
    .audit-subsection-title.clickable { cursor: pointer; padding: 8px; margin: 0 -8px 8px -8px; background: var(--color-bg); border-radius: 4px; }
    .audit-subsection-title.clickable:hover { background: var(--color-border); }

    /* Â§âÊõ¥„ÉªÁâπÂà•Ë®™Âïè„Ç¢„Ç§„ÉÜ„É† */
    .audit-change-item, .audit-special-item {
      font-size: 12px; margin-bottom: 6px; padding: 8px 10px;
      background: var(--color-bg); border-radius: 6px; border-left: 3px solid var(--color-orange);
    }
    .audit-special-item { border-left-color: var(--color-blue); }
    .audit-op-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    }
    .audit-op-badge.op-„Ç≠„É£„É≥„Çª„É´ { background: var(--color-error); color: var(--color-white); }
    .audit-op-badge.op-ÊôÇÈñìÂ§âÊõ¥ { background: var(--color-orange); color: var(--color-white); }
    .audit-op-badge.op-ËøΩÂä† { background: var(--color-green); color: var(--color-white); }
    .audit-mode-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    }
    .audit-mode-badge.mode-REPLACE { background: var(--color-error); color: var(--color-white); }
    .audit-mode-badge.mode-ADD { background: var(--color-blue); color: var(--color-white); }
    .audit-note { color: var(--color-text-light); font-style: italic; }

    /* Êó•Âà•Ë°å„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Éú„Éº„ÉÄ„Éº */
    .audit-day-row.status-ng { border-left: 4px solid var(--color-error); }
    .audit-day-row.status-warn { border-left: 4px solid var(--color-orange); }
    .audit-day-row.status-ok { border-left: 4px solid var(--color-green); }
    .violation-summary { font-size: 11px; color: var(--color-text-light); }

    /* Êù°‰ª∂ÂàÜÊûê„Çª„ÇØ„Ç∑„Éß„É≥ */
    .audit-conditions-section { margin-bottom: 12px; }
    .audit-conditions-grid { display: flex; flex-direction: column; gap: 10px; }
    .audit-condition-category {
      background: var(--color-white); border: 1px solid var(--color-border);
      border-radius: 6px; padding: 10px; overflow: hidden;
    }
    .category-header {
      font-size: 11px; font-weight: 600; color: var(--color-text-light);
      text-transform: uppercase; margin-bottom: 8px; padding-bottom: 6px;
      border-bottom: 1px solid var(--color-border);
    }

    /* Êù°‰ª∂„Ç¢„Ç§„ÉÜ„É† */
    .audit-condition-item {
      padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
      background: var(--color-bg); border-left: 3px solid var(--color-border);
      font-size: 12px;
    }
    .audit-condition-item.status-ok { border-left-color: var(--color-green); background: rgba(144, 238, 144, 0.1); }
    .audit-condition-item.status-warn { border-left-color: var(--color-orange); background: rgba(255, 193, 7, 0.1); }
    .audit-condition-item.status-ng { border-left-color: var(--color-error); background: rgba(232, 139, 139, 0.15); }
    .audit-condition-item:last-child { margin-bottom: 0; }

    .cond-status-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; border-radius: 50%; font-size: 11px; font-weight: bold;
      margin-right: 6px;
    }
    .cond-status-icon.ok { background: var(--color-green); color: var(--color-white); }
    .cond-status-icon.warn { background: var(--color-orange); color: var(--color-white); }
    .cond-status-icon.ng { background: var(--color-error); color: var(--color-white); }

    .cond-label { font-weight: 600; margin-right: 8px; }
    .cond-severity-badge {
      font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600;
      vertical-align: middle;
    }
    .cond-severity-badge.severity-critical { background: var(--color-error); color: var(--color-white); }
    .cond-severity-badge.severity-warning { background: var(--color-orange); color: var(--color-white); }
    .cond-severity-badge.severity-info { background: var(--color-text-light); color: var(--color-white); }

    .cond-detail { margin-top: 4px; color: var(--color-text-light); font-size: 11px; }
    .cond-expected { display: inline; }
    .cond-actual { display: inline; font-weight: 500; }
    .cond-diff-detail {
      margin-top: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px;
    }
    .cond-diff-detail.diff-ng { background: rgba(232, 139, 139, 0.2); color: var(--color-error); }
    .cond-diff-detail.diff-warn { background: rgba(255, 193, 7, 0.2); color: var(--color-orange-dark); }

    .severity-critical { color: var(--color-error); font-weight: 600; }

    /* Êù°‰ª∂ÈÅïÂèç„Çª„ÇØ„Ç∑„Éß„É≥ */
    .audit-violations-section {
      background: rgba(232, 139, 139, 0.1); border: 1px solid rgba(232, 139, 139, 0.3);
      border-radius: 6px; padding: 10px; margin-bottom: 12px;
    }
    .violations-title { color: var(--color-error); border-bottom: 1px solid rgba(232, 139, 139, 0.3); }
    .audit-violation-item {
      padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
      display: flex; align-items: flex-start; gap: 8px; flex-wrap: wrap;
    }
    .audit-violation-item:last-child { margin-bottom: 0; }
    .audit-violation-item.violation-ng { background: rgba(232, 139, 139, 0.2); }
    .audit-violation-item.violation-warn { background: rgba(255, 193, 7, 0.2); }
    .violation-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold;
      flex-shrink: 0;
    }
    .violation-ng .violation-icon { background: var(--color-error); color: var(--color-white); }
    .violation-warn .violation-icon { background: var(--color-orange); color: var(--color-white); }
    .violation-label { font-weight: 600; font-size: 12px; }
    .violation-severity { font-size: 10px; color: var(--color-text-light); }
    .violation-detail { width: 100%; font-size: 11px; color: var(--color-text); padding-left: 28px; margin-top: 2px; }

    /* ÊúüÂæÖvsÂÆüÁ∏æ„Çª„ÇØ„Ç∑„Éß„É≥ */
    .audit-compare-details { margin-bottom: 8px; }
    .audit-checks-details { margin-top: 8px; }

    /* ============================================================
       ÈÄ±Èñì„Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„ÉºÔºàÊÇ£ËÄÖË©≥Á¥∞Áî®Ôºâ
       ============================================================ */
    .audit-week-overview {
      margin-bottom: 16px;
    }
    .audit-week-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--color-green);
    }
    .audit-week-title {
      font-size: 14px; font-weight: 600; color: var(--color-text);
    }
    .audit-week-legend {
      display: flex; gap: 12px; font-size: 11px;
    }
    .audit-week-legend-item {
      display: flex; align-items: center; gap: 4px;
    }
    .audit-week-legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
    }
    .audit-week-legend-dot.ok { background: var(--color-green); }
    .audit-week-legend-dot.warn { background: var(--color-orange); }
    .audit-week-legend-dot.ng { background: var(--color-error); }

    .audit-week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .audit-week-day {
      border: 2px solid var(--color-border);
      border-radius: 8px;
      padding: 10px 8px;
      text-align: center;
      background: var(--color-white);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
    }
    .audit-week-day.no-visit {
      background: var(--color-bg);
      opacity: 0.6;
    }
    .audit-week-day.status-ok {
      border-color: var(--color-green);
      background: rgba(144, 238, 144, 0.1);
    }
    .audit-week-day.status-warn {
      border-color: var(--color-orange);
      background: rgba(255, 193, 7, 0.1);
      cursor: pointer;
    }
    .audit-week-day.status-warn:hover {
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      transform: translateY(-2px);
    }
    .audit-week-day.status-ng {
      border-color: var(--color-error);
      background: rgba(232, 139, 139, 0.15);
      cursor: pointer;
    }
    .audit-week-day.status-ng:hover {
      box-shadow: 0 4px 12px rgba(232, 139, 139, 0.3);
      transform: translateY(-2px);
    }
    .audit-week-day-date {
      font-size: 12px; color: var(--color-text-light);
      margin-bottom: 2px;
    }
    .audit-week-day-youbi {
      font-size: 14px; font-weight: 600; color: var(--color-text);
      margin-bottom: 8px;
    }
    .audit-week-day-status {
      font-size: 24px; font-weight: bold; margin-bottom: 6px;
    }
    .audit-week-day-status.ok { color: var(--color-green-dark); }
    .audit-week-day-status.warn { color: var(--color-orange-dark); }
    .audit-week-day-status.ng { color: var(--color-error); }
    .audit-week-day-time {
      font-size: 11px; color: var(--color-text);
      margin-bottom: 2px;
    }
    .audit-week-day-staff {
      font-size: 10px; color: var(--color-text-light);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .audit-week-day-novisit {
      font-size: 11px; color: var(--color-text-light);
      margin-top: auto;
    }
    .audit-week-day-click-hint {
      font-size: 10px; color: var(--color-text-light);
      margin-top: auto; padding-top: 4px;
    }
    .audit-week-day.status-warn .audit-week-day-click-hint,
    .audit-week-day.status-ng .audit-week-day-click-hint {
      color: inherit; opacity: 0.7;
    }

    /* Êó•Âà•Ë©≥Á¥∞„Éì„É•„ÉºÔºà„Éâ„É™„É´„ÉÄ„Ç¶„É≥ÂæåÔºâ */
    .audit-day-detail-view {
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .audit-back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--color-bg); border: 1px solid var(--color-border);
      border-radius: 6px; padding: 8px 14px; cursor: pointer;
      font-size: 12px; color: var(--color-text); font-weight: 500;
      margin-bottom: 16px; transition: all 0.2s;
    }
    .audit-back-btn:hover {
      background: var(--color-border);
    }
    .audit-day-detail-header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; margin-bottom: 16px;
      border-radius: 8px; background: var(--color-bg);
    }
    .audit-day-detail-header.status-ok { background: rgba(144, 238, 144, 0.2); border-left: 4px solid var(--color-green); }
    .audit-day-detail-header.status-warn { background: rgba(255, 193, 7, 0.2); border-left: 4px solid var(--color-orange); }
    .audit-day-detail-header.status-ng { background: rgba(232, 139, 139, 0.2); border-left: 4px solid var(--color-error); }
    .audit-day-detail-date {
      font-size: 18px; font-weight: 600;
    }
    .audit-day-detail-status {
      font-size: 20px; font-weight: bold;
    }
    .audit-day-detail-status.ok { color: var(--color-green-dark); }
    .audit-day-detail-status.warn { color: var(--color-orange-dark); }
    .audit-day-detail-status.ng { color: var(--color-error); }

    /* ============================================================
       „Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ„É¢„Éº„ÉÄ„É´
       ============================================================ */
    .kaipoke-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .kaipoke-modal.show { display: flex; }
    .kaipoke-modal-content {
      background: var(--color-white); border-radius: 12px;
      width: 95vw; height: 90vh;
      display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .kaipoke-modal-header {
      background: var(--color-blue); color: var(--color-white); padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 15px; border-radius: 12px 12px 0 0;
    }
    .kaipoke-modal-body {
      flex: 1; overflow: hidden; display: flex; flex-direction: row;
    }
    /* Â∑¶„Éë„Éç„É´: VNC„Éì„É•„Éº„Ç¢ (70%) */
    .kaipoke-viewer-panel {
      flex: 7; display: flex; flex-direction: column; background: #1a1a1a;
      border-right: 1px solid var(--color-border); border-radius: 0 0 0 12px;
    }
    .kaipoke-viewer-header {
      padding: 10px 16px; background: #2d2d2d; color: #fff;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 13px; border-bottom: 1px solid #444;
    }
    .kaipoke-viewer-status { display: flex; align-items: center; gap: 8px; }
    .kaipoke-viewer-status-dot {
      width: 10px; height: 10px; border-radius: 50%; background: #666;
    }
    .kaipoke-viewer-status-dot.connected { background: #34a853; }
    .kaipoke-viewer-status-dot.connecting { background: #fbbc04; animation: kaipoke-pulse 1s infinite; }
    .kaipoke-viewer-status-dot.error { background: #ea4335; }
    @keyframes kaipoke-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .kaipoke-viewer-frame-container {
      flex: 1; display: flex; align-items: center; justify-content: center;
      background: #1a1a1a; position: relative;
    }
    .kaipoke-viewer-frame {
      width: 100%; height: 100%; border: none; background: #000;
    }
    .kaipoke-viewer-placeholder {
      color: #888; text-align: center; padding: 40px;
    }
    .kaipoke-viewer-placeholder-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .kaipoke-viewer-placeholder-text { font-size: 14px; line-height: 1.8; }
    .kaipoke-viewer-error {
      background: rgba(234,67,53,0.1); border: 1px solid #ea4335;
      border-radius: 8px; padding: 20px; margin: 20px; color: #ea4335;
    }
    .kaipoke-viewer-error-title { font-weight: 600; margin-bottom: 8px; }
    /* Âè≥„Éë„Éç„É´: „Ç≥„É≥„Éà„É≠„Éº„É´ (30%) */
    .kaipoke-control-panel {
      flex: 3; display: flex; flex-direction: column; overflow-y: auto;
      background: var(--color-bg); min-width: 280px; max-width: 360px;
      border-radius: 0 0 12px 0;
    }
    .kaipoke-control-panel::-webkit-scrollbar { width: 6px; }
    .kaipoke-control-panel::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
    .kaipoke-section {
      background: var(--color-white); border-radius: 8px; padding: 14px; margin: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .kaipoke-section:first-child { margin-top: 12px; }
    .kaipoke-section.logs-section { flex: 1; display: flex; flex-direction: column; min-height: 120px; }
    .kaipoke-logs-container { flex: 1; overflow-y: auto; }
    .kaipoke-logs {
      background: #1a1a1a; color: #0f0; font-family: monospace; font-size: 11px;
      padding: 10px; border-radius: 4px; min-height: 80px; max-height: 150px;
      overflow-y: auto; white-space: pre-wrap; word-break: break-all;
    }
    .kaipoke-section-title { font-weight: 600; color: var(--color-text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .kaipoke-status-indicator {
      width: 12px; height: 12px; border-radius: 50%; display: inline-block;
    }
    .kaipoke-status-indicator.ready { background: var(--color-success); }
    .kaipoke-status-indicator.busy { background: var(--color-orange); }
    .kaipoke-status-indicator.error { background: var(--color-error); }
    .kaipoke-input-group { margin-bottom: 12px; }
    .kaipoke-input-group label { display: block; font-size: 12px; color: var(--color-text-light); margin-bottom: 4px; }
    .kaipoke-input-group select, .kaipoke-input-group input {
      width: 100%; padding: 8px 10px; border: 1px solid var(--color-border); border-radius: 6px;
      font-size: 13px; box-sizing: border-box;
    }
    .kaipoke-btn {
      width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 8px;
      cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;
    }
    .kaipoke-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .kaipoke-btn.primary { background: var(--color-blue); color: var(--color-white); }
    .kaipoke-btn.primary:hover:not(:disabled) { background: var(--color-blue-dark); }
    .kaipoke-btn.success { background: var(--color-success); color: var(--color-white); }
    .kaipoke-btn.success:hover:not(:disabled) { background: var(--color-green-dark); }
    .kaipoke-btn.warning { background: var(--color-orange); color: var(--color-white); }
    .kaipoke-btn.warning:hover:not(:disabled) { background: var(--color-orange-dark); }
    .kaipoke-btn.danger { background: var(--color-error); color: var(--color-white); }
    .kaipoke-btn.danger:hover:not(:disabled) { background: #c0392b; }
    .kaipoke-btn.info { background: #5f6368; color: var(--color-white); }
    .kaipoke-btn.info:hover:not(:disabled) { background: #4a4d51; }
    .kaipoke-btn.emergency {
      background: linear-gradient(135deg, #dc0000 0%, #ff0000 50%, #dc0000 100%);
      color: #ffffff; font-size: 18px; font-weight: 900; padding: 16px 12px;
      border: 3px solid #8b0000; border-radius: 10px;
      box-shadow: 0 4px 15px rgba(220, 0, 0, 0.5);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      letter-spacing: 2px; animation: emergency-pulse 2s ease-in-out infinite;
    }
    .kaipoke-btn.emergency:hover:not(:disabled) {
      background: linear-gradient(135deg, #ff0000 0%, #ff3333 50%, #ff0000 100%);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.7); transform: scale(1.02);
    }
    .kaipoke-btn.emergency:active:not(:disabled) { transform: scale(0.98); }
    @keyframes emergency-pulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(220, 0, 0, 0.5); }
      50% { box-shadow: 0 4px 25px rgba(255, 0, 0, 0.8); }
    }
    .kaipoke-result {
      background: var(--color-white); border: 1px solid var(--color-border); border-radius: 6px;
      padding: 12px; min-height: 60px; white-space: pre-wrap; font-size: 12px; color: var(--color-text);
    }
    .kaipoke-result.error { color: var(--color-error); }
    .kaipoke-loading { display: none; text-align: center; padding: 16px; }
    .kaipoke-loading.show { display: block; }
    .kaipoke-spinner {
      border: 3px solid var(--color-border); border-top-color: var(--color-blue);
      border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }

    /* „Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØ */
    .kaipoke-lock-msg {
      font-size: 12px; color: var(--color-error); padding: 4px 8px; margin: -4px 0 8px 0;
      background: #fef7f7; border-radius: 4px; border: 1px solid #fce8e6;
    }
    .kaipoke-completed-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .kaipoke-completed-tag {
      display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px;
      background: #e8f5e9; border-radius: 4px; font-size: 11px; color: #2e7d32; cursor: pointer;
    }
    .kaipoke-completed-tag:hover { background: #fce8e6; color: #c62828; }
    .kaipoke-interlock-panel { margin-top: 8px; }
    .kaipoke-interlock-row { display: flex; gap: 4px; margin-bottom: 8px; }
    .kaipoke-interlock-row select { flex: 1; padding: 6px; font-size: 12px; border: 1px solid var(--color-border); border-radius: 4px; }
    .kaipoke-interlock-row button { padding: 6px 10px; font-size: 11px; white-space: nowrap; }

    /* ============================================================
       „É´„Éº„Éà„Éû„ÉÉ„Éó„É¢„Éº„ÉÄ„É´
       ============================================================ */
    .route-map-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1100;
    }
    .route-map-modal.show { display: flex; }
    .route-map-modal-content {
      background: var(--color-white); border-radius: 12px; width: 90%; max-width: 900px;
      height: 85vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .route-map-header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white); padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 15px; border-radius: 12px 12px 0 0;
    }
    .route-map-header-info { display: flex; flex-direction: column; gap: 2px; }
    .route-map-header-title { font-size: 16px; }
    .route-map-header-subtitle { font-size: 12px; opacity: 0.9; }
    .route-map-close-btn {
      background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px;
      border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;
    }
    .route-map-close-btn:hover { background: rgba(255,255,255,0.3); }
    .route-map-body { flex: 1; display: flex; overflow: hidden; }
    #routeMapContainer { flex: 1; min-height: 300px; }
    .route-map-sidebar {
      width: 280px; background: var(--color-bg); border-left: 1px solid var(--color-border);
      overflow-y: auto; padding: 12px;
    }
    .route-stop-item {
      background: var(--color-white); border-radius: 8px; padding: 10px 12px;
      margin-bottom: 8px; border-left: 4px solid var(--color-green);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s;
    }
    .route-stop-item:hover { border-left-color: var(--color-blue); background: var(--color-blue-light); }
    .route-stop-item.office { border-left-color: #FF8C00; }
    .route-stop-number {
      display: inline-flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; background: var(--color-green); color: white;
      border-radius: 50%; font-size: 12px; font-weight: 600; margin-right: 8px;
    }
    .route-stop-number.office { background: #FF8C00; }
    .route-stop-name { font-weight: 600; font-size: 13px; color: var(--color-text); }
    .route-stop-address { font-size: 11px; color: var(--color-text-light); margin-top: 4px; }
    .route-map-stats {
      background: var(--color-white); border-radius: 8px; padding: 12px;
      margin-bottom: 12px; border: 1px solid var(--color-border);
    }
    .route-map-stat-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }
    .route-map-stat-label { color: var(--color-text-light); }
    .route-map-stat-value { font-weight: 600; color: var(--color-text); }
    .route-table-clickable tr { cursor: pointer; }
    .route-table-clickable tr:hover td { background: var(--color-blue-light) !important; }
    /* ÊÇ£ËÄÖË©≥Á¥∞„Éë„Éç„É´Ôºà„É´„Éº„Éà„Éû„ÉÉ„ÉóÂÜÖÔºâ */
    #routeStopListContainer { display: block; }
    .route-patient-detail-header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 0; margin-bottom: 8px; border-bottom: 1px solid var(--color-border);
    }
    .route-patient-back-btn {
      background: var(--color-blue); color: white; border: none;
      padding: 6px 12px; border-radius: 6px; font-size: 12px;
      cursor: pointer; font-weight: 600;
    }
    .route-patient-back-btn:hover { background: var(--color-blue-dark); }
    .route-patient-detail-title { font-weight: 600; font-size: 13px; color: var(--color-text); }
    .route-patient-detail-content { font-size: 12px; }
    .route-patient-section {
      background: var(--color-white); border-radius: 8px;
      padding: 10px; margin-bottom: 10px; border: 1px solid var(--color-border);
    }
    .route-patient-section-title {
      font-weight: 600; font-size: 12px; color: var(--color-text);
      margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--color-border);
    }
    .route-patient-info-row {
      display: flex; justify-content: space-between; padding: 4px 0;
      border-bottom: 1px dashed var(--color-border);
    }
    .route-patient-info-row:last-child { border-bottom: none; }
    .route-patient-info-label { color: var(--color-text-light); font-size: 11px; }
    .route-patient-info-value { font-weight: 600; color: var(--color-text); font-size: 11px; }
    .route-patient-info-value.highlight { color: var(--color-blue); }
    .route-patient-info-value.critical { color: var(--color-error); }
    .route-stop-detail-btn {
      background: var(--color-blue-light); color: var(--color-blue); border: none;
      padding: 3px 8px; border-radius: 4px; font-size: 10px;
      cursor: pointer; margin-left: auto; white-space: nowrap;
    }
    .route-stop-detail-btn:hover { background: var(--color-blue); color: white; }
    .route-stop-item-header { display: flex; align-items: center; width: 100%; }
    .route-stop-item-info { flex: 1; }
    .route-patient-loading { text-align: center; color: #999; padding: 20px; }
    .route-patient-error { color: var(--color-error); padding: 10px; }
  </style>
  <!-- Leaflet.js for route map visualization -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
</head>
<body>

  <!-- „Éò„ÉÉ„ÉÄ„Éº -->
  <div class="header">
    <h1>Ë®™ÂïèÁúãË≠∑ Ëá™Âãï„Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞</h1>
    <span class="header-status" id="headerStatus">Âá∫ÂäõÁîªÈù¢</span>
  </div>

  <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
  <div class="main-container">
    <!-- Â∑¶Ôºö„É°„Ç§„É≥Ë°®Á§∫ -->
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="refreshCurrentView()">Êõ¥Êñ∞</button>
      </div>
      <div id="mainContent">
        <div class="table-container">
          <table class="week-table" id="weekTable"></table>
        </div>
      </div>
      <!-- Áõ£Êüª„Éì„É•„Éº„Ç®„É™„Ç¢ -->
      <div id="auditArea" style="display:none; flex-direction:column; flex:1;">
        <div class="audit-controls">
          <label>ÈÄ±ÈñãÂßãÊó•:
            <input type="date" id="auditWeekStart" onchange="loadAuditData()">
          </label>
          <button class="refresh-btn" onclick="loadAuditData()">Êõ¥Êñ∞</button>
          <button class="refresh-btn" onclick="refreshAuditData()" title="„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçË™≠Ëæº">üîÑ ÂÜçË™≠Ëæº</button>
          <span class="audit-legend">Âá°‰æã: <span class="audit-ok">‚óãOK</span> <span class="audit-warn">‚ñ≥WARN</span> <span class="audit-ng">√óNG</span></span>
        </div>
        <div class="audit-toolbar">
          <div class="audit-filters">
            <span class="filter-label">Ë°®Á§∫:</span>
            <button class="audit-filter-btn active" data-filter="all" onclick="setAuditFilter('all')">ÂÖ®„Å¶</button>
            <button class="audit-filter-btn" data-filter="issues" onclick="setAuditFilter('issues')">NG+WARN</button>
            <button class="audit-filter-btn" data-filter="ng" onclick="setAuditFilter('ng')">NG„ÅÆ„Åø</button>
          </div>
          <div class="audit-summary" id="auditSummary"></div>
          <div class="audit-cache-status" id="auditCacheStatus"></div>
        </div>
        <div class="audit-warnings" id="auditWarnings" style="display:none;"></div>
        <div class="audit-main">
          <div class="audit-week-view">
            <table class="audit-table" id="auditWeekTable">
              <thead><tr><th>„Çπ„Çø„ÉÉ„Éï</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="audit-detail-panel" id="auditDetailPanel" style="display:none;">
            <div class="audit-detail-header">
              <span id="auditDetailTitle">„Çª„É´Ë©≥Á¥∞</span>
              <button class="audit-close-btn" onclick="closeAuditDetail()">√ó</button>
            </div>
            <div class="audit-detail-content" id="auditDetailContent"></div>
          </div>
        </div>
      </div>
      <!-- ÊÇ£ËÄÖË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
      <div class="audit-patient-modal" id="auditPatientModal" style="display:none;">
        <div class="audit-modal-content">
          <div class="audit-modal-header">
            <span id="auditModalTitle">ÊÇ£ËÄÖË©≥Á¥∞</span>
            <button class="audit-close-btn" onclick="closeAuditPatientModal()">√ó</button>
          </div>
          <div class="audit-modal-body" id="auditModalBody"></div>
        </div>
      </div>
    </div>

    <!-- Âè≥ÔºöGASÂÆüË°å„É°„Éã„É•„Éº -->
    <div class="right-panel">
      <div class="panel-title">GASÂÆüË°å„É°„Éã„É•„Éº</div>

      <!-- ÂØæË±°Êúà„ÉªÂØæË±°ÈÄ±„Çª„É¨„ÇØ„Çø„Éº -->
      <div class="week-selector">
        <label>ÂØæË±°Êúà</label>
        <select id="jobTargetMonth" onchange="onJobMonthChange()"></select>
        <label>ÂØæË±°ÈÄ±</label>
        <select id="jobTargetWeek" onchange="updateJobWeekLabel()"></select>
        <div id="jobCurrentWeekLabel" class="current-week-label"></div>
      </div>

      <div class="button-group">
        <div class="button-group-title">„Çπ„Ç±„Ç∏„É•„Éº„É´ÁîüÊàê</div>
        <button class="action-btn primary" onclick="runJob('weeklyRequest', this)">
          <span class="icon">üìã</span><span class="spinner"></span>
          ÈÄ±Èñì„É™„ÇØ„Ç®„Çπ„Éà„ÇíÁîüÊàê
        </button>
        <button class="action-btn primary" onclick="runJob('assignResult', this)">
          <span class="icon">üìÖ</span><span class="spinner"></span>
          Ââ≤ÂΩìÁµêÊûú„Çí‰ΩúÊàê
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">„Éá„Éº„ÇøÊõ¥Êñ∞</div>
        <button class="action-btn secondary" onclick="runJob('updateWeekView', this)">
          <span class="icon">üîÑ</span><span class="spinner"></span>
          ÈÄ±„Éì„É•„Éº„ÇíÊõ¥Êñ∞
        </button>
        <button class="action-btn secondary" onclick="runJob('routeSummary', this)">
          <span class="icon">üó∫Ô∏è</span><span class="spinner"></span>
          „É´„Éº„Éà„Çµ„Éû„É™„Çí‰ΩúÊàê
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">Áõ£Êüª</div>
        <button class="action-btn audit" id="auditNavBtn" onclick="showAuditView()">
          <span class="icon">‚úì</span>
          Áõ£Êüª„Éì„É•„Éº„ÇíÈñã„Åè
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">„Ç´„Ç§„Éù„Ç±ÈÄ£Êê∫</div>
        <button class="action-btn primary" onclick="exportKaipokeCsv()">
          <span class="icon">üì§</span>
          CSVÂá∫Âäõ
        </button>
        <button class="action-btn secondary" onclick="openKaipokeModal()">
          <span class="icon">ü§ñ</span>
          „Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ
        </button>
      </div>

      <div class="log-section">
        <div class="log-title">
          <span>ÊúÄËøë„ÅÆÂÆüË°å„É≠„Ç∞</span>
          <button class="refresh-btn" onclick="loadLogs()" style="padding:4px 10px;font-size:11px;">Êõ¥Êñ∞</button>
        </div>
        <div class="log-list" id="logList">„É≠„Ç∞„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- ‰∏ãÈÉ®„Çø„Éñ„Éê„Éº -->
  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-tab="weekView" onclick="showTab('weekView', this)">ÈÄ±„Éì„É•„Éº</button>
      <button class="tab-btn" data-tab="weeklyRequest" onclick="showTab('weeklyRequest', this)">ÈÄ±Èñì„É™„ÇØ„Ç®„Çπ„Éà</button>
      <button class="tab-btn" data-tab="assignResult" onclick="showTab('assignResult', this)">Ââ≤ÂΩìÁµêÊûú</button>
      <button class="tab-btn" data-tab="assignNg" onclick="showTab('assignNg', this)">Ââ≤ÂΩì‰∏çÂèØ</button>
      <button class="tab-btn" data-tab="routeSummary" onclick="showTab('routeSummary', this)">„É´„Éº„Éà„Çµ„Éû„É™</button>
    </div>
    <div class="tabs-right">
      <a class="nav-link" id="inputLink" onclick="goToInput()">ÂÖ•ÂäõÁÆ°ÁêÜÁîªÈù¢„Å∏ ‚Üí</a>
    </div>
  </div>

  <!-- „Éà„Éº„Çπ„Éà -->
  <div class="toast" id="toast"></div>

  <!-- „Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ„É¢„Éº„ÉÄ„É´ -->
  <div class="kaipoke-modal" id="kaipokeModal">
    <div class="kaipoke-modal-content">
      <div class="kaipoke-modal-header">
        <span>„Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ - RPAÂÆüË°å„É¢„Éã„Çø„Éº</span>
        <button class="audit-close-btn" onclick="closeKaipokeModal()">√ó</button>
      </div>
      <div class="kaipoke-modal-body">
        <!-- Â∑¶„Éë„Éç„É´: VNC„Éì„É•„Éº„Ç¢ -->
        <div class="kaipoke-viewer-panel">
          <div class="kaipoke-viewer-header">
            <div class="kaipoke-viewer-status">
              <span class="kaipoke-viewer-status-dot" id="kaipokeVncStatusDot"></span>
              <span id="kaipokeVncStatusText">Êú™Êé•Á∂ö</span>
            </div>
            <div>
              <span id="kaipokeVncHost">-</span>
            </div>
          </div>
          <div class="kaipoke-viewer-frame-container">
            <!-- VNC iframe (ÂàùÊúü„ÅØÈùûË°®Á§∫) -->
            <iframe id="kaipokeVncFrame" class="kaipoke-viewer-frame" style="display:none;" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
            <!-- „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº (ÂàùÊúüË°®Á§∫) -->
            <div class="kaipoke-viewer-placeholder" id="kaipokeVncPlaceholder">
              <div class="kaipoke-viewer-placeholder-icon">üñ•Ô∏è</div>
              <div class="kaipoke-viewer-placeholder-text">
                VNC„Éì„É•„Éº„Ç¢<br>
                „ÄåÊé•Á∂ö„ÉÜ„Çπ„Éà„Äç„Åß„Çµ„Éº„Éê„Éº„Å®„ÅÆÊé•Á∂ö„ÇíÁ¢∫Ë™çÂæå„ÄÅ<br>
                „ÄåÊúàÈñì„Çπ„Ç±„Ç∏„É•„Éº„É´Â±ïÈñã„Äç„Å™„Å©„ÇíÂÆüË°å„Åô„Çã„Å®<br>
                „Åì„Åì„Å´„Éñ„É©„Ç¶„Ç∂Êìç‰ΩúÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
              </div>
            </div>
            <!-- „Ç®„É©„ÉºË°®Á§∫„Ç®„É™„Ç¢ -->
            <div class="kaipoke-viewer-error" id="kaipokeVncError" style="display:none;">
              <div class="kaipoke-viewer-error-title">‚ö†Ô∏è Ë°®Á§∫„Ç®„É©„Éº</div>
              <div id="kaipokeVncErrorText"></div>
            </div>
          </div>
        </div>

        <!-- Âè≥„Éë„Éç„É´: „Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="kaipoke-control-panel">
          <!-- „Çµ„Éº„Éê„ÉºÁä∂ÊÖã -->
          <div class="kaipoke-section">
            <div class="kaipoke-section-title">
              <span class="kaipoke-status-indicator error" id="kaipokeStatusIndicator"></span>
              <span id="kaipokeStatusText">Á¢∫Ë™ç‰∏≠...</span>
            </div>
            <button class="kaipoke-btn primary" onclick="kaipokeRefreshStatus()">Áä∂ÊÖã„ÇíÊõ¥Êñ∞</button>
          </div>

          <!-- ÂØæË±°Ë®≠ÂÆö -->
          <div class="kaipoke-section">
            <div class="kaipoke-section-title">ÂØæË±°Ë®≠ÂÆö</div>
            <div class="kaipoke-input-group">
              <label>ÂØæË±°Êúà</label>
              <select id="kaipokeTargetMonth" onchange="kaipokeOnMonthChange()"></select>
            </div>
            <div class="kaipoke-input-group">
              <label>ÂØæË±°ÈÄ±ÔºàÂ∑ÆÂàÜÈÅ©Áî®ÊôÇ„Å´ÂøÖË¶ÅÔºâ</label>
              <select id="kaipokeWeekStart" onchange="kaipokeUpdateButtonStates()"></select>
            </div>
          </div>

          <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
          <div class="kaipoke-section">
            <div class="kaipoke-section-title">Ëá™ÂãïÂåñÊìç‰Ωú</div>
            <button class="kaipoke-btn emergency" onclick="kaipokeOpenEmergencyStop()">*** ÈùûÂ∏∏ÂÅúÊ≠¢ ***</button>
            <button class="kaipoke-btn info" onclick="kaipokeTest()">1. Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
            <button class="kaipoke-btn primary" id="kaipokeExpandBtn" onclick="kaipokeExpand()">2. ÊúàÈñì„Çπ„Ç±„Ç∏„É•„Éº„É´Â±ïÈñã</button>
            <div class="kaipoke-lock-msg" id="kaipokeExpandLock" style="display:none;"></div>
            <button class="kaipoke-btn success" onclick="kaipokeExport()">3. CSVÂá∫ÂäõÔºàDrive„Å´‰øùÂ≠òÔºâ</button>
            <button class="kaipoke-btn warning" onclick="kaipokeDiff()">4. Â∑ÆÂàÜÁ¢∫Ë™çÔºà„Éó„É¨„Éì„É•„ÉºÔºâ</button>
            <button class="kaipoke-btn danger" id="kaipokeApplyBtn" onclick="kaipokeApply()" disabled style="opacity:0.5" title="ÂÖà„Å´Â∑ÆÂàÜÁ¢∫Ë™çÔºà„Éó„É¨„Éì„É•„ÉºÔºâ„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ">5. Â∑ÆÂàÜÈÅ©Áî®Ôºà„Ç´„Ç§„Éù„Ç±„Å´ÂèçÊò†Ôºâ</button>
            <div class="kaipoke-lock-msg" id="kaipokeApplyLock" style="display:none;"></div>
          </div>

          <!-- „Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØË®≠ÂÆö -->
          <div class="kaipoke-section">
            <div class="kaipoke-section-title" style="cursor:pointer;" onclick="kaipokeToggleInterlock()">
              „Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØË®≠ÂÆö <span id="kaipokeInterlockArrow">‚ñ∂</span>
            </div>
            <div id="kaipokeInterlockPanel" class="kaipoke-interlock-panel" style="display:none;">
              <div class="kaipoke-input-group">
                <label>ÊúàÈñìÂ±ïÈñã - Âà∂ÈôêÊúàÔºà„Åì„ÅÆÊúà‰ª•Èôç„ÅÆ„ÅøÂÆüË°åÂèØÔºâ</label>
                <div class="kaipoke-interlock-row">
                  <select id="kaipokeExpandMinMonth"></select>
                  <button class="kaipoke-btn primary" onclick="kaipokeSaveExpandMin()">üîí‰øùÂ≠ò</button>
                </div>
              </div>
              <div class="kaipoke-input-group">
                <label>ÊúàÈñìÂ±ïÈñã - ÂÆå‰∫ÜÊúàÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßËß£Èô§ üîíÔºâ</label>
                <div class="kaipoke-completed-tags" id="kaipokeExpandCompleted"><span style="font-size:11px;color:#999;">„Å™„Åó</span></div>
              </div>
              <hr style="border:none;border-top:1px solid var(--color-border);margin:12px 0;">
              <div class="kaipoke-input-group">
                <label>Â∑ÆÂàÜÈÅ©Áî® - Âà∂ÈôêÈÄ±Ôºà„Åì„ÅÆÈÄ±‰ª•Èôç„ÅÆ„ÅøÂÆüË°åÂèØÔºâ</label>
                <div class="kaipoke-interlock-row">
                  <select id="kaipokeApplyMinWeek"></select>
                  <button class="kaipoke-btn primary" onclick="kaipokeSaveApplyMin()">üîí‰øùÂ≠ò</button>
                </div>
              </div>
              <div class="kaipoke-input-group">
                <label>Â∑ÆÂàÜÈÅ©Áî® - ÂÆå‰∫ÜÈÄ±Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßËß£Èô§ üîíÔºâ</label>
                <div class="kaipoke-completed-tags" id="kaipokeApplyCompleted"><span style="font-size:11px;color:#999;">„Å™„Åó</span></div>
              </div>
            </div>
          </div>

          <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
          <div class="kaipoke-loading" id="kaipokeLoading">
            <div class="kaipoke-spinner"></div>
            <div id="kaipokeLoadingText">Âá¶ÁêÜ‰∏≠...</div>
          </div>

          <!-- ÂÆüË°åÁµêÊûú -->
          <div class="kaipoke-section">
            <div class="kaipoke-section-title">ÂÆüË°åÁµêÊûú</div>
            <div class="kaipoke-result" id="kaipokeResult">„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êìç‰Ωú„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
          </div>

          <!-- „É≠„Ç∞Ë°®Á§∫ -->
          <div class="kaipoke-section logs-section">
            <div class="kaipoke-section-title">
              ÂÆüË°å„É≠„Ç∞
              <button class="kaipoke-btn info" style="width:auto; padding:4px 10px; margin:0 0 0 auto; font-size:11px;" onclick="kaipokeRefreshLogs()">Êõ¥Êñ∞</button>
            </div>
            <div class="kaipoke-logs-container">
              <div class="kaipoke-logs" id="kaipokeLogs">„É≠„Ç∞„ÅØ„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- „É´„Éº„Éà„Éû„ÉÉ„Éó„É¢„Éº„ÉÄ„É´ -->
  <div class="route-map-modal" id="routeMapModal">
    <div class="route-map-modal-content">
      <div class="route-map-header">
        <div class="route-map-header-info">
          <div class="route-map-header-title" id="routeMapTitle">Ë®™Âïè„É´„Éº„Éà„Éû„ÉÉ„Éó</div>
          <div class="route-map-header-subtitle" id="routeMapSubtitle"></div>
        </div>
        <button class="route-map-close-btn" onclick="closeRouteMapModal()">√ó</button>
      </div>
      <div class="route-map-body">
        <div id="routeMapContainer"></div>
        <div class="route-map-sidebar">
          <div class="route-map-stats" id="routeMapStats"></div>
          <!-- Ë®™Âïè„É™„Çπ„ÉàÔºà„Éá„Éï„Ç©„É´„ÉàË°®Á§∫Ôºâ -->
          <div id="routeStopListContainer">
            <div id="routeStopList"></div>
          </div>
          <!-- ÊÇ£ËÄÖË©≥Á¥∞„Éë„Éç„É´ÔºàË©≥Á¥∞„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Ë°®Á§∫Ôºâ -->
          <div id="routePatientDetailPanel" style="display:none;">
            <div class="route-patient-detail-header">
              <button class="route-patient-back-btn" onclick="closeRoutePatientDetail()">‚Üê Êàª„Çã</button>
              <span class="route-patient-detail-title" id="routePatientDetailTitle">ÊÇ£ËÄÖË©≥Á¥∞</span>
            </div>
            <div class="route-patient-detail-content" id="routePatientDetailContent">
              <!-- ÊÇ£ËÄÖË©≥Á¥∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var baseUrl = '';
    var currentTab = 'weekView';

    // „Ç∑„Éº„ÉàÂêç„Éû„ÉÉ„Éî„É≥„Ç∞
    var SHEET_MAP = {
      'weekView': 'ÈÄ±„Éì„É•„Éº',
      'weeklyRequest': 'ÈÄ±Èñì„É™„ÇØ„Ç®„Çπ„Éà',
      'assignResult': 'Ââ≤ÂΩìÁµêÊûú',
      'assignNg': 'Ââ≤ÂΩì‰∏çÂèØ',
      'routeSummary': '„É´„Éº„Éà„Çµ„Éû„É™'
    };

    // ÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(function(url) { baseUrl = url; })
        .getBaseUrl();

      initJobWeekSelector();
      loadWeekView();
      loadLogs();

      // kaipoke=1 „Éë„É©„É°„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Ç´„Ç§„Éù„Ç±„É¢„Éº„ÉÄ„É´„ÇíËá™Âãï„ÅßÈñã„Åè
      var urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('kaipoke') === '1') {
        setTimeout(function() { openKaipokeModal(); }, 500);
      }

      // „Çø„ÉñÂæ©Â∏∞ÊôÇ„Å´ÂØæË±°ÈÄ±„ÇíÊúÄÊñ∞„Å´Êõ¥Êñ∞
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          initJobWeekSelector();
        }
      });
    });

    // ============================================================
    // „Çø„ÉñÂàáÊõø
    // ============================================================
    function showTab(tabKey, btn) {
      // Áõ£Êüª„É¢„Éº„Éâ„Åã„Çâ„ÅÆÂæ©Â∏∞Âá¶ÁêÜ
      if (isAuditMode) {
        isAuditMode = false;
        document.getElementById('auditArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        var navBtn = document.getElementById('auditNavBtn');
        if (navBtn) navBtn.classList.remove('active');
      }

      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      currentTab = tabKey;

      if (tabKey === 'weekView') {
        loadWeekView();
      } else {
        loadSheetTable(SHEET_MAP[tabKey]);
      }
    }

    function refreshCurrentView() {
      if (currentTab === 'weekView') {
        loadWeekView();
      } else {
        loadSheetTable(SHEET_MAP[currentTab]);
      }
    }

    // ============================================================
    // ÈÄ±„Éì„É•„ÉºË°®Á§∫
    // ============================================================
    function loadWeekView() {
      setStatus('loading', 'ÈÄ±„Éì„É•„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(renderWeekView)
        .withFailureHandler(function(e) {
          setStatus('error', '„Ç®„É©„Éº: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getWeekViewData();
    }

    function renderWeekView(data) {
      document.getElementById('refreshBtn').disabled = false;

      if (!data.headerRow || data.headerRow.length === 0) {
        setStatus('error', '„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }

      setStatus('success', 'ÈÄ±„Éì„É•„ÉºÔºà' + data.rowCount + 'ÂêçÔºâ');

      var html = '<div class="table-container"><table class="week-table">';

      // „Éò„ÉÉ„ÉÄ„Éº
      html += '<thead><tr>';
      data.headerRow.forEach(function(h) {
        html += '<th>' + escapeHtml(h) + '</th>';
      });
      html += '</tr></thead>';

      // „Éú„Éá„Ç£
      html += '<tbody>';
      data.bodyRows.forEach(function(row) {
        html += '<tr>';
        row.forEach(function(cell, idx) {
          var content = cell ? '<div class="cell-content">' + escapeHtml(cell) + '</div>' : '-';
          html += '<td>' + content + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';

      document.getElementById('mainContent').innerHTML = html;
    }

    // ============================================================
    // Ê±éÁî®„Ç∑„Éº„ÉàË°®Á§∫
    // ============================================================
    function loadSheetTable(sheetName) {
      setStatus('loading', sheetName + ' „ÇíË™≠„ÅøËæº„Åø‰∏≠...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(data) { renderSheetTable(data); })
        .withFailureHandler(function(e) {
          setStatus('error', '„Ç®„É©„Éº: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getSheetTableData(sheetName, 500);
    }

    function renderSheetTable(data) {
      document.getElementById('refreshBtn').disabled = false;

      if (data.error) {
        setStatus('error', data.error);
        return;
      }

      if (!data.header || data.header.length === 0) {
        setStatus('error', '„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
        document.getElementById('mainContent').innerHTML = '<div style="padding:20px;text-align:center;color:#888;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }

      var isRouteSummary = data.sheetName === '„É´„Éº„Éà„Çµ„Éû„É™';
      var statusMsg = (data.sheetName || '') + 'Ôºà' + data.rowCount + 'Ë°åÔºâ';
      if (isRouteSummary) {
        statusMsg += ' - Ë°å„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„Éû„ÉÉ„ÉóË°®Á§∫';
      }
      setStatus('success', statusMsg);

      var tableClass = isRouteSummary ? 'sheet-table route-table-clickable' : 'sheet-table';
      var html = '<div class="table-container"><table class="' + tableClass + '">';

      html += '<thead><tr>';
      data.header.forEach(function(h) {
        html += '<th>' + escapeHtml(h) + '</th>';
      });
      html += '</tr></thead>';

      html += '<tbody>';
      data.rows.forEach(function(row, rowIndex) {
        if (isRouteSummary) {
          var rowDataAttr = ' data-row-index="' + rowIndex + '" onclick="showRouteMap(' + rowIndex + ')"';
          html += '<tr' + rowDataAttr + '>';
        } else {
          html += '<tr>';
        }
        row.forEach(function(cell) {
          html += '<td>' + escapeHtml(cell || '') + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';

      // „É´„Éº„Éà„Çµ„Éû„É™„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éº„Çø„Çí„Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò
      if (isRouteSummary) {
        window.routeSummaryData = { header: data.header, rows: data.rows };
      }

      document.getElementById('mainContent').innerHTML = html;
    }

    // ============================================================
    // ÂØæË±°Êúà„ÉªÂØæË±°ÈÄ±„Çª„É¨„ÇØ„Çø„Éº
    // ============================================================

    /**
     * Êúà„Çª„É¨„ÇØ„Çø„ÉºÂàùÊúüÂåñÔºö‰ªäÂπ¥„ÅÆ12„É∂Êúà„ÇíÁîüÊàê„Åó„ÄÅ‰ªäÊúà„Çí„Éá„Éï„Ç©„É´„Éà„Å´
     */
    function initJobWeekSelector() {
      var select = document.getElementById('jobTargetMonth');
      var now = new Date();
      var year = now.getFullYear();
      select.innerHTML = '';
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'Âπ¥' + m + 'Êúà';
        select.appendChild(opt);
      }
      var currentMonth = year + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
      select.value = currentMonth;
      onJobMonthChange();
    }

    /**
     * ÊåáÂÆöÊúà„ÅÆÊúàÊõúÊó•‰∏ÄË¶ß„ÇíÁîüÊàêÔºà„Ç´„Ç§„Éù„Ç±ÂÅ¥„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØÔºâ
     */
    function getWeeksForMonth(yearMonth) {
      var parts = yearMonth.split('-');
      var year = parseInt(parts[0]);
      var month = parseInt(parts[1]) - 1;
      var weeks = [];
      var date = new Date(year, month, 1);
      while (date.getDay() !== 1) { date.setDate(date.getDate() + 1); }
      var weekNum = 1;
      while (date.getMonth() === month) {
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var dateStr = date.getFullYear() + '-' + mm + '-' + dd;
        weeks.push({ value: dateStr, label: dateStr + 'Ôºà' + (month + 1) + 'Êúà' + weekNum + 'ÈÄ±ÁõÆÔºâ' });
        weekNum++;
        date.setDate(date.getDate() + 7);
      }
      return weeks;
    }

    /**
     * ‰ªäÊó•„Åå„Å©„ÅÆÈÄ±„Å´Â±û„Åô„Çã„Åã„ÇíËøî„ÅôÔºàÊúàÊõúÂü∫Ê∫ñÔºâ
     */
    function getCurrentWeekMonday() {
      var now = new Date();
      now.setHours(0,0,0,0);
      var day = now.getDay();
      var diff = (day + 6) % 7;
      var monday = new Date(now);
      monday.setDate(now.getDate() - diff);
      var mm = ('0' + (monday.getMonth() + 1)).slice(-2);
      var dd = ('0' + monday.getDate()).slice(-2);
      return monday.getFullYear() + '-' + mm + '-' + dd;
    }

    /**
     * ÊúàÂ§âÊõ¥ÊôÇÔºöÈÄ±„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÂÜçÁîüÊàê„Åó„ÄÅ‰ªäÈÄ±„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÈÅ∏Êäû
     */
    function onJobMonthChange() {
      var month = document.getElementById('jobTargetMonth').value;
      var weeks = getWeeksForMonth(month);
      var sel = document.getElementById('jobTargetWeek');
      sel.innerHTML = '';
      weeks.forEach(function(w) {
        var opt = document.createElement('option');
        opt.value = w.value;
        opt.textContent = w.label;
        sel.appendChild(opt);
      });
      // ‰ªäÈÄ±„ÅÆÊúàÊõú„Å´‰∏ÄËá¥„Åô„ÇãÈÅ∏ÊäûËÇ¢„Åå„ÅÇ„Çå„Å∞ÈÅ∏Êäû
      var currentMonday = getCurrentWeekMonday();
      var found = false;
      for (var i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === currentMonday) {
          sel.value = currentMonday;
          found = true;
          break;
        }
      }
      updateJobWeekLabel();
    }

    /**
     * ‰ªäÈÄ±„É©„Éô„É´„ÇíÊõ¥Êñ∞ÔºàÈÅ∏Êäû‰∏≠„ÅÆÈÄ±„Åå‰ªäÈÄ±„Åã„Å©„ÅÜ„Åã„ÇíË°®Á§∫Ôºâ
     */
    function updateJobWeekLabel() {
      var sel = document.getElementById('jobTargetWeek');
      var currentMonday = getCurrentWeekMonday();
      var label = document.getElementById('jobCurrentWeekLabel');
      if (sel.value === currentMonday) {
        label.textContent = 'Ôºà‰ªäÈÄ±„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºâ';
      } else {
        label.textContent = 'Ôºà‰ªäÈÄ±: ' + currentMonday + 'Ôºâ';
      }
      label.style.display = 'inline-block';
    }

    /**
     * ÈÅ∏Êäû‰∏≠„ÅÆÂØæË±°ÈÄ±„ÇíÂèñÂæó
     */
    function getSelectedWeekStart() {
      var sel = document.getElementById('jobTargetWeek');
      return sel ? sel.value : null;
    }

    // ============================================================
    // GASÂÆüË°å
    // ============================================================
    function runJob(jobKey, btn) {
      // ‚Äª initJobWeekSelector() „ÅØ„Åì„Åì„ÅßÂëº„Å∞„Å™„ÅÑ
      //   Ôºà„É¶„Éº„Ç∂„Éº„ÅÆÈÅ∏ÊäûÂÄ§„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Å¶„Åó„Åæ„ÅÜ„Åü„ÇÅÔºâ
      //   Êõ¥Êñ∞„ÅØ visibilitychangeÔºà„Çø„ÉñÂæ©Â∏∞ÊôÇÔºâ„Å®ÂàùÊúü„É≠„Éº„ÉâÊôÇ„ÅÆ„Åø

      var weekStart = getSelectedWeekStart();
      // „É©„Éô„É´„Å†„ÅëÊúÄÊñ∞ÂåñÔºàÈÅ∏ÊäûÂÄ§„ÅØÂ§â„Åà„Å™„ÅÑÔºâ
      updateJobWeekLabel();
      console.log('[runJob] jobKey=' + jobKey + ' weekStart=' + weekStart);

      btn.classList.add('loading');
      btn.disabled = true;

      var allBtns = document.querySelectorAll('.action-btn');
      allBtns.forEach(function(b) { b.disabled = true; });

      google.script.run
        .withSuccessHandler(function(result) {
          btn.classList.remove('loading');
          allBtns.forEach(function(b) { b.disabled = false; });

          if (result.ok) {
            showToast(result.message, 'success');
            if (jobKey === 'updateWeekView' || jobKey === 'assignResult') {
              loadWeekView();
            }
          } else {
            showToast('„Ç®„É©„Éº: ' + result.message, 'error');
          }
          loadLogs();
        })
        .withFailureHandler(function(e) {
          btn.classList.remove('loading');
          allBtns.forEach(function(b) { b.disabled = false; });
          showToast('„Ç®„É©„Éº: ' + e.message, 'error');
          loadLogs();
        })
        .runJob(jobKey, weekStart);
    }

    // ============================================================
    // ÂÆüË°å„É≠„Ç∞
    // ============================================================
    function loadLogs() {
      google.script.run
        .withSuccessHandler(renderLogs)
        .withFailureHandler(function() {
          document.getElementById('logList').innerHTML = '<div style="color:#E88B8B;">„É≠„Ç∞ÂèñÂæóÂ§±Êïó</div>';
        })
        .getExecutionLogs(5);
    }

    function renderLogs(data) {
      if (!data.success || !data.logs || data.logs.length === 0) {
        document.getElementById('logList').innerHTML = '<div style="color:#888;font-style:italic;">„É≠„Ç∞„Å™„Åó</div>';
        return;
      }

      var html = data.logs.map(function(log) {
        var time = formatTime(log.timestamp);
        var cls = log.success ? '' : ' error';
        return '<div class="log-item' + cls + '">' +
          '<div style="display:flex;justify-content:space-between;margin-bottom:3px;">' +
          '<span style="font-weight:600;">' + escapeHtml(log.action) + '</span>' +
          '<span style="color:#666;">' + time + '</span></div>' +
          '<div style="color:#666;">' + escapeHtml(log.message || '') + '</div></div>';
      }).join('');

      document.getElementById('logList').innerHTML = html;
    }

    // ============================================================
    // ÁîªÈù¢ÈÅ∑Áßª
    // ============================================================
    function goToInput() {
      var targetUrl;
      if (baseUrl) {
        targetUrl = baseUrl + '?page=input';
      } else {
        var currentUrl = window.location.href;
        targetUrl = currentUrl.split('?')[0] + '?page=input';
      }
      // GAS„ÅØiframeÂÜÖ„ÅßÂãï„Åè„Åü„ÇÅ„ÄÅwindow.top„Çí‰ΩøÁî®
      try {
        window.top.location.href = targetUrl;
      } catch (e) {
        window.location.href = targetUrl;
      }
    }

    // ============================================================
    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
    // ============================================================
    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function showToast(msg, type) {
      var toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type + ' show';
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        var d = new Date(ts);
        return d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      } catch (e) { return '-'; }
    }

    function escapeHtml(s) {
      var div = document.createElement('div');
      div.textContent = s || '';
      return div.innerHTML;
    }

    // ============================================================
    // Áõ£ÊüªÔºàÂêàÂê¶Âà§ÂÆöÔºâ„Éì„É•„Éº
    // ============================================================
    var isAuditMode = false;
    var auditLoading = false; // „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¨„Éº„ÉâÔºàÂ§öÈáçÂëº„Å≥Âá∫„ÅóÈò≤Ê≠¢Ôºâ
    var auditState = {
      weekStartStr: null,
      data: null,
      selectedCell: null,
      filter: 'all'
    };

    function showAuditView() {
      // Êó¢„Å´Áõ£Êüª„É¢„Éº„Éâ„Åß„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà: ÂØæË±°ÈÄ±„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„Å™„Åë„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó
      if (isAuditMode && auditState.data) {
        var selectedWeekCheck = getSelectedWeekStart();
        var currentAuditDate = document.getElementById('auditWeekStart').value;
        if (selectedWeekCheck && selectedWeekCheck !== currentAuditDate) {
          // ÂØæË±°ÈÄ±„ÅåÂ§â„Çè„Å£„Åü ‚Üí ÂÜçÂêåÊúü„Åó„Å¶ÂÜçË™≠„ÅøËæº„Åø
          document.getElementById('auditWeekStart').value = selectedWeekCheck;
          auditState.data = null;
          auditRetryCount = 0;
          loadAuditData();
        } else {
          console.log('showAuditView: Êó¢„Å´Áõ£Êüª„É¢„Éº„Éâ„ÄÅ„Éá„Éº„Çø„ÅÇ„ÇäÔºàÈÄ±Â§âÊõ¥„Å™„ÅóÔºâ');
        }
        return;
      }

      // „Çø„Éñ„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíËß£Èô§
      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) { b.classList.remove('active'); });

      // „Éä„Éì„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´
      var navBtn = document.getElementById('auditNavBtn');
      if (navBtn) navBtn.classList.add('active');

      // „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
      isAuditMode = true;
      currentTab = 'audit';

      // „Ç®„É™„Ç¢Ë°®Á§∫ÂàáÊõø
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('auditArea').style.display = 'flex';

      // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉºÊõ¥Êñ∞
      setStatus('', 'Áõ£Êüª„Éì„É•„Éº');

      // ÈÄ±ÈñãÂßãÊó•„ÇíÂØæË±°ÈÄ±„Çª„É¨„ÇØ„Çø„Å´ÂêåÊúüÔºàÊú™ÈÅ∏ÊäûÊôÇ„ÅØ‰ªäÈÄ±„ÅÆÊúàÊõúÔºâ
      var dateInput = document.getElementById('auditWeekStart');
      var selectedWeek = getSelectedWeekStart();
      if (selectedWeek) {
        // jobTargetWeek „ÅÆÂÄ§ (YYYY-MM-DD) „Çí„Åù„ÅÆ„Åæ„ÅæË®≠ÂÆö
        dateInput.value = selectedWeek;
      } else if (!dateInput.value) {
        var today = new Date();
        var day = today.getDay();
        var diff = (day === 0) ? -6 : 1 - day;
        var monday = new Date(today);
        monday.setDate(today.getDate() + diff);
        dateInput.value = formatDateISO(monday);
      }

      // „É™„Éà„É©„Ç§„Ç´„Ç¶„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà
      auditRetryCount = 0;

      // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºà„É™„Éà„É©„Ç§Ê©üËÉΩ‰ªò„ÅçÔºâ
      loadAuditData();
    }

    function formatDateISO(d) {
      var y = d.getFullYear();
      var m = ('0' + (d.getMonth() + 1)).slice(-2);
      var dd = ('0' + d.getDate()).slice(-2);
      return y + '-' + m + '-' + dd;
    }

    function formatDateSlash(d) {
      var y = d.getFullYear();
      var m = ('0' + (d.getMonth() + 1)).slice(-2);
      var dd = ('0' + d.getDate()).slice(-2);
      return y + '/' + m + '/' + dd;
    }

    var auditRetryCount = 0;
    var AUDIT_MAX_RETRY = 3;

    function loadAuditData() {
      // Â§öÈáçÂëº„Å≥Âá∫„ÅóÈò≤Ê≠¢
      if (auditLoading) {
        console.log('loadAuditData: Êó¢„Å´„É≠„Éº„Éâ‰∏≠„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
        return;
      }

      var dateInput = document.getElementById('auditWeekStart');
      var dateVal = dateInput.value;
      if (!dateVal) {
        console.warn('loadAuditData: Êó•‰ªò„ÅåÊú™Ë®≠ÂÆö');
        return;
      }

      var parts = dateVal.split('-');
      var weekStartStr = parts[0] + '/' + parts[1] + '/' + parts[2];
      auditState.weekStartStr = weekStartStr;

      auditLoading = true; // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
      console.log('loadAuditData: ÈñãÂßã', weekStartStr, '(„É™„Éà„É©„Ç§:', auditRetryCount, ')');
      setStatus('loading', 'Áõ£Êüª„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...' + (auditRetryCount > 0 ? ' („É™„Éà„É©„Ç§ ' + auditRetryCount + ')' : ''));

      google.script.run
        .withSuccessHandler(function(result) {
          auditLoading = false; // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
          console.log('loadAuditData: GASÂøúÁ≠îÂèó‰ø°', result ? 'OK' : 'null');
          try {
            if (!result) {
              // nullÂøúÁ≠îÊôÇ„ÅØ„É™„Éà„É©„Ç§
              if (auditRetryCount < AUDIT_MAX_RETRY) {
                auditRetryCount++;
                console.log('loadAuditData: nullÂøúÁ≠î„ÄÅ„É™„Éà„É©„Ç§', auditRetryCount);
                setTimeout(function() {
                  loadAuditData();
                }, 800 * auditRetryCount); // „É™„Éà„É©„Ç§ÈñìÈöî„ÇíÂ¢ó„ÇÑ„Åô
                return;
              }
              auditRetryCount = 0;
              setStatus('error', '„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Åã„ÇâÁ©∫„ÅÆÂøúÁ≠îÔºà„É™„Éà„É©„Ç§‰∏äÈôêÔºâ');
              return;
            }
            auditRetryCount = 0; // ÊàêÂäü„Åó„Åü„Çâ„É™„Çª„ÉÉ„Éà
            if (result.error) {
              setStatus('error', '„Ç®„É©„Éº: ' + result.error);
              return;
            }
            auditState.data = result;
            // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„ÇíÂá∫Âäõ
            if (result._debug) {
              console.log('loadAuditData: „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±', result._debug);
            }
            console.log('loadAuditData: staffList count =', (result.staffList || []).length);
            console.log('loadAuditData: cellSummary keys =', Object.keys(result.cellSummary || {}).length);
            console.log('loadAuditData: cellSummary sample =', Object.keys(result.cellSummary || {}).slice(0, 5));
            renderAuditWeekView(result);
            renderAuditSummary(result);
            renderAuditWarnings(result);
            renderAuditCacheStatus(result);
            setStatus('success', 'Áõ£Êüª„Éì„É•„Éº: ' + weekStartStr + ' „Äú ' + (result.weekEndStr || ''));
            console.log('loadAuditData: ÊèèÁîªÂÆå‰∫Ü');
          } catch (renderErr) {
            auditRetryCount = 0;
            console.error('loadAuditData: ÊèèÁîª„Ç®„É©„Éº', renderErr);
            setStatus('error', 'ÊèèÁîª„Ç®„É©„Éº: ' + (renderErr.message || String(renderErr)));
          }
        })
        .withFailureHandler(function(e) {
          auditLoading = false; // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
          auditRetryCount = 0;
          console.error('loadAuditData: GAS„Ç®„É©„Éº', e);
          setStatus('error', '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ' + (e.message || String(e)));
        })
        .audit_getWeekSummary(weekStartStr);
    }

    function refreshAuditData() {
      // Â§öÈáçÂëº„Å≥Âá∫„ÅóÈò≤Ê≠¢
      if (auditLoading) {
        console.log('refreshAuditData: Êó¢„Å´„É≠„Éº„Éâ‰∏≠„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
        return;
      }

      if (!auditState.weekStartStr) {
        loadAuditData();
        return;
      }

      auditLoading = true;
      setStatus('loading', '„Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÔºÜÂÜçË™≠Ëæº‰∏≠...');
      console.log('refreshAuditData: „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÈñãÂßã', auditState.weekStartStr);

      google.script.run
        .withSuccessHandler(function() {
          console.log('refreshAuditData: „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢ÂÆå‰∫Ü„ÄÅ„Éá„Éº„ÇøÂèñÂæóÈñãÂßã');
          auditLoading = false; // loadAuditData„ÅßÂÜçË®≠ÂÆö„Åï„Çå„Çã
          loadAuditData();
        })
        .withFailureHandler(function(e) {
          console.warn('refreshAuditData: „Ç≠„É£„ÉÉ„Ç∑„É•„ÇØ„É™„Ç¢Â§±Êïó„ÄÅ„Éá„Éº„ÇøÂèñÂæóË©¶Ë°å', e);
          auditLoading = false;
          loadAuditData();
        })
        .audit_clearCache(auditState.weekStartStr);
    }

    function setAuditFilter(filter) {
      auditState.filter = filter;
      document.querySelectorAll('.audit-filter-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      if (auditState.data) renderAuditWeekView(auditState.data);
    }

    function renderAuditSummary(data) {
      var summaryEl = document.getElementById('auditSummary');
      if (!summaryEl) return;
      var patientSummary = data.patientSummary || {};
      var totalOk = 0, totalWarn = 0, totalNg = 0, totalPatients = 0;
      for (var pid in patientSummary) {
        var ps = patientSummary[pid];
        totalOk += ps.okCount || 0;
        totalWarn += ps.warnCount || 0;
        totalNg += ps.ngCount || 0;
        totalPatients++;
      }
      var html = '';
      html += '<div class="stat"><span class="stat-label">ÊÇ£ËÄÖ:</span><span class="stat-value">' + totalPatients + 'Âêç</span></div>';
      html += '<div class="stat"><span class="stat-value ok">‚óã' + totalOk + '</span></div>';
      html += '<div class="stat"><span class="stat-value warn">‚ñ≥' + totalWarn + '</span></div>';
      html += '<div class="stat"><span class="stat-value ng">√ó' + totalNg + '</span></div>';
      summaryEl.innerHTML = html;
    }

    function renderAuditWarnings(data) {
      var warningsEl = document.getElementById('auditWarnings');
      if (!warningsEl) return;
      var warnings = data.warnings || [];
      if (warnings.length === 0) { warningsEl.style.display = 'none'; return; }
      var html = '<div class="audit-warnings-title">‚ö† Ë≠¶Âëä</div><div class="audit-warnings-list">';
      warnings.forEach(function(w) { html += '<div>‚Ä¢ ' + w.source + ': ' + w.message + '</div>'; });
      html += '</div>';
      warningsEl.innerHTML = html;
      warningsEl.style.display = 'block';
    }

    function renderAuditCacheStatus(data) {
      var statusEl = document.getElementById('auditCacheStatus');
      if (!statusEl) return;
      if (data.fromCache) {
        statusEl.textContent = '(„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâË™≠Ëæº)';
        statusEl.className = 'audit-cache-status from-cache';
      } else {
        statusEl.textContent = '';
        statusEl.className = 'audit-cache-status';
      }
    }

    function renderAuditWeekView(data) {
      var table = document.getElementById('auditWeekTable');
      var thead = table.querySelector('thead');
      var tbody = table.querySelector('tbody');

      var weekDates = data.weekDates || [];
      var youbiLabels = { 'Mon': 'Êúà', 'Tue': 'ÁÅ´', 'Wed': 'Ê∞¥', 'Thu': 'Êú®', 'Fri': 'Èáë', 'Sat': 'Âúü', 'Sun': 'Êó•' };
      var headerHtml = '<tr><th>„Çπ„Çø„ÉÉ„Éï</th>';
      weekDates.forEach(function(wd) {
        var label = youbiLabels[wd.youbi] || wd.youbi;
        var dateLabel = wd.dateStr.substring(5);
        headerHtml += '<th>' + label + '<br><small>' + dateLabel + '</small></th>';
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      var staffList = data.staffList || [];
      var cellSummary = data.cellSummary || {};
      var bodyHtml = '';

      staffList.forEach(function(staff) {
        bodyHtml += '<tr>';
        bodyHtml += '<td>' + staff.name + '<br><small>' + staff.staffId + '</small></td>';
        weekDates.forEach(function(wd) {
          var sdKey = staff.staffId + '|' + wd.dateStr;
          var items = cellSummary[sdKey] || [];
          var okCount = 0, warnCount = 0, ngCount = 0;
          items.forEach(function(item) {
            if (item.status === 'OK') okCount++;
            else if (item.status === 'WARN') warnCount++;
            else if (item.status === 'NG') ngCount++;
          });
          var cellContent = '';
          if (items.length > 0) {
            cellContent = '<div class="audit-cell-summary">';
            if (okCount > 0) cellContent += '<span class="ok">‚óã' + okCount + '</span>';
            if (warnCount > 0) cellContent += '<span class="warn">‚ñ≥' + warnCount + '</span>';
            if (ngCount > 0) cellContent += '<span class="ng">√ó' + ngCount + '</span>';
            cellContent += '</div>';
          } else {
            cellContent = '<span style="color:#ccc;">-</span>';
          }
          bodyHtml += '<td onclick="showAuditCellDetail(\'' + staff.staffId + '\', \'' + wd.dateStr + '\')">' + cellContent + '</td>';
        });
        bodyHtml += '</tr>';
      });

      // Êú™Ââ≤ÂΩìË°å
      bodyHtml += '<tr><td style="color:var(--color-error);">Êú™Ââ≤ÂΩì</td>';
      weekDates.forEach(function(wd) {
        var sdKey = '_UNASSIGNED_|' + wd.dateStr;
        var items = cellSummary[sdKey] || [];
        var cellContent = items.length > 0
          ? '<div class="audit-cell-summary"><span class="ng">√ó' + items.length + '</span></div>'
          : '<span style="color:#ccc;">-</span>';
        bodyHtml += '<td onclick="showAuditCellDetail(\'_UNASSIGNED_\', \'' + wd.dateStr + '\')">' + cellContent + '</td>';
      });
      bodyHtml += '</tr>';
      tbody.innerHTML = bodyHtml;
    }

    function showAuditCellDetail(staffId, dateStr) {
      auditState.selectedCell = { staffId: staffId, dateStr: dateStr };
      var panel = document.getElementById('auditDetailPanel');
      var content = document.getElementById('auditDetailContent');
      var title = document.getElementById('auditDetailTitle');

      var staffName = staffId;
      if (auditState.data && auditState.data.staffList) {
        var found = auditState.data.staffList.find(function(s) { return s.staffId === staffId; });
        if (found) staffName = found.name;
      }
      if (staffId === '_UNASSIGNED_') staffName = 'Êú™Ââ≤ÂΩì';
      title.textContent = staffName + ' - ' + dateStr.substring(5);
      content.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
      panel.style.display = 'flex';

      console.log('showAuditCellDetail: ÈñãÂßã', staffId, dateStr);
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('showAuditCellDetail: ÂøúÁ≠îÂèó‰ø°');
          try {
            renderAuditCellDetail(data);
          } catch (e) {
            console.error('showAuditCellDetail: ÊèèÁîª„Ç®„É©„Éº', e);
            content.innerHTML = '<div style="color:var(--color-error);">ÊèèÁîª„Ç®„É©„Éº: ' + (e.message || String(e)) + '</div>';
          }
        })
        .withFailureHandler(function(e) {
          console.error('showAuditCellDetail: GAS„Ç®„É©„Éº', e);
          content.innerHTML = '<div style="color:var(--color-error);">„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ' + (e.message || String(e)) + '</div>';
        })
        .audit_getCellDetail(staffId, dateStr, auditState.weekStartStr);
    }

    function renderAuditCellDetail(data) {
      var content = document.getElementById('auditDetailContent');
      var items = data.items || [];
      var filteredItems = items.filter(function(item) {
        if (auditState.filter === 'all') return true;
        if (auditState.filter === 'issues') return item.status === 'NG' || item.status === 'WARN';
        if (auditState.filter === 'ng') return item.status === 'NG';
        return true;
      });
      if (filteredItems.length === 0) {
        var msg = items.length > 0
          ? '„Éï„Ç£„É´„ÇøÊù°‰ª∂„Å´‰∏ÄËá¥„Åô„ÇãË®™Âïè„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàÂÖ®' + items.length + '‰ª∂Ôºâ'
          : '„Åì„ÅÆÊó•„ÅÆË®™Âïè„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
        content.innerHTML = '<div style="text-align:center;color:#999;">' + msg + '</div>';
        return;
      }
      var html = '';
      if (items.length !== filteredItems.length) {
        html += '<div style="font-size:11px;color:#666;margin-bottom:8px;text-align:right;">Ë°®Á§∫: ' + filteredItems.length + '/' + items.length + '‰ª∂</div>';
      }
      filteredItems.forEach(function(item) {
        var statusClass = item.status.toLowerCase();
        var statusIcon = item.status === 'OK' ? '‚óã' : (item.status === 'WARN' ? '‚ñ≥' : '√ó');
        html += '<div class="audit-patient-item" onclick="showAuditPatientDetail(\'' + item.pid + '\')">';
        html += '<span class="status ' + statusClass + '">' + statusIcon + '</span>';
        html += '<span class="name">' + (item.pname || item.pid) + '</span>';
        html += '<span style="font-size:11px;color:#666;">' + (item.startStr || '') + '-' + (item.endStr || '') + '</span>';
        html += '</div>';
        if (item.tags && item.tags.length > 0) {
          html += '<div style="margin:-4px 0 8px 28px;"><span class="tags">';
          item.tags.forEach(function(tag) {
            var tagClass = '';
            if (tag.indexOf('CONFLICT') >= 0 || tag.indexOf('UNASSIGNED') >= 0 || tag.indexOf('CANCELLED_BUT') >= 0 || tag.indexOf('OUT_OF') >= 0) tagClass = 'ng';
            else if (tag.indexOf('DIFF') >= 0 || tag.indexOf('MISSING') >= 0 || tag.indexOf('EXTRA') >= 0) tagClass = 'warn';
            else tagClass = 'ok';
            html += '<span class="audit-tag ' + tagClass + '">' + tag + '</span> ';
          });
          html += '</span></div>';
        }
      });
      content.innerHTML = html;
    }

    function closeAuditDetail() {
      document.getElementById('auditDetailPanel').style.display = 'none';
      auditState.selectedCell = null;
    }

    function showAuditPatientDetail(pid) {
      var modal = document.getElementById('auditPatientModal');
      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'ÊÇ£ËÄÖË©≥Á¥∞: ' + pid;
      body.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
      modal.style.display = 'flex';

      console.log('showAuditPatientDetail: ÈñãÂßã', pid);
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('showAuditPatientDetail: ÂøúÁ≠îÂèó‰ø°');
          try {
            renderAuditPatientDetail(data);
          } catch (e) {
            console.error('showAuditPatientDetail: ÊèèÁîª„Ç®„É©„Éº', e);
            body.innerHTML = '<div style="color:var(--color-error);padding:20px;">ÊèèÁîª„Ç®„É©„Éº: ' + (e.message || String(e)) + '</div>';
          }
        })
        .withFailureHandler(function(e) {
          console.error('showAuditPatientDetail: GAS„Ç®„É©„Éº', e);
          body.innerHTML = '<div style="color:var(--color-error);padding:20px;">„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: ' + (e.message || String(e)) + '</div>';
        })
        .audit_getPatientDetail(pid, auditState.weekStartStr);
    }

    // ÊÇ£ËÄÖË©≥Á¥∞„Éá„Éº„Çø„Çí‰øùÊåÅ„Åô„ÇãÂ§âÊï∞
    var currentPatientDetailData = null;

    function renderAuditPatientDetail(data) {
      // „Éá„Éº„Çø„Çí‰øùÊåÅ
      currentPatientDetailData = data;
      // ÈÄ±ÈñìÊ¶ÇË¶Å„Éì„É•„Éº„ÇíË°®Á§∫
      renderAuditWeekOverview(data);
    }

    // ÊõúÊó•„ÅÆÊó•Êú¨Ë™ûË°®Á§∫„Éû„ÉÉ„Éó
    var youbiJapanese = {
      'Mon': 'Êúà', 'Tue': 'ÁÅ´', 'Wed': 'Ê∞¥', 'Thu': 'Êú®', 'Fri': 'Èáë', 'Sat': 'Âúü', 'Sun': 'Êó•'
    };

    // ÈÄ±ÈñìÊ¶ÇË¶Å„Éì„É•„Éº„ÇíÊèèÁîª
    function renderAuditWeekOverview(data) {
      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'ÊÇ£ËÄÖË©≥Á¥∞: ' + (data.pname || data.pid);

      var html = '';

      // ÊÇ£ËÄÖ„Éû„Çπ„ÇøÊÉÖÂ†±ÔºàÊäò„Çä„Åü„Åü„ÅøÂèØËÉΩ„Å™„Çµ„Éû„É™Ôºâ
      if (data.master) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">Âü∫Êú¨ÊÉÖÂ†±Ôºà„Éû„Çπ„ÇøÔºâ</summary>';
        html += '<div class="audit-info-grid">';
        html += '<div class="audit-info-item"><span class="label">ÊôÇÈñì„Çø„Ç§„Éó:</span> <span class="value">' + (data.master.timeType || '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">Â∏åÊúõÊõúÊó•:</span> <span class="value">' + (data.master.prefDays && data.master.prefDays.length > 0 ? data.master.prefDays.join(',') : '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">ÊõúÊó•NG:</span> <span class="value">' + (data.master.ngDays && data.master.ngDays.length > 0 ? data.master.ngDays.join(',') : '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">Â∏åÊúõÊôÇÈñì:</span> <span class="value">' + (data.master.startPrefStr || '-') + ' - ' + (data.master.endPrefStr || '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">„Çµ„Éº„Éì„Çπ:</span> <span class="value">' + (data.master.svcMin || '-') + 'ÂàÜ</span></div>';
        if (data.master.sexLimit && data.master.sexLimit !== '-') {
          html += '<div class="audit-info-item"><span class="label">ÊÄßÂà•Âà∂Èôê:</span> <span class="value severity-critical">' + data.master.sexLimit + '</span></div>';
        }
        if (data.master.fixedStaff) {
          html += '<div class="audit-info-item"><span class="label">ÊåáÂÆö„Çπ„Çø„ÉÉ„Éï:</span> <span class="value">' + data.master.fixedStaff + ' (' + (data.master.fixedType || 'Â∏åÊúõ') + ')</span></div>';
        }
        if (data.master.ngStaff) {
          html += '<div class="audit-info-item"><span class="label">NG„Çπ„Çø„ÉÉ„Éï:</span> <span class="value severity-critical">' + data.master.ngStaff + '</span></div>';
        }
        html += '</div></details>';
      }

      // ÈÄ±Èñì„Ç´„É¨„É≥„ÉÄ„Éº„Éì„É•„Éº
      html += '<div class="audit-week-overview">';
      html += '<div class="audit-week-header">';
      html += '<div class="audit-week-title">ÈÄ±Èñì„Çπ„Ç±„Ç∏„É•„Éº„É´</div>';
      html += '<div class="audit-week-legend">';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot ok"></span>OK</div>';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot warn"></span>WARN</div>';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot ng"></span>NG</div>';
      html += '</div>';
      html += '</div>';

      html += '<div class="audit-week-calendar">';

      // ÊõúÊó•È†Ü„Å´‰∏¶„Åπ„ÇãÔºàÊúà„ÄúÊó•Ôºâ
      var dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      var djByYoubi = {};
      (data.dayJudgements || []).forEach(function(dj) {
        djByYoubi[dj.youbi] = dj;
      });

      dayOrder.forEach(function(youbi) {
        var dj = djByYoubi[youbi];
        if (dj) {
          // Ë®™Âïè„Åå„ÅÇ„ÇãÊó•
          var statusClass = dj.status.toLowerCase();
          var statusIcon = dj.status === 'OK' ? '‚óã' : (dj.status === 'WARN' ? '‚ñ≥' : '√ó');
          var isClickable = dj.status === 'NG' || dj.status === 'WARN';

          html += '<div class="audit-week-day status-' + statusClass + '"';
          if (isClickable) {
            html += ' onclick="showAuditDayDetail(\'' + dj.dateStr + '\')"';
          }
          html += '>';
          html += '<div class="audit-week-day-date">' + dj.dateStr.substring(5) + '</div>';
          html += '<div class="audit-week-day-youbi">' + youbiJapanese[youbi] + '</div>';
          html += '<div class="audit-week-day-status ' + statusClass + '">' + statusIcon + '</div>';

          // Ë®™ÂïèÊôÇÈñì„ÇíË°®Á§∫
          if (dj.hasActual && dj.actuals && dj.actuals.length > 0) {
            dj.actuals.forEach(function(a) {
              html += '<div class="audit-week-day-time">' + a.startStr + '-' + a.endStr + '</div>';
              if (a.staffName) {
                html += '<div class="audit-week-day-staff">' + a.staffName + '</div>';
              }
            });
          } else if (dj.hasExpected && dj.expectedVisits && dj.expectedVisits.length > 0) {
            // ÊúüÂæÖ„ÅØ„ÅÇ„Çã„ÅåÂÆüÁ∏æ„Å™„Åó
            dj.expectedVisits.forEach(function(exp) {
              if (!exp.isCancelled) {
                if (exp.timeType === 'Âõ∫ÂÆö') {
                  html += '<div class="audit-week-day-time">' + (exp.startStr || '-') + '-' + (exp.endStr || '-') + '</div>';
                } else {
                  html += '<div class="audit-week-day-time">' + (exp.earliestStr || '-') + '„Äú' + (exp.latestStr || '-') + '</div>';
                }
              }
            });
          }

          // „ÇØ„É™„ÉÉ„ÇØ„Éí„É≥„Éà
          if (isClickable) {
            var violationInfo = '';
            if (dj.conditionAnalysis && dj.conditionAnalysis.violationCount > 0) {
              violationInfo = 'NG:' + dj.conditionAnalysis.ngCount + ' WARN:' + dj.conditionAnalysis.warnCount;
            }
            html += '<div class="audit-week-day-click-hint">' + (violationInfo || '„ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞') + '</div>';
          }

          html += '</div>';
        } else {
          // Ë®™Âïè„Åå„Å™„ÅÑÊó•
          html += '<div class="audit-week-day no-visit">';
          html += '<div class="audit-week-day-date">-</div>';
          html += '<div class="audit-week-day-youbi">' + youbiJapanese[youbi] + '</div>';
          html += '<div class="audit-week-day-novisit">Ë®™Âïè„Å™„Åó</div>';
          html += '</div>';
        }
      });

      html += '</div></div>';

      // ÂÄãÂà•Â§âÊõ¥„Çµ„Éû„É™ÔºàÈÄ±ÂÖ®‰ΩìÔºâ
      if (data.changes && data.changes.length > 0) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">ÂÄãÂà•Â§âÊõ¥„É™„ÇØ„Ç®„Çπ„Éà (' + data.changes.length + '‰ª∂)</summary>';
        data.changes.forEach(function(ch) {
          html += '<div class="audit-change-item">';
          html += '<strong>' + ch.dateStr + '</strong> <span class="audit-op-badge op-' + ch.op + '">' + ch.op + '</span>';
          if (ch.newStartStr || ch.newEndStr) html += ' (' + (ch.newStartStr || '') + '-' + (ch.newEndStr || '') + ')';
          if (ch.note) html += ' <span class="audit-note">' + ch.note + '</span>';
          html += '</div>';
        });
        html += '</details>';
      }

      // ÁâπÂà•Ë®™ÂïèÈÄ±Èñì„Çµ„Éû„É™
      if (data.specialWeek) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">ÁâπÂà•Ë®™ÂïèÈÄ±Èñì (' + data.specialWeek.modes.join('/') + ')</summary>';
        data.specialWeek.details.forEach(function(sp) {
          html += '<div class="audit-special-item">';
          html += '<strong>' + sp.dateStr + '</strong> ';
          html += '<span class="audit-mode-badge mode-' + sp.mode + '">' + sp.mode + '</span> ';
          html += sp.rowLabel + ' [' + sp.timeType + '] ';
          if (sp.startStr || sp.endStr) html += sp.startStr + '-' + sp.endStr;
          else if (sp.earliestStr || sp.latestStr) html += sp.earliestStr + '„Äú' + sp.latestStr;
          html += '</div>';
        });
        html += '</details>';
      }

      body.innerHTML = html;
    }

    // Êó•Âà•Ë©≥Á¥∞„Éì„É•„Éº„ÇíË°®Á§∫
    function showAuditDayDetail(dateStr) {
      if (!currentPatientDetailData) return;

      var dj = null;
      (currentPatientDetailData.dayJudgements || []).forEach(function(d) {
        if (d.dateStr === dateStr) dj = d;
      });
      if (!dj) return;

      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'ÊÇ£ËÄÖË©≥Á¥∞: ' + (currentPatientDetailData.pname || currentPatientDetailData.pid) + ' - ' + dateStr;

      var html = '';
      var statusClass = dj.status.toLowerCase();
      var statusIcon = dj.status === 'OK' ? '‚óã' : (dj.status === 'WARN' ? '‚ñ≥' : '√ó');

      // Êàª„Çã„Éú„Çø„É≥
      html += '<button class="audit-back-btn" onclick="renderAuditWeekOverview(currentPatientDetailData)">';
      html += '‚Üê ÈÄ±ÈñìÊ¶ÇË¶Å„Å´Êàª„Çã';
      html += '</button>';

      // Êó•‰ªò„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„Éò„ÉÉ„ÉÄ„Éº
      html += '<div class="audit-day-detail-view">';
      html += '<div class="audit-day-detail-header status-' + statusClass + '">';
      html += '<span class="audit-day-detail-date">' + dj.dateStr + ' (' + youbiJapanese[dj.youbi] + ')</span>';
      html += '<span class="audit-day-detail-status ' + statusClass + '">' + statusIcon + ' ' + dj.status + '</span>';
      html += '</div>';

      // === Êù°‰ª∂ÈÅïÂèç„Çµ„Éû„É™ÔºàNG„Å®WARN„ÅÆ„ÅøÂº∑Ë™øË°®Á§∫Ôºâ ===
      if (dj.conditionAnalysis && dj.conditionAnalysis.violations && dj.conditionAnalysis.violations.length > 0) {
        html += '<div class="audit-violations-section">';
        html += '<div class="audit-subsection-title violations-title">Êù°‰ª∂ÈÅïÂèç</div>';
        dj.conditionAnalysis.violations.forEach(function(v) {
          var vClass = v.status === 'NG' ? 'violation-ng' : 'violation-warn';
          var vIcon = v.status === 'NG' ? '‚úó' : '!';
          html += '<div class="audit-violation-item ' + vClass + '">';
          html += '<span class="violation-icon">' + vIcon + '</span>';
          html += '<span class="violation-label">' + v.label + '</span>';
          html += '<span class="violation-severity">[' + (v.severity === 'CRITICAL' ? 'ÂøÖÈ†àÊù°‰ª∂' : 'Êé®Â•®Êù°‰ª∂') + ']</span>';
          if (v.diffDetail) html += '<div class="violation-detail">' + v.diffDetail + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }

      // === „Åì„ÅÆÊó•„ÅÆÊù°‰ª∂ ===
      if (dj.conditionAnalysis && dj.conditionAnalysis.conditions && dj.conditionAnalysis.conditions.length > 0) {
        html += '<details class="audit-conditions-section" open>';
        html += '<summary class="audit-subsection-title clickable">„Åì„ÅÆÊó•„ÅÆÊù°‰ª∂</summary>';
        html += '<div class="audit-conditions-grid">';

        // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
        var categories = {};
        dj.conditionAnalysis.conditions.forEach(function(cond) {
          if (!categories[cond.category]) categories[cond.category] = [];
          categories[cond.category].push(cond);
        });

        var categoryLabels = {
          'TIME': 'ÊôÇÈñìÊù°‰ª∂',
          'DAY': 'ÊõúÊó•Êù°‰ª∂',
          'STAFF': '„Çπ„Çø„ÉÉ„ÉïÊù°‰ª∂',
          'EVENT': '„Ç§„Éô„É≥„Éà',
          'CHANGE': 'ÂÄãÂà•Â§âÊõ¥',
          'SPECIAL': 'ÁâπÂà•Ë®™ÂïèÈÄ±Èñì'
        };

        var categoryIcons = {
          'TIME': '‚è∞',
          'DAY': 'üìÖ',
          'STAFF': 'üë§',
          'EVENT': 'üìå',
          'CHANGE': '‚úèÔ∏è',
          'SPECIAL': 'üóìÔ∏è'
        };

        for (var cat in categories) {
          html += '<div class="audit-condition-category">';
          html += '<div class="category-header">' + (categoryIcons[cat] || '') + ' ' + (categoryLabels[cat] || cat) + '</div>';
          categories[cat].forEach(function(cond) {
            var severityClass = 'severity-' + cond.severity.toLowerCase();
            var condStatusIcon = '';
            if (cond.status === 'NG') condStatusIcon = '<span class="cond-status-icon ng">‚úó</span>';
            else if (cond.status === 'WARN') condStatusIcon = '<span class="cond-status-icon warn">!</span>';
            else if (cond.status === 'OK') condStatusIcon = '<span class="cond-status-icon ok">‚úì</span>';

            html += '<div class="audit-condition-item ' + severityClass + ' status-' + (cond.status || 'unknown').toLowerCase() + '">';
            html += condStatusIcon;
            html += '<span class="cond-label">' + cond.label + '</span>';
            html += '<span class="cond-severity-badge ' + severityClass + '">' + (cond.severity === 'CRITICAL' ? 'ÂøÖÈ†à' : (cond.severity === 'WARNING' ? 'Êé®Â•®' : 'ÊÉÖÂ†±')) + '</span>';
            html += '<div class="cond-detail">';
            html += '<span class="cond-expected">ÊúüÂæÖ: ' + (cond.expected || '-') + '</span>';
            if (cond.actual) html += ' ‚Üí <span class="cond-actual">ÂÆüÁ∏æ: ' + cond.actual + '</span>';
            html += '</div>';
            if (cond.diffDetail) {
              html += '<div class="cond-diff-detail ' + (cond.status === 'NG' ? 'diff-ng' : 'diff-warn') + '">' + cond.diffDetail + '</div>';
            }
            html += '</div>';
          });
          html += '</div>';
        }
        html += '</div></details>';
      }

      // === ÊúüÂæÖ„Å®ÂÆüÁ∏æ„ÅÆÊØîËºÉ ===
      html += '<details class="audit-compare-details" open>';
      html += '<summary class="audit-subsection-title clickable">ÊúüÂæÖ vs ÂÆüÁ∏æ</summary>';

      // Expected
      html += '<div class="audit-compare-section"><div class="audit-compare-label">ÊúüÂæÖ (Expected):</div>';
      if (dj.hasExpected) {
        dj.expectedVisits.forEach(function(exp) {
          var sourceLabel = exp.source;
          if (exp.op) sourceLabel += '/' + exp.op;
          var sourceClass = exp.source === 'MASTER' ? 'source-master' : (exp.source.indexOf('SPECIAL') >= 0 ? 'source-special' : 'source-change');
          html += '<div class="audit-expected-item">';
          html += '<span class="audit-source-badge ' + sourceClass + '">' + sourceLabel + '</span> ';
          html += '<span class="audit-time-type">[' + (exp.timeType || 'ÊôÇÈñìÂ∏Ø') + ']</span> ';
          if (exp.timeType === 'Âõ∫ÂÆö') {
            html += '<span>' + (exp.startStr || '-') + '-' + (exp.endStr || '-') + '</span>';
          } else {
            html += '<span>' + (exp.earliestStr || '-') + '„Äú' + (exp.latestStr || '-') + '</span>';
          }
          if (exp.isCancelled) html += ' <span class="audit-cancelled-badge">„Ç≠„É£„É≥„Çª„É´</span>';
          html += '</div>';
        });
      } else {
        html += '<div style="color:#999;font-size:12px;">ÊúüÂæÖ„Å™„Åó</div>';
      }
      html += '</div>';

      // Actual
      html += '<div class="audit-compare-section"><div class="audit-compare-label">ÂÆüÁ∏æ (Actual):</div>';
      if (dj.hasActual) {
        dj.actuals.forEach(function(a) {
          html += '<div class="audit-actual-item">';
          html += '<span>' + a.startStr + '-' + a.endStr + '</span>';
          if (a.staffName) html += ' <span class="audit-staff-name">(' + a.staffName + ')</span>';
          if (a.isUnassigned) html += ' <span class="audit-unassigned-badge">[Êú™Ââ≤ÂΩì]</span>';
          html += '</div>';
        });
      } else {
        html += '<div style="color:#999;font-size:12px;">ÂÆüÁ∏æ„Å™„Åó</div>';
      }
      html += '</div>';
      html += '</details>';

      // „ÉÅ„Çß„ÉÉ„ÇØË©≥Á¥∞ÔºàÂæìÊù•„ÅÆ„ÇÇ„ÅÆ„ÄÅÊäò„Çä„Åü„Åü„ÅøÔºâ
      if (dj.checks && dj.checks.length > 0) {
        html += '<details class="audit-checks-details">';
        html += '<summary class="audit-subsection-title clickable">Âà§ÂÆöË©≥Á¥∞ÔºàÊäÄË°ìÊÉÖÂ†±Ôºâ</summary>';
        dj.checks.forEach(function(check) {
          var checkClass = check.status === 'NG' ? 'check-ng' : (check.status === 'WARN' ? 'check-warn' : 'check-ok');
          html += '<div class="audit-check-item ' + checkClass + '">';
          html += '<span class="audit-check-icon">' + (check.status === 'OK' ? '‚úì' : (check.status === 'WARN' ? '!' : '‚úó')) + '</span> ';
          html += '<span>' + (check.explanation || check.reason || check.type) + '</span>';
          if (check.diffMin && check.diffMin !== 0) {
            html += ' <span class="audit-diff">(' + (check.diffMin > 0 ? '+' : '') + check.diffMin + 'ÂàÜ)</span>';
          }
          html += '</div>';
        });
        html += '</details>';
      }

      // „Çø„Ç∞Ôºà„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫Ôºâ
      if (dj.tags && dj.tags.length > 0) {
        html += '<div class="tags" style="margin-top:12px;">';
        dj.tags.forEach(function(tag) {
          var tagClass = '';
          if (tag.indexOf('CONFLICT') >= 0 || tag.indexOf('UNASSIGNED') >= 0 || tag.indexOf('CANCELLED_BUT') >= 0 || tag.indexOf('OUT_OF') >= 0) tagClass = 'ng';
          else if (tag.indexOf('DIFF') >= 0 || tag.indexOf('MISSING') >= 0 || tag.indexOf('EXTRA') >= 0) tagClass = 'warn';
          else tagClass = 'ok';
          html += '<span class="audit-tag ' + tagClass + '">' + tag + '</span> ';
        });
        html += '</div>';
      }

      html += '</div>';
      body.innerHTML = html;
    }

    function closeAuditPatientModal() {
      document.getElementById('auditPatientModal').style.display = 'none';
    }

    // ‰ªñ„ÅÆ„Çø„Éñ„Å´Êàª„ÇãÊôÇ„ÅÆ„Éï„ÉÉ„ÇØ
    var originalShowTab = showTab;
    showTab = function(tabKey, btn) {
      if (isAuditMode) {
        isAuditMode = false;
        document.getElementById('auditArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        closeAuditDetail();
        closeAuditPatientModal();
      }
      originalShowTab(tabKey, btn);
    };

    // ============================================================
    // „Ç´„Ç§„Éù„Ç±CSVÂá∫Âäõ
    // ============================================================

    function exportKaipokeCsv() {
      // ÂØæË±°ÈÄ±„Çª„É¨„ÇØ„Çø„Åã„ÇâÈÅ∏ÊäûÂÄ§„ÇíÂèñÂæó
      var weekStartStr = getSelectedWeekStart();
      if (!weekStartStr) {
        showToast('ÂØæË±°ÈÄ±„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
        return;
      }

      // YYYY-MM-DD ‚Üí YYYY/MM/DD ÂΩ¢Âºè„Å´Â§âÊèõ
      weekStartStr = weekStartStr.replace(/-/g, '/');

      var msg = 'CSVÂá∫Âäõ‰∏≠... (' + weekStartStr + '„Äú)';
      showToast(msg, 'info', 10000);

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            var message = result.message + '\n\n„Éï„Ç°„Ç§„É´„ÇíÈñã„Åç„Åæ„Åô„ÅãÔºü';
            if (confirm(message)) {
              window.open(result.url, '_blank');
            }
            showToast('CSVÂá∫ÂäõÂÆå‰∫Ü: ' + result.fileName, 'success');
          } else {
            showToast('CSVÂá∫ÂäõÂ§±Êïó', 'error');
          }
        })
        .withFailureHandler(function(e) {
          showToast('„Ç®„É©„Éº: ' + (e.message || String(e)), 'error');
        })
        .kaipoke_exportCsv(weekStartStr);
    }

    // ============================================================
    // „Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ„É¢„Éº„ÉÄ„É´
    // ============================================================
    var kaipokeModalInitialized = false;
    var kaipokeAuthenticated = false;
    var kaipokeInterlock = { expandMinMonth: null, expandCompleted: [], applyMinWeek: null, applyCompleted: [] };

    function openKaipokeModal() {
      // Êó¢„Å´Ë™çË®ºÊ∏à„Åø„Å™„Çâ„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
      if (kaipokeAuthenticated) {
        showKaipokeModalInner_();
        return;
      }

      // „Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ„ÇíÊ±Ç„ÇÅ„Çã
      var password = prompt('„Ç´„Ç§„Éù„Ç±Ëá™ÂãïÂåñ„ÅÆ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (password === null) return; // „Ç≠„É£„É≥„Çª„É´

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            kaipokeAuthenticated = true;
            showKaipokeModalInner_();
          } else {
            alert('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
          }
        })
        .withFailureHandler(function(error) {
          alert('Ë™çË®º„Ç®„É©„Éº: ' + error.message);
        })
        .verifyKaipokePassword(password);
    }

    function showKaipokeModalInner_() {
      var modal = document.getElementById('kaipokeModal');
      modal.classList.add('show');

      if (!kaipokeModalInitialized) {
        kaipokeInitialize();
        kaipokeModalInitialized = true;
      }
    }

    function closeKaipokeModal() {
      document.getElementById('kaipokeModal').classList.remove('show');
    }

    function kaipokeInitialize() {
      // ÊúàÈÅ∏Êäû„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
      var select = document.getElementById('kaipokeTargetMonth');
      var now = new Date();
      var year = now.getFullYear();
      select.innerHTML = '';
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'Âπ¥' + m + 'Êúà';
        select.appendChild(opt);
      }
      var currentMonth = year + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
      select.value = currentMonth;

      // ÈÄ±„Éó„É´„ÉÄ„Ç¶„É≥„ÇíÁîüÊàê
      kaipokeOnMonthChange();

      // ÈùûÂ∏∏ÂÅúÊ≠¢„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÊúÄÂàù„Å´Èñã„ÅèÔºà‰ªñ„ÅÆgoogle.script.run„Çà„ÇäÂÖà„Å´Ôºâ
      // Áã¨Á´ã„Åó„Åü„É¢„Éº„Éâ„É¨„Çπ„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Å™„ÅÆ„Åß„ÄÅ„Çµ„Ç§„Éâ„Éë„Éç„É´„Åå„Éï„É™„Éº„Ç∫„Åó„Å¶„ÇÇÊìç‰ΩúÂèØËÉΩ
      google.script.run.showEmergencyStopDialog();

      // „Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
      kaipokeLoadInterlock();

      // „Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç
      kaipokeRefreshStatus();

      // Êé•Á∂ö„ÉÜ„Çπ„Éà„ÇíËá™ÂãïÂÆüË°å
      kaipokeTest();
    }

    // ==========================================
    // ÈÄ±„Éó„É´„ÉÄ„Ç¶„É≥ÁîüÊàê
    // ==========================================
    function kaipokeGetWeeksForMonth(yearMonth) {
      var parts = yearMonth.split('-');
      var year = parseInt(parts[0]);
      var month = parseInt(parts[1]) - 1;
      var weeks = [];
      var date = new Date(year, month, 1);
      while (date.getDay() !== 1) { date.setDate(date.getDate() + 1); }
      var weekNum = 1;
      while (date.getMonth() === month) {
        var mm = ('0' + (date.getMonth() + 1)).slice(-2);
        var dd = ('0' + date.getDate()).slice(-2);
        var dateStr = date.getFullYear() + '-' + mm + '-' + dd;
        weeks.push({ value: dateStr, label: dateStr + 'Ôºà' + (month + 1) + 'Êúà' + weekNum + 'ÈÄ±ÁõÆÔºâ' });
        weekNum++;
        date.setDate(date.getDate() + 7);
      }
      return weeks;
    }

    function kaipokeOnMonthChange() {
      var month = kaipokeGetMonth();
      var weeks = kaipokeGetWeeksForMonth(month);
      var sel = document.getElementById('kaipokeWeekStart');
      sel.innerHTML = '';
      weeks.forEach(function(w) {
        var opt = document.createElement('option');
        opt.value = w.value;
        opt.textContent = w.label;
        sel.appendChild(opt);
      });
      kaipokeUpdateButtonStates();
    }

    // ==========================================
    // „Ç§„É≥„Çø„Éº„É≠„ÉÉ„ÇØ
    // ==========================================
    function kaipokeLoadInterlock() {
      google.script.run
        .withSuccessHandler(function(settings) {
          kaipokeInterlock = settings;
          kaipokeUpdateButtonStates();
          kaipokePopulateInterlockPanel();
        })
        .withFailureHandler(function() {})
        .getInterlockSettings();
    }

    function kaipokeCheckExpandAllowed(month) {
      if (kaipokeInterlock.expandMinMonth && month < kaipokeInterlock.expandMinMonth) {
        return { allowed: false, reason: kaipokeInterlock.expandMinMonth.replace(/^\d{4}-0?/, '').replace(/^(\d+)/, function(m){return parseInt(m);}) + 'Êúà‰ª•Èôç„ÅÆ„ÅøÂ±ïÈñãÂèØËÉΩ„Åß„Åô' };
      }
      if (kaipokeInterlock.expandCompleted.indexOf(month) >= 0) {
        return { allowed: false, reason: month + ' „ÅØÂ±ïÈñãÂÆå‰∫ÜÊ∏à„Åø„Åß„Åô' };
      }
      return { allowed: true };
    }

    function kaipokeCheckApplyAllowed(weekStart) {
      if (!weekStart) return { allowed: true };
      if (kaipokeInterlock.applyMinWeek && weekStart < kaipokeInterlock.applyMinWeek) {
        return { allowed: false, reason: kaipokeInterlock.applyMinWeek + ' ‰ª•Èôç„ÅÆ„ÅøÂ∑ÆÂàÜÈÅ©Áî®ÂèØËÉΩ„Åß„Åô' };
      }
      if (kaipokeInterlock.applyCompleted.indexOf(weekStart) >= 0) {
        return { allowed: false, reason: weekStart + ' „ÅØÂ∑ÆÂàÜÈÅ©Áî®ÂÆå‰∫ÜÊ∏à„Åø„Åß„Åô' };
      }
      return { allowed: true };
    }

    function kaipokeUpdateButtonStates() {
      var month = kaipokeGetMonth();
      var weekStart = kaipokeGetWeekStart();

      var ec = kaipokeCheckExpandAllowed(month);
      var expandBtn = document.getElementById('kaipokeExpandBtn');
      var expandLock = document.getElementById('kaipokeExpandLock');
      if (expandBtn) { expandBtn.disabled = !ec.allowed; expandBtn.style.opacity = ec.allowed ? '1' : '0.5'; }
      if (expandLock) { expandLock.style.display = ec.allowed ? 'none' : 'block'; expandLock.textContent = ec.allowed ? '' : 'üîí ' + ec.reason; }

      var ac = kaipokeCheckApplyAllowed(weekStart);
      var applyBtn = document.getElementById('kaipokeApplyBtn');
      var applyLock = document.getElementById('kaipokeApplyLock');
      if (applyBtn) { applyBtn.disabled = !ac.allowed; applyBtn.style.opacity = ac.allowed ? '1' : '0.5'; }
      if (applyLock) { applyLock.style.display = ac.allowed ? 'none' : 'block'; applyLock.textContent = ac.allowed ? '' : 'üîí ' + ac.reason; }
    }

    function kaipokeToggleInterlock() {
      var panel = document.getElementById('kaipokeInterlockPanel');
      var arrow = document.getElementById('kaipokeInterlockArrow');
      if (panel.style.display === 'none') { panel.style.display = 'block'; arrow.textContent = '‚ñº'; }
      else { panel.style.display = 'none'; arrow.textContent = '‚ñ∂'; }
    }

    function kaipokePopulateInterlockPanel() {
      // Â±ïÈñãÂà∂ÈôêÊúà„Éó„É´„ÉÄ„Ç¶„É≥
      var expandSel = document.getElementById('kaipokeExpandMinMonth');
      expandSel.innerHTML = '<option value="">Âà∂Èôê„Å™„Åó</option>';
      var now = new Date();
      var year = now.getFullYear();
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'Âπ¥' + m + 'Êúà';
        expandSel.appendChild(opt);
      }
      if (kaipokeInterlock.expandMinMonth) expandSel.value = kaipokeInterlock.expandMinMonth;

      // Â∑ÆÂàÜÂà∂ÈôêÈÄ±„Éó„É´„ÉÄ„Ç¶„É≥ÔºàÂÖ®Êúà„ÅÆÈÄ±„ÇíË°®Á§∫Ôºâ
      var applySel = document.getElementById('kaipokeApplyMinWeek');
      applySel.innerHTML = '<option value="">Âà∂Èôê„Å™„Åó</option>';
      for (var m2 = 1; m2 <= 12; m2++) {
        var monthStr = year + '-' + ('0' + m2).slice(-2);
        var weeks = kaipokeGetWeeksForMonth(monthStr);
        weeks.forEach(function(w) {
          var opt = document.createElement('option');
          opt.value = w.value;
          opt.textContent = w.label;
          applySel.appendChild(opt);
        });
      }
      if (kaipokeInterlock.applyMinWeek) applySel.value = kaipokeInterlock.applyMinWeek;

      // ÂÆå‰∫Ü„Çø„Ç∞Ë°®Á§∫
      kaipokeRenderCompletedTags();
    }

    function kaipokeRenderCompletedTags() {
      // Â±ïÈñãÂÆå‰∫ÜÊúà
      var ec = document.getElementById('kaipokeExpandCompleted');
      if (kaipokeInterlock.expandCompleted.length === 0) {
        ec.innerHTML = '<span style="font-size:11px;color:#999;">„Å™„Åó</span>';
      } else {
        ec.innerHTML = '';
        kaipokeInterlock.expandCompleted.forEach(function(m) {
          var tag = document.createElement('span');
          tag.className = 'kaipoke-completed-tag';
          tag.textContent = m + ' ‚úì';
          tag.title = '„ÇØ„É™„ÉÉ„ÇØ„ÅßËß£Èô§Ôºà„Éë„Çπ„ÉØ„Éº„ÉâÂøÖË¶ÅÔºâ';
          tag.onclick = function() { kaipokeUnlockExpand(m); };
          ec.appendChild(tag);
        });
      }
      // Â∑ÆÂàÜÂÆå‰∫ÜÈÄ±
      var ac = document.getElementById('kaipokeApplyCompleted');
      if (kaipokeInterlock.applyCompleted.length === 0) {
        ac.innerHTML = '<span style="font-size:11px;color:#999;">„Å™„Åó</span>';
      } else {
        ac.innerHTML = '';
        kaipokeInterlock.applyCompleted.forEach(function(w) {
          var tag = document.createElement('span');
          tag.className = 'kaipoke-completed-tag';
          tag.textContent = w + ' ‚úì';
          tag.title = '„ÇØ„É™„ÉÉ„ÇØ„ÅßËß£Èô§Ôºà„Éë„Çπ„ÉØ„Éº„ÉâÂøÖË¶ÅÔºâ';
          tag.onclick = function() { kaipokeUnlockApply(w); };
          ac.appendChild(tag);
        });
      }
    }

    function kaipokeSaveExpandMin() {
      var val = document.getElementById('kaipokeExpandMinMonth').value;
      var pw = prompt('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (pw === null) return;
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            kaipokeInterlock.expandMinMonth = val || null;
            kaipokeUpdateButtonStates();
            setTimeout(function() { alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('„Ç®„É©„Éº: ' + e.message); })
        .saveInterlockSetting('Â±ïÈñãÂà∂ÈôêÊúà', val, pw);
    }

    function kaipokeSaveApplyMin() {
      var val = document.getElementById('kaipokeApplyMinWeek').value;
      var pw = prompt('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (pw === null) return;
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            kaipokeInterlock.applyMinWeek = val || null;
            kaipokeUpdateButtonStates();
            setTimeout(function() { alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('„Ç®„É©„Éº: ' + e.message); })
        .saveInterlockSetting('Â∑ÆÂàÜÂà∂ÈôêÈÄ±', val, pw);
    }

    function kaipokeUnlockExpand(month) {
      if (!confirm(month + ' „ÅÆÂ±ïÈñãÂÆå‰∫Ü„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      var pw = prompt('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (pw === null) return;
      var newList = kaipokeInterlock.expandCompleted.filter(function(m) { return m !== month; });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            kaipokeInterlock.expandCompleted = newList;
            kaipokeUpdateButtonStates();
            kaipokeRenderCompletedTags();
            setTimeout(function() { alert('Ëß£Èô§„Åó„Åæ„Åó„Åü'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('„Ç®„É©„Éº: ' + e.message); })
        .saveInterlockSetting('Â±ïÈñãÂÆå‰∫ÜÊúà', newList.join(','), pw);
    }

    function kaipokeUnlockApply(weekStart) {
      if (!confirm(weekStart + ' „ÅÆÂ∑ÆÂàÜÈÅ©Áî®ÂÆå‰∫Ü„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      var pw = prompt('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      if (pw === null) return;
      var newList = kaipokeInterlock.applyCompleted.filter(function(w) { return w !== weekStart; });
      google.script.run
        .withSuccessHandler(function(r) {
          if (r.success) {
            kaipokeInterlock.applyCompleted = newList;
            kaipokeUpdateButtonStates();
            kaipokeRenderCompletedTags();
            setTimeout(function() { alert('Ëß£Èô§„Åó„Åæ„Åó„Åü'); }, 50);
          } else { alert(r.message); }
        })
        .withFailureHandler(function(e) { alert('„Ç®„É©„Éº: ' + e.message); })
        .saveInterlockSetting('Â∑ÆÂàÜÂÆå‰∫ÜÈÄ±', newList.join(','), pw);
    }

    function kaipokeShowLoading(message) {
      document.getElementById('kaipokeLoading').className = 'kaipoke-loading show';
      document.getElementById('kaipokeLoadingText').innerText = message || 'Âá¶ÁêÜ‰∏≠...';
      kaipokeDisableButtons(true);
    }

    function kaipokeHideLoading() {
      document.getElementById('kaipokeLoading').className = 'kaipoke-loading';
      kaipokeDisableButtons(false);
      kaipokeUpdateButtonStates();
    }

    function kaipokeDisableButtons(disabled) {
      var modal = document.getElementById('kaipokeModal');
      var buttons = modal.querySelectorAll('.kaipoke-btn:not(.emergency)');
      buttons.forEach(function(btn) { btn.disabled = disabled; });
    }

    function kaipokeShowResult(message, isError) {
      var area = document.getElementById('kaipokeResult');
      area.innerText = message;
      area.className = 'kaipoke-result' + (isError ? ' error' : '');
    }

    function kaipokeGetMonth() {
      return document.getElementById('kaipokeTargetMonth').value;
    }

    function kaipokeGetWeekStart() {
      return document.getElementById('kaipokeWeekStart').value;
    }

    function kaipokeRefreshStatus() {
      google.script.run
        .withSuccessHandler(function(result) {
          var indicator = document.getElementById('kaipokeStatusIndicator');
          var text = document.getElementById('kaipokeStatusText');
          indicator.className = 'kaipoke-status-indicator';
          if (result.status === 'ready') {
            indicator.classList.add('ready');
            text.innerText = result.message;
          } else if (result.status === 'busy') {
            indicator.classList.add('busy');
            text.innerText = result.message;
          } else {
            indicator.classList.add('error');
            text.innerText = result.message;
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('kaipokeStatusIndicator').className = 'kaipoke-status-indicator error';
          document.getElementById('kaipokeStatusText').innerText = '„Ç®„É©„Éº: ' + error.message;
        })
        .checkServerStatus();
    }

    function kaipokeExpand() {
      var month = kaipokeGetMonth();
      var check = kaipokeCheckExpandAllowed(month);
      if (!check.allowed) { alert('üîí ' + check.reason); return; }
      if (!confirm('ÊúàÈñì„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂ±ïÈñã„Åó„Åæ„Åô„ÅãÔºü\nÔºàÊâÄË¶ÅÊôÇÈñì: Á¥Ñ2„Äú5ÂàÜÔºâ\n\n‚Äª ÈùûÂ∏∏ÂÅúÊ≠¢„Éë„Éç„É´„ÅåËá™Âãï„ÅßÈñã„Åç„Åæ„Åô')) return;

      // Èï∑ÊôÇÈñìÂá¶ÁêÜ„ÅÆÈñãÂßãÂâç„Å´ÈùûÂ∏∏ÂÅúÊ≠¢„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíËá™ÂãïË°®Á§∫
      // „Çµ„Ç§„Éâ„Éë„Éç„É´„ÅØ„Éï„É™„Éº„Ç∫„Åô„Çã„ÅÆ„Åß„ÄÅÁã¨Á´ã„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅßÈùûÂ∏∏ÂÅúÊ≠¢ÂèØËÉΩ„Å´„Åô„Çã
      google.script.run.showEmergencyStopDialog();

      kaipokeShowLoading('ÊúàÈñì„Çπ„Ç±„Ç∏„É•„Éº„É´Â±ïÈñã‰∏≠...\nÔºàÁ¥Ñ2„Äú5ÂàÜ„Åã„Åã„Çä„Åæ„ÅôÔºâ');
      kaipokeShowResult('Âá¶ÁêÜÈñãÂßã...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
          if (result.success) {
            // Â±ïÈñãÂÆå‰∫Ü„ÇíËá™ÂãïË®òÈå≤
            google.script.run.withSuccessHandler(function() {
              kaipokeInterlock.expandCompleted.push(month);
              kaipokeUpdateButtonStates();
              kaipokeRenderCompletedTags();
            }).markExpandCompleted(month);
          }
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('„Ç®„É©„Éº: ' + error.message, true);
          kaipokeRefreshStatus();
        })
        .runExpand(month);
    }

    function kaipokeExport() {
      if (!confirm('CSV„ÇíÂá∫Âäõ„Åó„Å¶Google Drive„Å´‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) return;
      kaipokeShowLoading('CSVÂá∫Âäõ‰∏≠...');
      kaipokeShowResult('Âá¶ÁêÜÈñãÂßã...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('„Ç®„É©„Éº: ' + error.message, true);
          kaipokeRefreshStatus();
        })
        .runExport(kaipokeGetMonth());
    }

    // Â∑ÆÂàÜÊ§úË®ºÁä∂ÊÖã„ÇíÁÆ°ÁêÜ
    var kaipokeDiffVerified = false;

    function kaipokeDiff() {
      var weekStart = kaipokeGetWeekStart();
      if (!weekStart) { alert('ÂØæË±°ÈÄ±„ÅÆÈñãÂßãÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      kaipokeShowLoading('Â∑ÆÂàÜÁ¢∫Ë™ç„ÉªÊ§úË®º‰∏≠...');
      kaipokeShowResult('Â∑ÆÂàÜÁ¢∫Ë™ç„ÇíÈñãÂßã... API„É™„ÇØ„Ç®„Çπ„ÉàÈÄÅ‰ø°‰∏≠');

      // Â∑ÆÂàÜÁ¢∫Ë™çÈñãÂßãÊôÇ„Å´ÈÅ©Áî®„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
      kaipokeDiffVerified = false;
      kaipokeUpdateApplyButton();

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);

          // Ê§úË®ºÁµêÊûú„Å´Âü∫„Å•„ÅÑ„Å¶ÈÅ©Áî®„Éú„Çø„É≥„ÇíÂà∂Âæ°
          if (result.success && result.verified) {
            kaipokeDiffVerified = true;
          } else {
            kaipokeDiffVerified = false;
          }
          kaipokeUpdateApplyButton();
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('„Ç®„É©„Éº: ' + error.message, true);
          kaipokeDiffVerified = false;
          kaipokeUpdateApplyButton();
        })
        .checkDiff(kaipokeGetMonth(), weekStart);
    }

    function kaipokeUpdateApplyButton() {
      var applyBtn = document.getElementById('kaipokeApplyBtn');
      if (!applyBtn) return;
      if (kaipokeDiffVerified) {
        applyBtn.disabled = false;
        applyBtn.style.opacity = '1';
        applyBtn.title = 'Â∑ÆÂàÜÊ§úË®ºOK - ÈÅ©Áî®ÂèØËÉΩ';
      } else {
        applyBtn.disabled = true;
        applyBtn.style.opacity = '0.5';
        applyBtn.title = 'ÂÖà„Å´Â∑ÆÂàÜÁ¢∫Ë™çÔºà„Éó„É¨„Éì„É•„ÉºÔºâ„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
      }
    }

    function kaipokeApply() {
      var weekStart = kaipokeGetWeekStart();
      if (!weekStart) { alert('ÂØæË±°ÈÄ±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
      if (!kaipokeDiffVerified) { alert('ÂÖà„Å´„ÄåÂ∑ÆÂàÜÁ¢∫Ë™çÔºà„Éó„É¨„Éì„É•„ÉºÔºâ„Äç„ÇíÂÆüË°å„Åó„ÄÅÊ§úË®º„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
      var check = kaipokeCheckApplyAllowed(weekStart);
      if (!check.allowed) { alert('üîí ' + check.reason); return; }

      // Step 1: Êú™Ââ≤ÂΩìËÅ∑Âì°„ÉÅ„Çß„ÉÉ„ÇØ
      google.script.run
        .withSuccessHandler(function(warning) {
          // Êú™Ââ≤ÂΩì„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË≠¶Âëä
          if (warning.hasUnassigned) {
            if (!confirm(warning.message)) return;
          }
          // Step 2: ÊúÄÁµÇÁ¢∫Ë™ç
          if (!confirm('Â∑ÆÂàÜ„Çí„Ç´„Ç§„Éù„Ç±„Å´ÈÅ©Áî®„Åó„Åæ„Åô„ÅãÔºü\n\n‚Äª „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì')) return;

          // Step 3: ÈÅ©Áî®ÂÆüË°å
          kaipokeShowLoading('Â∑ÆÂàÜÈÅ©Áî®‰∏≠...');
          kaipokeShowResult('Â∑ÆÂàÜÈÅ©Áî®„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü„ÄÇÂÆå‰∫Ü„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ...');

          google.script.run
            .withSuccessHandler(function(result) {
              kaipokeHideLoading();
              kaipokeShowResult(result.message, !result.success);
              kaipokeRefreshStatus();
              if (result.success) {
                // Â∑ÆÂàÜÈÅ©Áî®ÂÆå‰∫ÜÂæå„ÄÅÊ§úË®ºÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                kaipokeDiffVerified = false;
                kaipokeUpdateApplyButton();
                // Â∑ÆÂàÜÈÅ©Áî®ÂÆå‰∫Ü„ÇíËá™ÂãïË®òÈå≤
                google.script.run.withSuccessHandler(function() {
                  kaipokeInterlock.applyCompleted.push(weekStart);
                  kaipokeUpdateButtonStates();
                  kaipokeRenderCompletedTags();
                }).markApplyCompleted(weekStart);
              }
            })
            .withFailureHandler(function(error) {
              kaipokeHideLoading();
              kaipokeShowResult('„Ç®„É©„Éº: ' + error.message, true);
              kaipokeRefreshStatus();
            })
            .runApply(kaipokeGetMonth(), weekStart);
        })
        .withFailureHandler(function(error) {
          alert('Êú™Ââ≤ÂΩì„ÉÅ„Çß„ÉÉ„ÇØ„Ç®„É©„Éº: ' + error.message);
        })
        .getUnassignedWarning();
    }

    function kaipokeOpenEmergencyStop() {
      // fetch()„ÅßVPS API„ÇíÁõ¥Êé•Âëº„Å≥Âá∫„ÅóÔºàgoogle.script.run„Çí‰Ωø„Çè„Å™„ÅÑÔºâ
      // „Åì„Çå„Å´„Çà„ÇäGAS„Çµ„Éº„Éê„Éº„ÅÆ„Ç≠„É•„Éº„Å´Èñ¢‰øÇ„Å™„ÅèÂç≥Â∫ß„Å´ÈÄÅ‰ø°„Åß„Åç„Çã
      var API_URL = 'https://kaipoke-api.net:8443';
      kaipokeShowResult('ÈùûÂ∏∏ÂÅúÊ≠¢„ÇíÈÄÅ‰ø°‰∏≠...');

      fetch(API_URL + '/api/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(function(response) { return response.json(); })
      .then(function(result) {
        if (result.success) {
          var taskName = (result.current_task && result.current_task.command) ? result.current_task.command : '„Å™„Åó';
          kaipokeShowResult('ÈùûÂ∏∏ÂÅúÊ≠¢„ÇíË¶ÅÊ±Ç„Åó„Åæ„Åó„Åü„ÄÇ\nÂØæË±°„Çø„Çπ„ÇØ: ' + taskName, false);
        } else {
          kaipokeShowResult('ÂÅúÊ≠¢Â§±Êïó: ' + (result.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'), true);
        }
      })
      .catch(function(error) {
        // fetchÂ§±ÊïóÊôÇ„ÅØGASÁµåÁî±„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        kaipokeShowResult('Áõ¥Êé•ÈÄÅ‰ø°Â§±Êïó„ÄÅGASÁµåÁî±„ÅßÈÄÅ‰ø°‰∏≠...', true);
        google.script.run
          .withSuccessHandler(function(r) { kaipokeShowResult(r.message, !r.success); })
          .withFailureHandler(function(e) { kaipokeShowResult('„Ç®„É©„Éº: ' + e.message, true); })
          .emergencyStop();
      });
    }

    function kaipokeTest() {
      kaipokeShowLoading('Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...');
      kaipokeShowResult('„Çµ„Éº„Éê„Éº„Å®„ÅÆÊé•Á∂ö„Çí„ÉÜ„Çπ„Éà„Åó„Å¶„ÅÑ„Åæ„Åô...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
          // Êé•Á∂öÊàêÂäüÊôÇ„ÄÅVNCÁîªÈù¢„ÇíË°®Á§∫
          if (result.success) {
            kaipokeUpdateVncStatus('connecting', 'VNCÊé•Á∂ö‰∏≠...');
            kaipokeSetVncUrl('https://novnc.kaipoke-api.net/vnc.html?autoconnect=true&resize=scale');
          }
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('„Ç®„É©„Éº: ' + error.message, true);
          kaipokeRefreshStatus();
          kaipokeUpdateVncStatus('error', 'Êé•Á∂ö„Ç®„É©„Éº');
        })
        .runConnectionTest();
    }

    // ==========================================
    // VNC „Éì„É•„Éº„Ç¢Áä∂ÊÖãÁÆ°ÁêÜ
    // ==========================================
    var kaipokeVncState = {
      status: 'disconnected', // disconnected, connecting, connected, error
      url: null,
      lastUpdate: null
    };

    function kaipokeUpdateVncStatus(status, message) {
      kaipokeVncState.status = status;
      kaipokeVncState.lastUpdate = new Date();

      var dot = document.getElementById('kaipokeVncStatusDot');
      var text = document.getElementById('kaipokeVncStatusText');

      if (dot) {
        dot.className = 'kaipoke-viewer-status-dot ' + status;
      }
      if (text) {
        text.textContent = message || status;
      }
    }

    function kaipokeSetVncUrl(url) {
      var iframe = document.getElementById('kaipokeVncFrame');
      var placeholder = document.getElementById('kaipokeVncPlaceholder');
      var errorDiv = document.getElementById('kaipokeVncError');

      if (!url) {
        // URL„Å™„Åó ‚Üí „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„ÉºË°®Á§∫
        if (iframe) iframe.style.display = 'none';
        if (placeholder) placeholder.style.display = 'block';
        if (errorDiv) errorDiv.style.display = 'none';
        kaipokeUpdateVncStatus('disconnected', 'Êú™Êé•Á∂ö');
        return;
      }

      kaipokeVncState.url = url;
      kaipokeUpdateVncStatus('connecting', 'Êé•Á∂ö‰∏≠...');

      if (placeholder) placeholder.style.display = 'none';
      if (errorDiv) errorDiv.style.display = 'none';

      if (iframe) {
        iframe.style.display = 'block';
        iframe.src = url;

        // iframeË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÊ§úÁü•
        iframe.onload = function() {
          kaipokeUpdateVncStatus('connected', 'Êé•Á∂ö‰∏≠');
        };
        iframe.onerror = function() {
          kaipokeShowVncError('iframeË™≠„ÅøËæº„Åø„Ç®„É©„Éº: X-Frame-Options „Åæ„Åü„ÅØ CSP „Å´„Çà„ÇäË°®Á§∫„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô');
        };
      }
    }

    function kaipokeShowVncError(message) {
      var iframe = document.getElementById('kaipokeVncFrame');
      var placeholder = document.getElementById('kaipokeVncPlaceholder');
      var errorDiv = document.getElementById('kaipokeVncError');
      var errorText = document.getElementById('kaipokeVncErrorText');

      if (iframe) iframe.style.display = 'none';
      if (placeholder) placeholder.style.display = 'none';
      if (errorDiv) {
        errorDiv.style.display = 'block';
        if (errorText) errorText.textContent = message;
      }
      kaipokeUpdateVncStatus('error', '„Ç®„É©„Éº');
    }

    // ==========================================
    // „É≠„Ç∞Ë°®Á§∫Ê©üËÉΩ
    // ==========================================
    function kaipokeRefreshLogs() {
      var logsDiv = document.getElementById('kaipokeLogs');
      if (logsDiv) {
        logsDiv.textContent = 'ÂèñÂæó‰∏≠...';
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (logsDiv) {
            if (result && result.lines && result.lines.length > 0) {
              logsDiv.textContent = result.lines.join('\n');
              // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´ÔºàÊúÄÊñ∞„É≠„Ç∞„ÇíË°®Á§∫Ôºâ
              logsDiv.scrollTop = logsDiv.scrollHeight;
            } else {
              logsDiv.textContent = '„É≠„Ç∞„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
            }
          }
        })
        .withFailureHandler(function(error) {
          if (logsDiv) {
            logsDiv.textContent = '„É≠„Ç∞ÂèñÂæó„Ç®„É©„Éº: ' + error.message;
          }
        })
        .kaipoke_logs(200);
    }

    function kaipokeAppendLog(message) {
      var logsDiv = document.getElementById('kaipokeLogs');
      if (logsDiv) {
        var timestamp = new Date().toLocaleTimeString('ja-JP');
        logsDiv.textContent += '\n[' + timestamp + '] ' + message;
        logsDiv.scrollTop = logsDiv.scrollHeight;
      }
    }

    // ==========================================
    // Êã°Âºµ: Áä∂ÊÖã„Éù„Éº„É™„É≥„Ç∞Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
    // ==========================================
    var kaipokePollingInterval = null;

    function kaipokeStartPolling(intervalMs) {
      if (kaipokePollingInterval) {
        clearInterval(kaipokePollingInterval);
      }
      intervalMs = intervalMs || 10000; // „Éá„Éï„Ç©„É´„Éà10Áßí
      kaipokePollingInterval = setInterval(function() {
        kaipokeRefreshStatus();
      }, intervalMs);
      console.log('Kaipoke polling started: ' + intervalMs + 'ms');
    }

    function kaipokeStopPolling() {
      if (kaipokePollingInterval) {
        clearInterval(kaipokePollingInterval);
        kaipokePollingInterval = null;
        console.log('Kaipoke polling stopped');
      }
    }

    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.getElementById('kaipokeModal').addEventListener('click', function(e) {
      if (e.target === this) closeKaipokeModal();
    });

    // ============================================================
    // „É´„Éº„Éà„Éû„ÉÉ„ÉóË°®Á§∫Ê©üËÉΩ
    // ============================================================
    var routeMap = null;

    function showRouteMap(rowIndex) {
      if (!window.routeSummaryData || !window.routeSummaryData.rows[rowIndex]) {
        showToast('„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }

      var header = window.routeSummaryData.header;
      var row = window.routeSummaryData.rows[rowIndex];

      // „Éò„ÉÉ„ÉÄ„Éº„Åã„Çâ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÂèñÂæó
      var staffNameIdx = header.indexOf('„Çπ„Çø„ÉÉ„ÉïÂêç');
      var dateIdx = header.indexOf('Êó•‰ªò');
      var visitCountIdx = header.indexOf('Ë®™Âïè‰ª∂Êï∞');
      var distIdx = header.indexOf('Á∑èÁßªÂãïË∑ùÈõ¢(km)');
      var timeIdx = header.indexOf('Á∑èÁßªÂãïÊôÇÈñì(ÂàÜ)');
      var routeIdx = header.indexOf('„É´„Éº„ÉàÈ†ÜÔºàNo. ÊÇ£ËÄÖID ÊÇ£ËÄÖÂêç ‰ΩèÊâÄ (Á∑ØÂ∫¶, ÁµåÂ∫¶)Ôºâ');

      var staffName = staffNameIdx >= 0 ? row[staffNameIdx] : '‰∏çÊòé';
      var dateStr = dateIdx >= 0 ? row[dateIdx] : '';
      var visitCount = visitCountIdx >= 0 ? row[visitCountIdx] : '';
      var totalDist = distIdx >= 0 ? row[distIdx] : '';
      var totalTime = timeIdx >= 0 ? row[timeIdx] : '';
      var routeText = routeIdx >= 0 ? row[routeIdx] : '';

      // „É´„Éº„Éà„ÉÜ„Ç≠„Çπ„Éà„Çí„Éë„Éº„Çπ
      var stops = parseRouteText(routeText);
      if (stops.length === 0) {
        showToast('‰ΩçÁΩÆÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
        return;
      }

      // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      document.getElementById('routeMapTitle').textContent = staffName + ' „ÅÆË®™Âïè„É´„Éº„Éà';
      document.getElementById('routeMapSubtitle').textContent = dateStr;

      // Áµ±Ë®àÊÉÖÂ†±„ÇíË°®Á§∫
      var statsHtml = '<div class="route-map-stat-row"><span class="route-map-stat-label">Ë®™Âïè‰ª∂Êï∞</span><span class="route-map-stat-value">' + visitCount + '‰ª∂</span></div>' +
        '<div class="route-map-stat-row"><span class="route-map-stat-label">Á∑èÁßªÂãïË∑ùÈõ¢</span><span class="route-map-stat-value">' + (totalDist ? parseFloat(totalDist).toFixed(1) + 'km' : '-') + '</span></div>' +
        '<div class="route-map-stat-row"><span class="route-map-stat-label">Á∑èÁßªÂãïÊôÇÈñì</span><span class="route-map-stat-value">' + (totalTime ? totalTime + 'ÂàÜ' : '-') + '</span></div>';
      document.getElementById('routeMapStats').innerHTML = statsHtml;

      // Ë®™Âïè„É™„Çπ„Éà„ÇíË°®Á§∫
      var listHtml = '';
      stops.forEach(function(stop, idx) {
        var isOffice = stop.isOffice;
        var displayNo = stop.no;
        listHtml += '<div class="route-stop-item' + (isOffice ? ' office' : '') + '" onclick="panToStop(' + idx + ')">';
        listHtml += '<div class="route-stop-item-header">';
        listHtml += '<span class="route-stop-number' + (isOffice ? ' office' : '') + '">' + displayNo + '</span>';
        listHtml += '<div class="route-stop-item-info">';
        listHtml += '<span class="route-stop-name">' + escapeHtml(stop.name) + '</span>';
        listHtml += '<div class="route-stop-address">' + escapeHtml(stop.address) + '</div>';
        listHtml += '</div>';
        // Âñ∂Ê•≠ÊâÄ‰ª•Â§ñ„ÅØË©≥Á¥∞„Éú„Çø„É≥„ÇíË°®Á§∫
        if (!isOffice && stop.patientId) {
          listHtml += '<button class="route-stop-detail-btn" onclick="event.stopPropagation(); showRoutePatientDetail(\'' + stop.patientId + '\', \'' + escapeHtml(stop.name) + '\')">Êù°‰ª∂</button>';
        }
        listHtml += '</div></div>';
      });
      document.getElementById('routeStopList').innerHTML = listHtml;

      // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
      document.getElementById('routeMapModal').classList.add('show');

      // „Éû„ÉÉ„Éó„ÇíÂàùÊúüÂåñ
      setTimeout(function() {
        initRouteMap(stops);
      }, 100);
    }

    function parseRouteText(text) {
      if (!text) return [];

      var stops = [];
      // „Éë„Çø„Éº„É≥: No.0 S001 Âá∫Áô∫ ‰ΩèÊâÄ (Á∑ØÂ∫¶, ÁµåÂ∫¶) ‚Üí No.1 P001 ÊÇ£ËÄÖÂêç ‰ΩèÊâÄ (Á∑ØÂ∫¶, ÁµåÂ∫¶) ‚Üí ...
      var parts = text.split('‚Üí');

      parts.forEach(function(part) {
        part = part.trim();
        if (!part) return;

        // Â∫ßÊ®ô„ÇíÊäΩÂá∫: (Á∑ØÂ∫¶, ÁµåÂ∫¶)
        var coordMatch = part.match(/\(([0-9.]+),\s*([0-9.]+)\)\s*$/);
        if (!coordMatch) return;

        var lat = parseFloat(coordMatch[1]);
        var lng = parseFloat(coordMatch[2]);
        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return;

        // No.X „ÇíÈô§Âéª„Åó„Å¶„Éë„Éº„Çπ
        var contentWithoutCoord = part.replace(/\([0-9.]+,\s*[0-9.]+\)\s*$/, '').trim();
        var noMatch = contentWithoutCoord.match(/^No\.(\d+)\s+/);
        var routeNo = noMatch ? parseInt(noMatch[1]) : stops.length;
        var content = noMatch ? contentWithoutCoord.replace(/^No\.\d+\s+/, '') : contentWithoutCoord;

        // ÊÇ£ËÄÖID/„Çπ„Çø„ÉÉ„ÉïID ÂêçÂâç ‰ΩèÊâÄ „ÇíÂàÜÈõ¢
        var tokens = content.split(/\s+/);
        var id = tokens[0] || '';
        var name = tokens[1] || '';
        var address = tokens.slice(2).join(' ') || '';

        // No.0„Åã„Å§ÂêçÂâç„Åå„ÄåÂá∫Áô∫„Äç„Å™„ÇâÂñ∂Ê•≠ÊâÄ
        var isOffice = (routeNo === 0 && name === 'Âá∫Áô∫');

        stops.push({
          no: routeNo,
          patientId: id,
          name: isOffice ? 'Âñ∂Ê•≠ÊâÄÔºàÂá∫Áô∫Ôºâ' : (name || id),
          address: address,
          lat: lat,
          lng: lng,
          isOffice: isOffice
        });
      });

      return stops;
    }

    var routeMapStops = [];

    function initRouteMap(stops) {
      routeMapStops = stops;

      // Êó¢Â≠ò„ÅÆ„Éû„ÉÉ„Éó„ÇíÁ†¥Ê£Ñ
      if (routeMap) {
        routeMap.remove();
        routeMap = null;
      }

      var container = document.getElementById('routeMapContainer');
      if (!container) return;

      // „Éû„ÉÉ„Éó„ÇíÂàùÊúüÂåñ
      routeMap = L.map('routeMapContainer');

      // OpenStreetMap„Çø„Ç§„É´„ÇíËøΩÂä†
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(routeMap);

      if (stops.length === 0) return;

      // „Éû„Éº„Ç´„Éº„Å®„É´„Éº„Éà„É©„Ç§„É≥„ÇíËøΩÂä†
      var latlngs = [];
      var bounds = L.latLngBounds();

      stops.forEach(function(stop, idx) {
        var latlng = [stop.lat, stop.lng];
        latlngs.push(latlng);
        bounds.extend(latlng);

        // „Ç´„Çπ„Çø„É†„Ç¢„Ç§„Ç≥„É≥„Çí‰ΩúÊàêÔºàÂñ∂Ê•≠ÊâÄ„ÅØ„Ç™„É¨„É≥„Ç∏„ÄÅË®™Âïè„ÅØÁ∑ëÔºâ
        var isOffice = stop.isOffice;
        var markerColor = isOffice ? '#FF8C00' : '#9BC06A';
        var displayNo = stop.no;
        var markerContent = isOffice ? 'üè¢' : displayNo;
        var icon = L.divIcon({
          className: 'route-marker',
          html: '<div style="background:' + markerColor + ';color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:' + (isOffice ? '14px' : '12px') + ';box-shadow:0 2px 6px rgba(0,0,0,0.3);border:2px solid white;">' + markerContent + '</div>',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });

        var marker = L.marker(latlng, { icon: icon }).addTo(routeMap);
        marker.bindPopup('<b>' + displayNo + '. ' + escapeHtml(stop.name) + '</b><br>' + escapeHtml(stop.address));
      });

      // „É´„Éº„Éà„É©„Ç§„É≥„ÇíÊèèÁîª
      if (latlngs.length > 1) {
        var polyline = L.polyline(latlngs, {
          color: '#5A8BC4',
          weight: 4,
          opacity: 0.8,
          dashArray: '10, 10'
        }).addTo(routeMap);

        // Áü¢Âç∞„ÇíËøΩÂä†ÔºàÊñπÂêë„ÇíÁ§∫„ÅôÔºâ
        addArrowheads(latlngs);
      }

      // Ë°®Á§∫ÁØÑÂõ≤„ÇíË™øÊï¥
      routeMap.fitBounds(bounds, { padding: [30, 30] });
    }

    function addArrowheads(latlngs) {
      for (var i = 0; i < latlngs.length - 1; i++) {
        var start = latlngs[i];
        var end = latlngs[i + 1];

        // ‰∏≠ÈñìÁÇπ„ÇíË®àÁÆó
        var midLat = (start[0] + end[0]) / 2;
        var midLng = (start[1] + end[1]) / 2;

        // ËßíÂ∫¶„ÇíË®àÁÆó
        var angle = Math.atan2(end[0] - start[0], end[1] - start[1]) * 180 / Math.PI;

        // Áü¢Âç∞„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        var arrowIcon = L.divIcon({
          className: 'route-arrow',
          html: '<div style="transform:rotate(' + (-angle + 90) + 'deg);color:#5A8BC4;font-size:16px;text-shadow:0 0 2px white;">‚ñ∂</div>',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });

        L.marker([midLat, midLng], { icon: arrowIcon, interactive: false }).addTo(routeMap);
      }
    }

    function panToStop(idx) {
      if (!routeMap || !routeMapStops[idx]) return;
      var stop = routeMapStops[idx];
      routeMap.setView([stop.lat, stop.lng], 16);
    }

    // „É´„Éº„Éà„Éû„ÉÉ„ÉóÂÜÖ„ÅßÊÇ£ËÄÖË©≥Á¥∞„ÇíË°®Á§∫
    function showRoutePatientDetail(patientId, patientName) {
      // Ë®™Âïè„É™„Çπ„Éà„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶Ë©≥Á¥∞„Éë„Éç„É´„ÇíË°®Á§∫
      document.getElementById('routeStopListContainer').style.display = 'none';
      document.getElementById('routePatientDetailPanel').style.display = 'block';
      document.getElementById('routePatientDetailTitle').textContent = patientName + ' „ÅÆÊù°‰ª∂';
      document.getElementById('routePatientDetailContent').innerHTML = '<div class="route-patient-loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';

      // ÈÄ±ÈñãÂßãÊó•„ÇíÂèñÂæóÔºàÁõ£Êüª„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞ÁèæÂú®„ÅÆÈÄ±Ôºâ
      var weekStartStr = '';
      if (typeof auditState !== 'undefined' && auditState.weekStartStr) {
        weekStartStr = auditState.weekStartStr;
      } else {
        var today = new Date();
        var dayOfWeek = today.getDay();
        var diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        var monday = new Date(today);
        monday.setDate(today.getDate() + diff);
        weekStartStr = monday.getFullYear() + '/' + String(monday.getMonth() + 1).padStart(2, '0') + '/' + String(monday.getDate()).padStart(2, '0');
      }

      google.script.run
        .withSuccessHandler(function(data) {
          renderRoutePatientDetail(data);
        })
        .withFailureHandler(function(e) {
          document.getElementById('routePatientDetailContent').innerHTML = '<div class="route-patient-error">„Ç®„É©„Éº: ' + (e.message || String(e)) + '</div>';
        })
        .audit_getPatientDetail(patientId, weekStartStr);
    }

    // ÊÇ£ËÄÖË©≥Á¥∞„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderRoutePatientDetail(data) {
      var content = document.getElementById('routePatientDetailContent');
      if (!data || data.error) {
        content.innerHTML = '<div class="route-patient-error">' + (data ? data.error : '„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') + '</div>';
        return;
      }

      var html = '';

      // Âü∫Êú¨ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥
      if (data.master) {
        html += '<div class="route-patient-section">';
        html += '<div class="route-patient-section-title">Âü∫Êú¨ÊÉÖÂ†±</div>';

        // ÊôÇÈñì„Çø„Ç§„Éó
        var timeTypeClass = data.master.timeType === 'Âõ∫ÂÆö' ? 'highlight' : '';
        html += '<div class="route-patient-info-row">';
        html += '<span class="route-patient-info-label">ÊôÇÈñì„Çø„Ç§„Éó</span>';
        html += '<span class="route-patient-info-value ' + timeTypeClass + '">' + (data.master.timeType || '-') + '</span>';
        html += '</div>';

        // Â∏åÊúõÊôÇÈñì
        html += '<div class="route-patient-info-row">';
        html += '<span class="route-patient-info-label">Â∏åÊúõÊôÇÈñì</span>';
        html += '<span class="route-patient-info-value highlight">' + (data.master.startPrefStr || '-') + ' - ' + (data.master.endPrefStr || '-') + '</span>';
        html += '</div>';

        // Â∏åÊúõÊõúÊó•
        if (data.master.prefDays && data.master.prefDays.length > 0) {
          html += '<div class="route-patient-info-row">';
          html += '<span class="route-patient-info-label">Â∏åÊúõÊõúÊó•</span>';
          html += '<span class="route-patient-info-value">' + data.master.prefDays.join(', ') + '</span>';
          html += '</div>';
        }

        // ÊõúÊó•NG
        if (data.master.ngDays && data.master.ngDays.length > 0) {
          html += '<div class="route-patient-info-row">';
          html += '<span class="route-patient-info-label">ÊõúÊó•NG</span>';
          html += '<span class="route-patient-info-value critical">' + data.master.ngDays.join(', ') + '</span>';
          html += '</div>';
        }

        // „Çµ„Éº„Éì„ÇπÊôÇÈñì
        html += '<div class="route-patient-info-row">';
        html += '<span class="route-patient-info-label">„Çµ„Éº„Éì„Çπ</span>';
        html += '<span class="route-patient-info-value">' + (data.master.svcMin || '-') + 'ÂàÜ</span>';
        html += '</div>';

        // ÊÄßÂà•Âà∂Èôê
        if (data.master.sexLimit && data.master.sexLimit !== '-') {
          html += '<div class="route-patient-info-row">';
          html += '<span class="route-patient-info-label">ÊÄßÂà•Âà∂Èôê</span>';
          html += '<span class="route-patient-info-value critical">' + data.master.sexLimit + '</span>';
          html += '</div>';
        }

        // ÊåáÂÆö„Çπ„Çø„ÉÉ„Éï
        if (data.master.fixedStaff) {
          html += '<div class="route-patient-info-row">';
          html += '<span class="route-patient-info-label">ÊåáÂÆö„Çπ„Çø„ÉÉ„Éï</span>';
          html += '<span class="route-patient-info-value">' + data.master.fixedStaff + ' (' + (data.master.fixedType || 'Â∏åÊúõ') + ')</span>';
          html += '</div>';
        }

        // NG„Çπ„Çø„ÉÉ„Éï
        if (data.master.ngStaff) {
          html += '<div class="route-patient-info-row">';
          html += '<span class="route-patient-info-label">NG„Çπ„Çø„ÉÉ„Éï</span>';
          html += '<span class="route-patient-info-value critical">' + data.master.ngStaff + '</span>';
          html += '</div>';
        }

        html += '</div>';
      }

      // ÈÄ±Èñì„Çπ„Ç±„Ç∏„É•„Éº„É´Ê¶ÇË¶Å
      if (data.dayJudgements && data.dayJudgements.length > 0) {
        html += '<div class="route-patient-section">';
        html += '<div class="route-patient-section-title">‰ªäÈÄ±„ÅÆË®™Âïè</div>';

        var dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        var youbiMap = {'Mon': 'Êúà', 'Tue': 'ÁÅ´', 'Wed': 'Ê∞¥', 'Thu': 'Êú®', 'Fri': 'Èáë', 'Sat': 'Âúü', 'Sun': 'Êó•'};
        var djByYoubi = {};
        data.dayJudgements.forEach(function(dj) { djByYoubi[dj.youbi] = dj; });

        dayOrder.forEach(function(youbi) {
          var dj = djByYoubi[youbi];
          if (dj) {
            var statusIcon = dj.status === 'OK' ? '‚óã' : (dj.status === 'WARN' ? '‚ñ≥' : '√ó');
            var statusClass = dj.status === 'NG' ? 'critical' : (dj.status === 'WARN' ? 'highlight' : '');
            var timeStr = '';
            if (dj.hasActual && dj.actuals && dj.actuals.length > 0) {
              timeStr = dj.actuals.map(function(a) { return a.startStr + '-' + a.endStr; }).join(', ');
            }
            html += '<div class="route-patient-info-row">';
            html += '<span class="route-patient-info-label">' + youbiMap[youbi] + ' ' + dj.dateStr.substring(5) + '</span>';
            html += '<span class="route-patient-info-value ' + statusClass + '">' + statusIcon + ' ' + timeStr + '</span>';
            html += '</div>';
          }
        });

        html += '</div>';
      }

      content.innerHTML = html;
    }

    // ÊÇ£ËÄÖË©≥Á¥∞„Éë„Éç„É´„ÇíÈñâ„Åò„Å¶Ë®™Âïè„É™„Çπ„Éà„Å´Êàª„Çã
    function closeRoutePatientDetail() {
      document.getElementById('routePatientDetailPanel').style.display = 'none';
      document.getElementById('routeStopListContainer').style.display = 'block';
    }

    function closeRouteMapModal() {
      document.getElementById('routeMapModal').classList.remove('show');
      // Ë©≥Á¥∞„Éë„Éç„É´„ÇÇ„É™„Çª„ÉÉ„Éà
      closeRoutePatientDetail();
      if (routeMap) {
        routeMap.remove();
        routeMap = null;
      }
    }

    // „É´„Éº„Éà„Éû„ÉÉ„Éó„É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    document.getElementById('routeMapModal').addEventListener('click', function(e) {
      if (e.target === this) closeRouteMapModal();
    });
  </script>

</body>
</html>
