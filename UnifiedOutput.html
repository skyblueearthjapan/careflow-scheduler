<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_top">
  <style>
    /* ============================================================
       ã‚ˆã‚Šã‚ˆã‚Šãƒ–ãƒ©ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼
       ============================================================ */
    :root {
      --color-green: #B7D38A;
      --color-green-dark: #9BC06A;
      --color-green-light: #D4E8B8;
      --color-orange: #F6B26B;
      --color-orange-dark: #E89D4A;
      --color-orange-light: #FACCAA;
      --color-yellow: #F9E0A6;
      --color-yellow-light: #FDF5E6;
      --color-blue: #7DA7D9;
      --color-blue-dark: #5A8BC4;
      --color-blue-light: #B8D4F0;
      --color-text: #333333;
      --color-text-light: #666666;
      --color-border: #E0E0E0;
      --color-bg: #FAFAFA;
      --color-white: #FFFFFF;
      --color-success: #B7D38A;
      --color-error: #E88B8B;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Hiragino Sans', 'Meiryo', 'Segoe UI', sans-serif;
      background: var(--color-bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--color-text);
    }

    /* ============================================================
       ãƒ˜ãƒƒãƒ€ãƒ¼
       ============================================================ */
    .header {
      background: linear-gradient(135deg, var(--color-green) 0%, var(--color-green-dark) 100%);
      color: var(--color-white);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .header-status {
      font-size: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
    }

    /* ============================================================
       ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
       ============================================================ */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* å·¦ãƒ‘ãƒãƒ« */
    .left-panel {
      flex: 1;
      padding: 16px;
      overflow: auto;
      background: var(--color-white);
      display: flex;
      flex-direction: column;
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--color-yellow-light);
      border-radius: 8px;
      border: 1px solid var(--color-yellow);
      font-size: 13px;
    }

    .status-text { color: var(--color-text-light); }
    .status-text.loading { color: var(--color-blue-dark); }
    .status-text.error { color: var(--color-error); }
    .status-text.success { color: var(--color-green-dark); }

    .refresh-btn {
      padding: 6px 14px;
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    .refresh-btn:hover { background: var(--color-green-dark); }
    .refresh-btn:disabled { background: #ccc; cursor: not-allowed; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ */
    #mainContent {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-container {
      flex: 1;
      overflow: auto;
      border: 1px solid var(--color-green-light);
      border-radius: 8px;
    }

    /* é€±ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
    .week-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
      font-size: 13px;
    }

    .week-table th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      padding: 12px 10px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--color-blue-dark);
      z-index: 10;
    }

    .week-table th:first-child {
      left: 0;
      z-index: 20;
      min-width: 140px;
      text-align: left;
      background: var(--color-green);
      border-color: var(--color-green-dark);
    }

    .week-table td {
      border: 1px solid var(--color-green-light);
      padding: 8px 10px;
      vertical-align: top;
      background: var(--color-white);
    }

    .week-table td:first-child {
      position: sticky;
      left: 0;
      background: var(--color-yellow-light);
      font-weight: 600;
      min-width: 140px;
      z-index: 5;
      border-left: 3px solid var(--color-green);
    }

    .week-table tr:nth-child(even) td { background: #FDFDFB; }
    .week-table tr:nth-child(even) td:first-child { background: #FDF8E8; }
    .week-table tr:hover td { background: var(--color-blue-light); }
    .week-table tr:hover td:first-child { background: var(--color-yellow); }

    .cell-content {
      white-space: pre-wrap;
      line-height: 1.5;
      font-size: 12px;
      /* å†…å®¹é‡ã«å¿œã˜ã¦ç¸¦æ–¹å‘ã«è‡ªå‹•æ‹¡å¼µï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæ§˜ï¼‰ */
    }

    /* æ±ç”¨ã‚·ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« */
    .sheet-table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
      font-size: 12px;
    }

    .sheet-table th, .sheet-table td {
      border: 1px solid var(--color-border);
      padding: 8px 10px;
      white-space: nowrap;
    }

    .sheet-table thead th {
      position: sticky;
      top: 0;
      background: var(--color-blue);
      color: var(--color-white);
      font-weight: 600;
      z-index: 1;
    }

    .sheet-table tbody tr:nth-child(even) { background: #FDFDFB; }
    .sheet-table tbody tr:hover { background: var(--color-blue-light); }

    /* ============================================================
       å³ãƒ‘ãƒãƒ«ï¼ˆGASå®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
       ============================================================ */
    .right-panel {
      width: 260px;
      border-left: 1px solid var(--color-border);
      background: var(--color-white);
      padding: 16px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--color-green);
    }

    .button-group { margin-bottom: 20px; }

    .button-group-title {
      font-size: 11px;
      color: var(--color-text-light);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .action-btn {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      text-align: left;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .action-btn.primary {
      background: var(--color-orange);
      color: var(--color-white);
      box-shadow: 0 2px 4px rgba(246, 178, 107, 0.3);
    }
    .action-btn.primary:hover:not(:disabled) {
      background: var(--color-orange-dark);
      transform: translateY(-1px);
    }

    .action-btn.secondary {
      background: var(--color-yellow-light);
      color: var(--color-text);
      border: 1px solid var(--color-yellow);
    }
    .action-btn.secondary:hover:not(:disabled) {
      background: var(--color-yellow);
    }

    .action-btn.audit {
      background: var(--color-green);
      color: var(--color-white);
      box-shadow: 0 2px 4px rgba(106, 168, 79, 0.3);
    }
    .action-btn.audit:hover:not(:disabled) {
      background: var(--color-green-dark);
      transform: translateY(-1px);
    }
    .action-btn.audit.active {
      background: var(--color-green-dark);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .action-btn .spinner {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .action-btn.loading .spinner { display: inline-block; }
    .action-btn.loading .icon { display: none; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* å®Ÿè¡Œãƒ­ã‚° */
    .log-section {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--color-border);
    }

    .log-title {
      font-size: 12px;
      color: var(--color-text-light);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .log-list {
      max-height: 150px;
      overflow-y: auto;
      font-size: 11px;
    }

    .log-item {
      padding: 8px 10px;
      margin-bottom: 6px;
      background: var(--color-yellow-light);
      border-radius: 6px;
      border-left: 3px solid var(--color-green);
    }
    .log-item.error { border-left-color: var(--color-error); background: #FFF5F5; }

    /* ============================================================
       ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼
       ============================================================ */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-top: 1px solid var(--color-green-light);
      background: var(--color-white);
    }

    .tabs-left { display: flex; gap: 8px; }

    .tab-btn {
      border: 1px solid var(--color-green-light);
      background: var(--color-white);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: var(--color-text);
      transition: all 0.2s ease;
    }
    .tab-btn:hover { background: var(--color-green-light); }
    .tab-btn.active {
      background: var(--color-green);
      border-color: var(--color-green);
      color: var(--color-white);
    }

    .tabs-right { display: flex; gap: 8px; }

    .nav-link {
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--color-orange);
      background: var(--color-orange-light);
      border-radius: 8px;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .nav-link:hover {
      background: var(--color-orange);
      color: var(--color-white);
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .toast.show { opacity: 1; }
    .toast.success { background: var(--color-green); color: white; }
    .toast.error { background: var(--color-error); color: white; }

    /* ============================================================
       ç›£æŸ»ï¼ˆåˆå¦åˆ¤å®šï¼‰ãƒ“ãƒ¥ãƒ¼
       ============================================================ */
    .audit-controls {
      display: flex; align-items: center; gap: 16px; padding: 12px 0;
      border-bottom: 1px solid var(--color-border); margin-bottom: 12px;
    }
    .audit-controls label { font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .audit-controls input[type="date"] {
      padding: 6px 10px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 13px;
    }
    .audit-legend { font-size: 12px; color: var(--color-text-light); margin-left: auto; }
    .audit-ok { color: var(--color-green-dark); font-weight: bold; }
    .audit-warn { color: var(--color-orange-dark); font-weight: bold; }
    .audit-ng { color: var(--color-error); font-weight: bold; }
    .audit-toolbar {
      display: flex; align-items: center; gap: 16px; padding: 8px 0; margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .audit-filters { display: flex; align-items: center; gap: 6px; }
    .filter-label { font-size: 12px; color: var(--color-text-light); }
    .audit-filter-btn {
      padding: 4px 12px; border: 1px solid var(--color-border); border-radius: 4px;
      background: var(--color-white); font-size: 11px; cursor: pointer;
      transition: all 0.15s;
    }
    .audit-filter-btn:hover { background: var(--color-bg); }
    .audit-filter-btn.active { background: var(--color-green); color: var(--color-white); border-color: var(--color-green); }
    .audit-summary {
      display: flex; gap: 12px; font-size: 12px; margin-left: auto;
      padding: 6px 12px; background: var(--color-bg); border-radius: 6px;
    }
    .audit-summary .stat { display: flex; align-items: center; gap: 4px; }
    .audit-summary .stat-label { color: var(--color-text-light); }
    .audit-summary .stat-value { font-weight: 600; }
    .audit-summary .stat-value.ok { color: var(--color-green-dark); }
    .audit-summary .stat-value.warn { color: var(--color-orange-dark); }
    .audit-summary .stat-value.ng { color: var(--color-error); }
    .audit-cache-status { font-size: 11px; color: var(--color-text-light); }
    .audit-cache-status.from-cache { color: var(--color-blue-dark); }
    .audit-warnings {
      background: var(--color-orange-light); border: 1px solid var(--color-orange); border-radius: 6px;
      padding: 10px 14px; margin-bottom: 12px; font-size: 12px;
    }
    .audit-warnings-title { font-weight: 600; color: var(--color-orange-dark); margin-bottom: 6px; }
    .audit-warnings-list { color: var(--color-orange-dark); }
    .audit-main { display: flex; gap: 16px; flex: 1; overflow: hidden; }
    .audit-week-view { flex: 1; overflow: auto; border: 1px solid var(--color-green-light); border-radius: 8px; }
    .audit-table { border-collapse: collapse; width: 100%; font-size: 12px; }
    .audit-table th {
      position: sticky; top: 0; background: var(--color-blue); color: var(--color-white);
      padding: 10px 12px; text-align: center; font-weight: 600; border: 1px solid var(--color-blue-dark);
      white-space: nowrap; z-index: 10; min-width: 100px;
    }
    .audit-table th:first-child { min-width: 120px; text-align: left; }
    .audit-table td {
      border: 1px solid var(--color-border); padding: 8px; vertical-align: top;
      background: var(--color-white); cursor: pointer; min-height: 60px;
    }
    .audit-table td:first-child { font-weight: 500; background: var(--color-bg); }
    .audit-table td:hover { background: var(--color-blue-light); }
    .audit-cell-summary { display: flex; gap: 8px; font-size: 11px; justify-content: center; }
    .audit-cell-summary .ok { color: var(--color-green-dark); }
    .audit-cell-summary .warn { color: var(--color-orange-dark); }
    .audit-cell-summary .ng { color: var(--color-error); }
    .audit-detail-panel {
      width: 320px; border: 1px solid var(--color-border); border-radius: 8px;
      background: var(--color-white); display: flex; flex-direction: column; overflow: hidden;
    }
    .audit-detail-header {
      background: var(--color-green); color: var(--color-white); padding: 10px 14px;
      display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 13px;
    }
    .audit-close-btn {
      background: none; border: none; color: inherit; font-size: 18px; cursor: pointer; padding: 0 4px;
    }
    .audit-close-btn:hover { opacity: 0.7; }
    .audit-detail-content { flex: 1; overflow-y: auto; padding: 12px; }
    .audit-patient-item {
      display: flex; align-items: center; gap: 8px; padding: 8px 10px; margin-bottom: 6px;
      border: 1px solid var(--color-border); border-radius: 6px; cursor: pointer; font-size: 12px;
    }
    .audit-patient-item:hover { background: var(--color-blue-light); }
    .audit-patient-item .status { font-size: 14px; }
    .audit-patient-item .status.ok { color: var(--color-green-dark); }
    .audit-patient-item .status.warn { color: var(--color-orange-dark); }
    .audit-patient-item .status.ng { color: var(--color-error); }
    .audit-patient-item .name { flex: 1; }
    .audit-patient-item .tags { font-size: 10px; color: var(--color-text-light); }
    .audit-patient-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .audit-modal-content {
      background: var(--color-white); border-radius: 12px; width: 90%; max-width: 700px;
      max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .audit-modal-header {
      background: var(--color-green); color: var(--color-white); padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 14px; border-radius: 12px 12px 0 0;
    }
    .audit-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .audit-section { margin-bottom: 20px; }
    .audit-section-title {
      font-size: 13px; font-weight: 600; color: var(--color-text);
      border-bottom: 2px solid var(--color-green); padding-bottom: 6px; margin-bottom: 10px;
    }
    .audit-info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
    .audit-info-item { font-size: 12px; }
    .audit-info-item .label { color: var(--color-text-light); }
    .audit-info-item .value { font-weight: 500; }
    .audit-day-row {
      border: 1px solid var(--color-border); border-radius: 6px; margin-bottom: 12px;
      overflow: hidden;
    }
    .audit-day-header {
      display: flex; align-items: center; gap: 12px; padding: 10px 12px;
      background: var(--color-bg); border-bottom: 1px solid var(--color-border);
    }
    .audit-day-header .date { font-weight: 600; min-width: 80px; }
    .audit-day-header .status-icon { font-size: 18px; font-weight: bold; }
    .audit-day-header .status-icon.ok { color: var(--color-green-dark); }
    .audit-day-header .status-icon.warn { color: var(--color-orange-dark); }
    .audit-day-header .status-icon.ng { color: var(--color-error); }
    .audit-day-body { padding: 12px; font-size: 12px; }
    .audit-day-body .tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }
    .audit-compare-section { margin-bottom: 10px; }
    .audit-compare-label { font-weight: 600; color: var(--color-text-light); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; }
    .audit-expected-item, .audit-actual-item { padding: 4px 8px; background: var(--color-bg); border-radius: 4px; margin-bottom: 4px; }
    .audit-source-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .audit-source-badge.source-master { background: var(--color-green-light); color: var(--color-green-dark); }
    .audit-source-badge.source-change { background: var(--color-orange-light); color: var(--color-orange-dark); }
    .audit-source-badge.source-special { background: var(--color-blue-light); color: var(--color-blue-dark); }
    .audit-time-type { color: var(--color-text-light); font-size: 11px; }
    .audit-cancelled-badge { background: var(--color-error); color: var(--color-white); font-size: 10px; padding: 2px 6px; border-radius: 4px; }
    .audit-unassigned-badge { background: var(--color-error); color: var(--color-white); font-size: 10px; padding: 2px 4px; border-radius: 2px; }
    .audit-staff-name { color: var(--color-text-light); }
    .audit-check-item { padding: 4px 8px; border-radius: 4px; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    .audit-check-item.check-ok { background: var(--color-green-light); }
    .audit-check-item.check-warn { background: var(--color-orange-light); }
    .audit-check-item.check-ng { background: rgba(232, 139, 139, 0.3); }
    .audit-check-icon { font-weight: bold; width: 14px; text-align: center; }
    .check-ok .audit-check-icon { color: var(--color-green-dark); }
    .check-warn .audit-check-icon { color: var(--color-orange-dark); }
    .check-ng .audit-check-icon { color: var(--color-error); }
    .audit-diff { color: var(--color-text-light); font-size: 11px; }
    .audit-additional-info { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--color-border); }
    .audit-info-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; }
    .audit-info-badge.change { background: var(--color-orange-light); color: var(--color-orange-dark); }
    .audit-info-badge.special { background: var(--color-blue-light); color: var(--color-blue-dark); }
    .audit-info-badge.event { background: var(--color-yellow-light); color: var(--color-text); }
    .audit-tag {
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: var(--color-bg); border: 1px solid var(--color-border);
    }
    .audit-tag.ok { background: var(--color-green-light); border-color: var(--color-green); color: var(--color-green-dark); }
    .audit-tag.warn { background: var(--color-orange-light); border-color: var(--color-orange); color: var(--color-orange-dark); }
    .audit-tag.ng { background: rgba(232, 139, 139, 0.3); border-color: var(--color-error); color: var(--color-error); }

    /* æ¡ä»¶åˆ†æUIï¼ˆæ–°æ©Ÿèƒ½ï¼‰ */
    .audit-collapsible summary { cursor: pointer; user-select: none; }
    .audit-collapsible summary:hover { background: var(--color-bg); }
    .audit-section-title.clickable { padding: 8px 12px; margin: -10px -10px 10px -10px; border-radius: 6px 6px 0 0; }
    .audit-subsection-title { font-size: 12px; font-weight: 600; color: var(--color-text); padding: 6px 0; margin-bottom: 8px; }
    .audit-subsection-title.clickable { cursor: pointer; padding: 8px; margin: 0 -8px 8px -8px; background: var(--color-bg); border-radius: 4px; }
    .audit-subsection-title.clickable:hover { background: var(--color-border); }

    /* å¤‰æ›´ãƒ»ç‰¹åˆ¥è¨ªå•ã‚¢ã‚¤ãƒ†ãƒ  */
    .audit-change-item, .audit-special-item {
      font-size: 12px; margin-bottom: 6px; padding: 8px 10px;
      background: var(--color-bg); border-radius: 6px; border-left: 3px solid var(--color-orange);
    }
    .audit-special-item { border-left-color: var(--color-blue); }
    .audit-op-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    }
    .audit-op-badge.op-ã‚­ãƒ£ãƒ³ã‚»ãƒ« { background: var(--color-error); color: var(--color-white); }
    .audit-op-badge.op-æ™‚é–“å¤‰æ›´ { background: var(--color-orange); color: var(--color-white); }
    .audit-op-badge.op-è¿½åŠ  { background: var(--color-green); color: var(--color-white); }
    .audit-mode-badge {
      font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600;
    }
    .audit-mode-badge.mode-REPLACE { background: var(--color-error); color: var(--color-white); }
    .audit-mode-badge.mode-ADD { background: var(--color-blue); color: var(--color-white); }
    .audit-note { color: var(--color-text-light); font-style: italic; }

    /* æ—¥åˆ¥è¡Œã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒ¼ãƒ€ãƒ¼ */
    .audit-day-row.status-ng { border-left: 4px solid var(--color-error); }
    .audit-day-row.status-warn { border-left: 4px solid var(--color-orange); }
    .audit-day-row.status-ok { border-left: 4px solid var(--color-green); }
    .violation-summary { font-size: 11px; color: var(--color-text-light); }

    /* æ¡ä»¶åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .audit-conditions-section { margin-bottom: 12px; }
    .audit-conditions-grid { display: flex; flex-direction: column; gap: 10px; }
    .audit-condition-category {
      background: var(--color-white); border: 1px solid var(--color-border);
      border-radius: 6px; padding: 10px; overflow: hidden;
    }
    .category-header {
      font-size: 11px; font-weight: 600; color: var(--color-text-light);
      text-transform: uppercase; margin-bottom: 8px; padding-bottom: 6px;
      border-bottom: 1px solid var(--color-border);
    }

    /* æ¡ä»¶ã‚¢ã‚¤ãƒ†ãƒ  */
    .audit-condition-item {
      padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
      background: var(--color-bg); border-left: 3px solid var(--color-border);
      font-size: 12px;
    }
    .audit-condition-item.status-ok { border-left-color: var(--color-green); background: rgba(144, 238, 144, 0.1); }
    .audit-condition-item.status-warn { border-left-color: var(--color-orange); background: rgba(255, 193, 7, 0.1); }
    .audit-condition-item.status-ng { border-left-color: var(--color-error); background: rgba(232, 139, 139, 0.15); }
    .audit-condition-item:last-child { margin-bottom: 0; }

    .cond-status-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 18px; height: 18px; border-radius: 50%; font-size: 11px; font-weight: bold;
      margin-right: 6px;
    }
    .cond-status-icon.ok { background: var(--color-green); color: var(--color-white); }
    .cond-status-icon.warn { background: var(--color-orange); color: var(--color-white); }
    .cond-status-icon.ng { background: var(--color-error); color: var(--color-white); }

    .cond-label { font-weight: 600; margin-right: 8px; }
    .cond-severity-badge {
      font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600;
      vertical-align: middle;
    }
    .cond-severity-badge.severity-critical { background: var(--color-error); color: var(--color-white); }
    .cond-severity-badge.severity-warning { background: var(--color-orange); color: var(--color-white); }
    .cond-severity-badge.severity-info { background: var(--color-text-light); color: var(--color-white); }

    .cond-detail { margin-top: 4px; color: var(--color-text-light); font-size: 11px; }
    .cond-expected { display: inline; }
    .cond-actual { display: inline; font-weight: 500; }
    .cond-diff-detail {
      margin-top: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px;
    }
    .cond-diff-detail.diff-ng { background: rgba(232, 139, 139, 0.2); color: var(--color-error); }
    .cond-diff-detail.diff-warn { background: rgba(255, 193, 7, 0.2); color: var(--color-orange-dark); }

    .severity-critical { color: var(--color-error); font-weight: 600; }

    /* æ¡ä»¶é•åã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .audit-violations-section {
      background: rgba(232, 139, 139, 0.1); border: 1px solid rgba(232, 139, 139, 0.3);
      border-radius: 6px; padding: 10px; margin-bottom: 12px;
    }
    .violations-title { color: var(--color-error); border-bottom: 1px solid rgba(232, 139, 139, 0.3); }
    .audit-violation-item {
      padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
      display: flex; align-items: flex-start; gap: 8px; flex-wrap: wrap;
    }
    .audit-violation-item:last-child { margin-bottom: 0; }
    .audit-violation-item.violation-ng { background: rgba(232, 139, 139, 0.2); }
    .audit-violation-item.violation-warn { background: rgba(255, 193, 7, 0.2); }
    .violation-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 20px; height: 20px; border-radius: 50%; font-size: 12px; font-weight: bold;
      flex-shrink: 0;
    }
    .violation-ng .violation-icon { background: var(--color-error); color: var(--color-white); }
    .violation-warn .violation-icon { background: var(--color-orange); color: var(--color-white); }
    .violation-label { font-weight: 600; font-size: 12px; }
    .violation-severity { font-size: 10px; color: var(--color-text-light); }
    .violation-detail { width: 100%; font-size: 11px; color: var(--color-text); padding-left: 28px; margin-top: 2px; }

    /* æœŸå¾…vså®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .audit-compare-details { margin-bottom: 8px; }
    .audit-checks-details { margin-top: 8px; }

    /* ============================================================
       é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ï¼ˆæ‚£è€…è©³ç´°ç”¨ï¼‰
       ============================================================ */
    .audit-week-overview {
      margin-bottom: 16px;
    }
    .audit-week-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--color-green);
    }
    .audit-week-title {
      font-size: 14px; font-weight: 600; color: var(--color-text);
    }
    .audit-week-legend {
      display: flex; gap: 12px; font-size: 11px;
    }
    .audit-week-legend-item {
      display: flex; align-items: center; gap: 4px;
    }
    .audit-week-legend-dot {
      width: 10px; height: 10px; border-radius: 50%;
    }
    .audit-week-legend-dot.ok { background: var(--color-green); }
    .audit-week-legend-dot.warn { background: var(--color-orange); }
    .audit-week-legend-dot.ng { background: var(--color-error); }

    .audit-week-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .audit-week-day {
      border: 2px solid var(--color-border);
      border-radius: 8px;
      padding: 10px 8px;
      text-align: center;
      background: var(--color-white);
      min-height: 90px;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
    }
    .audit-week-day.no-visit {
      background: var(--color-bg);
      opacity: 0.6;
    }
    .audit-week-day.status-ok {
      border-color: var(--color-green);
      background: rgba(144, 238, 144, 0.1);
    }
    .audit-week-day.status-warn {
      border-color: var(--color-orange);
      background: rgba(255, 193, 7, 0.1);
      cursor: pointer;
    }
    .audit-week-day.status-warn:hover {
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
      transform: translateY(-2px);
    }
    .audit-week-day.status-ng {
      border-color: var(--color-error);
      background: rgba(232, 139, 139, 0.15);
      cursor: pointer;
    }
    .audit-week-day.status-ng:hover {
      box-shadow: 0 4px 12px rgba(232, 139, 139, 0.3);
      transform: translateY(-2px);
    }
    .audit-week-day-date {
      font-size: 12px; color: var(--color-text-light);
      margin-bottom: 2px;
    }
    .audit-week-day-youbi {
      font-size: 14px; font-weight: 600; color: var(--color-text);
      margin-bottom: 8px;
    }
    .audit-week-day-status {
      font-size: 24px; font-weight: bold; margin-bottom: 6px;
    }
    .audit-week-day-status.ok { color: var(--color-green-dark); }
    .audit-week-day-status.warn { color: var(--color-orange-dark); }
    .audit-week-day-status.ng { color: var(--color-error); }
    .audit-week-day-time {
      font-size: 11px; color: var(--color-text);
      margin-bottom: 2px;
    }
    .audit-week-day-staff {
      font-size: 10px; color: var(--color-text-light);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .audit-week-day-novisit {
      font-size: 11px; color: var(--color-text-light);
      margin-top: auto;
    }
    .audit-week-day-click-hint {
      font-size: 10px; color: var(--color-text-light);
      margin-top: auto; padding-top: 4px;
    }
    .audit-week-day.status-warn .audit-week-day-click-hint,
    .audit-week-day.status-ng .audit-week-day-click-hint {
      color: inherit; opacity: 0.7;
    }

    /* æ—¥åˆ¥è©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³å¾Œï¼‰ */
    .audit-day-detail-view {
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .audit-back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--color-bg); border: 1px solid var(--color-border);
      border-radius: 6px; padding: 8px 14px; cursor: pointer;
      font-size: 12px; color: var(--color-text); font-weight: 500;
      margin-bottom: 16px; transition: all 0.2s;
    }
    .audit-back-btn:hover {
      background: var(--color-border);
    }
    .audit-day-detail-header {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; margin-bottom: 16px;
      border-radius: 8px; background: var(--color-bg);
    }
    .audit-day-detail-header.status-ok { background: rgba(144, 238, 144, 0.2); border-left: 4px solid var(--color-green); }
    .audit-day-detail-header.status-warn { background: rgba(255, 193, 7, 0.2); border-left: 4px solid var(--color-orange); }
    .audit-day-detail-header.status-ng { background: rgba(232, 139, 139, 0.2); border-left: 4px solid var(--color-error); }
    .audit-day-detail-date {
      font-size: 18px; font-weight: 600;
    }
    .audit-day-detail-status {
      font-size: 20px; font-weight: bold;
    }
    .audit-day-detail-status.ok { color: var(--color-green-dark); }
    .audit-day-detail-status.warn { color: var(--color-orange-dark); }
    .audit-day-detail-status.ng { color: var(--color-error); }

    /* ============================================================
       ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«
       ============================================================ */
    .kaipoke-modal {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .kaipoke-modal.show { display: flex; }
    .kaipoke-modal-content {
      background: var(--color-white); border-radius: 12px; width: 400px; max-width: 90%;
      max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .kaipoke-modal-header {
      background: var(--color-blue); color: var(--color-white); padding: 14px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 600; font-size: 15px; border-radius: 12px 12px 0 0;
    }
    .kaipoke-modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    .kaipoke-section {
      background: var(--color-bg); border-radius: 8px; padding: 16px; margin-bottom: 16px;
    }
    .kaipoke-section-title { font-weight: 600; color: var(--color-text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .kaipoke-status-indicator {
      width: 12px; height: 12px; border-radius: 50%; display: inline-block;
    }
    .kaipoke-status-indicator.ready { background: var(--color-success); }
    .kaipoke-status-indicator.busy { background: var(--color-orange); }
    .kaipoke-status-indicator.error { background: var(--color-error); }
    .kaipoke-input-group { margin-bottom: 12px; }
    .kaipoke-input-group label { display: block; font-size: 12px; color: var(--color-text-light); margin-bottom: 4px; }
    .kaipoke-input-group select, .kaipoke-input-group input {
      width: 100%; padding: 8px 10px; border: 1px solid var(--color-border); border-radius: 6px;
      font-size: 13px; box-sizing: border-box;
    }
    .kaipoke-btn {
      width: 100%; padding: 12px; margin-bottom: 8px; border: none; border-radius: 8px;
      cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;
    }
    .kaipoke-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .kaipoke-btn.primary { background: var(--color-blue); color: var(--color-white); }
    .kaipoke-btn.primary:hover:not(:disabled) { background: var(--color-blue-dark); }
    .kaipoke-btn.success { background: var(--color-success); color: var(--color-white); }
    .kaipoke-btn.success:hover:not(:disabled) { background: var(--color-green-dark); }
    .kaipoke-btn.warning { background: var(--color-orange); color: var(--color-white); }
    .kaipoke-btn.warning:hover:not(:disabled) { background: var(--color-orange-dark); }
    .kaipoke-btn.danger { background: var(--color-error); color: var(--color-white); }
    .kaipoke-btn.danger:hover:not(:disabled) { background: #c0392b; }
    .kaipoke-result {
      background: var(--color-white); border: 1px solid var(--color-border); border-radius: 6px;
      padding: 12px; min-height: 60px; white-space: pre-wrap; font-size: 12px; color: var(--color-text);
    }
    .kaipoke-result.error { color: var(--color-error); }
    .kaipoke-loading { display: none; text-align: center; padding: 16px; }
    .kaipoke-loading.show { display: block; }
    .kaipoke-spinner {
      border: 3px solid var(--color-border); border-top-color: var(--color-blue);
      border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite;
      margin: 0 auto 10px;
    }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <h1>è¨ªå•çœ‹è­· è‡ªå‹•ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</h1>
    <span class="header-status" id="headerStatus">å‡ºåŠ›ç”»é¢</span>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-container">
    <!-- å·¦ï¼šãƒ¡ã‚¤ãƒ³è¡¨ç¤º -->
    <div class="left-panel">
      <div class="status-bar">
        <span class="status-text" id="statusText">èª­ã¿è¾¼ã¿ä¸­...</span>
        <button class="refresh-btn" id="refreshBtn" onclick="refreshCurrentView()">æ›´æ–°</button>
      </div>
      <div id="mainContent">
        <div class="table-container">
          <table class="week-table" id="weekTable"></table>
        </div>
      </div>
      <!-- ç›£æŸ»ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
      <div id="auditArea" style="display:none; flex-direction:column; flex:1;">
        <div class="audit-controls">
          <label>é€±é–‹å§‹æ—¥:
            <input type="date" id="auditWeekStart" onchange="loadAuditData()">
          </label>
          <button class="refresh-btn" onclick="loadAuditData()">æ›´æ–°</button>
          <button class="refresh-btn" onclick="refreshAuditData()" title="ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­è¾¼">ğŸ”„ å†èª­è¾¼</button>
          <span class="audit-legend">å‡¡ä¾‹: <span class="audit-ok">â—‹OK</span> <span class="audit-warn">â–³WARN</span> <span class="audit-ng">Ã—NG</span></span>
        </div>
        <div class="audit-toolbar">
          <div class="audit-filters">
            <span class="filter-label">è¡¨ç¤º:</span>
            <button class="audit-filter-btn active" data-filter="all" onclick="setAuditFilter('all')">å…¨ã¦</button>
            <button class="audit-filter-btn" data-filter="issues" onclick="setAuditFilter('issues')">NG+WARN</button>
            <button class="audit-filter-btn" data-filter="ng" onclick="setAuditFilter('ng')">NGã®ã¿</button>
          </div>
          <div class="audit-summary" id="auditSummary"></div>
          <div class="audit-cache-status" id="auditCacheStatus"></div>
        </div>
        <div class="audit-warnings" id="auditWarnings" style="display:none;"></div>
        <div class="audit-main">
          <div class="audit-week-view">
            <table class="audit-table" id="auditWeekTable">
              <thead><tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="audit-detail-panel" id="auditDetailPanel" style="display:none;">
            <div class="audit-detail-header">
              <span id="auditDetailTitle">ã‚»ãƒ«è©³ç´°</span>
              <button class="audit-close-btn" onclick="closeAuditDetail()">Ã—</button>
            </div>
            <div class="audit-detail-content" id="auditDetailContent"></div>
          </div>
        </div>
      </div>
      <!-- æ‚£è€…è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div class="audit-patient-modal" id="auditPatientModal" style="display:none;">
        <div class="audit-modal-content">
          <div class="audit-modal-header">
            <span id="auditModalTitle">æ‚£è€…è©³ç´°</span>
            <button class="audit-close-btn" onclick="closeAuditPatientModal()">Ã—</button>
          </div>
          <div class="audit-modal-body" id="auditModalBody"></div>
        </div>
      </div>
    </div>

    <!-- å³ï¼šGASå®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="right-panel">
      <div class="panel-title">GASå®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>

      <div class="button-group">
        <div class="button-group-title">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”Ÿæˆ</div>
        <button class="action-btn primary" onclick="runJob('weeklyRequest', this)">
          <span class="icon">ğŸ“‹</span><span class="spinner"></span>
          é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç”Ÿæˆ
        </button>
        <button class="action-btn primary" onclick="runJob('assignResult', this)">
          <span class="icon">ğŸ“…</span><span class="spinner"></span>
          å‰²å½“çµæœã‚’ä½œæˆ
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</div>
        <button class="action-btn secondary" onclick="runJob('updateWeekView', this)">
          <span class="icon">ğŸ”„</span><span class="spinner"></span>
          é€±ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
        </button>
        <button class="action-btn secondary" onclick="runJob('routeSummary', this)">
          <span class="icon">ğŸ—ºï¸</span><span class="spinner"></span>
          ãƒ«ãƒ¼ãƒˆã‚µãƒãƒªã‚’ä½œæˆ
        </button>
        <button class="action-btn secondary" onclick="runJob('updateGeo', this)">
          <span class="icon">ğŸ“</span><span class="spinner"></span>
          ä½ç½®æƒ…å ±ã‚’æ›´æ–°
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">ç›£æŸ»</div>
        <button class="action-btn audit" id="auditNavBtn" onclick="showAuditView()">
          <span class="icon">âœ“</span>
          ç›£æŸ»ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ã
        </button>
      </div>

      <div class="button-group">
        <div class="button-group-title">ã‚«ã‚¤ãƒã‚±é€£æº</div>
        <button class="action-btn secondary" onclick="openKaipokeModal()">
          <span class="icon">ğŸ¤–</span>
          ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–
        </button>
      </div>

      <div class="log-section">
        <div class="log-title">
          <span>æœ€è¿‘ã®å®Ÿè¡Œãƒ­ã‚°</span>
          <button class="refresh-btn" onclick="loadLogs()" style="padding:4px 10px;font-size:11px;">æ›´æ–°</button>
        </div>
        <div class="log-list" id="logList">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <!-- ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼ -->
  <div class="bottom-bar">
    <div class="tabs-left">
      <button class="tab-btn active" data-tab="weekView" onclick="showTab('weekView', this)">é€±ãƒ“ãƒ¥ãƒ¼</button>
      <button class="tab-btn" data-tab="weeklyRequest" onclick="showTab('weeklyRequest', this)">é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
      <button class="tab-btn" data-tab="assignResult" onclick="showTab('assignResult', this)">å‰²å½“çµæœ</button>
      <button class="tab-btn" data-tab="assignNg" onclick="showTab('assignNg', this)">å‰²å½“ä¸å¯</button>
      <button class="tab-btn" data-tab="routeSummary" onclick="showTab('routeSummary', this)">ãƒ«ãƒ¼ãƒˆã‚µãƒãƒª</button>
    </div>
    <div class="tabs-right">
      <a class="nav-link" id="inputLink" onclick="goToInput()">å…¥åŠ›ç®¡ç†ç”»é¢ã¸ â†’</a>
    </div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="toast" id="toast"></div>

  <!-- ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="kaipoke-modal" id="kaipokeModal">
    <div class="kaipoke-modal-content">
      <div class="kaipoke-modal-header">
        <span>ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–</span>
        <button class="audit-close-btn" onclick="closeKaipokeModal()">Ã—</button>
      </div>
      <div class="kaipoke-modal-body">
        <!-- ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ -->
        <div class="kaipoke-section">
          <div class="kaipoke-section-title">
            <span class="kaipoke-status-indicator error" id="kaipokeStatusIndicator"></span>
            <span id="kaipokeStatusText">ç¢ºèªä¸­...</span>
          </div>
          <button class="kaipoke-btn primary" onclick="kaipokeRefreshStatus()">çŠ¶æ…‹ã‚’æ›´æ–°</button>
        </div>

        <!-- æœˆé¸æŠ -->
        <div class="kaipoke-section">
          <div class="kaipoke-section-title">å¯¾è±¡è¨­å®š</div>
          <div class="kaipoke-input-group">
            <label>å¯¾è±¡æœˆ</label>
            <select id="kaipokeTargetMonth"></select>
          </div>
          <div class="kaipoke-input-group">
            <label>å¯¾è±¡é€±ã®é–‹å§‹æ—¥ï¼ˆå·®åˆ†é©ç”¨æ™‚ã«å¿…è¦ï¼‰</label>
            <input type="date" id="kaipokeWeekStart">
          </div>
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="kaipoke-section">
          <div class="kaipoke-section-title">è‡ªå‹•åŒ–æ“ä½œ</div>
          <button class="kaipoke-btn primary" onclick="kaipokeExpand()">1. æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹</button>
          <button class="kaipoke-btn success" onclick="kaipokeExport()">2. CSVå‡ºåŠ›ï¼ˆDriveã«ä¿å­˜ï¼‰</button>
          <button class="kaipoke-btn warning" onclick="kaipokeDiff()">3. å·®åˆ†ç¢ºèªï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</button>
          <button class="kaipoke-btn danger" onclick="kaipokeApply()">4. å·®åˆ†é©ç”¨ï¼ˆã‚«ã‚¤ãƒã‚±ã«åæ˜ ï¼‰</button>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div class="kaipoke-loading" id="kaipokeLoading">
          <div class="kaipoke-spinner"></div>
          <div id="kaipokeLoadingText">å‡¦ç†ä¸­...</div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div class="kaipoke-section">
          <div class="kaipoke-section-title">å®Ÿè¡Œçµæœ</div>
          <div class="kaipoke-result" id="kaipokeResult">ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ“ä½œã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    var baseUrl = '';
    var currentTab = 'weekView';

    // ã‚·ãƒ¼ãƒˆåãƒãƒƒãƒ”ãƒ³ã‚°
    var SHEET_MAP = {
      'weekView': 'é€±ãƒ“ãƒ¥ãƒ¼',
      'weeklyRequest': 'é€±é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆ',
      'assignResult': 'å‰²å½“çµæœ',
      'assignNg': 'å‰²å½“ä¸å¯',
      'routeSummary': 'ãƒ«ãƒ¼ãƒˆã‚µãƒãƒª'
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      google.script.run
        .withSuccessHandler(function(url) { baseUrl = url; })
        .getBaseUrl();

      loadWeekView();
      loadLogs();

      // kaipoke=1 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã‚«ã‚¤ãƒã‚±ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•ã§é–‹ã
      var urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('kaipoke') === '1') {
        setTimeout(function() { openKaipokeModal(); }, 500);
      }
    });

    // ============================================================
    // ã‚¿ãƒ–åˆ‡æ›¿
    // ============================================================
    function showTab(tabKey, btn) {
      // ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ã®å¾©å¸°å‡¦ç†
      if (isAuditMode) {
        isAuditMode = false;
        document.getElementById('auditArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        var navBtn = document.getElementById('auditNavBtn');
        if (navBtn) navBtn.classList.remove('active');
      }

      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) {
        b.classList.remove('active');
      });
      btn.classList.add('active');
      currentTab = tabKey;

      if (tabKey === 'weekView') {
        loadWeekView();
      } else {
        loadSheetTable(SHEET_MAP[tabKey]);
      }
    }

    function refreshCurrentView() {
      if (currentTab === 'weekView') {
        loadWeekView();
      } else {
        loadSheetTable(SHEET_MAP[currentTab]);
      }
    }

    // ============================================================
    // é€±ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    // ============================================================
    function loadWeekView() {
      setStatus('loading', 'é€±ãƒ“ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(renderWeekView)
        .withFailureHandler(function(e) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getWeekViewData();
    }

    function renderWeekView(data) {
      document.getElementById('refreshBtn').disabled = false;

      if (!data.headerRow || data.headerRow.length === 0) {
        setStatus('error', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      setStatus('success', 'é€±ãƒ“ãƒ¥ãƒ¼ï¼ˆ' + data.rowCount + 'åï¼‰');

      var html = '<div class="table-container"><table class="week-table">';

      // ãƒ˜ãƒƒãƒ€ãƒ¼
      html += '<thead><tr>';
      data.headerRow.forEach(function(h) {
        html += '<th>' + escapeHtml(h) + '</th>';
      });
      html += '</tr></thead>';

      // ãƒœãƒ‡ã‚£
      html += '<tbody>';
      data.bodyRows.forEach(function(row) {
        html += '<tr>';
        row.forEach(function(cell, idx) {
          var content = cell ? '<div class="cell-content">' + escapeHtml(cell) + '</div>' : '-';
          html += '<td>' + content + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';

      document.getElementById('mainContent').innerHTML = html;
    }

    // ============================================================
    // æ±ç”¨ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    // ============================================================
    function loadSheetTable(sheetName) {
      setStatus('loading', sheetName + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...');
      document.getElementById('refreshBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(data) { renderSheetTable(data); })
        .withFailureHandler(function(e) {
          setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + e.message);
          document.getElementById('refreshBtn').disabled = false;
        })
        .getSheetTableData(sheetName, 500);
    }

    function renderSheetTable(data) {
      document.getElementById('refreshBtn').disabled = false;

      if (data.error) {
        setStatus('error', data.error);
        return;
      }

      if (!data.header || data.header.length === 0) {
        setStatus('error', 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        document.getElementById('mainContent').innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      setStatus('success', (data.sheetName || '') + 'ï¼ˆ' + data.rowCount + 'è¡Œï¼‰');

      var html = '<div class="table-container"><table class="sheet-table">';

      html += '<thead><tr>';
      data.header.forEach(function(h) {
        html += '<th>' + escapeHtml(h) + '</th>';
      });
      html += '</tr></thead>';

      html += '<tbody>';
      data.rows.forEach(function(row) {
        html += '<tr>';
        row.forEach(function(cell) {
          html += '<td>' + escapeHtml(cell || '') + '</td>';
        });
        html += '</tr>';
      });
      html += '</tbody></table></div>';

      document.getElementById('mainContent').innerHTML = html;
    }

    // ============================================================
    // GASå®Ÿè¡Œ
    // ============================================================
    function runJob(jobKey, btn) {
      btn.classList.add('loading');
      btn.disabled = true;

      var allBtns = document.querySelectorAll('.action-btn');
      allBtns.forEach(function(b) { b.disabled = true; });

      google.script.run
        .withSuccessHandler(function(result) {
          btn.classList.remove('loading');
          allBtns.forEach(function(b) { b.disabled = false; });

          if (result.ok) {
            showToast(result.message, 'success');
            if (jobKey === 'updateWeekView' || jobKey === 'assignResult') {
              loadWeekView();
            }
          } else {
            showToast('ã‚¨ãƒ©ãƒ¼: ' + result.message, 'error');
          }
          loadLogs();
        })
        .withFailureHandler(function(e) {
          btn.classList.remove('loading');
          allBtns.forEach(function(b) { b.disabled = false; });
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
          loadLogs();
        })
        .runJob(jobKey);
    }

    // ============================================================
    // å®Ÿè¡Œãƒ­ã‚°
    // ============================================================
    function loadLogs() {
      google.script.run
        .withSuccessHandler(renderLogs)
        .withFailureHandler(function() {
          document.getElementById('logList').innerHTML = '<div style="color:#E88B8B;">ãƒ­ã‚°å–å¾—å¤±æ•—</div>';
        })
        .getExecutionLogs(5);
    }

    function renderLogs(data) {
      if (!data.success || !data.logs || data.logs.length === 0) {
        document.getElementById('logList').innerHTML = '<div style="color:#888;font-style:italic;">ãƒ­ã‚°ãªã—</div>';
        return;
      }

      var html = data.logs.map(function(log) {
        var time = formatTime(log.timestamp);
        var cls = log.success ? '' : ' error';
        return '<div class="log-item' + cls + '">' +
          '<div style="display:flex;justify-content:space-between;margin-bottom:3px;">' +
          '<span style="font-weight:600;">' + escapeHtml(log.action) + '</span>' +
          '<span style="color:#666;">' + time + '</span></div>' +
          '<div style="color:#666;">' + escapeHtml(log.message || '') + '</div></div>';
      }).join('');

      document.getElementById('logList').innerHTML = html;
    }

    // ============================================================
    // ç”»é¢é·ç§»
    // ============================================================
    function goToInput() {
      var targetUrl;
      if (baseUrl) {
        targetUrl = baseUrl + '?page=input';
      } else {
        var currentUrl = window.location.href;
        targetUrl = currentUrl.split('?')[0] + '?page=input';
      }
      // GASã¯iframeå†…ã§å‹•ããŸã‚ã€window.topã‚’ä½¿ç”¨
      try {
        window.top.location.href = targetUrl;
      } catch (e) {
        window.location.href = targetUrl;
      }
    }

    // ============================================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================================
    function setStatus(type, msg) {
      var el = document.getElementById('statusText');
      el.className = 'status-text ' + type;
      el.textContent = msg;
    }

    function showToast(msg, type) {
      var toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast ' + type + ' show';
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        var d = new Date(ts);
        return d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      } catch (e) { return '-'; }
    }

    function escapeHtml(s) {
      var div = document.createElement('div');
      div.textContent = s || '';
      return div.innerHTML;
    }

    // ============================================================
    // ç›£æŸ»ï¼ˆåˆå¦åˆ¤å®šï¼‰ãƒ“ãƒ¥ãƒ¼
    // ============================================================
    var isAuditMode = false;
    var auditLoading = false; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ãƒ¼ãƒ‰ï¼ˆå¤šé‡å‘¼ã³å‡ºã—é˜²æ­¢ï¼‰
    var auditState = {
      weekStartStr: null,
      data: null,
      selectedCell: null,
      filter: 'all'
    };

    function showAuditView() {
      // æ—¢ã«ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºã®ã¿
      if (isAuditMode && auditState.data) {
        console.log('showAuditView: æ—¢ã«ç›£æŸ»ãƒ¢ãƒ¼ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š');
        return;
      }

      // ã‚¿ãƒ–ã®é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
      document.querySelectorAll('.tabs-left .tab-btn').forEach(function(b) { b.classList.remove('active'); });

      // ãƒŠãƒ“ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      var navBtn = document.getElementById('auditNavBtn');
      if (navBtn) navBtn.classList.add('active');

      // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      isAuditMode = true;
      currentTab = 'audit';

      // ã‚¨ãƒªã‚¢è¡¨ç¤ºåˆ‡æ›¿
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('auditArea').style.display = 'flex';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼æ›´æ–°
      setStatus('', 'ç›£æŸ»ãƒ“ãƒ¥ãƒ¼');

      // é€±é–‹å§‹æ—¥ã‚’åˆæœŸåŒ–ï¼ˆä»Šé€±ã®æœˆæ›œï¼‰- åˆå›ã®ã¿
      var dateInput = document.getElementById('auditWeekStart');
      if (!dateInput.value) {
        var today = new Date();
        var day = today.getDay();
        var diff = (day === 0) ? -6 : 1 - day;
        var monday = new Date(today);
        monday.setDate(today.getDate() + diff);
        dateInput.value = formatDateISO(monday);
      }

      // ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      auditRetryCount = 0;

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
      loadAuditData();
    }

    function formatDateISO(d) {
      var y = d.getFullYear();
      var m = ('0' + (d.getMonth() + 1)).slice(-2);
      var dd = ('0' + d.getDate()).slice(-2);
      return y + '-' + m + '-' + dd;
    }

    function formatDateSlash(d) {
      var y = d.getFullYear();
      var m = ('0' + (d.getMonth() + 1)).slice(-2);
      var dd = ('0' + d.getDate()).slice(-2);
      return y + '/' + m + '/' + dd;
    }

    var auditRetryCount = 0;
    var AUDIT_MAX_RETRY = 3;

    function loadAuditData() {
      // å¤šé‡å‘¼ã³å‡ºã—é˜²æ­¢
      if (auditLoading) {
        console.log('loadAuditData: æ—¢ã«ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      var dateInput = document.getElementById('auditWeekStart');
      var dateVal = dateInput.value;
      if (!dateVal) {
        console.warn('loadAuditData: æ—¥ä»˜ãŒæœªè¨­å®š');
        return;
      }

      var parts = dateVal.split('-');
      var weekStartStr = parts[0] + '/' + parts[1] + '/' + parts[2];
      auditState.weekStartStr = weekStartStr;

      auditLoading = true; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
      console.log('loadAuditData: é–‹å§‹', weekStartStr, '(ãƒªãƒˆãƒ©ã‚¤:', auditRetryCount, ')');
      setStatus('loading', 'ç›£æŸ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...' + (auditRetryCount > 0 ? ' (ãƒªãƒˆãƒ©ã‚¤ ' + auditRetryCount + ')' : ''));

      google.script.run
        .withSuccessHandler(function(result) {
          auditLoading = false; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
          console.log('loadAuditData: GASå¿œç­”å—ä¿¡', result ? 'OK' : 'null');
          try {
            if (!result) {
              // nullå¿œç­”æ™‚ã¯ãƒªãƒˆãƒ©ã‚¤
              if (auditRetryCount < AUDIT_MAX_RETRY) {
                auditRetryCount++;
                console.log('loadAuditData: nullå¿œç­”ã€ãƒªãƒˆãƒ©ã‚¤', auditRetryCount);
                setTimeout(function() {
                  loadAuditData();
                }, 800 * auditRetryCount); // ãƒªãƒˆãƒ©ã‚¤é–“éš”ã‚’å¢—ã‚„ã™
                return;
              }
              auditRetryCount = 0;
              setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç©ºã®å¿œç­”ï¼ˆãƒªãƒˆãƒ©ã‚¤ä¸Šé™ï¼‰');
              return;
            }
            auditRetryCount = 0; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
            if (result.error) {
              setStatus('error', 'ã‚¨ãƒ©ãƒ¼: ' + result.error);
              return;
            }
            auditState.data = result;
            renderAuditWeekView(result);
            renderAuditSummary(result);
            renderAuditWarnings(result);
            renderAuditCacheStatus(result);
            setStatus('success', 'ç›£æŸ»ãƒ“ãƒ¥ãƒ¼: ' + weekStartStr + ' ã€œ ' + (result.weekEndStr || ''));
            console.log('loadAuditData: æç”»å®Œäº†');
          } catch (renderErr) {
            auditRetryCount = 0;
            console.error('loadAuditData: æç”»ã‚¨ãƒ©ãƒ¼', renderErr);
            setStatus('error', 'æç”»ã‚¨ãƒ©ãƒ¼: ' + (renderErr.message || String(renderErr)));
          }
        })
        .withFailureHandler(function(e) {
          auditLoading = false; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
          auditRetryCount = 0;
          console.error('loadAuditData: GASã‚¨ãƒ©ãƒ¼', e);
          setStatus('error', 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)));
        })
        .audit_getWeekSummary(weekStartStr);
    }

    function refreshAuditData() {
      // å¤šé‡å‘¼ã³å‡ºã—é˜²æ­¢
      if (auditLoading) {
        console.log('refreshAuditData: æ—¢ã«ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }

      if (!auditState.weekStartStr) {
        loadAuditData();
        return;
      }

      auditLoading = true;
      setStatus('loading', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ï¼†å†èª­è¾¼ä¸­...');
      console.log('refreshAuditData: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢é–‹å§‹', auditState.weekStartStr);

      google.script.run
        .withSuccessHandler(function() {
          console.log('refreshAuditData: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†ã€ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹');
          auditLoading = false; // loadAuditDataã§å†è¨­å®šã•ã‚Œã‚‹
          loadAuditData();
        })
        .withFailureHandler(function(e) {
          console.warn('refreshAuditData: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¤±æ•—ã€ãƒ‡ãƒ¼ã‚¿å–å¾—è©¦è¡Œ', e);
          auditLoading = false;
          loadAuditData();
        })
        .audit_clearCache(auditState.weekStartStr);
    }

    function setAuditFilter(filter) {
      auditState.filter = filter;
      document.querySelectorAll('.audit-filter-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      if (auditState.data) renderAuditWeekView(auditState.data);
    }

    function renderAuditSummary(data) {
      var summaryEl = document.getElementById('auditSummary');
      if (!summaryEl) return;
      var patientSummary = data.patientSummary || {};
      var totalOk = 0, totalWarn = 0, totalNg = 0, totalPatients = 0;
      for (var pid in patientSummary) {
        var ps = patientSummary[pid];
        totalOk += ps.okCount || 0;
        totalWarn += ps.warnCount || 0;
        totalNg += ps.ngCount || 0;
        totalPatients++;
      }
      var html = '';
      html += '<div class="stat"><span class="stat-label">æ‚£è€…:</span><span class="stat-value">' + totalPatients + 'å</span></div>';
      html += '<div class="stat"><span class="stat-value ok">â—‹' + totalOk + '</span></div>';
      html += '<div class="stat"><span class="stat-value warn">â–³' + totalWarn + '</span></div>';
      html += '<div class="stat"><span class="stat-value ng">Ã—' + totalNg + '</span></div>';
      summaryEl.innerHTML = html;
    }

    function renderAuditWarnings(data) {
      var warningsEl = document.getElementById('auditWarnings');
      if (!warningsEl) return;
      var warnings = data.warnings || [];
      if (warnings.length === 0) { warningsEl.style.display = 'none'; return; }
      var html = '<div class="audit-warnings-title">âš  è­¦å‘Š</div><div class="audit-warnings-list">';
      warnings.forEach(function(w) { html += '<div>â€¢ ' + w.source + ': ' + w.message + '</div>'; });
      html += '</div>';
      warningsEl.innerHTML = html;
      warningsEl.style.display = 'block';
    }

    function renderAuditCacheStatus(data) {
      var statusEl = document.getElementById('auditCacheStatus');
      if (!statusEl) return;
      if (data.fromCache) {
        statusEl.textContent = '(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­è¾¼)';
        statusEl.className = 'audit-cache-status from-cache';
      } else {
        statusEl.textContent = '';
        statusEl.className = 'audit-cache-status';
      }
    }

    function renderAuditWeekView(data) {
      var table = document.getElementById('auditWeekTable');
      var thead = table.querySelector('thead');
      var tbody = table.querySelector('tbody');

      var weekDates = data.weekDates || [];
      var youbiLabels = { 'Mon': 'æœˆ', 'Tue': 'ç«', 'Wed': 'æ°´', 'Thu': 'æœ¨', 'Fri': 'é‡‘', 'Sat': 'åœŸ', 'Sun': 'æ—¥' };
      var headerHtml = '<tr><th>ã‚¹ã‚¿ãƒƒãƒ•</th>';
      weekDates.forEach(function(wd) {
        var label = youbiLabels[wd.youbi] || wd.youbi;
        var dateLabel = wd.dateStr.substring(5);
        headerHtml += '<th>' + label + '<br><small>' + dateLabel + '</small></th>';
      });
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;

      var staffList = data.staffList || [];
      var cellSummary = data.cellSummary || {};
      var bodyHtml = '';

      staffList.forEach(function(staff) {
        bodyHtml += '<tr>';
        bodyHtml += '<td>' + staff.name + '<br><small>' + staff.staffId + '</small></td>';
        weekDates.forEach(function(wd) {
          var sdKey = staff.staffId + '|' + wd.dateStr;
          var items = cellSummary[sdKey] || [];
          var okCount = 0, warnCount = 0, ngCount = 0;
          items.forEach(function(item) {
            if (item.status === 'OK') okCount++;
            else if (item.status === 'WARN') warnCount++;
            else if (item.status === 'NG') ngCount++;
          });
          var cellContent = '';
          if (items.length > 0) {
            cellContent = '<div class="audit-cell-summary">';
            if (okCount > 0) cellContent += '<span class="ok">â—‹' + okCount + '</span>';
            if (warnCount > 0) cellContent += '<span class="warn">â–³' + warnCount + '</span>';
            if (ngCount > 0) cellContent += '<span class="ng">Ã—' + ngCount + '</span>';
            cellContent += '</div>';
          } else {
            cellContent = '<span style="color:#ccc;">-</span>';
          }
          bodyHtml += '<td onclick="showAuditCellDetail(\'' + staff.staffId + '\', \'' + wd.dateStr + '\')">' + cellContent + '</td>';
        });
        bodyHtml += '</tr>';
      });

      // æœªå‰²å½“è¡Œ
      bodyHtml += '<tr><td style="color:var(--color-error);">æœªå‰²å½“</td>';
      weekDates.forEach(function(wd) {
        var sdKey = '_UNASSIGNED_|' + wd.dateStr;
        var items = cellSummary[sdKey] || [];
        var cellContent = items.length > 0
          ? '<div class="audit-cell-summary"><span class="ng">Ã—' + items.length + '</span></div>'
          : '<span style="color:#ccc;">-</span>';
        bodyHtml += '<td onclick="showAuditCellDetail(\'_UNASSIGNED_\', \'' + wd.dateStr + '\')">' + cellContent + '</td>';
      });
      bodyHtml += '</tr>';
      tbody.innerHTML = bodyHtml;
    }

    function showAuditCellDetail(staffId, dateStr) {
      auditState.selectedCell = { staffId: staffId, dateStr: dateStr };
      var panel = document.getElementById('auditDetailPanel');
      var content = document.getElementById('auditDetailContent');
      var title = document.getElementById('auditDetailTitle');

      var staffName = staffId;
      if (auditState.data && auditState.data.staffList) {
        var found = auditState.data.staffList.find(function(s) { return s.staffId === staffId; });
        if (found) staffName = found.name;
      }
      if (staffId === '_UNASSIGNED_') staffName = 'æœªå‰²å½“';
      title.textContent = staffName + ' - ' + dateStr.substring(5);
      content.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      panel.style.display = 'flex';

      console.log('showAuditCellDetail: é–‹å§‹', staffId, dateStr);
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('showAuditCellDetail: å¿œç­”å—ä¿¡');
          try {
            renderAuditCellDetail(data);
          } catch (e) {
            console.error('showAuditCellDetail: æç”»ã‚¨ãƒ©ãƒ¼', e);
            content.innerHTML = '<div style="color:var(--color-error);">æç”»ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)) + '</div>';
          }
        })
        .withFailureHandler(function(e) {
          console.error('showAuditCellDetail: GASã‚¨ãƒ©ãƒ¼', e);
          content.innerHTML = '<div style="color:var(--color-error);">ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)) + '</div>';
        })
        .audit_getCellDetail(staffId, dateStr, auditState.weekStartStr);
    }

    function renderAuditCellDetail(data) {
      var content = document.getElementById('auditDetailContent');
      var items = data.items || [];
      var filteredItems = items.filter(function(item) {
        if (auditState.filter === 'all') return true;
        if (auditState.filter === 'issues') return item.status === 'NG' || item.status === 'WARN';
        if (auditState.filter === 'ng') return item.status === 'NG';
        return true;
      });
      if (filteredItems.length === 0) {
        var msg = items.length > 0
          ? 'ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¨ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆå…¨' + items.length + 'ä»¶ï¼‰'
          : 'ã“ã®æ—¥ã®è¨ªå•ã¯ã‚ã‚Šã¾ã›ã‚“';
        content.innerHTML = '<div style="text-align:center;color:#999;">' + msg + '</div>';
        return;
      }
      var html = '';
      if (items.length !== filteredItems.length) {
        html += '<div style="font-size:11px;color:#666;margin-bottom:8px;text-align:right;">è¡¨ç¤º: ' + filteredItems.length + '/' + items.length + 'ä»¶</div>';
      }
      filteredItems.forEach(function(item) {
        var statusClass = item.status.toLowerCase();
        var statusIcon = item.status === 'OK' ? 'â—‹' : (item.status === 'WARN' ? 'â–³' : 'Ã—');
        html += '<div class="audit-patient-item" onclick="showAuditPatientDetail(\'' + item.pid + '\')">';
        html += '<span class="status ' + statusClass + '">' + statusIcon + '</span>';
        html += '<span class="name">' + (item.pname || item.pid) + '</span>';
        html += '<span style="font-size:11px;color:#666;">' + (item.startStr || '') + '-' + (item.endStr || '') + '</span>';
        html += '</div>';
        if (item.tags && item.tags.length > 0) {
          html += '<div style="margin:-4px 0 8px 28px;"><span class="tags">';
          item.tags.forEach(function(tag) {
            var tagClass = '';
            if (tag.indexOf('CONFLICT') >= 0 || tag.indexOf('UNASSIGNED') >= 0 || tag.indexOf('CANCELLED_BUT') >= 0 || tag.indexOf('OUT_OF') >= 0) tagClass = 'ng';
            else if (tag.indexOf('DIFF') >= 0 || tag.indexOf('MISSING') >= 0 || tag.indexOf('EXTRA') >= 0) tagClass = 'warn';
            else tagClass = 'ok';
            html += '<span class="audit-tag ' + tagClass + '">' + tag + '</span> ';
          });
          html += '</span></div>';
        }
      });
      content.innerHTML = html;
    }

    function closeAuditDetail() {
      document.getElementById('auditDetailPanel').style.display = 'none';
      auditState.selectedCell = null;
    }

    function showAuditPatientDetail(pid) {
      var modal = document.getElementById('auditPatientModal');
      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'æ‚£è€…è©³ç´°: ' + pid;
      body.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      modal.style.display = 'flex';

      console.log('showAuditPatientDetail: é–‹å§‹', pid);
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('showAuditPatientDetail: å¿œç­”å—ä¿¡');
          try {
            renderAuditPatientDetail(data);
          } catch (e) {
            console.error('showAuditPatientDetail: æç”»ã‚¨ãƒ©ãƒ¼', e);
            body.innerHTML = '<div style="color:var(--color-error);padding:20px;">æç”»ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)) + '</div>';
          }
        })
        .withFailureHandler(function(e) {
          console.error('showAuditPatientDetail: GASã‚¨ãƒ©ãƒ¼', e);
          body.innerHTML = '<div style="color:var(--color-error);padding:20px;">ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ' + (e.message || String(e)) + '</div>';
        })
        .audit_getPatientDetail(pid, auditState.weekStartStr);
    }

    // æ‚£è€…è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    var currentPatientDetailData = null;

    function renderAuditPatientDetail(data) {
      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
      currentPatientDetailData = data;
      // é€±é–“æ¦‚è¦ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
      renderAuditWeekOverview(data);
    }

    // æ›œæ—¥ã®æ—¥æœ¬èªè¡¨ç¤ºãƒãƒƒãƒ—
    var youbiJapanese = {
      'Mon': 'æœˆ', 'Tue': 'ç«', 'Wed': 'æ°´', 'Thu': 'æœ¨', 'Fri': 'é‡‘', 'Sat': 'åœŸ', 'Sun': 'æ—¥'
    };

    // é€±é–“æ¦‚è¦ãƒ“ãƒ¥ãƒ¼ã‚’æç”»
    function renderAuditWeekOverview(data) {
      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'æ‚£è€…è©³ç´°: ' + (data.pname || data.pid);

      var html = '';

      // æ‚£è€…ãƒã‚¹ã‚¿æƒ…å ±ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªã‚µãƒãƒªï¼‰
      if (data.master) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">åŸºæœ¬æƒ…å ±ï¼ˆãƒã‚¹ã‚¿ï¼‰</summary>';
        html += '<div class="audit-info-grid">';
        html += '<div class="audit-info-item"><span class="label">æ™‚é–“ã‚¿ã‚¤ãƒ—:</span> <span class="value">' + (data.master.timeType || '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">å¸Œæœ›æ›œæ—¥:</span> <span class="value">' + (data.master.prefDays && data.master.prefDays.length > 0 ? data.master.prefDays.join(',') : '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">æ›œæ—¥NG:</span> <span class="value">' + (data.master.ngDays && data.master.ngDays.length > 0 ? data.master.ngDays.join(',') : '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">å¸Œæœ›æ™‚é–“:</span> <span class="value">' + (data.master.startPrefStr || '-') + ' - ' + (data.master.endPrefStr || '-') + '</span></div>';
        html += '<div class="audit-info-item"><span class="label">ã‚µãƒ¼ãƒ“ã‚¹:</span> <span class="value">' + (data.master.svcMin || '-') + 'åˆ†</span></div>';
        if (data.master.sexLimit && data.master.sexLimit !== '-') {
          html += '<div class="audit-info-item"><span class="label">æ€§åˆ¥åˆ¶é™:</span> <span class="value severity-critical">' + data.master.sexLimit + '</span></div>';
        }
        if (data.master.fixedStaff) {
          html += '<div class="audit-info-item"><span class="label">æŒ‡å®šã‚¹ã‚¿ãƒƒãƒ•:</span> <span class="value">' + data.master.fixedStaff + ' (' + (data.master.fixedType || 'å¸Œæœ›') + ')</span></div>';
        }
        if (data.master.ngStaff) {
          html += '<div class="audit-info-item"><span class="label">NGã‚¹ã‚¿ãƒƒãƒ•:</span> <span class="value severity-critical">' + data.master.ngStaff + '</span></div>';
        }
        html += '</div></details>';
      }

      // é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
      html += '<div class="audit-week-overview">';
      html += '<div class="audit-week-header">';
      html += '<div class="audit-week-title">é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>';
      html += '<div class="audit-week-legend">';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot ok"></span>OK</div>';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot warn"></span>WARN</div>';
      html += '<div class="audit-week-legend-item"><span class="audit-week-legend-dot ng"></span>NG</div>';
      html += '</div>';
      html += '</div>';

      html += '<div class="audit-week-calendar">';

      // æ›œæ—¥é †ã«ä¸¦ã¹ã‚‹ï¼ˆæœˆã€œæ—¥ï¼‰
      var dayOrder = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      var djByYoubi = {};
      (data.dayJudgements || []).forEach(function(dj) {
        djByYoubi[dj.youbi] = dj;
      });

      dayOrder.forEach(function(youbi) {
        var dj = djByYoubi[youbi];
        if (dj) {
          // è¨ªå•ãŒã‚ã‚‹æ—¥
          var statusClass = dj.status.toLowerCase();
          var statusIcon = dj.status === 'OK' ? 'â—‹' : (dj.status === 'WARN' ? 'â–³' : 'Ã—');
          var isClickable = dj.status === 'NG' || dj.status === 'WARN';

          html += '<div class="audit-week-day status-' + statusClass + '"';
          if (isClickable) {
            html += ' onclick="showAuditDayDetail(\'' + dj.dateStr + '\')"';
          }
          html += '>';
          html += '<div class="audit-week-day-date">' + dj.dateStr.substring(5) + '</div>';
          html += '<div class="audit-week-day-youbi">' + youbiJapanese[youbi] + '</div>';
          html += '<div class="audit-week-day-status ' + statusClass + '">' + statusIcon + '</div>';

          // è¨ªå•æ™‚é–“ã‚’è¡¨ç¤º
          if (dj.hasActual && dj.actuals && dj.actuals.length > 0) {
            dj.actuals.forEach(function(a) {
              html += '<div class="audit-week-day-time">' + a.startStr + '-' + a.endStr + '</div>';
              if (a.staffName) {
                html += '<div class="audit-week-day-staff">' + a.staffName + '</div>';
              }
            });
          } else if (dj.hasExpected && dj.expectedVisits && dj.expectedVisits.length > 0) {
            // æœŸå¾…ã¯ã‚ã‚‹ãŒå®Ÿç¸¾ãªã—
            dj.expectedVisits.forEach(function(exp) {
              if (!exp.isCancelled) {
                if (exp.timeType === 'å›ºå®š') {
                  html += '<div class="audit-week-day-time">' + (exp.startStr || '-') + '-' + (exp.endStr || '-') + '</div>';
                } else {
                  html += '<div class="audit-week-day-time">' + (exp.earliestStr || '-') + 'ã€œ' + (exp.latestStr || '-') + '</div>';
                }
              }
            });
          }

          // ã‚¯ãƒªãƒƒã‚¯ãƒ’ãƒ³ãƒˆ
          if (isClickable) {
            var violationInfo = '';
            if (dj.conditionAnalysis && dj.conditionAnalysis.violationCount > 0) {
              violationInfo = 'NG:' + dj.conditionAnalysis.ngCount + ' WARN:' + dj.conditionAnalysis.warnCount;
            }
            html += '<div class="audit-week-day-click-hint">' + (violationInfo || 'ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°') + '</div>';
          }

          html += '</div>';
        } else {
          // è¨ªå•ãŒãªã„æ—¥
          html += '<div class="audit-week-day no-visit">';
          html += '<div class="audit-week-day-date">-</div>';
          html += '<div class="audit-week-day-youbi">' + youbiJapanese[youbi] + '</div>';
          html += '<div class="audit-week-day-novisit">è¨ªå•ãªã—</div>';
          html += '</div>';
        }
      });

      html += '</div></div>';

      // å€‹åˆ¥å¤‰æ›´ã‚µãƒãƒªï¼ˆé€±å…¨ä½“ï¼‰
      if (data.changes && data.changes.length > 0) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">å€‹åˆ¥å¤‰æ›´ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (' + data.changes.length + 'ä»¶)</summary>';
        data.changes.forEach(function(ch) {
          html += '<div class="audit-change-item">';
          html += '<strong>' + ch.dateStr + '</strong> <span class="audit-op-badge op-' + ch.op + '">' + ch.op + '</span>';
          if (ch.newStartStr || ch.newEndStr) html += ' (' + (ch.newStartStr || '') + '-' + (ch.newEndStr || '') + ')';
          if (ch.note) html += ' <span class="audit-note">' + ch.note + '</span>';
          html += '</div>';
        });
        html += '</details>';
      }

      // ç‰¹åˆ¥è¨ªå•é€±é–“ã‚µãƒãƒª
      if (data.specialWeek) {
        html += '<details class="audit-section audit-collapsible">';
        html += '<summary class="audit-section-title clickable">ç‰¹åˆ¥è¨ªå•é€±é–“ (' + data.specialWeek.modes.join('/') + ')</summary>';
        data.specialWeek.details.forEach(function(sp) {
          html += '<div class="audit-special-item">';
          html += '<strong>' + sp.dateStr + '</strong> ';
          html += '<span class="audit-mode-badge mode-' + sp.mode + '">' + sp.mode + '</span> ';
          html += sp.rowLabel + ' [' + sp.timeType + '] ';
          if (sp.startStr || sp.endStr) html += sp.startStr + '-' + sp.endStr;
          else if (sp.earliestStr || sp.latestStr) html += sp.earliestStr + 'ã€œ' + sp.latestStr;
          html += '</div>';
        });
        html += '</details>';
      }

      body.innerHTML = html;
    }

    // æ—¥åˆ¥è©³ç´°ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    function showAuditDayDetail(dateStr) {
      if (!currentPatientDetailData) return;

      var dj = null;
      (currentPatientDetailData.dayJudgements || []).forEach(function(d) {
        if (d.dateStr === dateStr) dj = d;
      });
      if (!dj) return;

      var body = document.getElementById('auditModalBody');
      var title = document.getElementById('auditModalTitle');
      title.textContent = 'æ‚£è€…è©³ç´°: ' + (currentPatientDetailData.pname || currentPatientDetailData.pid) + ' - ' + dateStr;

      var html = '';
      var statusClass = dj.status.toLowerCase();
      var statusIcon = dj.status === 'OK' ? 'â—‹' : (dj.status === 'WARN' ? 'â–³' : 'Ã—');

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³
      html += '<button class="audit-back-btn" onclick="renderAuditWeekOverview(currentPatientDetailData)">';
      html += 'â† é€±é–“æ¦‚è¦ã«æˆ»ã‚‹';
      html += '</button>';

      // æ—¥ä»˜ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼
      html += '<div class="audit-day-detail-view">';
      html += '<div class="audit-day-detail-header status-' + statusClass + '">';
      html += '<span class="audit-day-detail-date">' + dj.dateStr + ' (' + youbiJapanese[dj.youbi] + ')</span>';
      html += '<span class="audit-day-detail-status ' + statusClass + '">' + statusIcon + ' ' + dj.status + '</span>';
      html += '</div>';

      // === æ¡ä»¶é•åã‚µãƒãƒªï¼ˆNGã¨WARNã®ã¿å¼·èª¿è¡¨ç¤ºï¼‰ ===
      if (dj.conditionAnalysis && dj.conditionAnalysis.violations && dj.conditionAnalysis.violations.length > 0) {
        html += '<div class="audit-violations-section">';
        html += '<div class="audit-subsection-title violations-title">æ¡ä»¶é•å</div>';
        dj.conditionAnalysis.violations.forEach(function(v) {
          var vClass = v.status === 'NG' ? 'violation-ng' : 'violation-warn';
          var vIcon = v.status === 'NG' ? 'âœ—' : '!';
          html += '<div class="audit-violation-item ' + vClass + '">';
          html += '<span class="violation-icon">' + vIcon + '</span>';
          html += '<span class="violation-label">' + v.label + '</span>';
          html += '<span class="violation-severity">[' + (v.severity === 'CRITICAL' ? 'å¿…é ˆæ¡ä»¶' : 'æ¨å¥¨æ¡ä»¶') + ']</span>';
          if (v.diffDetail) html += '<div class="violation-detail">' + v.diffDetail + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }

      // === ã“ã®æ—¥ã®æ¡ä»¶ ===
      if (dj.conditionAnalysis && dj.conditionAnalysis.conditions && dj.conditionAnalysis.conditions.length > 0) {
        html += '<details class="audit-conditions-section" open>';
        html += '<summary class="audit-subsection-title clickable">ã“ã®æ—¥ã®æ¡ä»¶</summary>';
        html += '<div class="audit-conditions-grid">';

        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        var categories = {};
        dj.conditionAnalysis.conditions.forEach(function(cond) {
          if (!categories[cond.category]) categories[cond.category] = [];
          categories[cond.category].push(cond);
        });

        var categoryLabels = {
          'TIME': 'æ™‚é–“æ¡ä»¶',
          'DAY': 'æ›œæ—¥æ¡ä»¶',
          'STAFF': 'ã‚¹ã‚¿ãƒƒãƒ•æ¡ä»¶',
          'EVENT': 'ã‚¤ãƒ™ãƒ³ãƒˆ',
          'CHANGE': 'å€‹åˆ¥å¤‰æ›´',
          'SPECIAL': 'ç‰¹åˆ¥è¨ªå•é€±é–“'
        };

        var categoryIcons = {
          'TIME': 'â°',
          'DAY': 'ğŸ“…',
          'STAFF': 'ğŸ‘¤',
          'EVENT': 'ğŸ“Œ',
          'CHANGE': 'âœï¸',
          'SPECIAL': 'ğŸ—“ï¸'
        };

        for (var cat in categories) {
          html += '<div class="audit-condition-category">';
          html += '<div class="category-header">' + (categoryIcons[cat] || '') + ' ' + (categoryLabels[cat] || cat) + '</div>';
          categories[cat].forEach(function(cond) {
            var severityClass = 'severity-' + cond.severity.toLowerCase();
            var condStatusIcon = '';
            if (cond.status === 'NG') condStatusIcon = '<span class="cond-status-icon ng">âœ—</span>';
            else if (cond.status === 'WARN') condStatusIcon = '<span class="cond-status-icon warn">!</span>';
            else if (cond.status === 'OK') condStatusIcon = '<span class="cond-status-icon ok">âœ“</span>';

            html += '<div class="audit-condition-item ' + severityClass + ' status-' + (cond.status || 'unknown').toLowerCase() + '">';
            html += condStatusIcon;
            html += '<span class="cond-label">' + cond.label + '</span>';
            html += '<span class="cond-severity-badge ' + severityClass + '">' + (cond.severity === 'CRITICAL' ? 'å¿…é ˆ' : (cond.severity === 'WARNING' ? 'æ¨å¥¨' : 'æƒ…å ±')) + '</span>';
            html += '<div class="cond-detail">';
            html += '<span class="cond-expected">æœŸå¾…: ' + (cond.expected || '-') + '</span>';
            if (cond.actual) html += ' â†’ <span class="cond-actual">å®Ÿç¸¾: ' + cond.actual + '</span>';
            html += '</div>';
            if (cond.diffDetail) {
              html += '<div class="cond-diff-detail ' + (cond.status === 'NG' ? 'diff-ng' : 'diff-warn') + '">' + cond.diffDetail + '</div>';
            }
            html += '</div>';
          });
          html += '</div>';
        }
        html += '</div></details>';
      }

      // === æœŸå¾…ã¨å®Ÿç¸¾ã®æ¯”è¼ƒ ===
      html += '<details class="audit-compare-details" open>';
      html += '<summary class="audit-subsection-title clickable">æœŸå¾… vs å®Ÿç¸¾</summary>';

      // Expected
      html += '<div class="audit-compare-section"><div class="audit-compare-label">æœŸå¾… (Expected):</div>';
      if (dj.hasExpected) {
        dj.expectedVisits.forEach(function(exp) {
          var sourceLabel = exp.source;
          if (exp.op) sourceLabel += '/' + exp.op;
          var sourceClass = exp.source === 'MASTER' ? 'source-master' : (exp.source.indexOf('SPECIAL') >= 0 ? 'source-special' : 'source-change');
          html += '<div class="audit-expected-item">';
          html += '<span class="audit-source-badge ' + sourceClass + '">' + sourceLabel + '</span> ';
          html += '<span class="audit-time-type">[' + (exp.timeType || 'æ™‚é–“å¸¯') + ']</span> ';
          if (exp.timeType === 'å›ºå®š') {
            html += '<span>' + (exp.startStr || '-') + '-' + (exp.endStr || '-') + '</span>';
          } else {
            html += '<span>' + (exp.earliestStr || '-') + 'ã€œ' + (exp.latestStr || '-') + '</span>';
          }
          if (exp.isCancelled) html += ' <span class="audit-cancelled-badge">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
          html += '</div>';
        });
      } else {
        html += '<div style="color:#999;font-size:12px;">æœŸå¾…ãªã—</div>';
      }
      html += '</div>';

      // Actual
      html += '<div class="audit-compare-section"><div class="audit-compare-label">å®Ÿç¸¾ (Actual):</div>';
      if (dj.hasActual) {
        dj.actuals.forEach(function(a) {
          html += '<div class="audit-actual-item">';
          html += '<span>' + a.startStr + '-' + a.endStr + '</span>';
          if (a.staffName) html += ' <span class="audit-staff-name">(' + a.staffName + ')</span>';
          if (a.isUnassigned) html += ' <span class="audit-unassigned-badge">[æœªå‰²å½“]</span>';
          html += '</div>';
        });
      } else {
        html += '<div style="color:#999;font-size:12px;">å®Ÿç¸¾ãªã—</div>';
      }
      html += '</div>';
      html += '</details>';

      // ãƒã‚§ãƒƒã‚¯è©³ç´°ï¼ˆå¾“æ¥ã®ã‚‚ã®ã€æŠ˜ã‚ŠãŸãŸã¿ï¼‰
      if (dj.checks && dj.checks.length > 0) {
        html += '<details class="audit-checks-details">';
        html += '<summary class="audit-subsection-title clickable">åˆ¤å®šè©³ç´°ï¼ˆæŠ€è¡“æƒ…å ±ï¼‰</summary>';
        dj.checks.forEach(function(check) {
          var checkClass = check.status === 'NG' ? 'check-ng' : (check.status === 'WARN' ? 'check-warn' : 'check-ok');
          html += '<div class="audit-check-item ' + checkClass + '">';
          html += '<span class="audit-check-icon">' + (check.status === 'OK' ? 'âœ“' : (check.status === 'WARN' ? '!' : 'âœ—')) + '</span> ';
          html += '<span>' + (check.explanation || check.reason || check.type) + '</span>';
          if (check.diffMin && check.diffMin !== 0) {
            html += ' <span class="audit-diff">(' + (check.diffMin > 0 ? '+' : '') + check.diffMin + 'åˆ†)</span>';
          }
          html += '</div>';
        });
        html += '</details>';
      }

      // ã‚¿ã‚°ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰
      if (dj.tags && dj.tags.length > 0) {
        html += '<div class="tags" style="margin-top:12px;">';
        dj.tags.forEach(function(tag) {
          var tagClass = '';
          if (tag.indexOf('CONFLICT') >= 0 || tag.indexOf('UNASSIGNED') >= 0 || tag.indexOf('CANCELLED_BUT') >= 0 || tag.indexOf('OUT_OF') >= 0) tagClass = 'ng';
          else if (tag.indexOf('DIFF') >= 0 || tag.indexOf('MISSING') >= 0 || tag.indexOf('EXTRA') >= 0) tagClass = 'warn';
          else tagClass = 'ok';
          html += '<span class="audit-tag ' + tagClass + '">' + tag + '</span> ';
        });
        html += '</div>';
      }

      html += '</div>';
      body.innerHTML = html;
    }

    function closeAuditPatientModal() {
      document.getElementById('auditPatientModal').style.display = 'none';
    }

    // ä»–ã®ã‚¿ãƒ–ã«æˆ»ã‚‹æ™‚ã®ãƒ•ãƒƒã‚¯
    var originalShowTab = showTab;
    showTab = function(tabKey, btn) {
      if (isAuditMode) {
        isAuditMode = false;
        document.getElementById('auditArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        closeAuditDetail();
        closeAuditPatientModal();
      }
      originalShowTab(tabKey, btn);
    };

    // ============================================================
    // ã‚«ã‚¤ãƒã‚±è‡ªå‹•åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ============================================================
    var kaipokeModalInitialized = false;

    function openKaipokeModal() {
      var modal = document.getElementById('kaipokeModal');
      modal.classList.add('show');

      if (!kaipokeModalInitialized) {
        kaipokeInitialize();
        kaipokeModalInitialized = true;
      }
    }

    function closeKaipokeModal() {
      document.getElementById('kaipokeModal').classList.remove('show');
    }

    function kaipokeInitialize() {
      // æœˆé¸æŠã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
      var select = document.getElementById('kaipokeTargetMonth');
      var now = new Date();
      var year = now.getFullYear();
      select.innerHTML = '';
      for (var m = 1; m <= 12; m++) {
        var val = year + '-' + ('0' + m).slice(-2);
        var opt = document.createElement('option');
        opt.value = val;
        opt.textContent = year + 'å¹´' + m + 'æœˆ';
        select.appendChild(opt);
      }
      // ç¾åœ¨ã®æœˆã‚’é¸æŠ
      var currentMonth = year + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
      select.value = currentMonth;

      // é€±é–‹å§‹æ—¥ã‚’è¨­å®š
      document.getElementById('kaipokeWeekStart').value = currentMonth + '-20';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
      kaipokeRefreshStatus();
    }

    function kaipokeShowLoading(message) {
      document.getElementById('kaipokeLoading').className = 'kaipoke-loading show';
      document.getElementById('kaipokeLoadingText').innerText = message || 'å‡¦ç†ä¸­...';
      kaipokeDisableButtons(true);
    }

    function kaipokeHideLoading() {
      document.getElementById('kaipokeLoading').className = 'kaipoke-loading';
      kaipokeDisableButtons(false);
    }

    function kaipokeDisableButtons(disabled) {
      var modal = document.getElementById('kaipokeModal');
      var buttons = modal.querySelectorAll('.kaipoke-btn');
      buttons.forEach(function(btn) { btn.disabled = disabled; });
    }

    function kaipokeShowResult(message, isError) {
      var area = document.getElementById('kaipokeResult');
      area.innerText = message;
      area.className = 'kaipoke-result' + (isError ? ' error' : '');
    }

    function kaipokeGetMonth() {
      return document.getElementById('kaipokeTargetMonth').value;
    }

    function kaipokeGetWeekStart() {
      return document.getElementById('kaipokeWeekStart').value;
    }

    function kaipokeRefreshStatus() {
      google.script.run
        .withSuccessHandler(function(result) {
          var indicator = document.getElementById('kaipokeStatusIndicator');
          var text = document.getElementById('kaipokeStatusText');
          indicator.className = 'kaipoke-status-indicator';
          if (result.status === 'ready') {
            indicator.classList.add('ready');
            text.innerText = result.message;
          } else if (result.status === 'busy') {
            indicator.classList.add('busy');
            text.innerText = result.message;
          } else {
            indicator.classList.add('error');
            text.innerText = result.message;
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('kaipokeStatusIndicator').className = 'kaipoke-status-indicator error';
          document.getElementById('kaipokeStatusText').innerText = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
        })
        .checkServerStatus();
    }

    function kaipokeExpand() {
      if (!confirm('æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å±•é–‹ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆæ‰€è¦æ™‚é–“: ç´„2ã€œ5åˆ†ï¼‰')) return;
      kaipokeShowLoading('æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹ä¸­...\nï¼ˆç´„2ã€œ5åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰');
      kaipokeShowResult('å‡¦ç†é–‹å§‹...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
          kaipokeRefreshStatus();
        })
        .runExpand(kaipokeGetMonth());
    }

    function kaipokeExport() {
      if (!confirm('CSVã‚’å‡ºåŠ›ã—ã¦Google Driveã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
      kaipokeShowLoading('CSVå‡ºåŠ›ä¸­...');
      kaipokeShowResult('å‡¦ç†é–‹å§‹...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
          kaipokeRefreshStatus();
        })
        .runExport(kaipokeGetMonth());
    }

    function kaipokeDiff() {
      var weekStart = kaipokeGetWeekStart();
      if (!weekStart) { alert('å¯¾è±¡é€±ã®é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      kaipokeShowLoading('å·®åˆ†ç¢ºèªä¸­...');
      kaipokeShowResult('å‡¦ç†é–‹å§‹...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
        })
        .checkDiff(kaipokeGetMonth(), weekStart);
    }

    function kaipokeApply() {
      var weekStart = kaipokeGetWeekStart();
      if (!weekStart) { alert('å¯¾è±¡é€±ã®é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!confirm('å·®åˆ†ã‚’ã‚«ã‚¤ãƒã‚±ã«é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“')) return;
      kaipokeShowLoading('å·®åˆ†é©ç”¨ä¸­...');
      kaipokeShowResult('å‡¦ç†é–‹å§‹...');

      google.script.run
        .withSuccessHandler(function(result) {
          kaipokeHideLoading();
          kaipokeShowResult(result.message, !result.success);
          kaipokeRefreshStatus();
        })
        .withFailureHandler(function(error) {
          kaipokeHideLoading();
          kaipokeShowResult('ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
          kaipokeRefreshStatus();
        })
        .runApply(kaipokeGetMonth(), weekStart);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('kaipokeModal').addEventListener('click', function(e) {
      if (e.target === this) closeKaipokeModal();
    });
  </script>

</body>
</html>
